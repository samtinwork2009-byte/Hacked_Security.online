<!DOCTYPE html><html lang="zh-HK"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模擬黑客入侵平台 | Cyber Attack Simulation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== 基礎重置 ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', 'Consolas', 'Monaco', monospace;
        }

        body {
            background: #000;
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* ===== 屏幕效果 ===== */
        .screen-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .scanlines {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 255, 65, 0.03) 50%
            );
            background-size: 100% 4px;
        }

        /* ===== 頁面管理 ===== */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            transition: opacity 0.3s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
            position: relative;
            z-index: 2;
        }

        .page.hidden {
            display: none;
            opacity: 0;
        }

        /* ===== 主頁面樣式 ===== */
        #main-page {
            background: linear-gradient(135deg, #0a0a0a 0%, #050505 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        /* 主頁Logo */
        .main-logo {
            font-size: 3.2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #00ff41 0%, #00cc33 25%, #00ffcc 50%, #00ff41 75%, #33ff77 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(0,255,65,0.6), 0 0 40px rgba(0,255,65,0.3);
            margin-bottom: 20px;
            letter-spacing: 4px;
            animation: logoShine 4s ease-in-out infinite;
            text-align: center;
            filter: drop-shadow(0 0 25px rgba(0,255,65,0.5)) drop-shadow(0 0 50px rgba(0,255,65,0.2)) drop-shadow(0 0 40px rgba(0,255,65,0.3));
        }

        @keyframes logoShine {
            0%, 100% {
                background-position: 0% 50%;
                filter: drop-shadow(0 0 25px rgba(0,255,65,0.5)) drop-shadow(0 0 50px rgba(0,255,65,0.2)) drop-shadow(0 0 40px rgba(0,255,65,0.3));
            }
            50% {
                background-position: 100% 50%;
                filter: drop-shadow(0 0 40px rgba(0,255,65,0.7)) drop-shadow(0 0 80px rgba(0,255,65,0.3));
            }
        }

        .main-subtitle {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 10px;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-align: center;
        }

        .main-tagline {
            color: #666;
            font-size: 1rem;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto 40px;
            text-align: center;
        }

        /* 模式選擇 */
        .mode-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            width: 100%;
            max-width: 1200px;
            padding: 0 20px;
            margin-bottom: 40px;
        }

        .mode-card {
            background: rgba(20, 20, 30, 0.9);
            border-radius: 12px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .mode-card:hover {
            transform: translateY(-5px);
        }

        .mode-card.hacker {
            border-color: #00ff41;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }

        .mode-card.hacker:hover {
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.4);
        }

        .mode-card.defender:hover {
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.4);
        }

        .mode-card.battle {
            border-color: #ff9900;
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.2);
        }

        .mode-card.battle:hover {
            box-shadow: 0 0 30px rgba(255, 153, 0, 0.4);
        }

        .mode-card.battle .mode-icon {
            color: #ff9900;
        }

        .mode-card.battle .mode-title {
            color: #ff9900;
        }

        .mode-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            text-align: center;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mode-card.hacker .mode-icon {
            color: #00ff41;
        }

        .mode-card.defender .mode-icon {
            color: #ff3333;
        }

        .mode-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mode-card.hacker .mode-title {
            color: #00ff41;
        }

        .mode-card.defender .mode-title {
            color: #ff3333;
        }

        .mode-description {
            color: #bbb;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
        }

        .mode-features {
            list-style: none;
            margin-bottom: 25px;
        }

        .mode-features li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            padding-left: 25px;
            display: flex;
            align-items: center;
        }

        .mode-features li:before {
            content: "⟩";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .mode-card.hacker .mode-features li:before {
            color: #00ff41;
        }

        .mode-card.defender .mode-features li:before {
            color: #ff3333;
        }

        .feature-icon {
            margin-right: 10px;
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .select-btn {
            display: block;
            width: 100%;
            padding: 14px;
            text-align: center;
            border-radius: 6px;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            text-transform: uppercase;
        }

        .hacker-btn {
            background: rgba(0, 255, 65, 0.1);
            color: #00ff41;
            border: 2px solid #00ff41;
        }

        .hacker-btn:hover {
            background: rgba(0, 255, 65, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
        }

        .defender-btn {
            background: rgba(255, 51, 51, 0.1);
            color: #ff3333;
            border: 2px solid #ff3333;
        }

        .defender-btn:hover {
            background: rgba(255, 51, 51, 0.2);
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.3);
        }

        /* 遊戲設置面板 */
        .game-settings {
            background: rgba(20, 20, 30, 0.9);
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 800px;
            margin-bottom: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            color: #4af;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
        }

        .setting-input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 1rem;
        }

        .setting-input:focus {
            outline: none;
            border-color: #4af;
        }

        /* 版權聲明 */
        .copyright {
            text-align: center;
            padding: 40px 20px 20px;
            color: #666;
            font-size: 0.9rem;
            line-height: 1.6;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            width: 100%;
            max-width: 800px;
        }

        .copyright strong {
            color: #888;
            font-weight: normal;
        }

        .disclaimer {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            color: #ff5555;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* ===== 遊戲頁面通用樣式 ===== */
        .game-container {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* 黑客模式主題 */
        .hacker-ui {
            --primary-color: #00ff41;
            --secondary-color: #0088ff;
            --danger-color: #ff3333;
            --bg-color: rgba(10, 30, 20, 0.95);
            --panel-bg: rgba(5, 15, 10, 0.9);
            --text-color: #e0ffe0;
        }

        /* 防禦模式主題 */
        .defender-ui {
            --primary-color: #ff3333;
            --secondary-color: #ff9900;
            --danger-color: #00ff41;
            --bg-color: rgba(30, 10, 10, 0.95);
            --panel-bg: rgba(15, 5, 5, 0.9);
            --text-color: #ffe0e0;
        }

        /* 遊戲頭部 */
        .game-header {
            background: var(--bg-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .game-title-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .game-mode-icon {
            font-size: 3rem;
            color: var(--primary-color);
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color);
            letter-spacing: 2px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            border: 1px solid var(--secondary-color);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff41;
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background: #ff3333;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .target-info {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--secondary-color);
        }

        .target-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .target-ip {
            font-family: 'Monaco', monospace;
            color: var(--primary-color);
            font-size: 1.2rem;
            letter-spacing: 1px;
        }

        .game-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px 25px;
            border: 1px solid var(--primary-color);
            min-width: 180px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* 主遊戲區域 */
        .game-main {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1400px) {
            .game-main {
                grid-template-columns: 1fr;
            }
        }

        /* 左側主面板 */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* 終端機 */
        .terminal-container {
            background: rgba(5, 5, 5, 0.95);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            background: linear-gradient(90deg, 
                rgba(0, 0, 0, 0.8), 
                rgba(20, 20, 30, 0.8));
            padding: 20px;
            border-bottom: 1px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .terminal-status {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .terminal-body {
            padding: 25px;
            flex: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
        }

        .terminal-body::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .terminal-body::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .terminal-output {
            flex: 1;
            margin-bottom: 20px;
        }

        .terminal-line {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            animation: fadeIn 0.3s ease;
            word-break: break-word;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .terminal-line.command {
            color: var(--primary-color);
            font-weight: bold;
            border-left: 3px solid var(--primary-color);
        }

        .terminal-line.response {
            color: var(--secondary-color);
        }

        .terminal-line.success {
            color: #00ff88;
            border-left: 3px solid #00ff88;
        }

        .terminal-line.error {
            color: #ff5555;
            border-left: 3px solid #ff5555;
        }

        .terminal-line.warning {
            color: #ffaa00;
            border-left: 3px solid #ffaa00;
        }

        .terminal-line.system {
            color: #aaa;
            font-style: italic;
        }

        .terminal-line.alert {
            color: #ff3333;
            background: rgba(255, 51, 51, 0.1);
            border-left: 3px solid #ff3333;
            animation: alertPulse 1s infinite;
        }

        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .terminal-input-container {
            display: flex;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .terminal-prompt {
            color: var(--primary-color);
            font-weight: bold;
            margin-right: 15px;
            min-width: 150px;
            font-family: 'Monaco', monospace;
        }

        .terminal-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.1rem;
            flex: 1;
            outline: none;
            caret-color: var(--primary-color);
            font-family: 'Monaco', monospace;
        }

        .input-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .suggestion-btn {
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: #ccc;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* 工具面板 */
        .tools-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
        }

        .tools-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tools-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn.active {
            background: var(--primary-color);
            color: black;
            border-color: var(--primary-color);
        }

        .category-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .tool-card {
            background: linear-gradient(135deg, rgba(0, 150, 255, 0.3), rgba(0, 100, 200, 0.3));
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #0099ff;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 150, 255, 0.5);
            background: linear-gradient(135deg, rgba(0, 180, 255, 0.5), rgba(0, 130, 230, 0.5));
            border-color: #00ccff;
        }

        .tool-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tool-card.disabled:hover {
            transform: none;
            box-shadow: none;
            background: rgba(30, 30, 40, 0.8);
        }

        .tool-icon {
            font-size: 2.5rem;
            color: #00ff99;
            margin-bottom: 15px;
        }

        .tool-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #ffffff;
            font-size: 1.1rem;
            text-shadow: 0 0 5px rgba(0, 255, 153, 0.5);
        }

        .tool-desc {
            color: #cccccc;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .defender-ui .tool-card {
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.3), rgba(200, 50, 50, 0.3));
            border-color: #ff3333;
        }

        .defender-ui .tool-card:hover {
            border-color: #ff6666;
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.7);
            background: linear-gradient(135deg, rgba(255, 130, 130, 0.5), rgba(220, 80, 80, 0.5));
        }

        .defender-ui .tool-name {
            color: #ffffff;
            text-shadow: 0 0 5px rgba(255, 51, 51, 0.5);
        }

        .defender-ui .tool-desc {
            color: #dddddd;
        }

        .tool-cooldown {
            font-size: 0.8rem;
            color: #ffaa00;
        }

        /* 右側面板 */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* 對戰信息面板 */
        .battle-info {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
        }

        .battle-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .opponent-info {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .opponent-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .opponent-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .detail-value {
            font-family: 'Monaco', monospace;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .attack-log {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }

        .log-time {
            color: #aaa;
            margin-right: 10px;
        }

        .log-message {
            color: #ccc;
        }

        /* 視覺化區域 */
        .visualization-container {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
            height: 300px;
        }

        .viz-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .network-map {
            height: 200px;
            position: relative;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            overflow: hidden;
        }

        .node {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid var(--primary-color);
            background: rgba(0, 0, 0, 0.7);
            z-index: 2;
        }

        .node:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px var(--primary-color);
            z-index: 3;
        }

        .node.attacked {
            border-color: #ff3333;
            animation: nodeAlert 0.5s infinite;
        }

        @keyframes nodeAlert {
            0%, 100% { box-shadow: 0 0 10px #ff3333; }
            50% { box-shadow: 0 0 20px #ff3333; }
        }

        .node.protected {
            border-color: #00ff41;
            box-shadow: 0 0 10px #00ff41;
        }

        .connection-line {
            position: absolute;
            height: 2px;
            opacity: 0.5;
            transition: opacity 0.3s;
            z-index: 1;
        }

        /* 狀態面板 */
        .status-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
            flex: 1;
        }

        .status-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-item {
            margin-bottom: 20px;
        }

        .status-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #aaa;
        }

        .status-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .status-fill {
            height: 100%;
            background: linear-gradient(90deg, 
                var(--primary-color), 
                color-mix(in srgb, var(--primary-color) 80%, white));
            border-radius: 6px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .status-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* 控制按鈕 */
        .game-controls {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid;
            font-size: 1rem;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn:hover:not(:disabled) {
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 15px var(--primary-color);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: rgba(0, 0, 0, 0.5);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: rgba(255, 51, 51, 0.2);
            color: #ff3333;
            border-color: #ff3333;
        }

        .btn-success {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
            border-color: #00ff41;
        }

        /* 通知系統 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 30, 0.95);
            border-left: 4px solid;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.hacker {
            border-left-color: #00ff41;
        }

        .notification.defender {
            border-left-color: #ff3333;
        }

        .notification.warning {
            border-left-color: #ffaa00;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-message {
            color: #ccc;
            line-height: 1.5;
        }

        /* ===== 響應式設計 ===== */
        @media (max-width: 1200px) {
            .game-main {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-logo {
                font-size: 2.5rem;
            }
            
            .mode-selection {
                grid-template-columns: 1fr;
                max-width: 500px;
                margin: 0 auto 30px;
            }

            .mode-card {
                padding: 25px 20px;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .game-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .game-stats {
                justify-content: center;
            }
            
            .stat-card {
                min-width: 140px;
            }
            
            .tools-grid {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .main-logo {
                font-size: 2rem;
            }
            
            .mode-title {
                font-size: 1.5rem;
            }
            
            .game-title {
                font-size: 1.8rem;
            }
            
            .stat-card {
                min-width: 100%;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }

        /* ===== 攻擊路徑可視化動畫 ===== */
        @keyframes dataFlow {
            0% { stroke-dashoffset: 100; opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { stroke-dashoffset: 0; opacity: 0; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 10px currentColor; }
            50% { transform: scale(1.1); box-shadow: 0 0 20px currentColor; }
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        @keyframes attackFlash {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(255, 0, 0, 0.3); }
        }

        @keyframes defenseShield {
            0%, 100% { box-shadow: 0 0 10px #00ff41; }
            50% { box-shadow: 0 0 30px #00ff41, 0 0 50px #00ff41; }
        }

        @keyframes scanLine {
            0% { top: 0; }
            100% { top: 100%; }
        }

        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }

        .attack-animation {
            animation: attackFlash 0.5s ease-in-out 3;
        }

        .defense-animation {
            animation: defenseShield 1s ease-in-out infinite;
        }

        .node.attacking {
            animation: pulse 0.5s ease-in-out infinite;
            color: #ff3333 !important;
        }

        .node.defending {
            animation: defenseShield 1s ease-in-out infinite;
            color: #00ff41 !important;
        }

        .node.compromised {
            animation: glitch 0.3s ease-in-out infinite;
            color: #ff0000 !important;
        }

        .network-map-enhanced {
            position: relative;
            overflow: hidden;
        }

        .network-map-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff41, transparent);
            animation: scanLine 3s linear infinite;
        }

        .data-packet {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #00ff41;
            border-radius: 50%;
            box-shadow: 0 0 10px #00ff41;
            animation: dataFlow 2s linear infinite;
        }

        .attack-packet {
            background: #ff3333;
            box-shadow: 0 0 10px #ff3333;
        }

        /* 終端機打字效果 */
        .terminal-line.typing {
            overflow: hidden;
            white-space: nowrap;
            animation: typewriter 0.5s steps(40, end);
        }

        /* 工具卡片懸停效果增強 */
        .tool-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 255, 65, 0.3);
        }

        .defender-ui .tool-card:hover {
            box-shadow: 0 10px 30px rgba(255, 51, 51, 0.3);
        }

        /* 晝夜循環效果 */
        .daytime {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .nighttime {
            --bg-gradient: linear-gradient(135deg, #0a0a0f 0%, #000000 100%);
        }

        .nighttime .game-container {
            filter: brightness(0.85);
        }

        /* 聲音效果指示器 */
        .sound-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            border-radius: 8px;
            color: #00ff41;
            font-size: 0.85rem;
            z-index: 100;
            cursor: pointer;
        }

        .sound-indicator:hover {
            background: rgba(0, 255, 65, 0.1);
        }

        /* 自定義模態框 ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay[style*="display: flex"] {
            display: flex !important;
        }

        .modal-box {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 2px solid #00ff41;
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
            position: relative;
        }

        .modal-box button {
            position: relative;
            z-index: 1;
        }

        .modal-title {
            color: #00ff41;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-message {
            color: #ccc;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 65, 0.5);
            border-radius: 6px;
            color: #00ff41;
            font-family: inherit;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .modal-input:focus {
            outline: none;
            border-color: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .modal-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .modal-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, #00ff41 0%, #00cc33 100%);
            color: #000;
            font-weight: bold;
        }

        .modal-btn-confirm:hover {
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
        }

        .modal-btn-danger {
            background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
            color: #fff;
        }

        .modal-btn-danger:hover {
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.5);
        }
    
        /* 改進的按鈕樣式 - 確保文字清晰可見 */
        .tool-btn {
            position: relative;
            padding: 14px 20px;
            border-radius: 8px;
            border: 2px solid;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.6) !important;
        }
        
        .tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        
        /* 斷開連接 - 紅色邊框，白色文字 */
        .tool-btn.disconnect {
            border-color: #ff3333;
            color: #ffffff !important;
            background: rgba(255,51,51,0.15) !important;
        }
        
        .tool-btn.disconnect:hover {
            background: rgba(255,51,51,0.25) !important;
            box-shadow: 0 0 20px rgba(255,51,51,0.4);
        }
        
        /* 強化防禦 - 紅色邊框，白色文字 */
        .tool-btn.fortify {
            border-color: #ff3333;
            color: #ffffff !important;
            background: rgba(255,51,51,0.15) !important;
        }
        
        .tool-btn.fortify:hover {
            background: rgba(255,51,51,0.25) !important;
            box-shadow: 0 0 20px rgba(255,51,51,0.4);
        }
        
        /* 監控流量 - 紅色邊框，白色文字 */
        .tool-btn.monitor {
            border-color: #ff3333;
            color: #ffffff !important;
            background: rgba(255,51,51,0.15) !important;
        }
        
        .tool-btn.monitor:hover {
            background: rgba(255,51,51,0.25) !important;
            box-shadow: 0 0 20px rgba(255,51,51,0.4);
        }
        
        /* 封鎖所有 - 深紅色背景，白色文字 */
        .tool-btn.block-all {
            border-color: #cc0000;
            color: #ffffff !important;
            background: rgba(204,0,0,0.3) !important;
        }
        
        .tool-btn.block-all:hover {
            background: rgba(204,0,0,0.4) !important;
            box-shadow: 0 0 20px rgba(204,0,0,0.5);
        }
        
        /* 威脅掃描 - 藍色邊框，白色文字 */
        .tool-btn.scan {
            border-color: #4488ff;
            color: #ffffff !important;
            background: rgba(68,136,255,0.2) !important;
        }
        
        .tool-btn.scan:hover {
            background: rgba(68,136,255,0.3) !important;
            box-shadow: 0 0 20px rgba(68,136,255,0.4);
        }
        
        /* 緊急封鎖 - 深紅色背景，白色文字 */
        .tool-btn.emergency {
            border-color: #ff0000;
            color: #ffffff !important;
            background: rgba(255,0,0,0.3) !important;
        }
        
        .tool-btn.emergency:hover {
            background: rgba(255,0,0,0.4) !important;
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
        }
        
        /* 啟動蜜罐 - 綠色邊框，白色文字 */
        .tool-btn.honeypot {
            border-color: #00ff66;
            color: #ffffff !important;
            background: rgba(0,255,102,0.15) !important;
        }
        
        .tool-btn.honeypot:hover {
            background: rgba(0,255,102,0.25) !important;
            box-shadow: 0 0 20px rgba(0,255,102,0.4);
        }
        
        /* 系統狀態 - 深藍色背景，白色文字 */
        .tool-btn.status {
            border-color: #336699;
            color: #ffffff !important;
            background: rgba(51,102,153,0.3) !important;
        }
        
        .tool-btn.status:hover {
            background: rgba(51,102,153,0.4) !important;
            box-shadow: 0 0 20px rgba(51,102,153,0.4);
        }
        
        /* 備份工具 - 青綠色邊框，白色文字 */
        .tool-btn.backup {
            border-color: #00ccaa;
            color: #ffffff !important;
            background: rgba(0,204,170,0.15) !important;
        }
        
        .tool-btn.backup:hover {
            background: rgba(0,204,170,0.25) !important;
            box-shadow: 0 0 20px rgba(0,204,170,0.4);
        }
        
        /* 與黑客談判 - 紫色邊框，白色文字 */
        .tool-btn.negotiate {
            border-color: #9966ff;
            color: #ffffff !important;
            background: rgba(153,102,255,0.2) !important;
        }
        
        .tool-btn.negotiate:hover {
            background: rgba(153,102,255,0.3) !important;
            box-shadow: 0 0 20px rgba(153,102,255,0.4);
        }
        
        /* VPN隧道 - 青綠色邊框，白色文字 */
        .tool-btn.vpn {
            border-color: #00ddaa;
            color: #ffffff !important;
            background: rgba(0,221,170,0.15) !important;
        }
        
        .tool-btn.vpn:hover {
            background: rgba(0,221,170,0.25) !important;
            box-shadow: 0 0 20px rgba(0,221,170,0.4);
        }
        
        /* 看來無敵 - 橙紅色背景，白色文字 */
        .tool-btn.invincible {
            border-color: #ff6600;
            color: #ffffff !important;
            background: rgba(255,102,0,0.25) !important;
        }
        
        .tool-btn.invincible:hover {
            background: rgba(255,102,0,0.35) !important;
            box-shadow: 0 0 20px rgba(255,102,0,0.5);
        }
        
        /* 看來無敵第三方支援 - 藍色邊框，白色文字 */
        .tool-btn.support {
            border-color: #4488ff;
            color: #ffffff !important;
            background: rgba(68,136,255,0.2) !important;
        }
        
        .tool-btn.support:hover {
            background: rgba(68,136,255,0.3) !important;
            box-shadow: 0 0 20px rgba(68,136,255,0.4);
        }
        
        /* 底部工具按鈕 - 深灰色背景，白色文字 */
        .utility-btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: 2px solid #555;
            background: rgba(40,40,40,0.9) !important;
            color: #ffffff !important;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        
        .utility-btn:hover {
            background: rgba(60,60,60,0.9) !important;
            border-color: #777;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }
        
        /* 返回主選單按鈕 */
        .back-btn {
            padding: 12px 30px;
            border-radius: 8px;
            border: 2px solid #666;
            background: rgba(30,30,30,0.9) !important;
            color: #ffffff !important;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        
        .back-btn:hover {
            background: rgba(50,50,50,0.9) !important;
            border-color: #888;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        /* 暗黑風格增強 */
        body {
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000000 100%);
        }
        
        .terminal {
            background: rgba(0, 0, 0, 0.9) !important;
            border: 1px solid rgba(0, 255, 65, 0.3);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.1);
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.3);
            border-radius: 5px;
        }
        /* ===== 導航欄樣式 ===== */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.95), rgba(5, 5, 5, 0.95));
            border-bottom: 2px solid rgba(0, 255, 65, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
        }

        .nav-logo {
            font-size: 1.3rem;
            font-weight: bold;
            color: #00ff41;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px rgba(0,255,65,0.5);
        }

        .nav-logo:hover {
            filter: drop-shadow(0 0 15px rgba(0,255,65,0.7));
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-menu li a {
            color: #aaa;
            text-decoration: none;
            font-size: 0.95rem;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 4px;
        }

        .nav-menu li a:hover {
            color: #00ff41;
            background: rgba(0, 255, 65, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        .nav-menu li a.active {
            color: #00ff41;
            border-bottom: 2px solid #00ff41;
        }

        /* ===== 麵包屑導航樣式 ===== */
        .breadcrumb {
            position: fixed;
            top: 65px;
            left: 30px;
            font-size: 0.85rem;
            color: #666;
            z-index: 99;
            display: none;
        }

        .breadcrumb.active {
            display: block;
        }

        .breadcrumb a {
            color: #4af;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .breadcrumb a:hover {
            color: #00ff41;
        }

        .breadcrumb span {
            color: #666;
            margin: 0 8px;
        }

        /* ===== 主頁面頂部邊距調整 ===== */
        #main-page {
            padding-top: 80px;
        }

        /* ===== 模式卡片增強 ===== */
        .mode-card {
            background: rgba(20, 20, 30, 0.95);
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .mode-card:hover::before {
            left: 100%;
        }

        .mode-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.7);
        }

        /* ===== 按鈕增強 ===== */
        .select-btn {
            display: block;
            width: 100%;
            padding: 16px;
            text-align: center;
            border-radius: 10px;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .select-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .select-btn:hover::after {
            width: 300px;
            height: 300px;
        }

        .hacker-btn {
            background: rgba(0, 255, 65, 0.15);
            color: #00ff41;
            border: 2px solid #00ff41;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }

        .hacker-btn:hover {
            background: rgba(0, 255, 65, 0.25);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.5), inset 0 0 20px rgba(0, 255, 65, 0.1);
        }

        .defender-btn {
            background: rgba(255, 51, 51, 0.15);
            color: #ff3333;
            border: 2px solid #ff3333;
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.2);
        }

        .defender-btn:hover {
            background: rgba(255, 51, 51, 0.25);
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.5), inset 0 0 20px rgba(255, 51, 51, 0.1);
        }

        /* ===== 執法系統樣式 ===== */
        .law-enforcement-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .law-enforcement-container {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.95), rgba(10, 10, 30, 0.95));
            border: 2px solid rgba(100, 150, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(100, 150, 255, 0.2);
        }

        .law-enforcement-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(100, 150, 255, 0.3);
            padding-bottom: 20px;
        }

        .law-enforcement-icon {
            font-size: 3rem;
            color: #4a90d9;
            filter: drop-shadow(0 0 10px rgba(74, 144, 217, 0.5));
        }

        .law-enforcement-title {
            font-size: 1.8rem;
            color: #4a90d9;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .law-enforcement-subtitle {
            font-size: 0.9rem;
            color: #888;
            margin-top: 5px;
        }

        .law-enforcement-section {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(100, 150, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .law-enforcement-section h3 {
            color: #4a90d9;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .law-enforcement-section h3 i {
            font-size: 1.5rem;
        }

        .department-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .department-card {
            background: rgba(20, 20, 40, 0.8);
            border: 1px solid rgba(100, 150, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .department-card:hover {
            background: rgba(30, 30, 50, 0.9);
            border-color: rgba(100, 150, 255, 0.6);
            box-shadow: 0 0 20px rgba(100, 150, 255, 0.2);
        }

        .department-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 5px rgba(100, 150, 255, 0.4));
        }

        .department-name {
            color: #4a90d9;
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .department-status {
            color: #888;
            font-size: 0.8rem;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(100, 150, 255, 0.3);
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90d9, #6ab0ff);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .investigation-timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
            padding-left: 40px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            width: 20px;
            height: 20px;
            background: rgba(100, 150, 255, 0.3);
            border: 2px solid #4a90d9;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .timeline-item.completed::before {
            background: #4a90d9;
            box-shadow: 0 0 15px rgba(74, 144, 217, 0.6);
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            left: 19px;
            top: 20px;
            width: 2px;
            height: calc(100% + 20px);
            background: rgba(100, 150, 255, 0.2);
        }

        .timeline-item:last-child::after {
            display: none;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            color: #4a90d9;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .timeline-description {
            color: #888;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .hacker-profile {
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid rgba(255, 51, 51, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .hacker-profile-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 51, 51, 0.1);
        }

        .hacker-profile-item:last-child {
            border-bottom: none;
        }

        .hacker-profile-label {
            color: #888;
        }

        .hacker-profile-value {
            color: #ff3333;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .law-enforcement-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .law-enforcement-btn {
            padding: 12px 25px;
            border-radius: 8px;
            border: 2px solid #4a90d9;
            background: rgba(74, 144, 217, 0.15);
            color: #4a90d9;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .law-enforcement-btn:hover {
            background: rgba(74, 144, 217, 0.25);
            box-shadow: 0 0 20px rgba(74, 144, 217, 0.4);
        }

        .law-enforcement-btn.arrest {
            border-color: #ff3333;
            background: rgba(255, 51, 51, 0.15);
            color: #ff3333;
        }

        .law-enforcement-btn.arrest:hover {
            background: rgba(255, 51, 51, 0.25);
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.4);
        }

        .law-enforcement-btn.success {
            border-color: #00ff41;
            background: rgba(0, 255, 65, 0.15);
            color: #00ff41;
        }

        .law-enforcement-btn.success:hover {
            background: rgba(0, 255, 65, 0.25);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
        }

        .law-enforcement-result {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(100, 150, 255, 0.4);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-top: 30px;
            animation: slideUp 0.5s ease;
        }

        .law-enforcement-result.success {
            border-color: rgba(0, 255, 65, 0.5);
        }

        .law-enforcement-result.failure {
            border-color: rgba(255, 51, 51, 0.5);
        }

        .result-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 15px currentColor);
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .result-description {
            color: #aaa;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close-law-enforcement {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            color: #888;
            cursor: pointer;
            transition: all 0.3s ease;
            background: none;
            border: none;
            padding: 0;
        }

        .close-law-enforcement:hover {
            color: #ff3333;
            transform: rotate(90deg);
        }
</style>
</head>
<body><nav id="navbar">
        <div class="nav-logo" onclick="goToMainPage()">
            <i class="fas fa-shield-virus"></i> Hacker VS Defender
        </div>
        <ul class="nav-menu">
            <li><a onclick="goToMainPage()" id="nav-home">主頁</a></li>
            <li><a onclick="navigateToMode('hacker')" id="nav-hacker">黑客模式</a></li>
            <li><a onclick="navigateToMode('defender')" id="nav-defender">防禦者模式</a></li>
            <li><a onclick="navigateToMode('battle')" id="nav-battle">對戰模式</a></li>
        </ul>
    </nav>
    <div class="breadcrumb" id="breadcrumb"></div>

    <!-- 自定義模態框 -->
    <div class="modal-overlay" id="custom-modal">
        <div class="modal-box">
            <div class="modal-title">
                <i class="fas fa-terminal"></i>
                <span id="modal-title-text">系統提示</span>
            </div>
            <div class="modal-message" id="modal-message"></div>
            <input type="text" class="modal-input" id="modal-input" style="display: none;">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">取消</button>
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">確定</button>
            </div>
        </div>
    </div>

    <!-- 屏幕效果 -->
    <div class="screen-effects">
        <div class="scanlines"></div>
    </div>

    <!-- 通知系統 -->
    <div class="notification" id="notification">
        <div class="notification-title" id="notification-title">
            <i class="fas fa-info-circle"></i>
            <span id="notification-title-text">系統通知</span>
        </div>
        <div class="notification-message" id="notification-message"></div>
    </div>

    <!-- 主頁面 -->
    <div id="main-page" class="page active">
        <div class="main-header">
            
        <!-- 網絡安全大數據圖標 -->
        <div style="text-align: center; margin-bottom: 30px;">
            <i class="fas fa-shield-virus" style="font-size: 4rem; color: #00ff41; filter: drop-shadow(0 0 20px rgba(0,255,65,0.5)); animation: iconPulse 3s ease-in-out infinite;"></i>
            <i class="fas fa-network-wired" style="font-size: 4rem; color: #ff3333; margin: 0 30px; filter: drop-shadow(0 0 20px rgba(255,51,51,0.5)); animation: iconPulse 3s ease-in-out infinite 0.5s;"></i>
            <i class="fas fa-skull-crossbones" style="font-size: 4rem; color: #888; filter: drop-shadow(0 0 20px rgba(136,136,136,0.5)); animation: iconPulse 3s ease-in-out infinite 1s;"></i>
        </div>
        
        <style>
        @keyframes iconPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        </style>
<div class="main-logo">Hacker VS 防禦者 網絡大戰場</div>
            <div class="main-subtitle">Cyber Attack Simulation Platform</div>
            <div class="main-tagline">
                網絡安全教育模擬平台。黑客/防禦者模擬器為獨立學習模式，
                對戰模式則可與AI進行攻防對決。所有操作均為純模擬，不會影響真實系統。
            </div>

            <!-- 說明指南和流程圖按鈕 -->
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                <button class="btn" id="guide-btn" style="background: linear-gradient(135deg, #4a90d9 0%, #357abd 100%); padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-book"></i>
                    <span>模擬器操作說明指南</span>
                </button>
                <button class="btn" id="flowchart-btn" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-project-diagram"></i>
                    <span>模擬器流程示範圖</span>
                </button>
            </div>
        </div>

        <!-- 隱藏的IP設置（用於對戰模式） -->
        <input type="hidden" id="player-ip" value="192.168.1.100">
        <input type="hidden" id="target-ip" value="">
        <input type="hidden" id="game-difficulty" value="medium">

        <div class="mode-selection">
            <!-- 黑客模式卡片 (獨立模擬) -->
            <div class="mode-card hacker" id="hacker-card">
                <div class="mode-icon">
                    <i class="fas fa-user-secret"></i>
                </div>
                <div class="mode-title">黑客模擬器</div>
                <div class="mode-description">
                    獨立模擬模式 - 體驗專業黑客的操作介面和工具。
                    學習各種攻擊技術，探索漏洞發現流程。此模式為純粹模擬，無對戰功能。
                </div>
                <ul class="mode-features">
                    <li>
                        <span class="feature-icon"><i class="fas fa-crosshairs"></i></span>
                        <span>15+ 專業攻擊工具</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-bug"></i></span>
                        <span>漏洞掃描模擬</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-mask"></i></span>
                        <span>隱蔽技術學習</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-terminal"></i></span>
                        <span>專業終端介面</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-graduation-cap"></i></span>
                        <span>教育學習模式</span>
                    </li>
                </ul>
                <button class="select-btn hacker-btn" id="hacker-btn" onclick="navigateToMode('hacker')">
                    <i class="fas fa-terminal"></i>
                    <span>進入模擬器</span>
                </button>
            </div>

            <!-- 防禦模式卡片 (獨立模擬) -->
            <div class="mode-card defender" id="defender-card">
                <div class="mode-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="mode-title">防禦者模擬器</div>
                <div class="mode-description">
                    獨立模擬模式 - 體驗網絡安全專家的防禦操作。
                    學習監控技術和防護策略。此模式為純粹模擬，無對戰功能。
                </div>
                <ul class="mode-features">
                    <li>
                        <span class="feature-icon"><i class="fas fa-eye"></i></span>
                        <span>系統監控模擬</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-filter"></i></span>
                        <span>防火牆配置學習</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-virus"></i></span>
                        <span>威脅檢測模擬</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-server"></i></span>
                        <span>伺服器管理介面</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-graduation-cap"></i></span>
                        <span>教育學習模式</span>
                    </li>
                </ul>
                <button class="select-btn defender-btn" id="defender-btn" onclick="navigateToMode('defender')">
                    <i class="fas fa-shield-alt"></i>
                    <span>進入模擬器</span>
                </button>
            </div>

            <!-- 對戰模式卡片 (真正雙方對戰) -->
            <div class="mode-card battle" id="battle-card" style="border-color: #ff9900; box-shadow: 0 0 25px rgba(255, 153, 0, 0.3);">
                <div class="mode-icon" style="color: #ff9900;">
                    <i class="fas fa-fist-raised"></i>
                </div>
                <div class="mode-title" style="color: #ff9900;">⚔️ 對戰模式 ⚔️</div>
                <div class="mode-description">
                    真正的攻防對決！選擇陣營後，AI將操控另一方與你進行實時對戰。
                    雙方同時行動，攻擊、防禦、課金系統全面啟用。
                </div>
                <ul class="mode-features">
                    <li>
                        <span class="feature-icon" style="color: #ff9900;"><i class="fas fa-users"></i></span>
                        <span>玩家 vs AI 對手</span>
                    </li>
                    <li>
                        <span class="feature-icon" style="color: #ff9900;"><i class="fas fa-bolt"></i></span>
                        <span>實時攻防系統</span>
                    </li>
                    <li>
                        <span class="feature-icon" style="color: #ff9900;"><i class="fas fa-robot"></i></span>
                        <span>智能AI自動操作</span>
                    </li>
                    <li>
                        <span class="feature-icon" style="color: #ff9900;"><i class="fas fa-coins"></i></span>
                        <span>課金與勒索系統</span>
                    </li>
                    <li>
                        <span class="feature-icon" style="color: #ff9900;"><i class="fas fa-trophy"></i></span>
                        <span>勝負判定系統</span>
                    </li>
                </ul>
                <button class="select-btn" id="battle-btn" onclick="navigateToMode('battle')" style="background: linear-gradient(135deg, #ff9900 0%, #ff6600 100%); font-weight: bold;">
                    <i class="fas fa-gamepad"></i>
                    <span>開始對戰</span>
                </button>
            
</div>
        </div>

        <!-- 版權聲明 -->
        <div class="copyright">
            <div class="disclaimer">
                <strong>⚠️ 重要聲明：</strong><br>
                這是這個平台是屬於純粹模擬的效果，不是真正的網絡世界黑客對戰，模擬器將不會收集任何的個人或私隱資料，不會連接真正的系統。也不建議進行真實的網絡黑客非法行為。模擬內能夠透過對戰遊戲認識出真正的黑客運作攻擊流程。
            </div>
            
            <p>
                <strong>© 2025 Create By【 Sam. T 】</strong><br>
                Copyright © 2025 Sam. T. All rights reserved.<br>
                版權所有© 2025 Sam. T<br>
                此平台已受版權所有
            </p>
        </div>
    </div>

    <!-- 遊戲頁面容器 -->
    <div id="game-page" class="page hidden"></div>

    <!-- 對戰模式選擇頁面 -->
    <div id="battle-select-page" class="page hidden">
        <div class="main-header">
            <div class="main-logo" style="color: #ff9900; text-shadow: 0 0 10px #ff9900, 0 0 20px #ff9900;">
                <span>對戰模式</span>
            </div>
            <div class="main-subtitle">選擇你的陣營</div>
            <div class="main-tagline">
                在對戰模式中，你將與AI對手進行實時攻防對決。
                選擇扮演黑客發動攻擊，或選擇扮演防禦者保護系統。
            </div>
        </div>

        <!-- 對戰設置 -->
        <div class="game-settings" style="border-color: rgba(255, 153, 0, 0.3);">
            <div class="settings-title" style="color: #ff9900;">
                <i class="fas fa-cog"></i>
                <span>對戰設置</span>
            </div>

            <div class="setting-group">
                <label class="setting-label">你的虛擬IP地址：</label>
                <input type="text" id="battle-player-ip" class="setting-input" value="192.168.1.100" readonly="" style="border-color: rgba(255, 153, 0, 0.5);">
                <small style="color: #666; display: block; margin-top: 5px;">
                    這是你的唯一識別ID
                </small>
            </div>

            <div class="setting-group">
                <label class="setting-label">目標IP地址（AI對手）：</label>
                <input type="text" id="battle-target-ip" class="setting-input" placeholder="輸入目標IP地址（例：192.168.1.200）" style="border-color: rgba(255, 153, 0, 0.5);">
                <small style="color: #666; display: block; margin-top: 5px;">
                    輸入對手的虛擬IP地址開始對戰
                </small>
            </div>

            <div class="setting-group">
                <label class="setting-label">AI難度：</label>
                <select id="battle-difficulty" class="setting-input" style="border-color: rgba(255, 153, 0, 0.5);">
                    <option value="random" selected="">🎲 隨機難度 (推薦)</option>
                    <option value="easy">簡單 - AI反應較慢 (7分鐘)</option>
                    <option value="medium">中等 - 標準AI對手 (5分鐘)</option>
                    <option value="hard">困難 - AI反應迅速 (3分鐘)</option>
                </select>
                <small style="color: #ff9900; display: block; margin-top: 5px;">
                    <i class="fas fa-info-circle"></i> 隨機難度: 60%簡單、30%中等、10%困難
                </small>
            </div>
        </div>

        <!-- 陣營選擇 -->
        <div class="mode-selection" style="margin-top: 30px;">
            <!-- 選擇黑客 -->
            <div class="mode-card hacker" id="battle-hacker-card">
                <div class="mode-icon">
                    <i class="fas fa-user-secret"></i>
                </div>
                <div class="mode-title">扮演黑客</div>
                <div class="mode-description">
                    作為攻擊方，使用各種攻擊工具嘗試入侵防禦者的系統。
                    突破防火牆，獲取系統權限，在被發現前完成目標。
                </div>
                <button class="select-btn hacker-btn" id="battle-start-hacker">
                    <i class="fas fa-skull-crossbones"></i>
                    <span>以黑客身份對戰</span>
                </button>
            </div>

            <!-- 選擇防禦者 -->
            <div class="mode-card defender" id="battle-defender-card">
                <div class="mode-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="mode-title">扮演防禦者</div>
                <div class="mode-description">
                    作為防守方，監控網絡流量，配置防火牆規則，
                    檢測並阻擋黑客的攻擊，保護系統安全。
                </div>
                <button class="select-btn defender-btn" id="battle-start-defender">
                    <i class="fas fa-shield-alt"></i>
                    <span>以防禦者身份對戰</span>
                </button>
            </div>
        </div>

        <!-- 返回按鈕 -->
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" id="battle-back-btn" style="background: rgba(255, 255, 255, 0.1); border: 1px solid #666; padding: 12px 30px;">
                <i class="fas fa-arrow-left"></i>
                <span>返回主選單</span>
            </button>
        </div>
    </div>

        <!-- 操作說明指南頁面 -->
    <div id="guide-page" class="page hidden">
        <div class="main-header">
            <div class="main-logo" style="color: #4a90d9; text-shadow: 0 0 10px #4a90d9, 0 0 20px #4a90d9;">
                <span>操作說明指南</span>
            </div>
            <div class="main-subtitle">模擬器使用手冊 v3.0 - 全新增強版</div>
        </div>

        <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
            <!-- 版本更新亮點 -->
            <div style="background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,140,0,0.2)); border: 2px solid #ffd700; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 0 20px rgba(255,215,0,0.3);">
                <h2 style="color: #ffd700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-star"></i> 🎉 v3.0 重大更新亮點
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #00ff41;">
                        <strong style="color: #00ff41; font-size: 1.1rem;"><i class="fas fa-shopping-cart"></i> 商店系統與商品應用</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">購買的商品現在可以實際應用到遊戲中！包括VPN、攻擊加速器、終極套裝等，每個商品都有獨特效果，可在商品選擇器中一鍵應用。</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #ff3333;">
                        <strong style="color: #ff3333; font-size: 1.1rem;"><i class="fas fa-eye"></i> 防禦者即時預覽</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">黑客可以即時監控防禦者的瀏覽器操作！查看對方正在做什麼、訪問哪些頁面，掌握先機。需要防禦者先上線才能開始監控。</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9900;">
                        <strong style="color: #ff9900; font-size: 1.1rem;"><i class="fas fa-clock"></i> 延遲提示系統</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">防禦者不會立即收到黑客監控的警告！系統會延遲30秒至1分鐘才通知，給黑客更多操作時間。購買隱身工具包可延長至2分鐘。</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #9b59b6;">
                        <strong style="color: #9b59b6; font-size: 1.1rem;"><i class="fas fa-bolt"></i> 權限爭奪機制</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">全新的系統控制權爭奪戰！黑客可以逐步奪取防禦者的系統權限。購買終極套裝可瞬間完全控制對方系統！</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #00ffff;">
                        <strong style="color: #00ffff; font-size: 1.1rem;"><i class="fas fa-shield-alt"></i> 防禦者反擊能力</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">防禦者不再只能被動防守！購買反擊套裝後可以反追蹤並攻擊黑客，在權限爭奪中有機會奪回控制權。速度是關鍵！</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #ff1493;">
                        <strong style="color: #ff1493; font-size: 1.1rem;"><i class="fas fa-gem"></i> 高級套裝系統</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">課金越高，能力越強！終極套裝提供瞬間控制能力，可在極短時間內完全掌控對方系統。攻擊力+100%，控制速度x10！</p>
                    </div>
                </div>
            </div>

            <!-- 介紹 -->
            <div style="background: rgba(74, 144, 217, 0.1); border: 2px solid #4a90d9; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #4a90d9; margin-bottom: 18px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle"></i> 關於此模擬器
                </h2>
                <p style="color: #ccc; line-height: 1.9; font-size: 1rem;">
                    「模擬黑客入侵平台」是一個功能完整的<strong style="color: #00ff41;">網絡安全教育模擬器</strong>，讓您在完全安全的環境中體驗真實的網絡攻防場景。
                    平台支援<strong style="color: #ff9900;">即時對戰</strong>、<strong style="color: #9b59b6;">完整課金系統</strong>、<strong style="color: #e74c3c;">多種攻擊模式</strong>以及<strong style="color: #00ffff;">商品應用機制</strong>。
                    <br><br>
                    <strong style="color: #ff9900;">⚠️ 重要提示：</strong>所有操作都在瀏覽器中模擬進行，不會對任何真實系統造成影響。本平台純粹用於教育和學習目的。
                    <br><br>
                    <strong style="color: #00ff41;">✨ 新功能：</strong>商品購買後可實際應用、即時監控對手、延遲警告系統、權限爭奪戰、防禦者反擊等豐富互動功能！
                </p>
            </div>

            <!-- 核心功能分類 -->
            <div style="margin-bottom: 25px;">
                <h2 style="color: #fff; margin-bottom: 20px; font-size: 1.4rem;">
                    <i class="fas fa-th-large"></i> 核心功能模組
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 18px;">
                    <!-- 黑客模式 -->
                    <div style="background: rgba(0, 255, 65, 0.1); border: 2px solid #00ff41; border-radius: 12px; padding: 22px;">
                        <h3 style="color: #00ff41; margin-bottom: 15px; font-size: 1.2rem;">
                            <i class="fas fa-user-secret"></i> 黑客模式功能
                        </h3>
                        <ul style="color: #aaa; line-height: 2; list-style: none; padding: 0; font-size: 0.95rem;">
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>端口掃描</strong> - 探測目標開放服務與漏洞</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>漏洞利用</strong> - 使用已知漏洞進行攻擊</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>密碼破解</strong> - 暴力破解系統密碼</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>三種攻擊模式</strong> - 直接/漸進/勒索</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>即時監控</strong> - 查看防禦者操作 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>權限奪取</strong> - 逐步控制對方系統 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>商品應用</strong> - 使用購買的工具 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>課金升級</strong> - 提升攻擊能力與速度</li>
                        </ul>
                    </div>

                    <!-- 防禦者模式 -->
                    <div style="background: rgba(255, 51, 51, 0.1); border: 2px solid #ff3333; border-radius: 12px; padding: 22px;">
                        <h3 style="color: #ff3333; margin-bottom: 15px; font-size: 1.2rem;">
                            <i class="fas fa-shield-alt"></i> 防禦者模式功能
                        </h3>
                        <ul style="color: #aaa; line-height: 2; list-style: none; padding: 0; font-size: 0.95rem;">
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>入侵檢測</strong> - 即時監控異常活動</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>防火牆配置</strong> - 封鎖惡意流量與IP</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>延遲警告</strong> - 30秒後收到監控提示 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>反擊能力</strong> - 反追蹤並攻擊黑客 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>權限防守</strong> - 抵抗黑客控制 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>反擊課金</strong> - 入侵黑客戶口竊取資金</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>漏洞修補</strong> - 修復系統安全弱點</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>警報系統</strong> - 收到攻擊即時提示</li>
                        </ul>
                    </div>

                    <!-- 對戰模式 -->
                    <div style="background: rgba(255, 153, 0, 0.1); border: 2px solid #ff9900; border-radius: 12px; padding: 22px;">
                        <h3 style="color: #ff9900; margin-bottom: 15px; font-size: 1.2rem;">
                            <i class="fas fa-gamepad"></i> 對戰模式功能
                        </h3>
                        <ul style="color: #aaa; line-height: 2; list-style: none; padding: 0; font-size: 0.95rem;">
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>限時對戰</strong> - 5分鐘激烈攻防對決</li>
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>智能AI對手</strong> - 根據難度即時反應</li>
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>進度追蹤</strong> - 實時顯示雙方進度條</li>
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>權限爭奪</strong> - 即時控制權百分比 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>勝利獎勵</strong> - 獲得大量虛擬金錢</li>
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>雙方互動</strong> - 指令互相影響與干擾</li>
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>商品效果</strong> - 應用的商品影響戰局 🆕</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 商店與商品系統 -->
            <div style="background: rgba(255, 215, 0, 0.1); border: 2px solid #ffd700; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #ffd700; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-store"></i> 商店與商品應用系統 🆕
                </h2>
                <p style="color: #ccc; line-height: 1.8; margin-bottom: 20px; font-size: 0.95rem;">
                    全新的商店系統讓您購買各種工具和套裝，<strong style="color: #00ff41;">購買後可以在遊戲中實際應用</strong>，每個商品都有獨特的效果和能力加成！
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <!-- 黑客商品 -->
                    <div style="background: rgba(0,255,65,0.1); padding: 18px; border-radius: 10px; border: 2px solid #00ff41;">
                        <h4 style="color: #00ff41; margin-bottom: 12px;"><i class="fas fa-skull-crossbones"></i> 黑客專屬商品</h4>
                        <ul style="color: #aaa; font-size: 0.9rem; line-height: 1.9; padding-left: 20px;">
                            <li><strong>VPN套裝</strong> - 基礎/高級/精英三個等級，隱藏機率30%/60%/90%</li>
                            <li><strong>攻擊加速器</strong> - 攻擊力+20%，控制速度x1.5</li>
                            <li><strong>高級攻擊套裝</strong> - 攻擊力+50%，控制速度x3.0</li>
                            <li><strong>終極套裝</strong> - 攻擊力+100%，瞬間控制能力！</li>
                            <li><strong>隱身工具包</strong> - 隱身+40%，警告延遲120秒</li>
                        </ul>
                    </div>
                    
                    <!-- 防禦者商品 -->
                    <div style="background: rgba(255,51,51,0.1); padding: 18px; border-radius: 10px; border: 2px solid #ff3333;">
                        <h4 style="color: #ff3333; margin-bottom: 12px;"><i class="fas fa-shield-alt"></i> 防禦者專屬商品</h4>
                        <ul style="color: #aaa; font-size: 0.9rem; line-height: 1.9; padding-left: 20px;">
                            <li><strong>基礎防火牆</strong> - 阻擋機率30%，基本防護</li>
                            <li><strong>高級防火牆</strong> - 阻擋機率60%，強化防護</li>
                            <li><strong>反擊套裝</strong> - 啟用反追蹤與攻擊能力，反擊力50%</li>
                            <li><strong>追蹤偵測器</strong> - 提前30秒警告黑客監控</li>
                        </ul>
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.4); padding: 18px; border-radius: 8px; border-left: 4px solid #ffd700;">
                    <strong style="color: #ffd700; font-size: 1.05rem;"><i class="fas fa-lightbulb"></i> 如何應用商品？</strong>
                    <p style="color: #ccc; margin-top: 10px; line-height: 1.8; font-size: 0.9rem;">
                        1. 在商店購買商品後，商品會自動加入您的庫存<br>
                        2. 點擊遊戲介面中的「應用商品」按鈕<br>
                        3. 在商品選擇器中選擇要使用的商品<br>
                        4. 商品效果立即生效，終端會顯示應用成功訊息<br>
                        5. 已應用的商品會在當前遊戲中持續有效
                    </p>
                </div>
            </div>

            <!-- 攻擊模式詳解 -->
            <div style="background: rgba(231, 76, 60, 0.1); border: 2px solid #e74c3c; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #e74c3c; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-bolt"></i> 黑客攻擊模式詳解
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <div style="background: rgba(0,0,0,0.4); padding: 18px; border-radius: 10px; border-left: 4px solid #ff3333;">
                        <strong style="color: #ff3333; font-size: 1.1rem;">💀 直接執行攻擊</strong>
                        <p style="color: #aaa; font-size: 0.9rem; margin-top: 12px; line-height: 1.8;">
                            <strong>效果：</strong>立即封殺對方防禦者系統，使所有設備殭屍化<br>
                            <strong>特點：</strong>攻擊速度最快，但風險較高<br>
                            <strong>結果：</strong>防禦者無法作出任何反擊或設定<br>
                            <strong>成本：</strong>$50,000
                        </p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 18px; border-radius: 10px; border-left: 4px solid #ff9900;">
                        <strong style="color: #ff9900; font-size: 1.1rem;">🕷️ 循序漸進攻擊</strong>
                        <p style="color: #aaa; font-size: 0.9rem; margin-top: 12px; line-height: 1.8;">
                            <strong>效果：</strong>分10步慢慢滲透目標系統<br>
                            <strong>特點：</strong>每步偷取$5,000-$15,000，隱蔽性高<br>
                            <strong>總收益：</strong>約$80,000-$120,000<br>
                            <strong>成本：</strong>$25,000
                        </p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 18px; border-radius: 10px; border-left: 4px solid #9b59b6;">
                        <strong style="color: #9b59b6; font-size: 1.1rem;">🔐 勒索金攻擊</strong>
                        <p style="color: #aaa; font-size: 0.9rem; margin-top: 12px; line-height: 1.8;">
                            <strong>效果：</strong>加密目標系統並發送勒索要求<br>
                            <strong>金額：</strong>$1,500,000 / $3,500,000 / $10,000,000（隨機）<br>
                            <strong>時限：</strong>5分鐘內不付款則自動殭屍化<br>
                            <strong>成本：</strong>$10,000
                        </p>
                    </div>
                </div>
            </div>

            <!-- 即時監控與權限爭奪 -->
            <div style="background: rgba(0, 255, 255, 0.1); border: 2px solid #00ffff; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #00ffff; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-eye"></i> 即時監控與權限爭奪系統 🆕
                </h2>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #00ff41; margin-bottom: 12px;"><i class="fas fa-binoculars"></i> 防禦者即時預覽（黑客功能）</h4>
                    <p style="color: #ccc; line-height: 1.8; font-size: 0.95rem;">
                        黑客可以即時監控防禦者的瀏覽器操作，查看對方正在訪問的頁面、執行的操作、系統狀態等資訊。
                        這個功能需要防禦者先上線並執行第一項操作後才能啟動。
                    </p>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; margin-top: 12px;">
                        <strong style="color: #ff9900;">⚠️ 延遲通知機制：</strong>
                        <p style="color: #aaa; margin-top: 8px; line-height: 1.7; font-size: 0.9rem;">
                            防禦者不會立即收到監控警告！系統會延遲<strong style="color: #ff3333;">30秒至1分鐘</strong>才通知防禦者「黑客已經看見你的瀏覽器操作」。
                            購買<strong style="color: #00ff41;">隱身工具包</strong>可以將延遲時間延長至<strong style="color: #00ff41;">120秒（2分鐘）</strong>！
                        </p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #ff3333; margin-bottom: 12px;"><i class="fas fa-tachometer-alt"></i> 系統控制權爭奪戰</h4>
                    <p style="color: #ccc; line-height: 1.8; font-size: 0.95rem;">
                        全新的權限爭奪機制！黑客可以逐步奪取防禦者的系統控制權，控制權以百分比顯示（0%-100%）。
                        當黑客控制權達到100%時，防禦者的系統將被完全控制。
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-top: 12px;">
                        <div style="background: rgba(0,255,65,0.1); padding: 12px; border-radius: 6px;">
                            <strong style="color: #00ff41;">基礎速度：</strong> 每秒+2%控制權
                        </div>
                        <div style="background: rgba(255,153,0,0.1); padding: 12px; border-radius: 6px;">
                            <strong style="color: #ff9900;">攻擊加速器：</strong> 速度x1.5
                        </div>
                        <div style="background: rgba(255,51,255,0.1); padding: 12px; border-radius: 6px;">
                            <strong style="color: #ff33ff;">高級套裝：</strong> 速度x3.0
                        </div>
                        <div style="background: rgba(255,0,0,0.1); padding: 12px; border-radius: 6px;">
                            <strong style="color: #ff0000;">終極套裝：</strong> 瞬間100%控制！
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #ff3333; margin-bottom: 12px;"><i class="fas fa-fist-raised"></i> 防禦者反擊機制</h4>
                    <p style="color: #ccc; line-height: 1.8; font-size: 0.95rem;">
                        防禦者不再只能被動挨打！購買<strong style="color: #ff3333;">反擊套裝</strong>後，防禦者可以：
                    </p>
                    <ul style="color: #aaa; line-height: 1.9; margin-top: 12px; font-size: 0.9rem;">
                        <li>反追蹤黑客的真實位置</li>
                        <li>發動反擊攻擊，降低黑客的控制權</li>
                        <li>在權限爭奪中有50%機率每次反擊-5%黑客控制權</li>
                        <li>速度是關鍵！越快反應，越有機會保住系統</li>
                    </ul>
                </div>
            </div>

            <!-- 課金系統說明 -->
            <div style="background: rgba(155, 89, 182, 0.1); border: 2px solid #9b59b6; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #9b59b6; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-coins"></i> 課金系統完整說明
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 18px;">
                    <div style="background: rgba(0,255,65,0.1); padding: 18px; border-radius: 10px; border: 2px solid #00ff41;">
                        <h4 style="color: #00ff41; margin-bottom: 12px;"><i class="fas fa-user-ninja"></i> 黑客課金功能</h4>
                        <ul style="color: #aaa; font-size: 0.9rem; line-height: 1.9; padding-left: 20px;">
                            <li>接收防禦者支付的勒索金</li>
                            <li>升級攻擊強度（+20%/+50%/+100%）</li>
                            <li>升級隱蔽能力（延長警告延遲）</li>
                            <li>購買殭屍網絡擴展</li>
                            <li>轉移偷取的資金到錢包</li>
                            <li>購買VPN套裝提升隱藏能力</li>
                            <li>購買終極套裝獲得瞬間控制</li>
                        </ul>
                    </div>
                    <div style="background: rgba(255,51,51,0.1); padding: 18px; border-radius: 10px; border: 2px solid #ff3333;">
                        <h4 style="color: #ff3333; margin-bottom: 12px;"><i class="fas fa-user-shield"></i> 防禦者課金功能</h4>
                        <ul style="color: #aaa; font-size: 0.9rem; line-height: 1.9; padding-left: 20px;">
                            <li>充值入侵預算反擊黑客</li>
                            <li>執行入侵偷取黑客資金</li>
                            <li>升級入侵成功率（40%→95%）</li>
                            <li>購買收益倍增器</li>
                            <li>購買防火牆提升阻擋率</li>
                            <li>購買反擊套裝啟用攻擊能力</li>
                            <li>購買追蹤偵測器提前警告</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 操作步驟流程 -->
            <div style="background: rgba(255, 255, 255, 0.05); border: 2px solid #666; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #fff; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-list-ol"></i> 完整操作步驟流程
                </h2>
                <div style="display: grid; gap: 15px;">
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">1</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">選擇模式</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">在主頁選擇「黑客」、「防禦者」或「對戰模式」。對戰模式提供更激烈的體驗。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">2</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">設定目標與難度</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">輸入目標IP地址（可使用預設），選擇難度等級（簡單/中等/困難）。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">3</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">購買商品（可選）🆕</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">開始遊戲前或遊戲中，可以在商店購買各種工具和套裝，提升能力。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">4</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">應用商品效果 🆕</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">點擊「應用商品」按鈕，選擇要使用的商品，效果立即生效。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">5</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">連接目標系統</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">點擊「連接」按鈕建立與目標系統的連接，連接成功後才能執行操作。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">6</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">使用工具執行操作</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">選擇工具分類，點擊具體工具執行操作。每個工具都有冷卻時間。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #00ff41, #00cc33); color: #000; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(0,255,65,0.4);">7</div>
                        <div style="flex: 1;">
                            <strong style="color: #00ff41; font-size: 1.05rem;">啟動即時監控（黑客）🆕</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">連接後可啟動防禦者即時預覽，查看對方操作。30-60秒後對方才會收到警告。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #ff3333, #cc0000); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(255,51,51,0.4);">8</div>
                        <div style="flex: 1;">
                            <strong style="color: #ff3333; font-size: 1.05rem;">權限爭奪戰 🆕</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">黑客逐步奪取控制權，防禦者可以反擊。控制權達到100%即獲勝。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(155,89,182,0.4);">9</div>
                        <div style="flex: 1;">
                            <strong style="color: #9b59b6; font-size: 1.05rem;">選擇攻擊模式（黑客）</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">選擇直接執行、循序漸進或勒索金攻擊，每種模式有不同效果和收益。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #ff9900, #cc7700); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(255,153,0,0.4);">10</div>
                        <div style="flex: 1;">
                            <strong style="color: #ff9900; font-size: 1.05rem;">查看結果與獎勵</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">對戰結束後查看勝負結果，獲得虛擬金錢獎勵，可用於購買更多商品。</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 重要提示 -->
            <div style="background: rgba(255, 193, 7, 0.1); border: 2px solid #ffc107; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #ffc107; margin-bottom: 18px; font-size: 1.3rem;">
                    <i class="fas fa-exclamation-triangle"></i> 重要提示與注意事項
                </h2>
                <ul style="color: #ccc; line-height: 2.2; font-size: 0.95rem; padding-left: 25px;">
                    <li><strong style="color: #ff9900;">純教育用途：</strong>此模擬器僅用於學習網絡安全知識，所有操作都在瀏覽器中模擬。</li>
                    <li><strong style="color: #ff9900;">無真實影響：</strong>不會對任何真實系統、網絡或設備造成任何影響。</li>
                    <li><strong style="color: #00ff41;">商品效果：</strong>購買的商品需要手動應用才會生效，已應用的商品在當前遊戲中持續有效。</li>
                    <li><strong style="color: #ff3333;">延遲警告：</strong>防禦者收到監控警告會有30-120秒延遲，購買隱身工具包可延長延遲時間。</li>
                    <li><strong style="color: #9b59b6;">速度競賽：</strong>權限爭奪戰中，反應速度和商品等級決定勝負。</li>
                    <li><strong style="color: #00ffff;">資料儲存：</strong>所有遊戲數據（錢包、商品、進度）都儲存在瀏覽器本地，清除瀏覽器數據會重置。</li>
                    <li><strong style="color: #ffd700;">終極套裝：</strong>終極套裝提供瞬間控制能力，是最強大的商品，但價格也最高。</li>
                </ul>
            </div>

            <!-- 返回按鈕 -->
            <div style="text-align: center; margin-top: 30px;">
                <button id="guide-back-btn" style="padding: 15px 40px; background: linear-gradient(135deg, #4a90d9, #357abd); border: none; border-radius: 10px; color: #fff; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(74,144,217,0.3); transition: all 0.3s;">
                    <i class="fas fa-arrow-left"></i> 返回主頁
                </button>
            </div>
        </div>
    </div>

        <!-- 流程示範圖頁面 -->
    <div id="flowchart-page" class="page hidden">
        <div class="main-header">
            <div class="main-logo" style="color: #9b59b6; text-shadow: 0 0 10px #9b59b6, 0 0 20px #9b59b6;">
                <span>流程示範圖</span>
            </div>
            <div class="main-subtitle">完整攻防流程視覺化 v3.2</div>},{find:
        </div>

        <div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
            <!-- 整體流程圖 -->
            <div style="background: rgba(155, 89, 182, 0.1); border: 2px solid #9b59b6; border-radius: 12px; padding: 30px; margin-bottom: 30px;">
                <h2 style="color: #9b59b6; margin-bottom: 25px; text-align: center; font-size: 1.5rem;">
                    <i class="fas fa-project-diagram"></i> 完整遊戲流程圖
                </h2>
                
                <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                    <!-- 開始 -->
                    <div style="background: linear-gradient(135deg, #00ff41, #00cc33); color: #000; padding: 20px 40px; border-radius: 50px; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px 20px rgba(0,255,65,0.4);">
                        🎮 開始遊戲
                    </div>
                    
                    <div style="font-size: 2rem; color: #666;">↓</div>
                    
                    <!-- 模式選擇 -->
	                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; width: 100%;">
	                        <div style="background: rgba(0,255,65,0.1); border: 2px solid #00ff41; border-radius: 12px; padding: 20px; text-align: center;">
	                            <div style="font-size: 2.5rem; margin-bottom: 10px;">🎭</div>
	                            <strong style="color: #00ff41; font-size: 1.1rem;">黑客模式</strong>
	                            <p style="color: #888; font-size: 0.85rem; margin-top: 8px;">攻擊與滲透</p>
	                        </div>
	                        <div style="background: rgba(255,51,51,0.1); border: 2px solid #ff3333; border-radius: 12px; padding: 20px; text-align: center;">
	                            <div style="font-size: 2.5rem; margin-bottom: 10px;">🛡️</div>
	                            <strong style="color: #ff3333; font-size: 1.1rem;">防禦者模式</strong>
	                            <p style="color: #888; font-size: 0.85rem; margin-top: 8px;">防守與反擊</p>
	                        </div>
	                        <div style="background: rgba(255,153,0,0.1); border: 2px solid #ff9900; border-radius: 12px; padding: 20px; text-align: center;">
	                            <div style="font-size: 2.5rem; margin-bottom: 10px;">⚔️</div>
	                            <strong style="color: #ff9900; font-size: 1.1rem;">對戰模式</strong>
	                            <p style="color: #888; font-size: 0.85rem; margin-top: 8px;">即時PVP對決</p>
	                        </div>
	                        <div style="background: rgba(153,102,255,0.1); border: 2px solid #9966ff; border-radius: 12px; padding: 20px; text-align: center;">
	                            <div style="font-size: 2.5rem; margin-bottom: 10px;">⚡</div>

	                            <p style="color: #888; font-size: 0.85rem; margin-top: 8px;">黑客 vs 執法部門</p>
	                        </div>
	                    </div>
                    
                    <div style="font-size: 2rem; color: #666;">↓</div>
                    
                    <!-- 商店購物 -->
                    <div style="background: rgba(255,215,0,0.1); border: 3px dashed #ffd700; border-radius: 12px; padding: 25px; width: 100%; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">🛒</div>
                        <strong style="color: #ffd700; font-size: 1.2rem;">商店購物（可選）🆕</strong>
                        <p style="color: #aaa; margin-top: 10px; line-height: 1.7;">購買VPN、攻擊套裝、防火牆、反擊工具等商品</p>
                        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
                            <span style="background: rgba(0,255,65,0.2); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem;">VPN套裝</span>
                            <span style="background: rgba(255,51,51,0.2); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem;">攻擊加速器</span>
                            <span style="background: rgba(255,0,255,0.2); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem;">終極套裝</span>
                            <span style="background: rgba(0,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem;">反擊套裝</span>
                        </div>
                    </div>
                    
                    <div style="font-size: 2rem; color: #666;">↓</div>
                    
                    <!-- 應用商品 -->
                    <div style="background: rgba(0,255,255,0.1); border: 3px dashed #00ffff; border-radius: 12px; padding: 25px; width: 100%; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">📦</div>
                        <strong style="color: #00ffff; font-size: 1.2rem;">應用商品效果 🆕</strong>
                        <p style="color: #aaa; margin-top: 10px; line-height: 1.7;">在商品選擇器中選擇要使用的商品，效果立即生效</p>
                        <div style="margin-top: 15px; color: #888; font-size: 0.9rem;">
                            攻擊力↑ | 隱藏率↑ | 控制速度↑ | 防禦力↑ | 反擊力↑
                        </div>
                    </div>
                    
                    <div style="font-size: 2rem; color: #666;">↓</div>
                    
                    <!-- 連接目標 -->
                    <div style="background: rgba(74,144,217,0.1); border: 2px solid #4a90d9; border-radius: 12px; padding: 20px; width: 100%; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">🔌</div>
                        <strong style="color: #4a90d9; font-size: 1.1rem;">連接目標系統</strong>
                        <p style="color: #888; margin-top: 8px;">建立與目標的網絡連接</p>
                    </div>
                    
                    <div style="font-size: 2rem; color: #666;">↓</div>
                    
<!-- 攻防流程 -->
	                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%;">
                        <!-- 黑客專屬流程 -->
                        <div style="background: rgba(0,255,65,0.05); border: 2px solid #00ff41; border-radius: 12px; padding: 25px;">
                            <h3 style="color: #00ff41; text-align: center; margin-bottom: 20px; font-size: 1.2rem;">
                                <i class="fas fa-user-secret"></i> 黑客專屬流程
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #00ff41;">
                                    <strong style="color: #00ff41;">1. 啟動即時監控 🆕</strong>
                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">查看防禦者瀏覽器操作</p>
                                </div>
                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9900;">
                                    <strong style="color: #ff9900;">2. 延遲通知機制 🆕</strong>
                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">30-120秒後對方才收到警告</p>
                                </div>
                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #ff3333;">
                                    <strong style="color: #ff3333;">3. 開始權限爭奪 🆕</strong>
                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">逐步奪取系統控制權</p>
                                </div>
                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #9b59b6;">
                                    <strong style="color: #9b59b6;">4. 選擇攻擊模式</strong>
                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">直接/漸進/勒索</p>
                                </div>
                            </div>
                        </div>
                        
<!-- 防禦者專屬流程 -->
	                        <div style="background: rgba(255,51,51,0.05); border: 2px solid #ff3333; border-radius: 12px; padding: 25px;">
	                            <h3 style="color: #ff3333; text-align: center; margin-bottom: 20px; font-size: 1.2rem;">
	                                <i class="fas fa-shield-alt"></i> 防禦者專屬流程
	                            </h3>
	                            <div style="display: flex; flex-direction: column; gap: 15px;">
	                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #ff3333;">
	                                    <strong style="color: #ff3333;">1. 收到延遲警告 🆕</strong>
	                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">30-120秒後收到監控提示</p>
	                                </div>
	                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #00ffff;">
	                                    <strong style="color: #00ffff;">2. 啟動反擊模式 🆕</strong>
	                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">反追蹤並攻擊黑客</p>
	                                </div>
	                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9900;">
	                                    <strong style="color: #ff9900;">3. 權限防守戰 🆕</strong>
	                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">抵抗黑客控制權奪取</p>
	                                </div>
	                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #4a90d9;">
	                                    <strong style="color: #4a90d9;">4. 尋求第三方支援 🆕</strong>
	                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">尋求專業協助或報案</p>
	                                </div>
	                            </div>
	                        </div>
	                        

	                        <div style="background: rgba(153,102,255,0.05); border: 2px solid #9966ff; border-radius: 12px; padding: 25px;">
	                            <h3 style="color: #9966ff; text-align: center; margin-bottom: 20px; font-size: 1.2rem;">
	                                <i class="fas fa-star"></i> 專屬流程 (續集)
	                            </h3>
	                            <div style="display: flex; flex-direction: column; gap: 15px;">
	                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #9966ff;">
	                                    <strong style="color: #9966ff;">1. 選擇角色</strong>
	                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">黑客或執法部門</p>
	                                </div>
	                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #9966ff;">
	                                    <strong style="color: #9966ff;">2. 攻防對決</strong>
	                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">黑客：攻擊/隱藏；執法部門：起底/反擊</p>
	                                </div>
	                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #9966ff;">
	                                    <strong style="color: #9966ff;">3. 策略行動</strong>
	                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">黑客：發起談判；執法部門：聯合部門</p>
	                                </div>
	                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #9966ff;">
	                                    <strong style="color: #9966ff;">4. 購買專屬商品</strong>
	                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">使用專屬工具強化攻防能力</p>
	                                </div>
	                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #9966ff;">
	                                    <strong style="color: #9966ff;">5. 判定勝負</strong>
	                                    <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">黑客逃脫或執法部門拘捕</p>
	                                </div>
	                            </div>
	                        </div>
                    </div>
                    
                    <div style="font-size: 2rem; color: #666;">↓</div>
                    
                    <!-- 權限爭奪戰 -->
                    <div style="background: linear-gradient(135deg, rgba(255,0,0,0.2), rgba(0,255,0,0.2)); border: 3px solid #ff9900; border-radius: 12px; padding: 30px; width: 100%;">
                        <h3 style="color: #ff9900; text-align: center; margin-bottom: 20px; font-size: 1.3rem;">
                            <i class="fas fa-tachometer-alt"></i> 系統控制權爭奪戰 🆕
                        </h3>
                        <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="color: #00ff41; font-weight: bold;">黑客控制權</span>
                                <span style="color: #fff; font-size: 1.5rem; font-weight: bold;">0% → 100%</span>
                                <span style="color: #ff3333; font-weight: bold;">防禦者控制權</span>
                            </div>
                            <div style="height: 30px; background: rgba(0,0,0,0.5); border-radius: 15px; overflow: hidden; position: relative;">
                                <div style="position: absolute; left: 0; top: 0; height: 100%; width: 50%; background: linear-gradient(90deg, #00ff41, #00cc33);"></div>
                                <div style="position: absolute; right: 0; top: 0; height: 100%; width: 50%; background: linear-gradient(90deg, #cc0000, #ff3333);"></div>
                            </div>
                            <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; font-size: 0.85rem;">
                                <div>
                                    <div style="color: #888;">基礎速度</div>
                                    <div style="color: #00ff41;">+2%/秒</div>
                                </div>
                                <div>
                                    <div style="color: #888;">加速器</div>
                                    <div style="color: #ff9900;">×1.5</div>
                                </div>
                                <div>
                                    <div style="color: #888;">高級套裝</div>
                                    <div style="color: #ff33ff;">×3.0</div>
                                </div>
                                <div>
                                    <div style="color: #888;">終極套裝</div>
                                    <div style="color: #ff0000;">瞬間100%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="font-size: 2rem; color: #666;">↓</div>
                    
                    <!-- 結果 -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; width: 100%;">
                        <div style="background: linear-gradient(135deg, rgba(0,255,65,0.2), rgba(0,200,50,0.2)); border: 2px solid #00ff41; border-radius: 12px; padding: 25px; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">🏆</div>
                            <strong style="color: #00ff41; font-size: 1.3rem;">黑客勝利</strong>
                            <p style="color: #888; margin-top: 10px;">完全控制對方系統</p>
                            <p style="color: #00ff41; margin-top: 5px;">獲得 $50,000 獎勵</p>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(255,51,51,0.2), rgba(200,0,0,0.2)); border: 2px solid #ff3333; border-radius: 12px; padding: 25px; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">🛡️</div>
                            <strong style="color: #ff3333; font-size: 1.3rem;">防禦者勝利</strong>
                            <p style="color: #888; margin-top: 10px;">成功保住系統</p>
                            <p style="color: #ff3333; margin-top: 5px;">獲得防禦獎勵</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 時間軸流程 -->
            <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid #444; border-radius: 12px; padding: 30px; margin-bottom: 30px;">
                <h2 style="color: #fff; margin-bottom: 25px; text-align: center; font-size: 1.4rem;">
                    <i class="fas fa-clock"></i> 典型對戰時間軸（5分鐘）
                </h2>
                
                <div style="position: relative; padding-left: 40px;">
                    <!-- 時間軸線 -->
                    <div style="position: absolute; left: 20px; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, #00ff41, #ff3333);"></div>
                    
                    <!-- 時間點 -->
                    <div style="display: flex; flex-direction: column; gap: 25px;">
                        <div style="position: relative;">
                            <div style="position: absolute; left: -28px; top: 5px; width: 16px; height: 16px; background: #00ff41; border-radius: 50%; border: 3px solid #000;"></div>
                            <div style="background: rgba(0,255,65,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00ff41;">
                                <strong style="color: #00ff41;">0:00 - 遊戲開始</strong>
                                <p style="color: #888; margin-top: 5px; font-size: 0.9rem;">雙方連接系統，黑客購買並應用商品</p>
                            </div>
                        </div>
                        
                        <div style="position: relative;">
                            <div style="position: absolute; left: -28px; top: 5px; width: 16px; height: 16px; background: #4a90d9; border-radius: 50%; border: 3px solid #000;"></div>
                            <div style="background: rgba(74,144,217,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #4a90d9;">
                                <strong style="color: #4a90d9;">0:05 - 黑客啟動監控 🆕</strong>
                                <p style="color: #888; margin-top: 5px; font-size: 0.9rem;">黑客開始即時監控防禦者瀏覽器操作</p>
                            </div>
                        </div>
                        
                        <div style="position: relative;">
                            <div style="position: absolute; left: -28px; top: 5px; width: 16px; height: 16px; background: #ff9900; border-radius: 50%; border: 3px solid #000;"></div>
                            <div style="background: rgba(255,153,0,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9900;">
                                <strong style="color: #ff9900;">0:35 - 防禦者收到警告 🆕</strong>
                                <p style="color: #888; margin-top: 5px; font-size: 0.9rem;">延遲30秒後，防禦者收到「黑客已經看見你的瀏覽器操作」的提示</p>
                            </div>
                        </div>
                        
                        <div style="position: relative;">
                            <div style="position: absolute; left: -28px; top: 5px; width: 16px; height: 16px; background: #ff3333; border-radius: 50%; border: 3px solid #000;"></div>
                            <div style="background: rgba(255,51,51,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ff3333;">
                                <strong style="color: #ff3333;">0:40 - 權限爭奪開始 🆕</strong>
                                <p style="color: #888; margin-top: 5px; font-size: 0.9rem;">黑客開始奪取控制權，防禦者啟動反擊</p>
                            </div>
                        </div>
                        
                        <div style="position: relative;">
                            <div style="position: absolute; left: -28px; top: 5px; width: 16px; height: 16px; background: #9b59b6; border-radius: 50%; border: 3px solid #000;"></div>
                            <div style="background: rgba(155,89,182,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #9b59b6;">
                                <strong style="color: #9b59b6;">1:00 - 攻擊模式執行</strong>
                                <p style="color: #888; margin-top: 5px; font-size: 0.9rem;">黑客選擇並執行攻擊模式（直接/漸進/勒索）</p>
                            </div>
                        </div>
                        
                        <div style="position: relative;">
                            <div style="position: absolute; left: -28px; top: 5px; width: 16px; height: 16px; background: #00ffff; border-radius: 50%; border: 3px solid #000;"></div>
                            <div style="background: rgba(0,255,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00ffff;">
                                <strong style="color: #00ffff;">2:00 - 激烈攻防</strong>
                                <p style="color: #888; margin-top: 5px; font-size: 0.9rem;">雙方使用各種工具進行攻擊與防禦</p>
                            </div>
                        </div>
                        
                        <div style="position: relative;">
                            <div style="position: absolute; left: -28px; top: 5px; width: 16px; height: 16px; background: #ffd700; border-radius: 50%; border: 3px solid #000;"></div>
                            <div style="background: rgba(255,215,0,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ffd700;">
                                <strong style="color: #ffd700;">5:00 - 對戰結束</strong>
                                <p style="color: #888; margin-top: 5px; font-size: 0.9rem;">時間到或控制權達100%，判定勝負並發放獎勵</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 商品效果對比 -->
            <div style="background: rgba(255, 215, 0, 0.1); border: 2px solid #ffd700; border-radius: 12px; padding: 30px; margin-bottom: 30px;">
                <h2 style="color: #ffd700; margin-bottom: 25px; text-align: center; font-size: 1.4rem;">
                    <i class="fas fa-chart-bar"></i> 商品效果對比表 🆕
                </h2>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; color: #fff;">
                        <thead>
                            <tr style="background: rgba(0,0,0,0.5);">
                                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ffd700;">商品名稱</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #ffd700;">價格</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #ffd700;">攻擊力加成</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #ffd700;">控制速度</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #ffd700;">特殊效果</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: rgba(0,255,65,0.05);">
                                <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);"><strong style="color: #00ff41;">VPN 基礎版</strong></td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">$5,000</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">-</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">-</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">隱藏30%</td>
                            </tr>
                            <tr style="background: rgba(0,255,65,0.05);">
                                <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);"><strong style="color: #00ff41;">攻擊加速器</strong></td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">$15,000</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">+20%</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">×1.5</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">-</td>
                            </tr>
                            <tr style="background: rgba(255,153,0,0.05);">
                                <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);"><strong style="color: #ff9900;">高級攻擊套裝</strong></td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">$50,000</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">+50%</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">×3.0</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">-</td>
                            </tr>
                            <tr style="background: rgba(255,0,0,0.1);">
                                <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);"><strong style="color: #ff0000;">終極套裝</strong></td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">$200,000</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">+100%</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">×10</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);"><strong style="color: #ff0000;">瞬間控制</strong></td>
                            </tr>
                            <tr style="background: rgba(0,255,255,0.05);">
                                <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);"><strong style="color: #00ffff;">隱身工具包</strong></td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">$30,000</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">-</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">-</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">隱身+40%, 延遲120秒</td>
                            </tr>
                            <tr style="background: rgba(255,51,51,0.05);">
                                <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);"><strong style="color: #ff3333;">反擊套裝</strong></td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">$40,000</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">-</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">-</td>
                                <td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">反擊力50%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 返回按鈕 -->
            <div style="text-align: center; margin-top: 30px;">
                <button id="flowchart-back-btn" style="padding: 15px 40px; background: linear-gradient(135deg, #9b59b6, #8e44ad); border: none; border-radius: 10px; color: #fff; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(155,89,182,0.3); transition: all 0.3s;">
                    <i class="fas fa-arrow-left"></i> 返回主頁
                </button>
            </div>
        </div>
    </div>

    <!-- 遊戲頁面容器 -->
    <div id="game-page" class="page hidden"></div>

    <!-- 對戰模式選擇頁面 -->
    <div id="battle-select-page" class="page hidden">
        <div class="main-header">
            <div class="main-logo" style="color: #ff9900; text-shadow: 0 0 10px #ff9900, 0 0 20px #ff9900;">
                <span>對戰模式</span>
            </div>
            <div class="main-subtitle">選擇你的陣營</div>
            <div class="main-tagline">
                在對戰模式中，你將與AI對手進行實時攻防對決。
                選擇扮演黑客發動攻擊，或選擇扮演防禦者保護系統。
            </div>
        </div>

        <!-- 對戰設置 -->
        <div class="game-settings" style="border-color: rgba(255, 153, 0, 0.3);">
            <div class="settings-title" style="color: #ff9900;">
                <i class="fas fa-cog"></i>
                <span>對戰設置</span>
            </div>

            <div class="setting-group">
                <label class="setting-label">你的虛擬IP地址：</label>
                <input type="text" id="battle-player-ip" class="setting-input" value="192.168.1.100" readonly="" style="border-color: rgba(255, 153, 0, 0.5);">
                <small style="color: #666; display: block; margin-top: 5px;">
                    這是你的唯一識別ID
                </small>
            </div>

            <div class="setting-group">
                <label class="setting-label">目標IP地址（AI對手）：</label>
                <input type="text" id="battle-target-ip" class="setting-input" placeholder="輸入目標IP地址（例：192.168.1.200）" style="border-color: rgba(255, 153, 0, 0.5);">
                <small style="color: #666; display: block; margin-top: 5px;">
                    輸入對手的虛擬IP地址開始對戰
                </small>
            </div>

            <div class="setting-group">
                <label class="setting-label">AI難度：</label>
                <select id="battle-difficulty" class="setting-input" style="border-color: rgba(255, 153, 0, 0.5);">
                    <option value="random" selected="">🎲 隨機難度 (推薦)</option>
                    <option value="easy">簡單 - AI反應較慢 (7分鐘)</option>
                    <option value="medium">中等 - 標準AI對手 (5分鐘)</option>
                    <option value="hard">困難 - AI反應迅速 (3分鐘)</option>
                </select>
                <small style="color: #ff9900; display: block; margin-top: 5px;">
                    <i class="fas fa-info-circle"></i> 隨機難度: 60%簡單、30%中等、10%困難
                </small>
            </div>
        </div>

        <!-- 陣營選擇 -->
        <div class="mode-selection" style="margin-top: 30px;">
            <!-- 選擇黑客 -->
            <div class="mode-card hacker" id="battle-hacker-card">
                <div class="mode-icon">
                    <i class="fas fa-user-secret"></i>
                </div>
                <div class="mode-title">扮演黑客</div>
                <div class="mode-description">
                    作為攻擊方，使用各種攻擊工具嘗試入侵防禦者的系統。
                    突破防火牆，獲取系統權限，在被發現前完成目標。
                </div>
                <button class="select-btn hacker-btn" id="battle-start-hacker">
                    <i class="fas fa-skull-crossbones"></i>
                    <span>以黑客身份對戰</span>
                </button>
            </div>

            <!-- 選擇防禦者 -->
            <div class="mode-card defender" id="battle-defender-card">
                <div class="mode-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="mode-title">扮演防禦者</div>
                <div class="mode-description">
                    作為防守方，監控網絡流量，配置防火牆規則，
                    檢測並阻擋黑客的攻擊，保護系統安全。
                </div>
                <button class="select-btn defender-btn" id="battle-start-defender">
                    <i class="fas fa-shield-alt"></i>
                    <span>以防禦者身份對戰</span>
                </button>
            </div>
        </div>

        <!-- 返回按鈕 -->
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" id="battle-back-btn" style="background: rgba(255, 255, 255, 0.1); border: 1px solid #666; padding: 12px 30px;">
                <i class="fas fa-arrow-left"></i>
                <span>返回主選單</span>
            </button>
        </div>
    </div>

        <!-- 操作說明指南頁面 -->
    <div id="guide-page" class="page hidden">
        <div class="main-header">
            <div class="main-logo" style="color: #4a90d9; text-shadow: 0 0 10px #4a90d9, 0 0 20px #4a90d9;">
                <span>操作說明指南</span>
            </div>
            <div class="main-subtitle">模擬器使用手冊 v3.0 - 全新增強版</div>
        </div>

        <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
            <!-- 版本更新亮點 -->
            <div style="background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,140,0,0.2)); border: 2px solid #ffd700; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 0 20px rgba(255,215,0,0.3);">
                <h2 style="color: #ffd700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-star"></i> 🎉 v3.0 重大更新亮點
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #00ff41;">
                        <strong style="color: #00ff41; font-size: 1.1rem;"><i class="fas fa-shopping-cart"></i> 商店系統與商品應用</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">購買的商品現在可以實際應用到遊戲中！包括VPN、攻擊加速器、終極套裝等，每個商品都有獨特效果，可在商品選擇器中一鍵應用。</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #ff3333;">
                        <strong style="color: #ff3333; font-size: 1.1rem;"><i class="fas fa-eye"></i> 防禦者即時預覽</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">黑客可以即時監控防禦者的瀏覽器操作！查看對方正在做什麼、訪問哪些頁面，掌握先機。需要防禦者先上線才能開始監控。</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9900;">
                        <strong style="color: #ff9900; font-size: 1.1rem;"><i class="fas fa-clock"></i> 延遲提示系統</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">防禦者不會立即收到黑客監控的警告！系統會延遲30秒至1分鐘才通知，給黑客更多操作時間。購買隱身工具包可延長至2分鐘。</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #9b59b6;">
                        <strong style="color: #9b59b6; font-size: 1.1rem;"><i class="fas fa-bolt"></i> 權限爭奪機制</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">全新的系統控制權爭奪戰！黑客可以逐步奪取防禦者的系統權限。購買終極套裝可瞬間完全控制對方系統！</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #00ffff;">
                        <strong style="color: #00ffff; font-size: 1.1rem;"><i class="fas fa-shield-alt"></i> 防禦者反擊能力</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">防禦者不再只能被動防守！購買反擊套裝後可以反追蹤並攻擊黑客，在權限爭奪中有機會奪回控制權。速度是關鍵！</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border-left: 4px solid #ff1493;">
                        <strong style="color: #ff1493; font-size: 1.1rem;"><i class="fas fa-gem"></i> 高級套裝系統</strong>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 10px; line-height: 1.7;">課金越高，能力越強！終極套裝提供瞬間控制能力，可在極短時間內完全掌控對方系統。攻擊力+100%，控制速度x10！</p>
                    </div>
                </div>
            </div>

            <!-- 介紹 -->
            <div style="background: rgba(74, 144, 217, 0.1); border: 2px solid #4a90d9; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #4a90d9; margin-bottom: 18px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle"></i> 關於此模擬器
                </h2>
                <p style="color: #ccc; line-height: 1.9; font-size: 1rem;">
                    「模擬黑客入侵平台」是一個功能完整的<strong style="color: #00ff41;">網絡安全教育模擬器</strong>，讓您在完全安全的環境中體驗真實的網絡攻防場景。
                    平台支援<strong style="color: #ff9900;">即時對戰</strong>、<strong style="color: #9b59b6;">完整課金系統</strong>、<strong style="color: #e74c3c;">多種攻擊模式</strong>以及<strong style="color: #00ffff;">商品應用機制</strong>。
                    <br><br>
                    <strong style="color: #ff9900;">⚠️ 重要提示：</strong>所有操作都在瀏覽器中模擬進行，不會對任何真實系統造成影響。本平台純粹用於教育和學習目的。
                    <br><br>
                    <strong style="color: #00ff41;">✨ 新功能：</strong>商品購買後可實際應用、即時監控對手、延遲警告系統、權限爭奪戰、防禦者反擊等豐富互動功能！
                </p>
            </div>

            <!-- 核心功能分類 -->
            <div style="margin-bottom: 25px;">
                <h2 style="color: #fff; margin-bottom: 20px; font-size: 1.4rem;">
                    <i class="fas fa-th-large"></i> 核心功能模組
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 18px;">
                    <!-- 黑客模式 -->
                    <div style="background: rgba(0, 255, 65, 0.1); border: 2px solid #00ff41; border-radius: 12px; padding: 22px;">
                        <h3 style="color: #00ff41; margin-bottom: 15px; font-size: 1.2rem;">
                            <i class="fas fa-user-secret"></i> 黑客模式功能
                        </h3>
                        <ul style="color: #aaa; line-height: 2; list-style: none; padding: 0; font-size: 0.95rem;">
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>端口掃描</strong> - 探測目標開放服務與漏洞</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>漏洞利用</strong> - 使用已知漏洞進行攻擊</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>密碼破解</strong> - 暴力破解系統密碼</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>三種攻擊模式</strong> - 直接/漸進/勒索</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>即時監控</strong> - 查看防禦者操作 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>權限奪取</strong> - 逐步控制對方系統 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>商品應用</strong> - 使用購買的工具 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #00ff41; margin-right: 10px;"></i><strong>課金升級</strong> - 提升攻擊能力與速度</li>
                        </ul>
                    </div>

                    <!-- 防禦者模式 -->
                    <div style="background: rgba(255, 51, 51, 0.1); border: 2px solid #ff3333; border-radius: 12px; padding: 22px;">
                        <h3 style="color: #ff3333; margin-bottom: 15px; font-size: 1.2rem;">
                            <i class="fas fa-shield-alt"></i> 防禦者模式功能
                        </h3>
                        <ul style="color: #aaa; line-height: 2; list-style: none; padding: 0; font-size: 0.95rem;">
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>入侵檢測</strong> - 即時監控異常活動</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>防火牆配置</strong> - 封鎖惡意流量與IP</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>延遲警告</strong> - 30秒後收到監控提示 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>反擊能力</strong> - 反追蹤並攻擊黑客 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>權限防守</strong> - 抵抗黑客控制 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>反擊課金</strong> - 入侵黑客戶口竊取資金</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>漏洞修補</strong> - 修復系統安全弱點</li>
                            <li><i class="fas fa-check-circle" style="color: #ff3333; margin-right: 10px;"></i><strong>警報系統</strong> - 收到攻擊即時提示</li>
                        </ul>
                    </div>
<!-- 對戰模式 -->
                    <div style="background: rgba(255, 153, 0, 0.1); border: 2px solid #ff9900; border-radius: 12px; padding: 22px;">
                        <h3 style="color: #ff9900; margin-bottom: 15px; font-size: 1.2rem;">
                            <i class="fas fa-gamepad"></i> 對戰模式功能
                        </h3>
                        <ul style="color: #aaa; line-height: 2; list-style: none; padding: 0; font-size: 0.95rem;">
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>限時對戰</strong> - 5分鐘激烈攻防對決</li>
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>智能AI對手</strong> - 根據難度即時反應</li>
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>進度追蹤</strong> - 實時顯示雙方進度條</li>
                        </ul>
                    </div>
                    

                    <div style="background: rgba(153, 102, 255, 0.1); border: 2px solid #9966ff; border-radius: 12px; padding: 22px;">
                        <h3 style="color: #9966ff; margin-bottom: 15px; font-size: 1.2rem;">
                            <i class="fas fa-star"></i> 其他功能 (續集)
                        </h3>
                        <ul style="color: #aaa; line-height: 2; list-style: none; padding: 0; font-size: 0.95rem;">
                            <li><i class="fas fa-check-circle" style="color: #9966ff; margin-right: 10px;"></i><strong>黑客 vs 執法部門</strong> - 高強度身份攻防</li>
                            <li><i class="fas fa-check-circle" style="color: #9966ff; margin-right: 10px;"></i><strong>談判系統</strong> - 影響戰局的策略選擇</li>
                            <li><i class="fas fa-check-circle" style="color: #9966ff; margin-right: 10px;"></i><strong>多部門聯合</strong> - 執法部門可選擇聯合調查</li>
                            <li><i class="fas fa-check-circle" style="color: #9966ff; margin-right: 10px;"></i><strong>專屬商品</strong> - 購買獨有的攻防工具</li>
                        </ul>
                    </div>class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>權限爭奪</strong> - 即時控制權百分比 🆕</li>
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>勝利獎勵</strong> - 獲得大量虛擬金錢</li>
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>雙方互動</strong> - 指令互相影響與干擾</li>
                            <li><i class="fas fa-check-circle" style="color: #ff9900; margin-right: 10px;"></i><strong>商品效果</strong> - 應用的商品影響戰局 🆕</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 商店與商品系統 -->
            <div style="background: rgba(255, 215, 0, 0.1); border: 2px solid #ffd700; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #ffd700; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-store"></i> 商店與商品應用系統 🆕
                </h2>
                <p style="color: #ccc; line-height: 1.8; margin-bottom: 20px; font-size: 0.95rem;">
                    全新的商店系統讓您購買各種工具和套裝，<strong style="color: #00ff41;">購買後可以在遊戲中實際應用</strong>，每個商品都有獨特的效果和能力加成！
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <!-- 黑客商品 -->
                    <div style="background: rgba(0,255,65,0.1); padding: 18px; border-radius: 10px; border: 2px solid #00ff41;">
                        <h4 style="color: #00ff41; margin-bottom: 12px;"><i class="fas fa-skull-crossbones"></i> 黑客專屬商品</h4>
                        <ul style="color: #aaa; font-size: 0.9rem; line-height: 1.9; padding-left: 20px;">
                            <li><strong>VPN套裝</strong> - 基礎/高級/精英三個等級，隱藏機率30%/60%/90%</li>
                            <li><strong>攻擊加速器</strong> - 攻擊力+20%，控制速度x1.5</li>
                            <li><strong>高級攻擊套裝</strong> - 攻擊力+50%，控制速度x3.0</li>
                            <li><strong>終極套裝</strong> - 攻擊力+100%，瞬間控制能力！</li>
                            <li><strong>隱身工具包</strong> - 隱身+40%，警告延遲120秒</li>
                        </ul>
                    </div>
                    
                    <!-- 防禦者商品 -->
                    <div style="background: rgba(255,51,51,0.1); padding: 18px; border-radius: 10px; border: 2px solid #ff3333;">
                        <h4 style="color: #ff3333; margin-bottom: 12px;"><i class="fas fa-shield-alt"></i> 防禦者專屬商品</h4>
                        <ul style="color: #aaa; font-size: 0.9rem; line-height: 1.9; padding-left: 20px;">
                            <li><strong>基礎防火牆</strong> - 阻擋機率30%，基本防護</li>
                            <li><strong>高級防火牆</strong> - 阻擋機率60%，強化防護</li>
                            <li><strong>反擊套裝</strong> - 啟用反追蹤與攻擊能力，反擊力50%</li>
                            <li><strong>追蹤偵測器</strong> - 提前30秒警告黑客監控</li>
                        </ul>
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.4); padding: 18px; border-radius: 8px; border-left: 4px solid #ffd700;">
                    <strong style="color: #ffd700; font-size: 1.05rem;"><i class="fas fa-lightbulb"></i> 如何應用商品？</strong>
                    <p style="color: #ccc; margin-top: 10px; line-height: 1.8; font-size: 0.9rem;">
                        1. 在商店購買商品後，商品會自動加入您的庫存<br>
                        2. 點擊遊戲介面中的「應用商品」按鈕<br>
                        3. 在商品選擇器中選擇要使用的商品<br>
                        4. 商品效果立即生效，終端會顯示應用成功訊息<br>
                        5. 已應用的商品會在當前遊戲中持續有效
                    </p>
                </div>
            </div>

            <!-- 攻擊模式詳解 -->
            <div style="background: rgba(231, 76, 60, 0.1); border: 2px solid #e74c3c; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #e74c3c; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-bolt"></i> 黑客攻擊模式詳解
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <div style="background: rgba(0,0,0,0.4); padding: 18px; border-radius: 10px; border-left: 4px solid #ff3333;">
                        <strong style="color: #ff3333; font-size: 1.1rem;">💀 直接執行攻擊</strong>
                        <p style="color: #aaa; font-size: 0.9rem; margin-top: 12px; line-height: 1.8;">
                            <strong>效果：</strong>立即封殺對方防禦者系統，使所有設備殭屍化<br>
                            <strong>特點：</strong>攻擊速度最快，但風險較高<br>
                            <strong>結果：</strong>防禦者無法作出任何反擊或設定<br>
                            <strong>成本：</strong>$50,000
                        </p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 18px; border-radius: 10px; border-left: 4px solid #ff9900;">
                        <strong style="color: #ff9900; font-size: 1.1rem;">🕷️ 循序漸進攻擊</strong>
                        <p style="color: #aaa; font-size: 0.9rem; margin-top: 12px; line-height: 1.8;">
                            <strong>效果：</strong>分10步慢慢滲透目標系統<br>
                            <strong>特點：</strong>每步偷取$5,000-$15,000，隱蔽性高<br>
                            <strong>總收益：</strong>約$80,000-$120,000<br>
                            <strong>成本：</strong>$25,000
                        </p>
                    </div>
                    <div style="background: rgba(0,0,0,0.4); padding: 18px; border-radius: 10px; border-left: 4px solid #9b59b6;">
                        <strong style="color: #9b59b6; font-size: 1.1rem;">🔐 勒索金攻擊</strong>
                        <p style="color: #aaa; font-size: 0.9rem; margin-top: 12px; line-height: 1.8;">
                            <strong>效果：</strong>加密目標系統並發送勒索要求<br>
                            <strong>金額：</strong>$1,500,000 / $3,500,000 / $10,000,000（隨機）<br>
                            <strong>時限：</strong>5分鐘內不付款則自動殭屍化<br>
                            <strong>成本：</strong>$10,000
                        </p>
                    </div>
                </div>
            </div>

            <!-- 即時監控與權限爭奪 -->
            <div style="background: rgba(0, 255, 255, 0.1); border: 2px solid #00ffff; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #00ffff; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-eye"></i> 即時監控與權限爭奪系統 🆕
                </h2>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #00ff41; margin-bottom: 12px;"><i class="fas fa-binoculars"></i> 防禦者即時預覽（黑客功能）</h4>
                    <p style="color: #ccc; line-height: 1.8; font-size: 0.95rem;">
                        黑客可以即時監控防禦者的瀏覽器操作，查看對方正在訪問的頁面、執行的操作、系統狀態等資訊。
                        這個功能需要防禦者先上線並執行第一項操作後才能啟動。
                    </p>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; margin-top: 12px;">
                        <strong style="color: #ff9900;">⚠️ 延遲通知機制：</strong>
                        <p style="color: #aaa; margin-top: 8px; line-height: 1.7; font-size: 0.9rem;">
                            防禦者不會立即收到監控警告！系統會延遲<strong style="color: #ff3333;">30秒至1分鐘</strong>才通知防禦者「黑客已經看見你的瀏覽器操作」。
                            購買<strong style="color: #00ff41;">隱身工具包</strong>可以將延遲時間延長至<strong style="color: #00ff41;">120秒（2分鐘）</strong>！
                        </p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #ff3333; margin-bottom: 12px;"><i class="fas fa-tachometer-alt"></i> 系統控制權爭奪戰</h4>
                    <p style="color: #ccc; line-height: 1.8; font-size: 0.95rem;">
                        全新的權限爭奪機制！黑客可以逐步奪取防禦者的系統控制權，控制權以百分比顯示（0%-100%）。
                        當黑客控制權達到100%時，防禦者的系統將被完全控制。
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-top: 12px;">
                        <div style="background: rgba(0,255,65,0.1); padding: 12px; border-radius: 6px;">
                            <strong style="color: #00ff41;">基礎速度：</strong> 每秒+2%控制權
                        </div>
                        <div style="background: rgba(255,153,0,0.1); padding: 12px; border-radius: 6px;">
                            <strong style="color: #ff9900;">攻擊加速器：</strong> 速度x1.5
                        </div>
                        <div style="background: rgba(255,51,255,0.1); padding: 12px; border-radius: 6px;">
                            <strong style="color: #ff33ff;">高級套裝：</strong> 速度x3.0
                        </div>
                        <div style="background: rgba(255,0,0,0.1); padding: 12px; border-radius: 6px;">
                            <strong style="color: #ff0000;">終極套裝：</strong> 瞬間100%控制！
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #ff3333; margin-bottom: 12px;"><i class="fas fa-fist-raised"></i> 防禦者反擊機制</h4>
                    <p style="color: #ccc; line-height: 1.8; font-size: 0.95rem;">
                        防禦者不再只能被動挨打！購買<strong style="color: #ff3333;">反擊套裝</strong>後，防禦者可以：
                    </p>
                    <ul style="color: #aaa; line-height: 1.9; margin-top: 12px; font-size: 0.9rem;">
                        <li>反追蹤黑客的真實位置</li>
                        <li>發動反擊攻擊，降低黑客的控制權</li>
                        <li>在權限爭奪中有50%機率每次反擊-5%黑客控制權</li>
                        <li>速度是關鍵！越快反應，越有機會保住系統</li>
                    </ul>
                </div>
            </div>

            <!-- 課金系統說明 -->
            <div style="background: rgba(155, 89, 182, 0.1); border: 2px solid #9b59b6; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #9b59b6; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-coins"></i> 課金系統完整說明
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 18px;">
                    <div style="background: rgba(0,255,65,0.1); padding: 18px; border-radius: 10px; border: 2px solid #00ff41;">
                        <h4 style="color: #00ff41; margin-bottom: 12px;"><i class="fas fa-user-ninja"></i> 黑客課金功能</h4>
                        <ul style="color: #aaa; font-size: 0.9rem; line-height: 1.9; padding-left: 20px;">
                            <li>接收防禦者支付的勒索金</li>
                            <li>升級攻擊強度（+20%/+50%/+100%）</li>
                            <li>升級隱蔽能力（延長警告延遲）</li>
                            <li>購買殭屍網絡擴展</li>
                            <li>轉移偷取的資金到錢包</li>
                            <li>購買VPN套裝提升隱藏能力</li>
                            <li>購買終極套裝獲得瞬間控制</li>
                        </ul>
                    </div>
                    <div style="background: rgba(255,51,51,0.1); padding: 18px; border-radius: 10px; border: 2px solid #ff3333;">
                        <h4 style="color: #ff3333; margin-bottom: 12px;"><i class="fas fa-user-shield"></i> 防禦者課金功能</h4>
                        <ul style="color: #aaa; font-size: 0.9rem; line-height: 1.9; padding-left: 20px;">
                            <li>充值入侵預算反擊黑客</li>
                            <li>執行入侵偷取黑客資金</li>
                            <li>升級入侵成功率（40%→95%）</li>
                            <li>購買收益倍增器</li>
                            <li>購買防火牆提升阻擋率</li>
                            <li>購買反擊套裝啟用攻擊能力</li>
                            <li>購買追蹤偵測器提前警告</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 操作步驟流程 -->
            <div style="background: rgba(255, 255, 255, 0.05); border: 2px solid #666; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #fff; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-list-ol"></i> 完整操作步驟流程
                </h2>
                <div style="display: grid; gap: 15px;">
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">1</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">選擇模式</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">在主頁選擇「黑客」、「防禦者」或「對戰模式」。對戰模式提供更激烈的體驗。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">2</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">設定目標與難度</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">輸入目標IP地址（可使用預設），選擇難度等級（簡單/中等/困難）。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">3</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">購買商品（可選）🆕</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">開始遊戲前或遊戲中，可以在商店購買各種工具和套裝，提升能力。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">4</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">應用商品效果 🆕</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">點擊「應用商品」按鈕，選擇要使用的商品，效果立即生效。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">5</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">連接目標系統</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">點擊「連接」按鈕建立與目標系統的連接，連接成功後才能執行操作。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #4a90d9, #357abd); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(74,144,217,0.4);">6</div>
                        <div style="flex: 1;">
                            <strong style="color: #fff; font-size: 1.05rem;">使用工具執行操作</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">選擇工具分類，點擊具體工具執行操作。每個工具都有冷卻時間。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #00ff41, #00cc33); color: #000; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(0,255,65,0.4);">7</div>
                        <div style="flex: 1;">
                            <strong style="color: #00ff41; font-size: 1.05rem;">啟動即時監控（黑客）🆕</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">連接後可啟動防禦者即時預覽，查看對方操作。30-60秒後對方才會收到警告。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #ff3333, #cc0000); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(255,51,51,0.4);">8</div>
                        <div style="flex: 1;">
                            <strong style="color: #ff3333; font-size: 1.05rem;">權限爭奪戰 🆕</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">黑客逐步奪取控制權，防禦者可以反擊。控制權達到100%即獲勝。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(155,89,182,0.4);">9</div>
                        <div style="flex: 1;">
                            <strong style="color: #9b59b6; font-size: 1.05rem;">選擇攻擊模式（黑客）</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">選擇直接執行、循序漸進或勒索金攻擊，每種模式有不同效果和收益。</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="background: linear-gradient(135deg, #ff9900, #cc7700); color: #fff; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(255,153,0,0.4);">10</div>
                        <div style="flex: 1;">
                            <strong style="color: #ff9900; font-size: 1.05rem;">查看結果與獎勵</strong>
                            <p style="color: #aaa; margin-top: 5px; line-height: 1.7; font-size: 0.9rem;">對戰結束後查看勝負結果，獲得虛擬金錢獎勵，可用於購買更多商品。</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 重要提示 -->
            <div style="background: rgba(255, 193, 7, 0.1); border: 2px solid #ffc107; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: #ffc107; margin-bottom: 18px; font-size: 1.3rem;">
                    <i class="fas fa-exclamation-triangle"></i> 重要提示與注意事項
                </h2>
                <ul style="color: #ccc; line-height: 2.2; font-size: 0.95rem; padding-left: 25px;">
                    <li><strong style="color: #ff9900;">純教育用途：</strong>此模擬器僅用於學習網絡安全知識，所有操作都在瀏覽器中模擬。</li>
                    <li><strong style="color: #ff9900;">無真實影響：</strong>不會對任何真實系統、網絡或設備造成任何影響。</li>
                    <li><strong style="color: #00ff41;">商品效果：</strong>購買的商品需要手動應用才會生效，已應用的商品在當前遊戲中持續有效。</li>
                    <li><strong style="color: #ff3333;">延遲警告：</strong>防禦者收到監控警告會有30-120秒延遲，購買隱身工具包可延長延遲時間。</li>
                    <li><strong style="color: #9b59b6;">速度競賽：</strong>權限爭奪戰中，反應速度和商品等級決定勝負。</li>
                    <li><strong style="color: #00ffff;">資料儲存：</strong>所有遊戲數據（錢包、商品、進度）都儲存在瀏覽器本地，清除瀏覽器數據會重置。</li>
                    <li><strong style="color: #ffd700;">終極套裝：</strong>終極套裝提供瞬間控制能力，是最強大的商品，但價格也最高。</li>
                </ul>
            </div>

            <!-- 返回按鈕 -->
            <div style="text-align: center; margin-top: 30px;">
                <button id="guide-back-btn" style="padding: 15px 40px; background: linear-gradient(135deg, #4a90d9, #357abd); border: none; border-radius: 10px; color: #fff; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(74,144,217,0.3); transition: all 0.3s;">
                    <i class="fas fa-arrow-left"></i> 返回主頁
                </button>
            </div>
        </div>
    </div>

    <!-- 流程示範圖頁面 -->
    <div id="flowchart-page" class="page hidden">
        <div class="main-header">
            <div class="main-logo" style="color: #9b59b6; text-shadow: 0 0 10px #9b59b6, 0 0 20px #9b59b6;">
                <span>流程示範圖</span>
            </div>
            <div class="main-subtitle">模擬器操作流程 v2.0</div>
        </div>

        <div style="max-width: 1100px; margin: 0 auto; padding: 15px;">
            <!-- 主流程圖 -->
            <div style="background: rgba(155, 89, 182, 0.1); border: 2px solid #9b59b6; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h2 style="color: #9b59b6; text-align: center; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-project-diagram"></i> 模擬器主流程
                </h2>

                <!-- 流程圖 -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                    <!-- 開始 -->
                    <div style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: #fff; padding: 12px 30px; border-radius: 25px; font-weight: bold; font-size: 0.95rem;">
                        <i class="fas fa-play"></i> 啟動模擬器
                    </div>
                    <div style="width: 3px; height: 20px; background: #9b59b6;"></div>

                    <!-- 選擇模式 -->
                    <div style="background: #2a2a40; border: 2px solid #9b59b6; padding: 15px 25px; border-radius: 10px; text-align: center;">
                        <strong style="color: #fff; font-size: 0.95rem;">選擇遊戲模式</strong>
                    </div>
                    <div style="width: 3px; height: 15px; background: #9b59b6;"></div>

                    <!-- 三分支 -->
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; width: 100%;">
                        <!-- 黑客模式分支 -->
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; flex: 1; min-width: 140px; max-width: 200px;">
                            <div style="background: rgba(0, 255, 65, 0.2); border: 2px solid #00ff41; padding: 12px 15px; border-radius: 10px; text-align: center; width: 100%;">
                                <i class="fas fa-user-secret" style="color: #00ff41;"></i><br>
                                <strong style="color: #00ff41; font-size: 0.9rem;">黑客模式</strong>
                            </div>
                            <div style="width: 3px; height: 15px; background: #00ff41;"></div>
                            <div style="background: #1a1a2e; border: 1px solid #00ff41; padding: 10px 12px; border-radius: 8px; color: #aaa; font-size: 0.8rem; text-align: center; width: 100%;">
                                攻擊模式 → 課金升級 → 殭屍化
                            </div>
                        </div>

                        <!-- 防禦者模式分支 -->
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; flex: 1; min-width: 140px; max-width: 200px;">
                            <div style="background: rgba(255, 51, 51, 0.2); border: 2px solid #ff3333; padding: 12px 15px; border-radius: 10px; text-align: center; width: 100%;">
                                <i class="fas fa-shield-alt" style="color: #ff3333;"></i><br>
                                <strong style="color: #ff3333; font-size: 0.9rem;">防禦者模式</strong>
                            </div>
                            <div style="width: 3px; height: 15px; background: #ff3333;"></div>
                            <div style="background: #1a1a2e; border: 1px solid #ff3333; padding: 10px 12px; border-radius: 8px; color: #aaa; font-size: 0.8rem; text-align: center; width: 100%;">
                                監控 → 反擊課金 → 入侵黑客
                            </div>
                        </div>

                        <!-- 對戰模式分支 -->
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; flex: 1; min-width: 140px; max-width: 200px;">
                            <div style="background: rgba(255, 153, 0, 0.2); border: 2px solid #ff9900; padding: 12px 15px; border-radius: 10px; text-align: center; width: 100%;">
                                <i class="fas fa-gamepad" style="color: #ff9900;"></i><br>
                                <strong style="color: #ff9900; font-size: 0.9rem;">對戰模式</strong>
                            </div>
                            <div style="width: 3px; height: 15px; background: #ff9900;"></div>
                            <div style="background: #1a1a2e; border: 1px solid #ff9900; padding: 10px 12px; border-radius: 8px; color: #aaa; font-size: 0.8rem; text-align: center; width: 100%;">
                                5分鐘限時 → 互相攻防 → 勝負
                            </div>
                        </div>
                    </div>

                    <div style="width: 3px; height: 20px; background: #9b59b6;"></div>

                    <!-- 遊戲進行 -->
                    <div style="background: #2a2a40; border: 2px solid #9b59b6; padding: 15px 25px; border-radius: 10px; text-align: center;">
                        <strong style="color: #fff; font-size: 0.95rem;">使用工具 / 課金系統 / 攻擊模式</strong>
                    </div>
                    <div style="width: 3px; height: 15px; background: #9b59b6;"></div>

                    <!-- 結果 -->
                    <div style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: #fff; padding: 12px 30px; border-radius: 25px; font-weight: bold; font-size: 0.95rem;">
                        <i class="fas fa-trophy"></i> 獲勝 + 獲得獎勵
                    </div>
                </div>
            </div>

            <!-- 對戰模式詳細流程（新增） -->
<div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <!-- 對戰模式詳細流程 -->
                <div style="flex: 1; min-width: 300px; background: rgba(255, 153, 0, 0.1); border: 2px solid #ff9900; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h2 style="color: #ff9900; text-align: center; margin-bottom: 15px; font-size: 1.2rem;">
                        <i class="fas fa-gamepad"></i> 對戰模式詳細流程
                    </h2>
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; text-align: center;">
                        <div style="background: rgba(255,153,0,0.2); padding: 10px 15px; border-radius: 8px; border: 1px solid #ff9900;">
                            <div style="color: #ff9900; font-weight: bold; font-size: 0.85rem;">1. 選擇陣營</div>
                            <div style="color: #aaa; font-size: 0.75rem;">黑客或防禦者</div>
                        </div>
                        <div style="color: #ff9900;">→</div>
                        <div style="background: rgba(255,153,0,0.2); padding: 10px 15px; border-radius: 8px; border: 1px solid #ff9900;">
                            <div style="color: #ff9900; font-weight: bold; font-size: 0.85rem;">2. 設置IP/難度</div>
                            <div style="color: #aaa; font-size: 0.75rem;">準備開始</div>
                        </div>
                        <div style="color: #ff9900;">→</div>
                        <div style="background: rgba(255,153,0,0.2); padding: 10px 15px; border-radius: 8px; border: 1px solid #ff9900;">
                            <div style="color: #ff9900; font-weight: bold; font-size: 0.85rem;">3. 開始對戰</div>
                            <div style="color: #aaa; font-size: 0.75rem;">5分鐘限時</div>
                        </div>
                        <div style="color: #ff9900;">→</div>
                        <div style="background: rgba(255,153,0,0.2); padding: 10px 15px; border-radius: 8px; border: 1px solid #ff9900;">
                            <div style="color: #ff9900; font-weight: bold; font-size: 0.85rem;">4. 實時對戰</div>
                            <div style="color: #aaa; font-size: 0.75rem;">進度追蹤</div>
                        </div>
                        <div style="color: #ff9900;">→</div>
                        <div style="background: rgba(255,153,0,0.2); padding: 10px 15px; border-radius: 8px; border: 1px solid #ff9900;">
                            <div style="color: #ff9900; font-weight: bold; font-size: 0.85rem;">5. 判定勝負</div>
                            <div style="color: #aaa; font-size: 0.75rem;">獲得獎勵</div>
                        </div>
                    </div>
                </div>
                

                <div style="flex: 1; min-width: 300px; background: rgba(153, 102, 255, 0.1); border: 2px solid #9966ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h2 style="color: #9966ff; text-align: center; margin-bottom: 15px; font-size: 1.2rem;">
                        <i class="fas fa-star"></i> 詳細流程 (續集)
                    </h2>
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; text-align: center;">
                        <div style="background: rgba(153,102,255,0.2); padding: 10px 15px; border-radius: 8px; border: 1px solid #9966ff;">
                            <div style="color: #9966ff; font-weight: bold; font-size: 0.85rem;">1. 選擇角色</div>
                            <div style="color: #aaa; font-size: 0.75rem;">黑客或執法部門</div>
                        </div>
                        <div style="color: #9966ff;">→</div>
                        <div style="background: rgba(153,102,255,0.2); padding: 10px 15px; border-radius: 8px; border: 1px solid #9966ff;">
                            <div style="color: #9966ff; font-weight: bold; font-size: 0.85rem;">2. 設置難度</div>
                            <div style="color: #aaa; font-size: 0.75rem;">準備開始</div>
                        </div>
                        <div style="color: #9966ff;">→</div>
                        <div style="background: rgba(153,102,255,0.2); padding: 10px 15px; border-radius: 8px; border: 1px solid #9966ff;">
                            <div style="color: #9966ff; font-weight: bold; font-size: 0.85rem;">3. 攻防對決</div>
                            <div style="color: #aaa; font-size: 0.75rem;">起底/反追蹤/反擊</div>
                        </div>
                        <div style="color: #9966ff;">→</div>
                        <div style="background: rgba(153,102,255,0.2); padding: 10px 15px; border-radius: 8px; border: 1px solid #9966ff;">
                            <div style="color: #9966ff; font-weight: bold; font-size: 0.85rem;">4. 談判/聯合</div>
                            <div style="color: #aaa; font-size: 0.75rem;">策略性行動</div>
                        </div>
                        <div style="color: #9966ff;">→</div>
                        <div style="background: rgba(153,102,255,0.2); padding: 10px 15px; border-radius: 8px; border: 1px solid #9966ff;">
                            <div style="color: #9966ff; font-weight: bold; font-size: 0.85rem;">5. 判定勝負</div>
                            <div style="color: #aaa; font-size: 0.75rem;">獲得高額獎勵</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 詳細流程說明 -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
                <!-- 黑客攻擊流程 -->
                <div style="background: rgba(0, 255, 65, 0.05); border: 2px solid #00ff41; border-radius: 12px; padding: 20px;">
                    <h3 style="color: #00ff41; margin-bottom: 15px; text-align: center;">
                        <i class="fas fa-user-secret"></i> 黑客攻擊流程
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #00ff41; color: #000; padding: 5px 10px; border-radius: 5px; font-weight: bold;">1</span>
                            <span style="color: #ccc;">偵察階段：端口掃描、信息收集</span>
                        </div>
                        <div style="text-align: center; color: #00ff41;">↓</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #00ff41; color: #000; padding: 5px 10px; border-radius: 5px; font-weight: bold;">2</span>
                            <span style="color: #ccc;">武器化：選擇攻擊工具和漏洞</span>
                        </div>
                        <div style="text-align: center; color: #00ff41;">↓</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #00ff41; color: #000; padding: 5px 10px; border-radius: 5px; font-weight: bold;">3</span>
                            <span style="color: #ccc;">入侵階段：執行攻擊獲取訪問</span>
                        </div>
                        <div style="text-align: center; color: #00ff41;">↓</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #00ff41; color: #000; padding: 5px 10px; border-radius: 5px; font-weight: bold;">4</span>
                            <span style="color: #ccc;">提權階段：提升系統權限</span>
                        </div>
                        <div style="text-align: center; color: #00ff41;">↓</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #00ff41; color: #000; padding: 5px 10px; border-radius: 5px; font-weight: bold;">5</span>
                            <span style="color: #ccc;">隱藏階段：清除痕跡植入後門</span>
                        </div>
                    </div>
                </div>

                <!-- 防禦者防護流程 -->
                <div style="background: rgba(255, 51, 51, 0.05); border: 2px solid #ff3333; border-radius: 12px; padding: 20px;">
                    <h3 style="color: #ff3333; margin-bottom: 15px; text-align: center;">
                        <i class="fas fa-shield-alt"></i> 防禦者防護流程
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #ff3333; color: #fff; padding: 5px 10px; border-radius: 5px; font-weight: bold;">1</span>
                            <span style="color: #ccc;">監控階段：啟動IDS和日誌監控</span>
                        </div>
                        <div style="text-align: center; color: #ff3333;">↓</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #ff3333; color: #fff; padding: 5px 10px; border-radius: 5px; font-weight: bold;">2</span>
                            <span style="color: #ccc;">檢測階段：識別異常活動</span>
                        </div>
                        <div style="text-align: center; color: #ff3333;">↓</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #ff3333; color: #fff; padding: 5px 10px; border-radius: 5px; font-weight: bold;">3</span>
                            <span style="color: #ccc;">分析階段：確認威脅來源</span>
                        </div>
                        <div style="text-align: center; color: #ff3333;">↓</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #ff3333; color: #fff; padding: 5px 10px; border-radius: 5px; font-weight: bold;">4</span>
                            <span style="color: #ccc;">響應階段：封鎖攻擊IP</span>
                        </div>
                        <div style="text-align: center; color: #ff3333;">↓</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #ff3333; color: #fff; padding: 5px 10px; border-radius: 5px; font-weight: bold;">5</span>
                            <span style="color: #ccc;">修復階段：修補漏洞加固系統</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 返回按鈕 -->
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" id="flowchart-back-btn" style="background: rgba(255, 255, 255, 0.1); border: 1px solid #666; padding: 12px 30px;">
                <i class="fas fa-arrow-left"></i>
                <span>返回主選單</span>
            </button>
        </div>
    </div>

    <script>

        // ===== 頁面導航優化 =====
        function showPage(pageId) {
            // 隱藏所有頁面
            document.getElementById('main-page').style.display = 'none';
            document.getElementById('game-page').style.display = 'none';
            document.getElementById('battle-select-page').style.display = 'none';
            document.getElementById('guide-page').style.display = 'none';
            
            // 顯示指定頁面
            const page = document.getElementById(pageId);
            if (page) {
                page.style.display = 'block';
                // 跳到頁面頂部
                window.scrollTo(0, 0);
                setTimeout(() => {
                    window.scrollTo(0, 0);
                }, 100);
            }
        }
        // ===== 內存存儲（替代 localStorage）=====
        const MemoryStorage = {
            data: {},
            getItem(key) {
                return this.data[key] || null;
            },
            setItem(key, value) {
                this.data[key] = value;
            },
            removeItem(key) {
                delete this.data[key];
            },
            clear() {
                this.data = {};
            }
        };

        // ===== 自定義模態框函數 =====
        function showModal(options) {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-modal');
                const titleText = document.getElementById('modal-title-text');
                const message = document.getElementById('modal-message');
                const input = document.getElementById('modal-input');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                titleText.textContent = options.title || '系統提示';
                message.textContent = options.message || '';

                if (options.showInput) {
                    input.style.display = 'block';
                    input.value = options.defaultValue || '';
                    input.placeholder = options.placeholder || '';
                } else {
                    input.style.display = 'none';
                }

                confirmBtn.textContent = options.confirmText || '確定';
                cancelBtn.style.display = options.showCancel !== false ? 'block' : 'none';

                modal.classList.add('show');

                const cleanup = () => {
                    modal.classList.remove('show');
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                };

                confirmBtn.onclick = () => {
                    cleanup();
                    resolve(options.showInput ? input.value : true);
                };

                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(null);
                };
            });
        }

        function showPromptModal(message, defaultValue) {
            return showModal({
                title: '輸入設置',
                message: message,
                showInput: true,
                defaultValue: defaultValue,
                showCancel: true
            });
        }

        function showAlertModal(title, message) {
            return showModal({
                title: title,
                message: message,
                showInput: false,
                showCancel: false
            });
        }

        // ===== 聲音效果系統 =====
        const SoundSystem = {
            enabled: true,
            audioContext: null,

            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Web Audio API 不支持');
                    this.enabled = false;
                }
            },

            play(type) {
                if (!this.enabled || !this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                switch(type) {
                    case 'keypress':
                        oscillator.frequency.value = 800;
                        gainNode.gain.value = 0.05;
                        oscillator.type = 'sine';
                        break;
                    case 'success':
                        oscillator.frequency.value = 1200;
                        gainNode.gain.value = 0.1;
                        oscillator.type = 'sine';
                        break;
                    case 'error':
                        oscillator.frequency.value = 200;
                        gainNode.gain.value = 0.1;
                        oscillator.type = 'sawtooth';
                        break;
                    case 'alert':
                        oscillator.frequency.value = 600;
                        gainNode.gain.value = 0.15;
                        oscillator.type = 'square';
                        break;
                    case 'attack':
                        oscillator.frequency.value = 400;
                        gainNode.gain.value = 0.12;
                        oscillator.type = 'sawtooth';
                        break;
                    case 'defense':
                        oscillator.frequency.value = 900;
                        gainNode.gain.value = 0.08;
                        oscillator.type = 'triangle';
                        break;
                    default:
                        oscillator.frequency.value = 500;
                        gainNode.gain.value = 0.05;
                }

                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.2);
                oscillator.stop(this.audioContext.currentTime + 0.2);
            },

            toggle() {
                this.enabled = !this.enabled;
                updateSoundIndicator();
                return this.enabled;
            }
        };

        // ===== 晝夜循環系統 =====
        const DayNightCycle = {
            isNight: false,
            difficultyMultiplier: 1,

            init() {
                this.updateCycle();
                setInterval(() => this.updateCycle(), 60000); // 每分鐘檢查
            },

            updateCycle() {
                const hour = new Date().getHours();
                const wasNight = this.isNight;
                this.isNight = hour < 6 || hour >= 22;

                if (this.isNight !== wasNight) {
                    this.applyTimeEffects();
                }

                // 更新難度
                if (this.isNight) {
                    this.difficultyMultiplier = 0.7; // 夜間防禦者減少
                    document.body.classList.add('nighttime');
                    document.body.classList.remove('daytime');
                } else {
                    this.difficultyMultiplier = 1.0;
                    document.body.classList.add('daytime');
                    document.body.classList.remove('nighttime');
                }
            },

            applyTimeEffects() {
                if (GameState.currentMode === 'hacker' && this.isNight) {
                    addTerminalLine('[系統] 夜間模式：防禦系統減弱', 'system');
                } else if (GameState.currentMode === 'defender' && this.isNight) {
                    addTerminalLine('[警告] 夜間模式：人員減少，需加強監控', 'warning');
                }
            },

            getDifficultyMultiplier() {
                return this.difficultyMultiplier;
            }
        };

        // ===== 更新聲音指示器 =====
        function updateSoundIndicator() {
            const indicator = document.getElementById('sound-indicator');
            if (indicator) {
                indicator.innerHTML = SoundSystem.enabled ?
                    '<i class="fas fa-volume-up"></i> 音效開啟' :
                    '<i class="fas fa-volume-mute"></i> 音效關閉';
            }
        }

        // ===== 視覺效果管理 =====
        const VisualEffects = {
            triggerAttackAnimation(targetNode) {
                const node = document.querySelector(targetNode);
                if (node) {
                    node.classList.add('attacking');
                    setTimeout(() => node.classList.remove('attacking'), 2000);
                }
            },

            triggerDefenseAnimation(targetNode) {
                const node = document.querySelector(targetNode);
                if (node) {
                    node.classList.add('defending');
                    setTimeout(() => node.classList.remove('defending'), 2000);
                }
            },

            triggerCompromised(targetNode) {
                const node = document.querySelector(targetNode);
                if (node) {
                    node.classList.add('compromised');
                    setTimeout(() => node.classList.remove('compromised'), 3000);
                }
            },

            createDataPacket(startX, startY, endX, endY, isAttack = false) {
                const networkMap = document.getElementById('network-map');
                if (!networkMap) return;

                const packet = document.createElement('div');
                packet.className = `data-packet ${isAttack ? 'attack-packet' : ''}`;
                packet.style.left = startX + 'px';
                packet.style.top = startY + 'px';
                networkMap.appendChild(packet);

                // 動畫移動
                const duration = 1500;
                const startTime = Date.now();

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    packet.style.left = startX + (endX - startX) * progress + 'px';
                    packet.style.top = startY + (endY - startY) * progress + 'px';

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        packet.remove();
                    }
                };

                requestAnimationFrame(animate);
            }
        };

        // ===== 遊戲核心配置 =====
        const GameConfig = {
            // 本地存儲鍵名
            STORAGE_KEY: 'cyber_battle_simulator',
            
            // 遊戲設置
            settings: {
                playerIP: '192.168.1.100',
                targetIP: '',
                difficulty: 'medium',
                autoSave: true,
                notifications: true,
                soundEffects: true,
            },
            
            // 虛擬對手配置 (AI模擬人物)
            opponent: {
                hacker: {
                    ip: '192.168.1.200',
                    name: 'Shadow_Hacker',
                    level: 'expert',
                    tools: ['nmap', 'metasploit', 'sqlmap', 'hydra'],
                    attackPattern: 'stealth',
                    // AI模擬人物詳細資料
                    profile: {
                        realName: '未知',
                        alias: 'Shadow_Hacker',
                        country: '俄羅斯',
                        organization: 'DarkNet Collective',
                        skillLevel: 95,
                        reputation: 'Legendary',
                        activeHours: '02:00-06:00 UTC',
                        knownExploits: ['CVE-2024-0001', 'CVE-2023-9999', 'Zero-Day-X'],
                        preferredTargets: ['金融機構', '政府系統', '企業網絡'],
                        cryptoWallet: '0x7a3f...8c2d',
                        estimatedWorth: 2500000
                    },
                    device: {
                        os: 'Kali Linux 2024.1',
                        hardware: 'Custom Build - 64GB RAM',
                        vpnActive: true,
                        vpnProvider: 'NordVPN (多層代理)',
                        torActive: true,
                        firewallLevel: 95,
                        antivirusLevel: 98
                    }
                },
                defender: {
                    ip: '192.168.1.150',
                    name: 'Security_Guard',
                    level: 'professional',
                    tools: ['firewall', 'ids', 'antivirus', 'log_analyzer'],
                    defensePattern: 'active',
                    // AI模擬人物詳細資料
                    profile: {
                        realName: '陳大明',
                        company: 'CyberShield Corp.',
                        position: '資安主管',
                        country: '香港',
                        certifications: ['CISSP', 'CEH', 'OSCP'],
                        yearsExperience: 8,
                        email: 'admin@cybershield.hk',
                        phone: '+852-XXXX-XXXX',
                        socialMedia: {
                            linkedin: 'chen-daming-security',
                            twitter: '@cybershield_hk'
                        },
                        officeAddress: '中環金融街88號25樓'
                    },
                    device: {
                        os: 'Windows Server 2022',
                        hardware: 'Dell PowerEdge R750',
                        vpnActive: false,
                        firewallLevel: 70,
                        antivirusLevel: 65,
                        openPorts: [22, 80, 443, 3389, 8080],
                        vulnerabilities: ['CVE-2023-1234', 'Outdated SSL', 'Weak Password Policy']
                    },
                    network: {
                        publicIP: '203.145.67.89',
                        internalRange: '192.168.1.0/24',
                        dnsServer: '8.8.8.8',
                        gateway: '192.168.1.1',
                        bandwidth: '1Gbps',
                        connectedDevices: 47
                    }
                }
            },
            
            // 黑客模式配置
            hacker: {
                title: "黑客入侵指揮中心",
                icon: "fa-user-secret",
                primaryColor: "#00ff41",
                secondaryColor: "#0088ff",
                dangerColor: "#ff3333",
                terminalTitle: "DARKNET TERMINAL v3.0",
                terminalPrompt: "root@shadow:~#",
                


            // 黑客工具分類
                toolCategories: {
                    reconnaissance: {
                        name: "偵察工具",
                        icon: "fa-binoculars",
                        tools: [
                            { 
                                id: "nmap", 
                                name: "Nmap掃描器", 
                                icon: "fa-search", 
                                desc: "掃描目標網絡拓撲和開放端口",
                                cooldown: 5,
                                effect: { stealth: -5, detection: 10 },
                                command: "nmap -sS -sV -O"
                            },
                            { 
                                id: "whois", 
                                name: "Whois查詢", 
                                icon: "fa-address-card", 
                                desc: "查詢目標域名註冊信息",
                                cooldown: 3,
                                effect: { info: 15 },
                                command: "whois target.com"
                            },
                            { 
                                id: "dns_enum", 
                                name: "DNS枚舉", 
                                icon: "fa-sitemap", 
                                desc: "枚舉目標DNS記錄和子域名",
                                cooldown: 4,
                                effect: { info: 10, stealth: -3 },
                                command: "dnsrecon -d target.com"
                            },
                            { 
                                id: "social_engineer", 
                                name: "社交工程", 
                                icon: "fa-users", 
                                desc: "收集目標社交媒體信息",
                                cooldown: 8,
                                effect: { info: 20, stealth: -8 },
                                command: "theHarvester -d target.com -b all"
                            }
                        ]
                    },
                    exploitation: {
                        name: "漏洞利用",
                        icon: "fa-bug",
                        tools: [
                            { 
                                id: "metasploit", 
                                name: "Metasploit框架", 
                                icon: "fa-crosshairs", 
                                desc: "利用已知系統漏洞",
                                cooldown: 10,
                                effect: { attack: 15, detection: 20 },
                                command: "msfconsole -q"
                            },
                            { 
                                id: "sqlmap", 
                                name: "SQL注入工具", 
                                icon: "fa-database", 
                                desc: "自動化SQL注入檢測和利用",
                                cooldown: 7,
                                effect: { attack: 12, detection: 15 },
                                command: "sqlmap -u 'http://target.com/login.php'"
                            },
                            { 
                                id: "xss_scanner", 
                                name: "XSS掃描器", 
                                icon: "fa-code", 
                                desc: "檢測跨站腳本漏洞",
                                cooldown: 6,
                                effect: { attack: 8, detection: 10 },
                                command: "xsser --url http://target.com"
                            },
                            { 
                                id: "exploit_db", 
                                name: "漏洞數據庫", 
                                icon: "fa-book", 
                                desc: "搜索已知漏洞和利用代碼",
                                cooldown: 2,
                                effect: { info: 5 },
                                command: "searchsploit apache 2.4"
                            }
                        ]
                    },
                    access: {
                        name: "權限提升",
                        icon: "fa-key",
                        tools: [
                            { 
                                id: "hydra", 
                                name: "Hydra破解器", 
                                icon: "fa-unlock-alt", 
                                desc: "暴力破解登入憑證",
                                cooldown: 12,
                                effect: { attack: 10, detection: 25 },
                                command: "hydra -l admin -P passlist.txt ssh://target"
                            },
                            { 
                                id: "john", 
                                name: "John破解器", 
                                icon: "fa-hammer", 
                                desc: "破解密碼哈希值",
                                cooldown: 15,
                                effect: { attack: 8 },
                                command: "john --format=md5 hashes.txt"
                            },
                            { 
                                id: "privilege_escalation", 
                                name: "權限提升工具", 
                                icon: "fa-user-plus", 
                                desc: "提升系統權限到管理員",
                                cooldown: 10,
                                effect: { access: 20, detection: 18 },
                                command: "sudo -l"
                            },
                            { 
                                id: "backdoor", 
                                name: "後門植入", 
                                icon: "fa-door-open", 
                                desc: "創建持久性後門訪問",
                                cooldown: 20,
                                effect: { access: 25, detection: 30 },
                                command: "msfvenom -p linux/x64/meterpreter/reverse_tcp"
                            }
                        ]
                    },
                    stealth: {
                        name: "隱蔽工具",
                        icon: "fa-mask",
                        tools: [
                            {
                                id: "tor",
                                name: "Tor網絡",
                                icon: "fa-user-ninja",
                                desc: "匿名化網絡連接",
                                cooldown: 3,
                                effect: { stealth: 20, speed: -10 },
                                command: "service tor start"
                            },
                            {
                                id: "vpn",
                                name: "VPN連接",
                                icon: "fa-user-shield",
                                desc: "加密和偽裝IP地址",
                                cooldown: 5,
                                effect: { stealth: 15 },
                                command: "openvpn --config vpn.conf"
                            },
                            {
                                id: "log_cleaner",
                                name: "日誌清理",
                                icon: "fa-eraser",
                                desc: "清除系統日誌記錄",
                                cooldown: 8,
                                effect: { stealth: 12, detection: -10 },
                                command: "shred -u /var/log/auth.log"
                            },
                            {
                                id: "spoofing",
                                name: "地址偽造",
                                icon: "fa-theater-masks",
                                desc: "偽造MAC和IP地址",
                                cooldown: 6,
                                effect: { stealth: 10 },
                                command: "macchanger -r eth0"
                            }
                        ]
                    },
                    identity: {
                        name: "身份隱藏",
                        icon: "fa-user-secret",
                        tools: [
                            {
                                id: "proxy_chain",
                                name: "代理鏈路",
                                icon: "fa-link",
                                desc: "多層代理跳轉隱藏真實來源",
                                cooldown: 8,
                                effect: { stealth: 30, speed: -15 },
                                command: "proxychains4 -f chain.conf nmap -sS target"
                            },
                            {
                                id: "identity_forge",
                                name: "身份偽造器",
                                icon: "fa-id-card",
                                desc: "偽造數字身份和憑證",
                                cooldown: 12,
                                effect: { stealth: 25, access: 15 },
                                command: "identity-forge --generate --country=random"
                            },
                            {
                                id: "traffic_morph",
                                name: "流量偽裝",
                                icon: "fa-random",
                                desc: "將攻擊流量偽裝成正常流量",
                                cooldown: 10,
                                effect: { stealth: 22, detection: -20 },
                                command: "obfs4proxy -mode client -tunnel https"
                            },
                            {
                                id: "timing_rand",
                                name: "時序隨機化",
                                icon: "fa-clock",
                                desc: "隨機化攻擊時間間隔避免檢測",
                                cooldown: 6,
                                effect: { stealth: 18, detection: -15 },
                                command: "jitter-attack --min=100 --max=5000"
                            },
                            {
                                id: "dns_tunnel",
                                name: "DNS隧道",
                                icon: "fa-project-diagram",
                                desc: "通過DNS協議隱藏通信",
                                cooldown: 15,
                                effect: { stealth: 35, speed: -20 },
                                command: "iodine -f -P secret dns.tunnel.local"
                            },
                            {
                                id: "steganography",
                                name: "隱寫術工具",
                                icon: "fa-image",
                                desc: "在圖片中隱藏惡意代碼",
                                cooldown: 20,
                                effect: { stealth: 40, attack: 10 },
                                command: "steghide embed -cf image.jpg -ef payload.sh"
                            },
                            {
                                id: "antiforensics",
                                name: "反取證工具",
                                icon: "fa-broom",
                                desc: "深度清除數字痕跡",
                                cooldown: 25,
                                effect: { stealth: 50, detection: -40 },
                                command: "srm -sz /var/log/* && bleachbit --clean system.*"
                            },
                            {
                                id: "vm_escape",
                                name: "虛擬機逃逸",
                                icon: "fa-box-open",
                                desc: "繞過沙盒和虛擬機檢測",
                                cooldown: 30,
                                effect: { stealth: 45, access: 25 },
                                command: "vmdetect --bypass --technique=timing,cpuid"
                            }
                        ]
                    },
                    webattack: {
                        name: "Web攻擊",
                        icon: "fa-globe",
                        tools: [
                            {
                                id: "sqlinjection",
                                name: "SQL注入工具",
                                icon: "fa-database",
                                desc: "自動化SQL注入測試",
                                cooldown: 10,
                                effect: { attack: 15, detection: 20 },
                                command: "sqlmap -u 'http://target/page?id=1' --dbs"
                            },
                            {
                                id: "xss",
                                name: "XSS攻擊工具",
                                icon: "fa-code",
                                desc: "跨站腳本攻擊模擬",
                                cooldown: 8,
                                effect: { attack: 12, detection: 15 },
                                command: "xsser -u 'http://target/search?q=test'"
                            },
                            {
                                id: "csrf",
                                name: "CSRF生成器",
                                icon: "fa-exchange-alt",
                                desc: "跨站請求偽造攻擊",
                                cooldown: 12,
                                effect: { attack: 10, access: 8 },
                                command: "csrfgen --target http://target/api/action"
                            },
                            {
                                id: "lfi",
                                name: "文件包含漏洞",
                                icon: "fa-folder-open",
                                desc: "本地/遠程文件包含利用",
                                cooldown: 10,
                                effect: { attack: 14, access: 12 },
                                command: "lfimap -u 'http://target/?page=../' --rce"
                            }
                        ]
                    },
                    ddos: {
                        name: "DDoS攻擊",
                        icon: "fa-bolt",
                        tools: [
                            {
                                id: "synflood",
                                name: "SYN洪水攻擊",
                                icon: "fa-water",
                                desc: "TCP SYN泛洪攻擊模擬",
                                cooldown: 15,
                                effect: { attack: 25, detection: 40 },
                                command: "hping3 -S --flood -V -p 80 target"
                            },
                            {
                                id: "udpflood",
                                name: "UDP洪水攻擊",
                                icon: "fa-broadcast-tower",
                                desc: "UDP泛洪攻擊模擬",
                                cooldown: 15,
                                effect: { attack: 22, detection: 35 },
                                command: "udpflood target 53 1000"
                            },
                            {
                                id: "slowloris",
                                name: "Slowloris攻擊",
                                icon: "fa-hourglass-half",
                                desc: "慢速HTTP攻擊",
                                cooldown: 12,
                                effect: { attack: 18, detection: 25 },
                                command: "slowloris target -p 80 -s 500"
                            },
                            {
                                id: "dnsamp",
                                name: "DNS放大攻擊",
                                icon: "fa-expand-arrows-alt",
                                desc: "DNS放大DDoS攻擊",
                                cooldown: 18,
                                effect: { attack: 30, detection: 45 },
                                command: "dnsamplify --target target --resolvers list.txt"
                            }
                        ]
                    },
                    socialeng: {
                        name: "社交工程",
                        icon: "fa-users",
                        tools: [
                            {
                                id: "phishing",
                                name: "釣魚郵件生成器",
                                icon: "fa-envelope",
                                desc: "生成釣魚郵件模板",
                                cooldown: 8,
                                effect: { attack: 10, stealth: 5 },
                                command: "setoolkit --phishing --template banking"
                            },
                            {
                                id: "fakepage",
                                name: "虛假登錄頁面",
                                icon: "fa-window-maximize",
                                desc: "克隆登錄頁面獲取憑證",
                                cooldown: 10,
                                effect: { attack: 12, access: 15 },
                                command: "socialfish --clone https://target/login"
                            },
                            {
                                id: "pretexting",
                                name: "偽裝欺騙",
                                icon: "fa-mask",
                                desc: "偽裝身份獲取信息",
                                cooldown: 6,
                                effect: { stealth: 8, info: 10 },
                                command: "gophish --campaign impersonation"
                            },
                            {
                                id: "baiting",
                                name: "誘餌攻擊",
                                icon: "fa-gift",
                                desc: "部署惡意USB/文件誘餌",
                                cooldown: 12,
                                effect: { attack: 8, access: 10 },
                                command: "usbdrop --payload reverse_shell.exe"
                            }
                        ]
                    },
                    malware: {
                        name: "惡意軟件",
                        icon: "fa-bug",
                        tools: [
                            {
                                id: "ransomware",
                                name: "勒索軟件模擬",
                                icon: "fa-lock",
                                desc: "勒索軟件攻擊模擬",
                                cooldown: 25,
                                effect: { attack: 35, detection: 50 },
                                command: "ransim --encrypt-demo --target /var/www"
                            },
                            {
                                id: "rat",
                                name: "遠程訪問木馬",
                                icon: "fa-desktop",
                                desc: "RAT遠程控制模擬",
                                cooldown: 20,
                                effect: { access: 30, detection: 35 },
                                command: "quasar --generate --host attacker --port 4444"
                            },
                            {
                                id: "keylogger",
                                name: "鍵盤記錄器",
                                icon: "fa-keyboard",
                                desc: "鍵盤輸入記錄模擬",
                                cooldown: 15,
                                effect: { info: 20, detection: 25 },
                                command: "keylog --stealth --output keys.log"
                            },
                            {
                                id: "botnet",
                                name: "殭屍網絡控制",
                                icon: "fa-robot",
                                desc: "殭屍網絡C2控制台",
                                cooldown: 30,
                                effect: { attack: 40, detection: 60 },
                                command: "mirai-c2 --bots 1000 --target target"
                            }
                        ]
                    }
                },

                // 黑客命令
                commands: {
                    'scan': {
                        desc: '掃描目標網絡',
                        handler: 'executeTool',
                        tool: 'nmap'
                    },
                    'whois': {
                        desc: '查詢域名信息',
                        handler: 'executeTool',
                        tool: 'whois'
                    },
                    'dnsenum': {
                        desc: 'DNS枚舉',
                        handler: 'executeTool',
                        tool: 'dns_enum'
                    },
                    'exploit': {
                        desc: '利用系統漏洞',
                        handler: 'executeTool',
                        tool: 'metasploit'
                    },
                    'crack': {
                        desc: '破解密碼',
                        handler: 'executeTool',
                        tool: 'hydra'
                    },
                    'stealth': {
                        desc: '啟動隱蔽模式',
                        handler: 'toggleStealth'
                    },
                    'backdoor': {
                        desc: '植入後門',
                        handler: 'executeTool',
                        tool: 'backdoor'
                    },
                    'sqli': {
                        desc: 'SQL注入攻擊',
                        handler: 'executeTool',
                        tool: 'sqlinjection'
                    },
                    'xss': {
                        desc: 'XSS跨站腳本攻擊',
                        handler: 'executeTool',
                        tool: 'xss'
                    },
                    'ddos': {
                        desc: 'DDoS攻擊',
                        handler: 'executeTool',
                        tool: 'synflood'
                    },
                    'phish': {
                        desc: '釣魚攻擊',
                        handler: 'executeTool',
                        tool: 'phishing'
                    },
                    'ransom': {
                        desc: '勒索軟件模擬',
                        handler: 'executeTool',
                        tool: 'ransomware'
                    },

                    // 通用命令
                    'status': {
                        desc: '顯示攻擊狀態',
                        handler: 'showStatus'
                    },
                    'help': {
                        desc: '顯示幫助信息',
                        handler: 'showHelp'
                    },
                    'clear': {
                        desc: '清空終端',
                        handler: 'clearTerminal'
                    },
                    'connect': {
                        desc: '連接目標系統',
                        handler: 'connectToTarget'
                    },
                    'disconnect': {
                        desc: '斷開連接',
                        handler: 'disconnectFromTarget'
                    },
                    'upgrade': {
                        desc: '升級或購買強化',
                        handler: 'openShop'
                    },
                    'shop': {
                        desc: '打開商店',
                        handler: 'openShop'
                    },
                    'select': {
                        desc: '顯示當前選項/目標',
                        handler: 'showSelection'
                    },
                    'setupvpn': {
                        desc: '設定VPN',
                        handler: 'setupVPN'
                    },
                    'proxy': {
                        desc: '使用代理鏈',
                        handler: 'executeTool',
                        tool: 'proxy_chain'
                    },
                    'tor': {
                        desc: '使用Tor網絡',
                        handler: 'executeTool',
                        tool: 'tor'
                    },
                    'history': {
                        desc: '顯示終端歷史',
                        handler: 'showHistory'
                    },
                    'save': {
                        desc: '保存遊戲狀態',
                        handler: 'saveGame'
                    },
                    'load': {
                        desc: '加載遊戲狀態',
                        handler: 'loadGame'
                    },
                    'settings': {
                        desc: '打開設置',
                        handler: 'showSettings'
                    },
                    'notifications': {
                        desc: '切換通知',
                        handler: 'toggleNotifications'
                    },
                    'sound': {
                        desc: '切換音效',
                        handler: 'toggleSound'
                    },
                    'quit': {
                        desc: '退出遊戲',
                        handler: 'quitGame'
                    }
                },
                
                // 初始狀態
                stats: {
                    attackPower: 75,
                    stealthLevel: 65,
                    detectionRisk: 25,
                    accessLevel: 10,
                    connections: 0,
                    resources: 1000,
                    time: 0
                }
            },
            
            // 防禦模式配置
            defender: {
                title: "網絡安全運營中心",
                icon: "fa-shield-alt",
                primaryColor: "#ff3333",
                secondaryColor: "#ff9900",
                dangerColor: "#00ff41",
                terminalTitle: "SECURITY OPERATIONS CENTER v4.1",
                terminalPrompt: "admin@soc:~#",
                
                // 防禦工具分類
                toolCategories: {
                    monitoring: {
                        name: "監控工具",
                        icon: "fa-eye",
                        tools: [
                            { 
                                id: "ids", 
                                name: "入侵檢測系統", 
                                icon: "fa-radar", 
                                desc: "實時監控網絡異常行為",
                                cooldown: 2,
                                effect: { detection: 15, resources: -5 },
                                command: "snort -A console -q -c /etc/snort/snort.conf"
                            },
                            { 
                                id: "siem", 
                                name: "SIEM系統", 
                                icon: "fa-chart-line", 
                                desc: "安全信息和事件管理",
                                cooldown: 3,
                                effect: { detection: 10, info: 15 },
                                command: "啟動Splunk監控"
                            },
                            { 
                                id: "network_monitor", 
                                name: "網絡監控", 
                                icon: "fa-network-wired", 
                                desc: "監控網絡流量和帶寬",
                                cooldown: 1,
                                effect: { detection: 5 },
                                command: "iftop -i eth0"
                            },
                            { 
                                id: "log_monitor", 
                                name: "日誌監控", 
                                icon: "fa-clipboard-list", 
                                desc: "實時監控系統日誌",
                                cooldown: 2,
                                effect: { detection: 8 },
                                command: "tail -f /var/log/syslog"
                            }
                        ]
                    },
                    defense: {
                        name: "防禦工具",
                        icon: "fa-shield-alt",
                        tools: [
                            { 
                                id: "firewall", 
                                name: "防火牆配置", 
                                icon: "fa-filter", 
                                desc: "配置和管理防火牆規則",
                                cooldown: 4,
                                effect: { defense: 20, resources: -10 },
                                command: "iptables -A INPUT -s 192.168.1.200 -j DROP"
                            },
                            { 
                                id: "waf", 
                                name: "Web應用防火牆", 
                                icon: "fa-globe", 
                                desc: "保護Web應用程序",
                                cooldown: 5,
                                effect: { defense: 15 },
                                command: "啟動ModSecurity"
                            },
                            { 
                                id: "antivirus", 
                                name: "防病毒掃描", 
                                icon: "fa-virus", 
                                desc: "掃描系統惡意軟件",
                                cooldown: 8,
                                effect: { defense: 12, detection: 10 },
                                command: "clamscan -r /var/www"
                            },
                            { 
                                id: "patch_manager", 
                                name: "補丁管理", 
                                icon: "fa-download", 
                                desc: "管理系統安全更新",
                                cooldown: 10,
                                effect: { defense: 25, resources: -15 },
                                command: "apt update && apt upgrade -y"
                            }
                        ]
                    },
                    analysis: {
                        name: "分析工具",
                        icon: "fa-search",
                        tools: [
                            { 
                                id: "forensics", 
                                name: "數字取證", 
                                icon: "fa-microscope", 
                                desc: "分析攻擊證據和痕跡",
                                cooldown: 6,
                                effect: { info: 20, detection: 10 },
                                command: "autopsy -d /cases/case1"
                            },
                            { 
                                id: "malware_analysis", 
                                name: "惡意軟件分析", 
                                icon: "fa-biohazard", 
                                desc: "分析惡意軟件行為",
                                cooldown: 12,
                                effect: { info: 15, defense: 8 },
                                command: "cuckoo submit malware.exe"
                            },
                            { 
                                id: "threat_intel", 
                                name: "威脅情報", 
                                icon: "fa-brain", 
                                desc: "收集和分析威脅情報",
                                cooldown: 3,
                                effect: { info: 10, detection: 8 },
                                command: "MISP threat feed update"
                            },
                            { 
                                id: "vulnerability_scanner", 
                                name: "漏洞掃描器", 
                                icon: "fa-search-plus", 
                                desc: "掃描系統安全漏洞",
                                cooldown: 15,
                                effect: { info: 25, resources: -20 },
                                command: "nessus --scan target"
                            }
                        ]
                    },
                    response: {
                        name: "響應工具",
                        icon: "fa-first-aid",
                        tools: [
                            { 
                                id: "incident_response", 
                                name: "事件響應", 
                                icon: "fa-ambulance", 
                                desc: "處理安全事件和攻擊",
                                cooldown: 8,
                                effect: { defense: 15, detection: 12 },
                                command: "啟動事件響應程序"
                            },
                            { 
                                id: "backup_restore", 
                                name: "備份恢復", 
                                icon: "fa-save", 
                                desc: "系統數據備份和恢復",
                                cooldown: 20,
                                effect: { defense: 30, resources: -25 },
                                command: "tar -czf backup.tar.gz /important"
                            },
                            { 
                                id: "honeypot", 
                                name: "蜜罐系統", 
                                icon: "fa-bug", 
                                desc: "部署誘捕系統收集攻擊信息",
                                cooldown: 12,
                                effect: { info: 25, detection: 20 },
                                command: "部署Dionaea蜜罐"
                            },
                            {
                                id: "block_ip",
                                name: "IP封鎖",
                                icon: "fa-ban",
                                desc: "封鎖惡意IP地址",
                                cooldown: 1,
                                effect: { defense: 5 },
                                command: "iptables -A INPUT -s 192.168.1.200 -j DROP"
                            }
                        ]
                    },
                    proactive: {
                        name: "主動防禦",
                        icon: "fa-crosshairs",
                        tools: [
                            {
                                id: "threat_hunt",
                                name: "威脅狩獵",
                                icon: "fa-bullseye",
                                desc: "主動搜索潛在威脅",
                                cooldown: 10,
                                effect: { detection: 25, info: 15 },
                                command: "threat-hunt --mode proactive --scope network"
                            },
                            {
                                id: "decoy_deploy",
                                name: "誘餌部署",
                                icon: "fa-clone",
                                desc: "部署誘餌文件和憑證",
                                cooldown: 8,
                                effect: { detection: 18, info: 12 },
                                command: "deploy-decoys --type credentials --count 50"
                            },
                            {
                                id: "behavior_analysis",
                                name: "行為分析",
                                icon: "fa-chart-area",
                                desc: "用戶實體行為分析(UEBA)",
                                cooldown: 6,
                                effect: { detection: 20, info: 10 },
                                command: "ueba-analyze --baseline 7d --sensitivity high"
                            },
                            {
                                id: "ioc_scan",
                                name: "IoC掃描",
                                icon: "fa-search-location",
                                desc: "入侵指標匹配掃描",
                                cooldown: 5,
                                effect: { detection: 15, info: 20 },
                                command: "ioc-scan --feed latest --scope all"
                            }
                        ]
                    },
                    encryption: {
                        name: "加密工具",
                        icon: "fa-lock",
                        tools: [
                            {
                                id: "data_encrypt",
                                name: "數據加密",
                                icon: "fa-key",
                                desc: "加密敏�����數據",
                                cooldown: 12,
                                effect: { defense: 20 },
                                command: "openssl enc -aes-256-cbc -salt -in data.txt"
                            },
                            {
                                id: "ssl_manager",
                                name: "SSL證書管理",
                                icon: "fa-certificate",
                                desc: "管理SSL/TLS證書",
                                cooldown: 8,
                                effect: { defense: 15 },
                                command: "certbot renew --force-renewal"
                            },
                            {
                                id: "key_rotation",
                                name: "密鑰輪換",
                                icon: "fa-sync-alt",
                                desc: "自動密鑰輪換",
                                cooldown: 15,
                                effect: { defense: 25 },
                                command: "key-rotate --all --backup"
                            },
                            {
                                id: "access_control",
                                name: "訪問控制",
                                icon: "fa-user-lock",
                                desc: "權限最小化配置",
                                cooldown: 10,
                                effect: { defense: 18 },
                                command: "acl-enforce --principle least-privilege"
                            }
                        ]
                    }
                },

                // 防禦命令
                commands: {
                    'monitor': {
                        desc: '監控網絡流量',
                        handler: 'executeTool',
                        tool: 'ids'
                    },
                    'firewall': {
                        desc: '配置防火牆',
                        handler: 'executeTool',
                        tool: 'firewall'
                    },
                    'scan': {
                        desc: '掃描系統漏洞',
                        handler: 'executeTool',
                        tool: 'vulnerability_scanner'
                    },
                    'block': {
                        desc: '封鎖攻擊IP',
                        handler: 'executeTool',
                        tool: 'block_ip'
                    },
                    'analyze': {
                        desc: '分析攻擊證據',
                        handler: 'executeTool',
                        tool: 'forensics'
                    },
                    'hunt': {
                        desc: '威脅狩獵',
                        handler: 'executeTool',
                        tool: 'threat_hunt'
                    },
                    'honeypot': {
                        desc: '部署蜜罐系統',
                        handler: 'executeTool',
                        tool: 'honeypot'
                    },
                    'encrypt': {
                        desc: '加密敏感數據',
                        handler: 'executeTool',
                        tool: 'data_encrypt'
                    },
                    'backup': {
                        desc: '備份系統數據',
                        handler: 'executeTool',
                        tool: 'backup_restore'
                    },

                    // 通用命令
                    'status': {
                        desc: '顯示防禦狀態',
                        handler: 'showStatus'
                    },
                    'help': {
                        desc: '顯示幫助信息',
                        handler: 'showHelp'
                    },
                    'clear': {
                        desc: '清空終端',
                        handler: 'clearTerminal'
                    },
                    'connect': {
                        desc: '連接監控系統',
                        handler: 'connectToTarget'
                    },
                    'disconnect': {
                        desc: '斷開連接',
                        handler: 'disconnectFromTarget'
                    },
                    'upgrade': {
                        desc: '升級或購買強化',
                        handler: 'openShop'
                    },
                    'shop': {
                        desc: '打開商店',
                        handler: 'openShop'
                    },
                    'select': {
                        desc: '顯示當前選項/目標',
                        handler: 'showSelection'
                    },
                    'isolate': {
                        desc: '隔離受感染主機',
                        handler: 'notAvailable'
                    },
                    'quarantine': {
                        desc: '隔離系統',
                        handler: 'notAvailable'
                    },
                    'patch': {
                        desc: '修補漏洞',
                        handler: 'executeTool',
                        tool: 'patch_manager'
                    },
                    'harden': {
                        desc: '系統加固',
                        handler: 'notAvailable'
                    },
                    'update': {
                        desc: '更新系統和簽名',
                        handler: 'executeTool',
                        tool: 'update_system'
                    },
                    'blacklist': {
                        desc: '添加到黑名單',
                        handler: 'notAvailable'
                    },
                    'whitelist': {
                        desc: '添加到白名單',
                        handler: 'notAvailable'
                    },
                    'trace': {
                        desc: '追蹤來源',
                        handler: 'notAvailable'
                    },
                    'contain': {
                        desc: '限制威脅擴散',
                        handler: 'notAvailable'
                    },
                    'eradicate': {
                        desc: '消除威脅',
                        handler: 'notAvailable'
                    },
                    'history': {
                        desc: '顯示終端歷史',
                        handler: 'showHistory'
                    },
                    'save': {
                        desc: '保存遊戲狀態',
                        handler: 'saveGame'
                    },
                    'load': {
                        desc: '加載遊戲狀態',
                        handler: 'loadGame'
                    },
                    'settings': {
                        desc: '打開設置',
                        handler: 'showSettings'
                    },
                    'notifications': {
                        desc: '切換通知',
                        handler: 'toggleNotifications'
                    },
                    'sound': {
                        desc: '切換音效',
                        handler: 'toggleSound'
                    },
                    'quit': {
                        desc: '退出遊戲',
                        handler: 'quitGame'
                    }
                },
                
                // 初始狀態
                stats: {
                    defenseLevel: 85,
                    detectionRate: 75,
                    systemHealth: 100,
                    blockedAttacks: 0,
                    activeAlerts: 0,
                    resources: 1500,
                    time: 0
                }
            }
        };

        // ===== 遊戲狀態管理 =====
        const GameState = {
            currentMode: null,
            isBattleMode: false, // 是否為對戰模式
            connected: false,
            opponentConnected: false,
            battleActive: false,
            stats: null,
            toolCooldowns: {},
            attackLog: [],
            notifications: [],
            gameTimer: null,
            lastUpdate: null,

            // 貨幣和課金系統
            wallet: {
                balance: 100000, // 預設 $100,000
                cryptoBalance: { BTC: 0.5, ETH: 2.0, USDT: 5000 },
                transactionHistory: [],
                cards: [
                    { id: 'card1', type: 'visa', last4: '4532', balance: 50000, isStolen: false },
                    { id: 'card2', type: 'mastercard', last4: '8891', balance: 25000, isStolen: true }
                ],
                // 防禦者充值限制
                defenderRecharges: 0, // 已充值次數
                maxDefenderRecharges: 2, // 最大充值次數
                rechargeLimit: 50000, // 每次充值限額
                // 暗網支付工具餘額 (模擬)
                octopusBalance: 50000,
                alipayBalance: 80000,
                moneroBalance: 15000,
                tornadoBalance: 100000
            },

            // VPN系統
            vpn: {
                active: false,
                provider: null,
                isFake: false, // 防禦者的VPN可能是假的
                currentRegion: '本地',
                availableRegions: ['美國', '日本', '德國', '英國', '新加坡', '香港', '荷蘭'],
                realIP: null,
                maskedIP: null
            },

            // 防火牆系統（雙方共用）
            firewall: {
                level: 50, // 中等強度 (0-100)
                rules: [],
                blockedIPs: [],
                allowedPorts: [80, 443, 22, 21],
                intrusionAttempts: 0
            },

            // 黑客專用 - 監視防禦者能力
            hackerIntel: {
                defenderVisible: true, // 黑客預設可以看到防禦者
                gatheredData: [],
                vpnStatus: null, // 可看到防禦者VPN真假
                passwordsCracked: [],
                filesDecrypted: [],
                accessLevel: 'medium' // low, medium, high, root
            },

            // 防禦者專用 - 需要努力才能看到黑客
            defenderIntel: {
                hackerVisible: false, // 防禦者預設看不到黑客
                observationLevel: 0, // 觀察等級 0-100
                detectedActions: [],
                suspiciousIPs: [],
                alertHistory: []
            },



            // 對戰狀態
            battle: {
                targetIP: '',
                opponentStats: {},
                incomingAttacks: [],
                outgoingAttacks: [],
                connectionQuality: 100,
                aiDifficulty: 'medium',
                aiAttackTimer: null,
                score: { player: 0, ai: 0 },
                // 新增對戰限時系統
                timeLimit: 300, // 對戰時間限制（秒）- 5分鐘
                timeRemaining: 300,
                battleTimer: null,
                // 勝利條件
                playerProgress: 0, // 玩家進度 0-100
                aiProgress: 0, // AI進度 0-100
                // 對戰結果
                battleEnded: false,
                winner: null,
                // 雙方互動訊息
                sharedMessages: [],
                lastPlayerAction: null,
                lastAIAction: null
            },

            // 黑客攻擊模式系統
            hackerAttack: {
                mode: null, // 'direct', 'gradual', 'ransom'
                zombieProgress: 0, // 殭屍化進度 0-100
                isZombified: false, // 是否已完全殭屍化
                gradualStep: 0, // 循序漸進的步驟 0-10
                ransomAmount: 0, // 勒索金額
                ransomPaid: false, // 是否已支付勒索金
                ransomReceived: 0, // 已收到的勒索金
                ransomTimer: null, // 勒索計時器
                ransomTimeLeft: 0, // 剩餘時間
                stolenFunds: 0 // 從防禦者偷取的資金
            },

            // 防禦者課金系統 (用於入侵黑客戶口)
            defenderPayment: {
                hackBudget: 0, // 用於黑客對方戶口的預算
                hackAttempts: 0, // 入侵次數
                stolenFromHacker: 0 // 從黑客偷取的資金
            },

            // AI模擬對手系統
            aiOpponent: {
                active: true, // AI對手是否活躍
                difficulty: 'medium', // easy, medium, hard, expert
                reactionSpeed: 3000, // 反應時間(ms)
                lastAction: null,
                actionCount: 0,
                personality: 'balanced', // aggressive, defensive, balanced, random
                currentActivity: 'idle' // idle, attacking, defending, scanning
            },

            // IP追蹤系統
            ipTracking: {
                isTracking: false,
                targetIP: null,
                progress: 0, // 0-100
                estimatedTime: 0, // 預計時間(秒)
                trackedIPs: [], // 已追蹤的IP列表
                vpnLayers: 0, // 目標的VPN層數
                realIPDiscovered: false
            },

            // 殺毒軟件系統
            antivirus: {
                enabled: true,
                level: 50, // 殺毒軟件等級
                lastScan: null,
                threatsFound: [],
                quarantined: [],
                realTimeProtection: true,
                firewallActive: true
            },

            // 裝置狀態
            deviceStatus: {
                cpu: 45,
                memory: 62,
                disk: 78,
                network: 85,
                temperature: 52,
                processes: 127,
                connections: 23,
                threats: 0
            },

            // 虛假連結系統
            phishingLinks: {
                created: [],
                clicked: 0,
                successRate: 0
            },

            // 釣魚模擬系統
            phishing: {
                activeTemplate: null,
                victimStatus: 'waiting',
                capturedData: [],
                sentCount: 0,
                successCount: 0
            },

            // 漏洞掃描結果
            vulnerabilities: {
                scanned: false,
                found: [],
                exploited: []
            }
        };

        // ===== 雙向實時監控系統 =====
        const MonitoringSystem = {
            hackerMonitoring: {
                isActive: false,
                targetBrowser: null,
                targetActivities: [],
                lastUpdate: 0,
                updateInterval: 500 // 500ms更新一次
            },
            defenderMonitoring: {
                isActive: false,
                hackerBrowser: null,
                hackerActivities: [],
                lastUpdate: 0,
                updateInterval: 500
            },
            
            // 黑客開始監控防禦者
            startHackerMonitoring: function(targetDefenderId) {
                this.hackerMonitoring.isActive = true;
                this.hackerMonitoring.targetBrowser = {
                    ip: '192.168.' + Math.floor(Math.random() * 255) + '.' + Math.floor(Math.random() * 255),
                    browser: ['Chrome', 'Firefox', 'Safari', 'Edge'][Math.floor(Math.random() * 4)],
                    os: ['Windows 10', 'macOS', 'Ubuntu 20.04'][Math.floor(Math.random() * 3)],
                    screenResolution: ['1920x1080', '1366x768', '2560x1440'][Math.floor(Math.random() * 3)],
                    timestamp: new Date().toLocaleTimeString('zh-HK')
                };
        // ===== 反追蹤和延遲警示系統 =====
        const CounterTrackingSystem = {
            defenderDetectedHacker: false,
            hackerDetectedDefender: false,
            warningQueue: [],
            delayedWarnings: {},
            
            // 防禦者檢測到黑客監控
            detectHackerMonitoring: function() {
                if (GameState.battle.hackerMonitoring && !this.defenderDetectedHacker) {
                    this.defenderDetectedHacker = true;
                    
                    // 隨機延遲30秒至1分鐘
                    const delayMs = 30000 + Math.random() * 30000; // 30-60秒
                    
                    addTerminalLog('⚠️ [警告] 系統檢測到異常連接嘗試...');
                    
                    // 設置延遲警示
                    setTimeout(() => {
                        this.sendDefenderWarning();
                    }, delayMs);
                    
                    console.log('延遲警示將在 ' + Math.round(delayMs / 1000) + ' 秒後發送');
                }
            },
            
            // 發送防禦者警示
            sendDefenderWarning: function() {
                const warningMessages = [
                    '⚠️ [警告] 黑客已經看見你的瀏覽器！',
                    '🚨 [緊急] 檢測到黑客監控你的設備！',
                    '⚠️ [警告] 黑客正在監視你的操作！',
                    '🔴 [危險] 黑客已鎖定你的IP地址！',
                    '⚠️ [警告] 檢測到未授權的遠程監控！'
                ];
                
                const message = warningMessages[Math.floor(Math.random() * warningMessages.length)];
                
                // 在終端顯示警示
                addTerminalLog(message);
                
                // 創建警示面板
                const warningPanel = document.createElement('div');
                warningPanel.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
                    border: 2px solid #ff6666;
                    border-radius: 8px;
                    padding: 20px;
                    color: #fff;
                    font-weight: bold;
                    z-index: 10000;
                    box-shadow: 0 0 20px rgba(255,51,51,0.6);
                    animation: pulse 0.5s infinite;
                `;
                warningPanel.innerHTML = `
                    <div style="font-size: 1.2rem; margin-bottom: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> ${message}
                    </div>
                    <div style="font-size: 0.9rem;">
                        黑客已經看到你的瀏覽器設備信息！<br>
                        建議立即啟動反追蹤或尋求第三方支援！
                    </div>
                `;
                
                document.body.appendChild(warningPanel);
                
                // 5秒後移除警示
                setTimeout(() => {
                    warningPanel.remove();
                }, 5000);
                
                GameState.battle.defenderWarningReceived = true;
                GameState.battle.warningTime = new Date().getTime();
            },
            
            // 黑客檢測到防禦者反追蹤
            detectDefenderCounterTracking: function() {
                if (GameState.battle.defenderMonitoring && !this.hackerDetectedDefender) {
                    this.hackerDetectedDefender = true;
                    
                    const warningMessages = [
                        '⚠️ [警告] 防禦者正在反追蹤你！',
                        '🚨 [危險] 檢測到防禦者的追蹤信號！',
                        '⚠️ [警告] 防禦者已鎖定你的連接！',
                        '🔴 [危險] 防禦者正在追蹤你的IP！'
                    ];
                    
                    const message = warningMessages[Math.floor(Math.random() * warningMessages.length)];
                    addTerminalLog(message);
                    
                    GameState.battle.hackerDetectedCounterTracking = true;
                }
            },
            
            // 防禦者發起反擊
            initiateCounterAttack: function() {
                addTerminalLog('⚔️ [反擊] 防禦者發起反擊！');
                addTerminalLog('🔍 [追蹤] 正在追蹤黑客的真實身份...');
                
                // 模擬追蹤過程
                const trackingSteps = [
                    '正在分析網絡流量...',
                    '正在追蹤IP地址...',
                    '正在識別代理鏈...',
                    '正在破解VPN...',
                    '正在定位黑客...'
                ];
                
                let step = 0;
                const trackingInterval = setInterval(() => {
                    if (step < trackingSteps.length) {
                        addTerminalLog('🔍 ' + trackingSteps[step]);
                        step++;
                    } else {
                        clearInterval(trackingInterval);
                        addTerminalLog('✓ [成功] 已識別黑客身份！');
                        GameState.battle.hackerIdentified = true;
                    }
                }, 1500);
            },
            
            // 防禦者啟動快速反擊
            quickCounterAttack: function() {
                if (!GameState.battle.defenderMonitoring) {
                    addTerminalLog('❌ [失敗] 必須先啟動反追蹤才能進行反擊！');
                    return;
                }
                
                addTerminalLog('⚡ [快速反擊] 防禦者發起閃電反擊！');
                
                // 快速反擊需要消耗防禦者的能量
                if (GameState.battle.defenderEnergy < 30) {
                    addTerminalLog('❌ [失敗] 能量不足，無法進行反擊！');
                    return;
                }
                
                GameState.battle.defenderEnergy -= 30;
                GameState.battle.counterAttackActive = true;
                
                // 快速反擊持續10秒
                addTerminalLog('⚡ [反擊] 快速反擊已啟動！黑客防禦力-40%');
                
                setTimeout(() => {
                    GameState.battle.counterAttackActive = false;
                    addTerminalLog('⚡ [反擊] 快速反擊結束');
                }, 10000);
            }
        };
        // ===== 權限爭奪和防禦者反擊機制 =====
        const PrivilegeEscalationSystem = {
            hackerPrivilegeLevel: 0, // 0-100
            defenderPrivilegeLevel: 100, // 0-100
            systemControlStatus: 'defender', // 'defender' 或 'hacker'
            
            // 黑客嘗試提升權限
            hackerEscalatePrivilege: function(packageLevel) {
                // 根據課金套裝等級計算提升速度
                const escalationRate = packageLevel * 5; // 每級課金+5%/秒
                
                addTerminalLog('🔓 [權限提升] 黑客正在嘗試提升系統權限...');
                addTerminalLog('📊 [進度] 權限提升速度: ' + escalationRate + '%/秒');
                
                const escalationInterval = setInterval(() => {
                    this.hackerPrivilegeLevel += escalationRate;
                    
                    if (this.hackerPrivilegeLevel >= 100) {
                        this.hackerPrivilegeLevel = 100;
                        clearInterval(escalationInterval);
                        this.systemControlStatus = 'hacker';
                        
                        addTerminalLog('✓ [成功] 黑客已獲得完全系統控制權！');
                        addTerminalLog('🔴 [警告] 防禦者已失去對系統的控制！');
                        addTerminalLog('💀 [結果] 黑客已拿捏防禦者的所有一切系統權限！');
                        
                        GameState.battle.hackerControlledSystem = true;
                        GameState.battle.gameOver = true;
                        GameState.battle.winner = 'hacker';
                        
                        // 顯示系統控制權轉移
                        this.displayPrivilegeTransfer();
                    }
                }, 1000);
                
                GameState.battle.privilegeEscalationActive = true;
            },
            
            // 防禦者防止權限提升
            defenderBlockPrivilegeEscalation: function() {
                if (GameState.battle.privilegeEscalationActive) {
                    addTerminalLog('🛡️ [防禦] 防禦者正在阻止權限提升...');
                    
                    // 防禦者需要快速反應
                    const blockStrength = 20; // 每次阻止-20%
                    this.hackerPrivilegeLevel = Math.max(0, this.hackerPrivilegeLevel - blockStrength);
                    
                    addTerminalLog('✓ [成功] 已阻止黑客權限提升！黑客權限-' + blockStrength + '%');
                    
                    if (this.hackerPrivilegeLevel <= 0) {
                        GameState.battle.privilegeEscalationActive = false;
                        addTerminalLog('✓ [完全阻止] 黑客的權限提升已被完全阻止！');
                    }
                }
            },
            
            // 防禦者發起系統恢復
            defenderSystemRecovery: function() {
                if (GameState.battle.hackerControlledSystem) {
                    addTerminalLog('⚙️ [恢復] 防禦者正在進行系統恢復...');
                    addTerminalLog('🔄 [進度] 正在重新初始化系統...');
                    
                    // 模擬恢復過程
                    const recoverySteps = [
                        '正在掃描惡意代碼...',
                        '正在隔離受感染的進程...',
                        '正在恢復系統文件...',
                        '正在重置用戶權限...',
                        '正在驗證系統完整性...'
                    ];
                    
                    let step = 0;
                    const recoveryInterval = setInterval(() => {
                        if (step < recoverySteps.length) {
                            addTerminalLog('⚙️ ' + recoverySteps[step]);
                            step++;
                        } else {
                            clearInterval(recoveryInterval);
                            
                            this.hackerPrivilegeLevel = 0;
                            this.defenderPrivilegeLevel = 100;
                            this.systemControlStatus = 'defender';
                            GameState.battle.hackerControlledSystem = false;
                            
                            addTerminalLog('✓ [成功] 系統已完全恢復！');
                            addTerminalLog('🛡️ [防禦者] 重新獲得完全系統控制權！');
                        }
                    }, 1500);
                }
            },
            
            // 顯示權限轉移
            displayPrivilegeTransfer: function() {
                const transferPanel = document.createElement('div');
                transferPanel.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
                    border: 3px solid #ff6666;
                    border-radius: 12px;
                    padding: 40px;
                    color: #fff;
                    text-align: center;
                    z-index: 10001;
                    box-shadow: 0 0 40px rgba(255,51,51,0.8);
                    animation: pulse 0.5s infinite;
                `;
                transferPanel.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 20px; font-weight: bold;">
                        <i class="fas fa-skull-crossbones"></i> 系統控制權轉移
                    </div>
                    <div style="font-size: 1.2rem; margin-bottom: 15px;">
                        黑客已獲得完全系統控制權！
                    </div>
                    <div style="font-size: 1rem; color: #ffcccc;">
                        防禦者已失去對系統的所有控制
                    </div>
                `;
                
                document.body.appendChild(transferPanel);
                
                setTimeout(() => {
                    transferPanel.remove();
                }, 5000);
            },
            
            // 獲取權限狀態
            getPrivilegeStatus: function() {
                return {
                    hackerLevel: this.hackerPrivilegeLevel,
                    defenderLevel: this.defenderPrivilegeLevel,
                    controlledBy: this.systemControlStatus,
                    hackerControlled: this.systemControlStatus === 'hacker'
                };
        // ===== 防禦者上線機制 =====
        const DefenderOnlineSystem = {
            isDefenderOnline: false,
            defenderOperations: [],
            lastOperationTime: 0,
            
            // 防禦者上線
            goOnline: function() {
                this.isDefenderOnline = true;
                GameState.battle.defenderOnline = true;
                
                addTerminalLog('🟢 [防禦者] 已上線');
                addTerminalLog('📡 [信號] 防禦者設備已連接到網絡');
                addTerminalLog('⚠️ [警告] 防禦者現在可被黑客監控');
                
                // 通知黑客防禦者已上線
                if (GameState.battle.hackerMonitoring) {
                    addTerminalLog('🔍 [黑客] 檢測到防禦者已上線！');
                }
            },
            
            // 防禦者執行操作
            recordDefenderOperation: function(operationName) {
                if (!this.isDefenderOnline) {
                    addTerminalLog('❌ [失敗] 防禦者必須先上線才能執行操作');
                    return false;
                }
                
                const operation = {
                    name: operationName,
                    timestamp: new Date().toLocaleTimeString('zh-HK'),
                    time: Date.now()
                };
                
                this.defenderOperations.push(operation);
                this.lastOperationTime = Date.now();
                
                addTerminalLog('📝 [操作] 防禦者執行了: ' + operationName);
                
                return true;
            },
            
            // 獲取防禦者操作列表
            getDefenderOperations: function() {
                return this.defenderOperations.slice(-5); // 返回最後5個操作
            }
        };

        // ===== 黑客即時預覽系統 =====
        const HackerLivePreview = {
            previewActive: false,
            previewRefreshRate: 1000, // 1秒更新一次
            
            // 啟動實時預覽
            startLivePreview: function() {
                if (!GameState.battle.hackerMonitoring) {
                    addTerminalLog('❌ [失敗] 必須先啟動監控才能進行實時預覽');
                    return;
                }
                
                if (!GameState.battle.defenderOnline) {
                    addTerminalLog('❌ [失敗] 防禦者未上線，無法預覽');
                    return;
                }
                
                this.previewActive = true;
                addTerminalLog('📹 [實時預覽] 已啟動防禦者設備的實時監控');
                addTerminalLog('👁️ [監視] 正在實時顯示防禦者的操作...');
                
                // 開始實時更新預覽
                this.updatePreview();
            },
            
            // 更新預覽內容
            updatePreview: function() {
                const self = this;
                
                const previewInterval = setInterval(() => {
                    if (!this.previewActive || !GameState.battle.hackerMonitoring) {
                        clearInterval(previewInterval);
                        return;
                    }
                    
                    const operations = DefenderOnlineSystem.getDefenderOperations();
                    const previewPanel = document.getElementById('hacker-live-preview-panel');
                    
                    if (previewPanel && operations.length > 0) {
                        let previewHTML = `
                            <div style="background: rgba(0,0,0,0.5); border: 2px solid #00ff41; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <h4 style="color: #00ff41; margin-top: 0;">📹 實時預覽 - 防禦者操作</h4>
                                <div style="background: rgba(0,0,0,0.3); border-left: 3px solid #00ff41; padding: 10px; border-radius: 4px; max-height: 150px; overflow-y: auto;">
                        `;
                        
                        operations.forEach(op => {
                            previewHTML += `
                                <div style="margin: 5px 0; padding: 5px; border-bottom: 1px solid rgba(0,255,65,0.2);">
                                    <span style="color: #00ff41;">⏱️ ${op.timestamp}</span> - 
                                    <span style="color: #00ff41;">${op.name}</span>
                                </div>
                            `;
                        });
                        
                        previewHTML += `
                                </div>
                            </div>
                        `;
                        
                        previewPanel.innerHTML = previewHTML;
                    }
                }, this.previewRefreshRate);
            }
        };

        // ===== 高級課金權限奇襲系統 =====
        const PremiumPrivilegeSystem = {
            premiumPackageLevel: 0, // 0-5級
            
            // 黑客購買高級課金套裝
            purchasePremiumPackage: function(level) {
                if (GameState.wallet.hacker < level * 500) {
                    addTerminalLog('❌ [失敗] 金錢不足，無法購買高級套裝');
                    return false;
                }
                
                GameState.wallet.hacker -= level * 500;
                this.premiumPackageLevel = level;
                
                addTerminalLog('💎 [購買] 已購買 ' + level + '級高級課金套裝');
                addTerminalLog('⚡ [效果] 權限提升速度: ' + (level * 20) + '%/秒');
                
                return true;
            },
            
            // 發起快速權限奇襲
            launchPrivilegeRaid: function() {
                if (this.premiumPackageLevel === 0) {
                    addTerminalLog('❌ [失敗] 必須購買高級課金套裝才能進行權限奇襲');
                    return;
                }
                
                if (!GameState.battle.defenderOnline) {
                    addTerminalLog('❌ [失敗] 防禦者未上線，無法進行奇襲');
                    return;
                }
                
                addTerminalLog('⚡ [權限奇襲] 黑客發起快速權限奇襲！');
                addTerminalLog('💥 [強度] 奇襲強度: ' + (this.premiumPackageLevel * 20) + '%');
                
                // 快速提升黑客權限
                const escalationRate = this.premiumPackageLevel * 25; // 每級課金+25%/秒
                let currentRate = 0;
                
                const raidInterval = setInterval(() => {
                    PrivilegeEscalationSystem.hackerPrivilegeLevel += escalationRate;
                    currentRate += escalationRate;
                    
                    if (PrivilegeEscalationSystem.hackerPrivilegeLevel >= 100 || currentRate >= 100) {
                        clearInterval(raidInterval);
                        PrivilegeEscalationSystem.hackerPrivilegeLevel = 100;
                        PrivilegeEscalationSystem.systemControlStatus = 'hacker';
                        
                        addTerminalLog('✓ [成功] 黑客已通過權限奇襲獲得完全控制！');
                        GameState.battle.hackerControlledSystem = true;
                    }
                }, 500); // 每500ms更新一次
            }
        };

        // ===== 防禦者快速反應系統 =====
        const DefenderQuickResponse = {
            reactionTime: 0,
            isReacting: false,
            
            // 防禦者快速反應
            quickReact: function() {
                if (!GameState.battle.defenderOnline) {
                    addTerminalLog('❌ [失敗] 防禦者未上線');
                    return;
                }
                
                if (PrivilegeEscalationSystem.hackerPrivilegeLevel < 50) {
                    addTerminalLog('❌ [失敗] 威脅等級不足，無需快速反應');
                    return;
                }
                
                this.isReacting = true;
                this.reactionTime = Date.now();
                
                addTerminalLog('⚡ [快速反應] 防禦者發起緊急反應！');
                addTerminalLog('🛡️ [防禦] 正在啟動緊急防禦機制...');
                
                // 快速反應可以阻止黑客的權限提升
                const blockAmount = 30;
                PrivilegeEscalationSystem.hackerPrivilegeLevel = Math.max(0, PrivilegeEscalationSystem.hackerPrivilegeLevel - blockAmount);
                
                addTerminalLog('✓ [成功] 已阻止黑客權限提升！黑客權限-' + blockAmount + '%');
                
                // 反應持續5秒
                setTimeout(() => {
                    this.isReacting = false;
                    addTerminalLog('⚡ [反應結束] 防禦者快速反應已結束');
                }, 5000);
            },
            
            // 防禦者發起反擊
            counterAttack: function() {
                if (!GameState.battle.defenderOnline) {
                    addTerminalLog('❌ [失敗] 防禦者未上線');
                    return;
                }
                
                if (!GameState.battle.defenderMonitoring) {
                    addTerminalLog('❌ [失敗] 必須先啟動反追蹤才能進行反擊');
                    return;
                }
                
                addTerminalLog('⚔️ [反擊] 防禦者發起反擊攻擊！');
                addTerminalLog('💥 [攻擊] 正在反擊黑客...');
                
                // 反擊可以直接傷害黑客
                const damageAmount = 25;
                PrivilegeEscalationSystem.hackerPrivilegeLevel = Math.max(0, PrivilegeEscalationSystem.hackerPrivilegeLevel - damageAmount);
                
                addTerminalLog('✓ [命中] 反擊成功！黑客權限-' + damageAmount + '%');
            }
        };

            }
        };


                
                GameState.battle.hackerMonitoring = true;
                GameState.battle.targetBrowserInfo = this.hackerMonitoring.targetBrowser;
                
                addTerminalLog('🔍 [監控] 已鎖定防禦者設備: ' + this.hackerMonitoring.targetBrowser.ip);
                addTerminalLog('📱 [設備] ' + this.hackerMonitoring.targetBrowser.browser + ' / ' + this.hackerMonitoring.targetBrowser.os);
                addTerminalLog('🖥️ [解析度] ' + this.hackerMonitoring.targetBrowser.screenResolution);
                
                // 開始實時監控迴圈
                this.startMonitoringLoop();
            },
            
            // 開始監控迴圈
            startMonitoringLoop: function() {
                const self = this;
                setInterval(() => {
                    if (self.hackerMonitoring.isActive && GameState.currentMode === 'battle') {
                        self.updateHackerMonitoring();
                    }
                }, this.hackerMonitoring.updateInterval);
            },
            
            // 更新黑客監控信息
            updateHackerMonitoring: function() {
                if (!this.hackerMonitoring.isActive) return;
                
                const activities = [
                    '正在瀏覽網頁...',
                    '正在輸入文本...',
                    '正在點擊按鈕...',
                    '正在滾動頁面...',
                    '正在打開新標籤...',
                    '正在下載文件...',
                    '正在查看郵件...',
                    '正在編輯文檔...'
                ];
                
                const currentActivity = activities[Math.floor(Math.random() * activities.length)];
                const monitoringPanel = document.getElementById('hacker-monitoring-panel');
                
                if (monitoringPanel) {
                    monitoringPanel.innerHTML = `
                        <div style="background: rgba(0,0,0,0.5); border: 1px solid #00ff41; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="color: #00ff41; margin-top: 0;">🔴 實時監控 - 防禦者設備</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                                <div><strong>IP地址:</strong> ${this.hackerMonitoring.targetBrowser.ip}</div>
                                <div><strong>瀏覽器:</strong> ${this.hackerMonitoring.targetBrowser.browser}</div>
                                <div><strong>系統:</strong> ${this.hackerMonitoring.targetBrowser.os}</div>
                                <div><strong>解析度:</strong> ${this.hackerMonitoring.targetBrowser.screenResolution}</div>
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: rgba(0,255,65,0.1); border-left: 3px solid #00ff41; border-radius: 4px;">
                                <strong>當前活動:</strong> ${currentActivity}
                            </div>
                            <div style="margin-top: 10px; font-size: 0.85rem; color: #888;">
                                <strong>最後更新:</strong> ${new Date().toLocaleTimeString('zh-HK')}
                            </div>
                        </div>
                    `;
                }
            },
            
            // 防禦者開始監控黑客
            startDefenderMonitoring: function() {
                this.defenderMonitoring.isActive = true;
                this.defenderMonitoring.hackerBrowser = {
                    ip: '10.' + Math.floor(Math.random() * 255) + '.' + Math.floor(Math.random() * 255) + '.' + Math.floor(Math.random() * 255),
                    browser: ['Chrome', 'Firefox', 'Tor Browser'][Math.floor(Math.random() * 3)],
                    os: ['Linux', 'Kali Linux', 'Ubuntu'][Math.floor(Math.random() * 3)],
                    vpnActive: true,
                    proxyChains: Math.floor(Math.random() * 5) + 3,
                    timestamp: new Date().toLocaleTimeString('zh-HK')
                };
                
                GameState.battle.defenderMonitoring = true;
                GameState.battle.hackerBrowserInfo = this.defenderMonitoring.hackerBrowser;
                
                addTerminalLog('🔍 [反追蹤] 已偵測到黑客連接: ' + this.defenderMonitoring.hackerBrowser.ip);
                addTerminalLog('🕵️ [VPN] 檢測到VPN活動，代理鏈數: ' + this.defenderMonitoring.hackerBrowser.proxyChains);
            }
        };

        // ===== 課金商店項目 =====
        const ShopItems = {
            hacker: [
                // 基礎級別 - 入門黑客工具
                { id: 'elite_intrusion', name: '精英入侵套件', price: 15000, effect: { accessLevel: 'high', attackBoost: 20 }, desc: '提升入侵能力，更快突破防火牆', tier: 1, icon: 'fa-door-open' },
                { id: 'crypto_mixer', name: '加密貨幣混幣器', price: 20000, effect: { moneyLaunder: true }, desc: '完全匿名的資金轉移', tier: 1, icon: 'fa-random' },
                { id: 'keylogger_pro', name: '專業鍵盤記錄器', price: 18000, effect: { keylogger: true, stealCredentials: 30 }, desc: '記錄所有按鍵，竊取密碼', tier: 1, icon: 'fa-keyboard' },
                { id: 'phishing_kit', name: '釣魚工具包', price: 12000, effect: { phishingBoost: 25 }, desc: '專業釣魚模板與自動化工具', tier: 1, icon: 'fa-fish' },
                { id: 'password_cracker', name: '密碼破解器', price: 16000, effect: { crackSpeed: 30 }, desc: '高速暴力破解密碼', tier: 1, icon: 'fa-key' },
                { id: 'social_engineer', name: '社會工程工具', price: 14000, effect: { socialBoost: 20 }, desc: '人性弱點利用技術', tier: 1, icon: 'fa-user-secret' },
                // 中級 - 進階滲透工具
                { id: 'ghost_mode', name: '幽靈模式', price: 25000, effect: { stealthBoost: 40, detection: -30 }, desc: '極致隱藏，幾乎無法被檢測', tier: 2, icon: 'fa-ghost' },
                { id: 'identity_vault', name: '身份保險庫', price: 30000, effect: { fakeIdentities: 50 }, desc: '50個無法追蹤的假身份', tier: 2, icon: 'fa-id-card' },
                { id: 'ransomware_kit', name: '勒索軟件工具包', price: 35000, effect: { ransomBoost: 50, encryptSpeed: 2 }, desc: '更快加密，更高勒索成功率', tier: 2, icon: 'fa-lock' },
                { id: 'quantum_decrypt', name: '量子解密器', price: 35000, effect: { decryptPower: 50 }, desc: '破解任何加密文件和密碼', tier: 2, icon: 'fa-unlock-alt' },
                { id: 'exploit_framework', name: '漏洞利用框架', price: 28000, effect: { exploitBoost: 35 }, desc: '自動化漏洞掃描與利用', tier: 2, icon: 'fa-bug' },
                { id: 'trojan_builder', name: '木馬生成器', price: 32000, effect: { trojanPower: 40 }, desc: '生成難以偵測的遠程木馬', tier: 2, icon: 'fa-horse' },
                { id: 'wifi_cracker', name: 'WiFi破解套件', price: 22000, effect: { wifiCrack: true }, desc: '破解無線網絡密碼', tier: 2, icon: 'fa-wifi' },
                { id: 'sql_injection', name: 'SQL注入工具', price: 26000, effect: { sqlBoost: 30 }, desc: '數據庫攻擊專業工具', tier: 2, icon: 'fa-database' },
                // 高級 - 專業攻擊工具
                { id: 'botnet_army', name: '殭屍網絡軍團', price: 40000, effect: { ddosPower: 100, zombies: 100000 }, desc: '10萬台殭屍機供你調用', tier: 3, icon: 'fa-robot' },
                { id: 'root_kit_pro', name: 'Rootkit專業版', price: 45000, effect: { persistence: true, hide: true }, desc: '永久植入後門，完全隱藏', tier: 3, icon: 'fa-user-ninja' },
                { id: 'zero_day', name: '零日漏洞庫', price: 50000, effect: { attackBoost: 35, bypassFirewall: true }, desc: '繞過所有已知防火牆', tier: 3, icon: 'fa-bomb' },
                { id: 'apt_toolkit', name: 'APT攻擊套件', price: 55000, effect: { advancedPersistent: true, undetectable: true }, desc: '高級持續性威脅，長期潛伏', tier: 3, icon: 'fa-spider' },
                { id: 'malware_factory', name: '惡意軟件工廠', price: 48000, effect: { malwareGen: true }, desc: '自動生成多態惡意軟件', tier: 3, icon: 'fa-virus' },
                { id: 'crypto_ransomware', name: '加密勒索變種', price: 52000, effect: { ransomPower: 60 }, desc: '無法解密的勒索軟件', tier: 3, icon: 'fa-file-lock' },
                { id: 'network_sniffer', name: '網絡嗅探器Pro', price: 42000, effect: { snifferPower: 50 }, desc: '攔截並分析網絡流量', tier: 3, icon: 'fa-network-wired' },
                { id: 'backdoor_master', name: '後門大師', price: 46000, effect: { backdoorSlots: 10 }, desc: '同時維護10個隱藏後門', tier: 3, icon: 'fa-door-closed' },
                // 終極級別 - 頂級黑客裝備
                { id: 'darknet_access', name: '暗網完整存取權', price: 75000, effect: { darknetAccess: true, blackMarket: true }, desc: '存取所有暗網資源和黑市', tier: 4, icon: 'fa-moon' },
                { id: 'nation_state', name: '國家級攻擊工具', price: 100000, effect: { nationLevel: true, bypassAll: true }, desc: '國家級別的攻擊能力', tier: 4, icon: 'fa-flag' },
                { id: 'quantum_computer', name: '量子計算存取', price: 150000, effect: { quantumPower: true, breakEncryption: true }, desc: '破解任何現代加密', tier: 4, icon: 'fa-atom' },
                { id: 'ai_hacker', name: 'AI自動攻擊系統', price: 120000, effect: { aiAttack: true, autoExploit: true }, desc: 'AI自動發現並利用漏洞', tier: 4, icon: 'fa-brain' },
                { id: 'cyber_weapon', name: '網絡武器庫', price: 180000, effect: { cyberWeapon: true, criticalHit: 50 }, desc: '可癱瘓關鍵基礎設施', tier: 4, icon: 'fa-crosshairs' },
                { id: 'ghost_network', name: '幽靈網絡', price: 200000, effect: { untraceable: true, globalReach: true }, desc: '完全無法追蹤的全球網絡', tier: 4, icon: 'fa-globe' }
            ],
            defender: [
                // 基礎級別 - 入門防禦工具
                { id: 'threat_intel', name: '威脅情報訂閱', price: 15000, effect: { hackerVisible: 25 }, desc: '獲取黑客行為的部分可見性', tier: 1, icon: 'fa-eye' },
                { id: 'log_analyzer', name: '日誌分析系統', price: 18000, effect: { logAnalysis: true, detectAnomaly: 20 }, desc: '自動分析可疑活動日誌', tier: 1, icon: 'fa-file-alt' },
                { id: 'ai_defender', name: 'AI防禦系統', price: 20000, effect: { autoBlock: true, detectionBoost: 30 }, desc: '自動識別並封鎖威脅', tier: 1, icon: 'fa-robot' },
                { id: 'antivirus_pro', name: '專業防毒軟件', price: 12000, effect: { virusDetect: 30 }, desc: '實時掃描並清除病毒', tier: 1, icon: 'fa-shield-virus' },
                { id: 'email_filter', name: '郵件過濾系統', price: 14000, effect: { phishingBlock: 40 }, desc: '阻擋釣魚郵件攻擊', tier: 1, icon: 'fa-envelope-open-text' },
                { id: 'password_manager', name: '密碼管理器', price: 10000, effect: { passwordStrength: 25 }, desc: '強化密碼安全管理', tier: 1, icon: 'fa-key' },
                { id: 'security_training', name: '安全意識培訓', price: 16000, effect: { socialDefense: 30 }, desc: '員工安全意識提升', tier: 1, icon: 'fa-graduation-cap' },
                // 中級 - 進階防禦工具
                { id: 'honeypot_pro', name: '專業蜜罐網絡', price: 25000, effect: { trapEfficiency: 50 }, desc: '更有效地誘捕攻擊者', tier: 2, icon: 'fa-spider' },
                { id: 'forensic_tools', name: '數位取證工具', price: 30000, effect: { traceBack: true }, desc: '追蹤黑客真實身份', tier: 2, icon: 'fa-search' },
                { id: 'backup_bunker', name: '數據堡壘', price: 35000, effect: { dataProtection: 100 }, desc: '確保數據永不丟失', tier: 2, icon: 'fa-database' },
                { id: 'ids_premium', name: '高級入侵偵測', price: 32000, effect: { intrusionDetect: 80, alertSpeed: 2 }, desc: '即時偵測入侵行為', tier: 2, icon: 'fa-bell' },
                { id: 'network_monitor', name: '網絡監控中心', price: 28000, effect: { networkVisibility: 50 }, desc: '全面監控網絡流量', tier: 2, icon: 'fa-tv' },
                { id: 'access_control', name: '存取控制系統', price: 26000, effect: { accessControl: 40 }, desc: '嚴格控制系統存取權限', tier: 2, icon: 'fa-user-lock' },
                { id: 'patch_manager', name: '補丁管���系統', price: 22000, effect: { vulnerabilityFix: 35 }, desc: '自動更新安全補丁', tier: 2, icon: 'fa-wrench' },
                { id: 'endpoint_protect', name: '端點防護平台', price: 30000, effect: { endpointSecurity: 45 }, desc: '保護所有終端設備', tier: 2, icon: 'fa-laptop-medical' },
                // 高級 - 專業防禦工具
                { id: 'firewall_ultra', name: '超級防火牆', price: 40000, effect: { firewallBoost: 50 }, desc: '最高級別防火牆防護', tier: 3, icon: 'fa-fire' },
                { id: 'counter_hack', name: '反擊套件', price: 45000, effect: { counterAttack: true }, desc: '自動反擊入侵者', tier: 3, icon: 'fa-fist-raised' },
                { id: 'encryption_max', name: '軍事級加密', price: 50000, effect: { encryptionLevel: 100 }, desc: '無法破解的數據加密', tier: 3, icon: 'fa-lock' },
                { id: 'soc_team', name: 'SOC團隊支援', price: 55000, effect: { socSupport: true, response247: true }, desc: '24/7專業安全團隊支援', tier: 3, icon: 'fa-users' },
                { id: 'threat_hunting', name: '威脅獵捕系統', price: 48000, effect: { proactiveDetect: 60 }, desc: '主動搜索潛在威脅', tier: 3, icon: 'fa-binoculars' },
                { id: 'sandbox_pro', name: '沙盒分析環境', price: 42000, effect: { malwareAnalysis: true }, desc: '安全分析可疑文件', tier: 3, icon: 'fa-box' },
                { id: 'ddos_shield', name: 'DDoS防護盾', price: 46000, effect: { ddosProtect: 80 }, desc: '抵禦大規模DDoS攻擊', tier: 3, icon: 'fa-shield-alt' },
                { id: 'incident_response', name: '事件響應平台', price: 52000, effect: { responseSpeed: 70 }, desc: '快速處理安全事件', tier: 3, icon: 'fa-ambulance' },
                // 終極級別 - 頂級防禦裝備
                { id: 'zero_trust', name: '零信任架構', price: 75000, effect: { zeroTrust: true, noBypass: true }, desc: '完全零信任安全架構', tier: 4, icon: 'fa-user-shield' },
                { id: 'cyber_insurance', name: '網絡安全保險', price: 80000, effect: { insurance: true, ransomCover: 500000 }, desc: '勒索金保險，最高50萬', tier: 4, icon: 'fa-file-invoice-dollar' },
                { id: 'govt_protection', name: '政府級防護', price: 120000, effect: { govtLevel: true, immuneRansom: true }, desc: '政府級別防護，免疫勒索', tier: 4, icon: 'fa-landmark' },
                { id: 'ai_security', name: 'AI安全大腦', price: 100000, effect: { aiDefense: true, predictAttack: true }, desc: 'AI預測並阻止攻擊', tier: 4, icon: 'fa-brain' },
                { id: 'quantum_safe', name: '量子安全加密', price: 150000, effect: { quantumResist: true }, desc: '抵禦量子計算攻擊', tier: 4, icon: 'fa-atom' },
                { id: 'cyber_fortress', name: '網絡堡壘', price: 180000, effect: { ultimateDefense: true, allProtect: true }, desc: '終極防禦系統', tier: 4, icon: 'fa-chess-rook' }
            ],
            // VPN服務 - 僅限黑客模式使用
            vpn: [
                { id: 'cheap_vpn', name: '免費VPN (可能假)', price: 500, isFake: 'random', desc: '便宜但風險高', icon: 'fa-question-circle' },
                { id: 'sus_vpn', name: '神秘VPN (可能假)', price: 1000, isFake: 'random', desc: '來源不明的VPN', icon: 'fa-mask' },
                { id: 'basic_vpn', name: '基礎VPN (真)', price: 3000, isFake: false, desc: '基本匿名保護', icon: 'fa-shield-alt' },
                { id: 'premium_vpn', name: '高級VPN (真)', price: 5000, isFake: false, desc: '100%真實匿名VPN', icon: 'fa-shield-alt' },
                { id: 'ultra_vpn', name: '超級VPN (真)', price: 10000, isFake: false, desc: '軍事級加密VPN', icon: 'fa-user-secret' },
                { id: 'multi_hop', name: '多跳VPN (真)', price: 15000, isFake: false, desc: '多層加密，極難追蹤', icon: 'fa-route' },
                { id: 'onion_vpn', name: '洋蔥路由VPN', price: 20000, isFake: false, desc: 'Tor網絡���合，極致匿名', icon: 'fa-globe' },
                { id: 'quantum_vpn', name: '量子加密VPN', price: 35000, isFake: false, desc: '量子加密，未來防護', icon: 'fa-atom' }
            ],
            // 防禦者專屬服務
            defenderServices: [
                { id: 'security_audit', name: '安全審計服務', price: 8000, effect: { auditBoost: 20 }, desc: '專業安全漏洞評估', tier: 1, icon: 'fa-clipboard-check' },
                { id: 'compliance_check', name: '合規檢查服務', price: 10000, effect: { complianceScore: 25 }, desc: '確保符合安全標準', tier: 1, icon: 'fa-balance-scale' },
                { id: 'penetration_test', name: '滲透測試服務', price: 25000, effect: { vulnerabilityFind: 40 }, desc: '模擬攻擊找出弱點', tier: 2, icon: 'fa-crosshairs' },
                { id: 'red_team', name: '紅隊演練', price: 45000, effect: { readinessBoost: 50 }, desc: '專業紅隊模擬攻擊', tier: 3, icon: 'fa-chess-knight' },
                { id: 'incident_retainer', name: '應急響應預約', price: 60000, effect: { emergencySupport: true }, desc: '緊急事件優先支援', tier: 3, icon: 'fa-phone-volume' },
                { id: 'cyber_intel', name: '網絡情報訂閱', price: 35000, effect: { threatIntel: 60 }, desc: '即時威脅情報更新', tier: 2, icon: 'fa-satellite-dish' }
            ]
        };

        // ===== DOM元素引用 =====
        let mainPage, gamePage, battleSelectPage;
        let terminalInput, terminalOutput, terminalBody;
        let toolsGrid, networkMap, attackLog;

        // ===== 初始化 =====
        function init() {
            console.log("初始化遊戲系統...");

            // 獲取DOM元素
            mainPage = document.getElementById('main-page');
            gamePage = document.getElementById('game-page');
            battleSelectPage = document.getElementById('battle-select-page');

            // 初始化聲音系統
            SoundSystem.init();

            // 初始化晝夜循環
            DayNightCycle.init();

            // 加載保存的設置
            loadSettings();

            // 設置事件監聽器
            setupEventListeners();

            // 隨機生成玩家IP
            generatePlayerIP();
        }

        // ===== 設置事件監聽器 =====
        function setupEventListeners() {
            // 獨立模式選擇按鈕（不進入對戰）
            document.getElementById('hacker-btn').addEventListener('click', () => startSoloGame('hacker'));
            document.getElementById('defender-btn').addEventListener('click', () => startSoloGame('defender'));

            // 獨立模式卡片
            document.getElementById('hacker-card').addEventListener('click', (e) => {
                if (e.target.closest('.select-btn')) return;
                startSoloGame('hacker');
            });
            document.getElementById('defender-card').addEventListener('click', (e) => {
                if (e.target.closest('.select-btn')) return;
                startSoloGame('defender');
            });

            // 對戰模式按鈕
            document.getElementById('battle-btn').addEventListener('click', showBattleSelect);
            document.getElementById('battle-card').addEventListener('click', (e) => {
                if (e.target.closest('.select-btn')) return;
                showBattleSelect();
            });

            // 對戰模式選擇頁面按鈕
            document.getElementById('battle-start-hacker').addEventListener('click', (e) => {
                e.stopPropagation();
                startBattleGame('hacker');
            });
            document.getElementById('battle-start-defender').addEventListener('click', (e) => {
                e.stopPropagation();
                startBattleGame('defender');
            });
            document.getElementById('battle-back-btn').addEventListener('click', backToMainFromBattle);

            // 對戰選擇頁面卡片���擊
            document.getElementById('battle-hacker-card').addEventListener('click', (e) => {
                if (!e.target.closest('.select-btn')) {
                    startBattleGame('hacker');
                }
            });
            document.getElementById('battle-defender-card').addEventListener('click', (e) => {
                if (!e.target.closest('.select-btn')) {
                    startBattleGame('defender');
                }
            });

            // 說明指南和流程圖按鈕
            const guideBtn = document.getElementById('guide-btn');
            const flowchartBtn = document.getElementById('flowchart-btn');
            const guideBackBtn = document.getElementById('guide-back-btn');
            const flowchartBackBtn = document.getElementById('flowchart-back-btn');

            if (guideBtn) guideBtn.addEventListener('click', showGuide);
            if (flowchartBtn) flowchartBtn.addEventListener('click', showFlowchart);
            if (guideBackBtn) guideBackBtn.addEventListener('click', backToMainFromGuide);
            if (flowchartBackBtn) flowchartBackBtn.addEventListener('click', backToMainFromFlowchart);

            // 設置輸入
            document.getElementById('target-ip').addEventListener('change', updateTargetIP);
            document.getElementById('game-difficulty').addEventListener('change', updateDifficulty);

            console.log("事件監聽器設置完成");
        }

        // ===== 加載設置 =====
        function loadSettings() {
            const saved = MemoryStorage.getItem(GameConfig.STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    GameConfig.settings = { ...GameConfig.settings, ...data.settings };

                    // 更新UI
                    document.getElementById('player-ip').value = GameConfig.settings.playerIP;
                    document.getElementById('target-ip').value = GameConfig.settings.targetIP;
                    document.getElementById('game-difficulty').value = GameConfig.settings.difficulty;

                    console.log("設置已加載");
                } catch (e) {
                    console.error("加載設置失敗:", e);
                }
            }
        }

        // ===== 保存設置 =====
        function saveSettings() {
            const data = {
                settings: GameConfig.settings,
                timestamp: new Date().toISOString()
            };

            try {
                MemoryStorage.setItem(GameConfig.STORAGE_KEY, JSON.stringify(data));
                console.log("設置已保存");
            } catch (e) {
                console.error("保存設置失敗:", e);
            }
        }

        // ===== 生成玩家IP =====
        function generatePlayerIP() {
            const randomPart = Math.floor(Math.random() * 255);
            const ip = `192.168.1.${100 + randomPart}`;
            GameConfig.settings.playerIP = ip;
            document.getElementById('player-ip').value = ip;
            saveSettings();
        }

        // ===== 更新目標IP =====
        function updateTargetIP() {
            const targetIP = document.getElementById('target-ip').value.trim();
            GameConfig.settings.targetIP = targetIP;
            GameState.battle.targetIP = targetIP;
            saveSettings();
            
            console.log(`目標IP設置為: ${targetIP}`);
        }

        // ===== 更新難度 =====
        function updateDifficulty() {
            const difficulty = document.getElementById('game-difficulty').value;
            GameConfig.settings.difficulty = difficulty;
            saveSettings();
            
            console.log(`遊戲難度設置為: ${difficulty}`);
        }

        // ===== 顯示對戰模式選擇頁面 =====
        function showBattleSelect() {
            console.log("進入對戰模式選擇...");
            SoundSystem.play('success');

            // ���藏主頁，顯示對戰選擇頁
            mainPage.classList.remove('active');
            mainPage.classList.add('hidden');

            battleSelectPage.classList.remove('hidden');
            battleSelectPage.classList.add('active');

            // 更新對戰頁面的玩家IP
            const battlePlayerIP = document.getElementById('battle-player-ip');
            if (battlePlayerIP) {
                battlePlayerIP.value = GameConfig.settings.playerIP;
            }
        }

        // ===== 從對戰選擇返回主頁 =====
        function backToMainFromBattle() {
            console.log("返回主選單...");

            battleSelectPage.classList.remove('active');
            battleSelectPage.classList.add('hidden');

            mainPage.classList.remove('hidden');
            mainPage.classList.add('active');
        }

        // ===== 顯示操作說明指南 =====
        function showGuide() {
            console.log("顯示操作說明指南...");
            SoundSystem.play('success');

            mainPage.classList.remove('active');
            mainPage.classList.add('hidden');

            const guidePage = document.getElementById('guide-page');
            guidePage.classList.remove('hidden');
            guidePage.classList.add('active');
        }

        // ===== 從指南返回主頁 =====
        function backToMainFromGuide() {
            console.log("從指南返回主選單...");

            const guidePage = document.getElementById('guide-page');
            guidePage.classList.remove('active');
            guidePage.classList.add('hidden');

            mainPage.classList.remove('hidden');
            mainPage.classList.add('active');
        }

        // ===== 顯示流程示範圖 =====
        function showFlowchart() {
            console.log("顯示流程示範圖...");
            SoundSystem.play('success');

            mainPage.classList.remove('active');
            mainPage.classList.add('hidden');

            const flowchartPage = document.getElementById('flowchart-page');
            flowchartPage.classList.remove('hidden');
            flowchartPage.classList.add('active');
        }

        // ===== 從流程圖返回主頁 =====
        function backToMainFromFlowchart() {
            console.log("從流程圖返回主選單...");

            const flowchartPage = document.getElementById('flowchart-page');
            flowchartPage.classList.remove('active');
            flowchartPage.classList.add('hidden');

            mainPage.classList.remove('hidden');
            mainPage.classList.add('active');
        }

        // ===== 獨立模式遊戲（無對戰） =====
        function startSoloGame(mode) {
            console.log(`開始獨立 ${mode} 模式...`);
            GameState.isBattleMode = false;
            SoundSystem.play('success');

            // 設置預設AI目標
            GameState.battle.targetIP = GameConfig.opponent[mode === 'hacker' ? 'defender' : 'hacker'].ip;

            startGame(mode);
        }

        // ===== 對戰模式遊戲 =====
        function startBattleGame(mode) {
            console.log(`開始對戰 ${mode} 模式...`);

            // 獲取對戰設置
            const targetIP = document.getElementById('battle-target-ip').value.trim();
            let difficulty = document.getElementById('battle-difficulty').value;

            if (!targetIP) {
                showAlertModal('錯誤', '請輸入目標IP地址才能開始對戰！');
                return;
            }

            // 處理隨機難度 - 60%簡單、30%中等、10%困難
            if (difficulty === 'random') {
                const rand = Math.random();
                if (rand < 0.6) {
                    difficulty = 'easy';
                } else if (rand < 0.9) {
                    difficulty = 'medium';
                } else {
                    difficulty = 'hard';
                }
                console.log(`隨機選擇難度: ${difficulty}`);
            }

            // 根據難度設定時限 - 簡單7分鐘、中等5分鐘、困難3分鐘
            const timeLimits = { easy: 420, medium: 300, hard: 180 };
            GameState.battle.timeLimit = timeLimits[difficulty] || 300;

            GameState.isBattleMode = true;
            GameState.battle.targetIP = targetIP;
            GameState.battle.aiDifficulty = difficulty;
            GameConfig.settings.difficulty = difficulty;

            // 重置對戰狀態
            GameState.battle.timeRemaining = GameState.battle.timeLimit;
            GameState.battle.playerProgress = 0;
            GameState.battle.aiProgress = 0;
            GameState.battle.battleEnded = false;
            GameState.battle.winner = null;
            GameState.battle.score = { player: 0, ai: 0 };
            GameState.battle.sharedMessages = [];

            SoundSystem.play('attack');

            // 隱藏對戰選擇頁，顯示遊戲頁
            battleSelectPage.classList.remove('active');
            battleSelectPage.classList.add('hidden');

            startGame(mode);

            // 啟動AI對手
            startAIOpponent(mode, difficulty);

            // 啟動對戰計時器
            startBattleTimer(mode);

            // 顯示對戰開始提示
            showBattleStartNotification(mode, difficulty);
        }

        // ===== 對戰開始提示 =====
        function showBattleStartNotification(mode, difficulty) {
            const difficultyNames = { easy: '簡單', medium: '中等', hard: '困難' };
            const difficultyColors = { easy: '#00ff41', medium: '#ff9900', hard: '#ff3333' };
            const timeNames = { easy: '7分鐘', medium: '5分鐘', hard: '3分鐘' };
            const modeNames = { hacker: '黑客', defender: '防禦者' };
            const opponentMode = mode === 'hacker' ? 'defender' : 'hacker';

            addTerminalLine('═══════════════════════════════════════', 'system');
            addTerminalLine('⚔️  對  戰  開  始  ⚔️', 'command');
            addTerminalLine('═══════════════════════════════════════', 'system');
            addTerminalLine(`🎮 你的角色: ${modeNames[mode]}`, 'success');
            addTerminalLine(`🤖 AI對手: ${modeNames[opponentMode]} (難度: ${difficultyNames[difficulty]})`, 'warning');
            addTerminalLine(`⏱️ 對戰時間: ${timeNames[difficulty]}`, 'system');
            addTerminalLine(`🎯 目標: ${mode === 'hacker' ? '入侵並控制目標系統' : '防禦並擊退黑客攻擊'}`, 'system');
            addTerminalLine('═══════════════════════════════════════', 'system');

            // 根據難度顯示不同提示
            if (difficulty === 'easy') {
                addTerminalLine('💡 簡單模式: AI反應較慢，你有更多時間準備！', 'success');
            } else if (difficulty === 'medium') {
                addTerminalLine('💡 中等模式: 標準對戰，平衡攻防！', 'response');
            } else {
                addTerminalLine('⚠️ 困難模式: AI反應迅速，需快速行動！', 'alert');
            }

            if (mode === 'hacker') {
                addTerminalLine('💡 提示: 使用「攻擊模式」快速殭屍化對方系統！', 'response');
            } else {
                addTerminalLine('💡 提示: 使用「反擊課金」入侵黑客戶口反擊！', 'response');
            }
        }

        // ===== 對戰計時器 =====
        function startBattleTimer(mode) {
            // 清除舊計時器
            if (GameState.battle.battleTimer) {
                clearInterval(GameState.battle.battleTimer);
            }

            // 創建計時器顯示
            updateBattleTimerDisplay();

            GameState.battle.battleTimer = setInterval(() => {
                if (GameState.battle.battleEnded) {
                    clearInterval(GameState.battle.battleTimer);
                    return;
                }

                GameState.battle.timeRemaining--;
                updateBattleTimerDisplay();

                // 每30秒提醒
                if (GameState.battle.timeRemaining > 0 && GameState.battle.timeRemaining % 30 === 0) {
                    addTerminalLine(`⏰ 剩餘時間: ${Math.floor(GameState.battle.timeRemaining / 60)}:${(GameState.battle.timeRemaining % 60).toString().padStart(2, '0')}`, 'warning');
                }

                // 最後30秒警告
                if (GameState.battle.timeRemaining === 30) {
                    addTerminalLine('⚠️ 警告: 只剩30秒！加快行動！', 'alert');
                    SoundSystem.play('alert');
                }

                // 時間到
                if (GameState.battle.timeRemaining <= 0) {
                    clearInterval(GameState.battle.battleTimer);
                    determineBattleWinner(mode);
                }
            }, 1000);
        }

        // ===== 更新計時器顯示 =====
        function updateBattleTimerDisplay() {
            const timerElement = document.getElementById('battle-timer-display');
            if (timerElement) {
                const minutes = Math.floor(GameState.battle.timeRemaining / 60);
                const seconds = GameState.battle.timeRemaining % 60;
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                // 時間少於60秒變紅色
                if (GameState.battle.timeRemaining <= 60) {
                    timerElement.style.color = '#ff3333';
                    timerElement.style.animation = 'pulse 1s infinite';
                } else {
                    timerElement.style.color = '#ffaa00';
                    timerElement.style.animation = 'none';
                }
            }

            // 更新進度條
            updateBattleProgressDisplay();
        }

        // ===== 更新對戰進度顯示 =====
        function updateBattleProgressDisplay() {
            const playerBar = document.getElementById('player-progress-bar');
            const aiBar = document.getElementById('ai-progress-bar');
            const playerText = document.getElementById('player-progress-text');
            const aiText = document.getElementById('ai-progress-text');

            if (playerBar) playerBar.style.width = `${GameState.battle.playerProgress}%`;
            if (aiBar) aiBar.style.width = `${GameState.battle.aiProgress}%`;
            if (playerText) playerText.textContent = `${GameState.battle.playerProgress}%`;
            if (aiText) aiText.textContent = `${GameState.battle.aiProgress}%`;
        }

        // ===== 決定對戰勝負 =====
        function determineBattleWinner(mode) {
            GameState.battle.battleEnded = true;

            // 停止AI
            if (GameState.battle.aiAttackTimer) {
                clearInterval(GameState.battle.aiAttackTimer);
            }

            let winner;
            let resultMessage;

            // 判斷勝負 - 根據進度和分數
            const playerScore = GameState.battle.playerProgress + GameState.battle.score.player;
            const aiScore = GameState.battle.aiProgress + GameState.battle.score.ai;

            if (mode === 'hacker') {
                // 黑客模式：檢查殭屍化進度
                if (GameState.hackerAttack.zombieProgress >= 100) {
                    winner = 'player';
                    resultMessage = '你成功完全控制了目標系統！';
                } else if (playerScore > aiScore) {
                    winner = 'player';
                    resultMessage = `你的攻擊更有效！(${playerScore} vs ${aiScore})`;
                } else if (aiScore > playerScore) {
                    winner = 'ai';
                    resultMessage = `防禦者成功阻擋了你的攻擊！(${aiScore} vs ${playerScore})`;
                } else {
                    winner = 'draw';
                    resultMessage = '雙方勢均力敵，平局收場！';
                }
            } else {
                // 防禦者模式：檢查系統健康
                if (GameState.stats.systemHealth > 50) {
                    winner = 'player';
                    resultMessage = '你成功保護了系統！';
                } else if (playerScore > aiScore) {
                    winner = 'player';
                    resultMessage = `你的防禦更加穩固！(${playerScore} vs ${aiScore})`;
                } else if (aiScore > playerScore) {
                    winner = 'ai';
                    resultMessage = `黑客突破了你的防線！(${aiScore} vs ${playerScore})`;
                } else {
                    winner = 'draw';
                    resultMessage = '雙方勢均力敵，平局收場！';
                }
            }

            GameState.battle.winner = winner;
            showBattleResult(winner, resultMessage, mode);
        }

        // ===== 啟動AI對手 =====
        function startAIOpponent(playerMode, difficulty) {
            const aiMode = playerMode === 'hacker' ? 'defender' : 'hacker';
            const intervals = { easy: 8000, medium: 5000, hard: 3000 };
            const interval = intervals[difficulty] || 5000;

            console.log(`AI對手 (${aiMode}) 已啟動，難度: ${difficulty}`);

            // 清除舊的AI計時器
            if (GameState.battle.aiAttackTimer) {
                clearInterval(GameState.battle.aiAttackTimer);
            }

            // 啟動AI行動計時器
            GameState.battle.aiAttackTimer = setInterval(() => {
                if (!GameState.battleActive) return;

                executeAIAction(aiMode, difficulty);
            }, interval);
        }

        // ===== 執行AI行動 =====
        function executeAIAction(aiMode, difficulty) {
            if (GameState.battle.battleEnded) return;

            const config = GameConfig[aiMode];
            const categories = Object.values(config.toolCategories);
            const allTools = categories.flatMap(cat => cat.tools);

            // 隨機選擇一個工具
            const tool = allTools[Math.floor(Math.random() * allTools.length)];

            // 記錄AI最後行動
            GameState.battle.lastAIAction = { tool: tool.name, time: Date.now() };

            // 添加到共享訊息（雙方互動）
            GameState.battle.sharedMessages.push({
                from: aiMode,
                action: tool.name,
                time: Date.now()
            });

            if (aiMode === 'hacker') {
                // AI黑客攻擊玩家（防禦者模式）
                addTerminalLine(`[警報] 檢測到來自 ${GameState.battle.targetIP} 的攻擊: ${tool.name}`, 'alert');
                SoundSystem.play('alert');

                // 降低玩家防禦/系統健康
                if (GameState.stats.systemHealth !== undefined) {
                    const baseDamage = difficulty === 'hard' ? 15 : difficulty === 'medium' ? 10 : 5;
                    const damage = Math.floor(Math.random() * baseDamage) + baseDamage / 2;
                    GameState.stats.systemHealth = Math.max(0, GameState.stats.systemHealth - damage);
                    updateStatsDisplay('defender');

                    // 更新AI進度
                    GameState.battle.aiProgress = Math.min(100, GameState.battle.aiProgress + Math.floor(damage / 2));

                    if (GameState.stats.systemHealth <= 0) {
                        endBattle('lose');
                        return;
                    }
                }

                GameState.battle.score.ai += 10;
            } else {
                // AI防禦���阻擋玩家（黑客模式）
                const blockChance = difficulty === 'hard' ? 0.7 : difficulty === 'medium' ? 0.5 : 0.3;

                if (Math.random() < blockChance) {
                    addTerminalLine(`[防禦] 目標系統使用 ${tool.name} 阻擋了你的攻擊！`, 'warning');
                    SoundSystem.play('defense');

                    // 增加檢測風險
                    if (GameState.stats.detectionRisk !== undefined) {
                        const riskIncrease = difficulty === 'hard' ? 15 : difficulty === 'medium' ? 10 : 5;
                        GameState.stats.detectionRisk = Math.min(100, GameState.stats.detectionRisk + riskIncrease);
                        updateStatsDisplay('hacker');

                        // 更新AI進度
                        GameState.battle.aiProgress = Math.min(100, GameState.battle.aiProgress + Math.floor(riskIncrease / 2));

                        if (GameState.stats.detectionRisk >= 100) {
                            endBattle('lose');
                            return;
                        }
                    }

                    // AI防禦者有機會反擊入侵黑客資金
                    if (Math.random() < 0.2) {
                        const stolenAmount = Math.floor(Math.random() * 5000) + 1000;
                        if (GameState.wallet.balance >= stolenAmount) {
                            GameState.wallet.balance -= stolenAmount;
                            addTerminalLine(`💰 [反擊] AI防禦者從你的錢包偷取了 $${stolenAmount.toLocaleString()}！`, 'error');
                            updateWalletDisplay();
                        }
                    }
                } else {
                    // AI沒能阻擋 - 玩家進度增加
                    GameState.battle.playerProgress = Math.min(100, GameState.battle.playerProgress + 3);
                }

                GameState.battle.score.ai += 5;
            }

            // 更新分數顯示
            updateBattleScoreDisplay();
            updateBattleProgressDisplay();

            addAttackLog(`[AI] ${aiMode === 'hacker' ? '攻擊' : '防禦'}: ${tool.name}`);
        }

        // ===== 更新對戰分數顯示 =====
        function updateBattleScoreDisplay() {
            const playerScoreEl = document.getElementById('player-score-display');
            const aiScoreEl = document.getElementById('ai-score-display');

            if (playerScoreEl) playerScoreEl.textContent = GameState.battle.score.player;
            if (aiScoreEl) aiScoreEl.textContent = GameState.battle.score.ai;
        }

        // ===== 玩家行動增加進度 =====
        function addPlayerBattleProgress(amount) {
            if (!GameState.isBattleMode || GameState.battle.battleEnded) return;

            GameState.battle.playerProgress = Math.min(100, GameState.battle.playerProgress + amount);
            GameState.battle.score.player += amount * 2;

            updateBattleProgressDisplay();
            updateBattleScoreDisplay();

            // 檢查勝利條件
            if (GameState.battle.playerProgress >= 100) {
                endBattle('win');
            }
        }

        // ===== 結束對戰 =====
        function endBattle(result) {
            GameState.battleActive = false;
            GameState.battle.battleEnded = true;

            // 停止所有計時器
            if (GameState.battle.aiAttackTimer) {
                clearInterval(GameState.battle.aiAttackTimer);
                GameState.battle.aiAttackTimer = null;
            }
            if (GameState.battle.battleTimer) {
                clearInterval(GameState.battle.battleTimer);
                GameState.battle.battleTimer = null;
            }

            const mode = GameState.currentMode;
            let resultMessage;

            if (result === 'win') {
                GameState.battle.winner = 'player';
                resultMessage = mode === 'hacker' ? '成功入侵���控制目標系統！' : '成功擊退黑客攻擊！';
                showBattleResult('player', resultMessage, mode);
            } else {
                GameState.battle.winner = 'ai';
                resultMessage = mode === 'hacker' ? '被防禦者擊敗！' : '系統被黑客攻陷！';
                showBattleResult('ai', resultMessage, mode);
            }
        }

        // ===== 顯示對戰結果 =====
        function showBattleResult(winner, message, mode) {
            const isPlayerWin = winner === 'player';
            const isDraw = winner === 'draw';

            // 計算獎勵
            let reward = 0;
            if (isPlayerWin) {
                reward = 50000 + (GameState.battle.score.player * 100);
            } else if (isDraw) {
                reward = 10000;
            }

            // 添加獎勵
            if (reward > 0) {
                GameState.wallet.balance += reward;
                updateWalletDisplay();
            }

            const resultHTML = `
                <div class="modal-overlay" id="battle-result-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 600px; background: linear-gradient(135deg, ${isPlayerWin ? 'rgba(39,174,96,0.95)' : isDraw ? 'rgba(255,153,0,0.95)' : 'rgba(231,76,60,0.95)'} 0%, ${isPlayerWin ? 'rgba(30,130,70,0.95)' : isDraw ? 'rgba(200,120,0,0.95)' : 'rgba(180,50,40,0.95)'} 100%); border: 3px solid ${isPlayerWin ? '#27ae60' : isDraw ? '#ff9900' : '#e74c3c'}; text-align: center;">

                        <div style="font-size: 5rem; margin-bottom: 20px;">
                            ${isPlayerWin ? '🏆' : isDraw ? '🤝' : '💀'}
                        </div>

                        <h2 style="color: #fff; font-size: 2.5rem; margin-bottom: 15px; text-shadow: 0 2px 10px rgba(0,0,0,0.5);">
                            ${isPlayerWin ? '勝 利 ！' : isDraw ? '平 局' : '失 敗'}
                        </h2>

                        <p style="color: rgba(255,255,255,0.9); font-size: 1.2rem; margin-bottom: 25px;">
                            ${message}
                        </p>

                        <!-- 對戰統計 -->
                        <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                            <h3 style="color: #fff; margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> 對戰統計</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div>
                                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">你的得分</div>
                                    <div style="color: #fff; font-size: 1.5rem; font-weight: bold;">${GameState.battle.score.player}</div>
                                </div>
                                <div>
                                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">AI得分</div>
                                    <div style="color: #fff; font-size: 1.5rem; font-weight: bold;">${GameState.battle.score.ai}</div>
                                </div>
                                <div>
                                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">對戰時長</div>
                                    <div style="color: #fff; font-size: 1.5rem; font-weight: bold;">${formatTime(GameState.battle.timeLimit - GameState.battle.timeRemaining)}</div>
                                </div>
                            </div>
                            ${mode === 'hacker' ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                                    <div style="color: rgba(255,255,255,0.7);">殭屍化進度: <span style="color: #fff; font-weight: bold;">${GameState.hackerAttack.zombieProgress}%</span></div>
                                </div>
                            ` : `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                                    <div style="color: rgba(255,255,255,0.7);">系統健康: <span style="color: #fff; font-weight: bold;">${GameState.stats.systemHealth || 0}%</span></div>
                                </div>
                            `}
                        </div>

                        ${reward > 0 ? `
                            <div style="background: rgba(0,255,65,0.2); border: 1px solid #00ff41; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                                <div style="color: #00ff41; font-size: 1.3rem; font-weight: bold;">
                                    <i class="fas fa-coins"></i> 獲得獎勵: $${reward.toLocaleString()}
                                </div>
                            </div>
                        ` : ''}

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button onclick="restartBattle()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none; padding: 15px 25px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem; font-weight: bold;">
                                <i class="fas fa-redo"></i> 再戰一次
                            </button>
                            <button onclick="closeBattleResult(); backToMain();" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); padding: 15px 25px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem; font-weight: bold;">
                                <i class="fas fa-home"></i> 返回主選單
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', resultHTML);
            SoundSystem.play(isPlayerWin ? 'success' : 'error');

            // 終端輸出
            addTerminalLine('═══════════════════════════════════════', 'system');
            addTerminalLine(`${isPlayerWin ? '🏆 勝利' : isDraw ? '🤝 平局' : '💀 失敗'} - ${message}`, isPlayerWin ? 'success' : isDraw ? 'warning' : 'error');
            addTerminalLine(`得分: 你 ${GameState.battle.score.player} vs AI ${GameState.battle.score.ai}`, 'system');
            if (reward > 0) {
                addTerminalLine(`💰 獲得獎勵: $${reward.toLocaleString()}`, 'success');
            }
            addTerminalLine('═══════════════════════════════════════', 'system');
        }

        // 格式化時間
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 關閉對戰結果
        function closeBattleResult() {
            const modal = document.getElementById('battle-result-modal');
            if (modal) modal.remove();
        }

        // 重新開始對戰
        function restartBattle() {
            closeBattleResult();

            // 重置狀態
            GameState.hackerAttack.zombieProgress = 0;
            GameState.hackerAttack.isZombified = false;
            GameState.hackerAttack.gradualStep = 0;
            GameState.hackerAttack.mode = null;

            // 返回對戰選擇頁
            gamePage.classList.remove('active');
            gamePage.classList.add('hidden');
            battleSelectPage.classList.remove('hidden');
            battleSelectPage.classList.add('active');
        }

        // ===== 開始遊戲 =====
        function startGame(mode) {
            console.log(`開始 ${mode} 模���遊戲`);
            
            GameState.currentMode = mode;
            GameState.stats = JSON.parse(JSON.stringify(GameConfig[mode].stats));
            
            /// 設置對戰目標
            let opponentMode = mode === 'hacker' ? 'defender' : 'hacker';
            // 設置對戰目標（傳統對戰模式）
            GameState.battle.targetIP = GameConfig.settings.targetIP || GameConfig.opponent[opponentMode].ip;
            GameState.battle.opponentStats = JSON.parse(JSON.stringify(GameConfig[opponentMode].stats));
            
            // 隱藏主頁，顯示遊戲頁
            mainPage.classList.remove('active');
            mainPage.classList.add('hidden');
            
            gamePage.classList.remove('hidden');
            gamePage.classList.add('active');
            
            // 生成遊戲頁面
            generateGamePage(mode);
            
            // 初始化遊戲邏輯
            initGameLogic(mode);
            
            // 顯示歡迎通知
            showNotification('系統', `${GameConfig[mode].title} 已啟動`, mode);
            
            // 嘗試連接目標
            setTimeout(() => {
                simulateConnection(mode);
            }, 1000);
        }

        // ===== 生成遊戲頁面 =====
        function generateGamePage(mode) {
            const config = GameConfig[mode];
            const stats = GameState.stats;
            const opponentMode = mode === 'hacker' ? 'defender' : 'hacker';
            const opponent = GameConfig.opponent[opponentMode];
            
            // 生成工具HTML
            let toolsHTML = '';
            for (const [categoryId, category] of Object.entries(config.toolCategories)) {
                toolsHTML += `
                    <div class="tool-category" id="category-${categoryId}" style="${categoryId !== 'reconnaissance' && categoryId !== 'monitoring' ? 'display: none;' : ''}">
                        ${category.tools.map(tool => `
                            <div class="tool-card" data-tool-id="${tool.id}" data-category="${categoryId}">
                                <div class="tool-icon">
                                    <i class="fas ${tool.icon}"></i>
                                </div>
                                <div class="tool-name">${tool.name}</div>
                                <div class="tool-desc">${tool.desc}</div>
                                <div class="tool-cooldown" id="cooldown-${tool.id}"></div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // 生成分類按鈕
            let categoryButtons = '';
            for (const [categoryId, category] of Object.entries(config.toolCategories)) {
                categoryButtons += `
                    <button class="category-btn ${categoryId === 'reconnaissance' || categoryId === 'monitoring' ? 'active' : ''}" 
                            data-category="${categoryId}">
                        <i class="fas ${category.icon}"></i>
                        ${category.name}
                    </button>
                `;
            }
            
            // 生成狀態條
            let statusBars = '';
            if (mode === 'hacker') {
                statusBars = `
                    <div class="status-item">
                        <div class="status-label">
                            <span>攻擊強度</span>
                            <span id="stat-attack-value">${stats.attackPower}%</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-fill" id="attack-bar" style="width: ${stats.attackPower}%;"></div>
                        </div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">
                            <span>隱蔽等級</span>
                            <span id="stat-stealth-value">${stats.stealthLevel}%</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-fill" id="stealth-bar" style="width: ${stats.stealthLevel}%;"></div>
                        </div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">
                            <span>檢測風險</span>
                            <span id="stat-detection-value">${stats.detectionRisk}%</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-fill" id="detection-bar" style="width: ${stats.detectionRisk}%;"></div>
                        </div>
                    </div>
                `;
            } else {
                statusBars = `
                    <div class="status-item">
                        <div class="status-label">
                            <span>防禦等級</span>
                            <span id="stat-defense-value">${stats.defenseLevel}%</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-fill" id="defense-bar" style="width: ${stats.defenseLevel}%;"></div>
                        </div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">
                            <span>檢測率</span>
                            <span id="stat-detection-value">${stats.detectionRate}%</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-fill" id="detection-bar" style="width: ${stats.detectionRate}%;"></div>
                        </div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">
                            <span>系統健康</span>
                            <span id="stat-health-value">${stats.systemHealth}%</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-fill" id="health-bar" style="width: ${stats.systemHealth}%;"></div>
                        </div>
                    </div>
                `;
            }
            
            // 生成網絡地圖
            let networkMapHTML = '';
            if (mode === 'hacker') {
                networkMapHTML = `
                    <div class="node" style="top: 30px; left: 50px;" title="攻擊者 (你)">
                        <i class="fas fa-user-secret"></i>
                    </div>
                    <div class="node" style="top: 120px; left: 150px;" title="防火牆">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="node" style="top: 30px; left: 250px;" title="目標伺服器">
                        <i class="fas fa-server"></i>
                    </div>
                    <div class="node" style="top: 120px; left: 350px;" title="數據庫">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="node" style="top: 210px; left: 250px;" title="防禦者">
                        <i class="fas fa-user-shield"></i>
                    </div>
                `;
            } else {
                networkMapHTML = `
                    <div class="node protected" style="top: 30px; left: 50px;" title="防禦者 (你)">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="node protected" style="top: 120px; left: 150px;" title="主防火牆">
                        <i class="fas fa-filter"></i>
                    </div>
                    <div class="node" style="top: 30px; left: 250px;" title="Web伺服器">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="node" style="top: 120px; left: 350px;" title="數據庫">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="node" style="top: 210px; left: 50px;" title="黑客">
                        <i class="fas fa-user-secret"></i>
                    </div>
                `;
            }
            
            // 生成統計卡片
            let statCards = '';
            if (mode === 'hacker') {
                statCards = `
                    <div class="stat-card">
                        <div class="stat-label">攻擊強度</div>
                        <div class="stat-value" id="stat-attack">${stats.attackPower}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">隱蔽等級</div>
                        <div class="stat-value" id="stat-stealth">${stats.stealthLevel}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">訪問權限</div>
                        <div class="stat-value" id="stat-access">${stats.accessLevel}%</div>
                    </div>
                `;
            } else {
                statCards = `
                    <div class="stat-card">
                        <div class="stat-label">防禦等級</div>
                        <div class="stat-value" id="stat-defense">${stats.defenseLevel}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">已封鎖攻擊</div>
                        <div class="stat-value" id="stat-blocked">${stats.blockedAttacks}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">活動警報</div>
                        <div class="stat-value" id="stat-alerts">${stats.activeAlerts}</div>
                    </div>
                `;
            }

            gamePage.innerHTML = `
                <div class="game-container ${mode}-ui">
                    <!-- 對戰信息面板 (對戰模式時顯示) -->
                    ${GameState.isBattleMode ? `
                    <div class="battle-info" style="background: linear-gradient(135deg, rgba(255,153,0,0.15) 0%, rgba(200,100,0,0.2) 100%); border: 2px solid #ff9900; border-radius: 12px; padding: 15px 25px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 2rem;">⚔️</div>
                            <div>
                                <div style="color: #ff9900; font-weight: bold; font-size: 1.2rem;">對戰模式</div>
                                <div style="color: #aaa; font-size: 0.9rem;">難度: ${GameState.battle.aiDifficulty === 'easy' ? '簡單' : GameState.battle.aiDifficulty === 'hard' ? '困難' : '中等'}</div>
                            </div>
                        </div>

                        <div style="text-align: center; background: rgba(0,0,0,0.3); padding: 10px 25px; border-radius: 8px; border: 1px solid #ff9900;">
                            <div style="color: #888; font-size: 0.85rem;">⏱️ 剩餘時間</div>
                            <div id="battle-timer-display" style="color: #ffaa00; font-size: 2rem; font-weight: bold; font-family: 'Monaco', monospace;">5:00</div>
                        </div>

                        <div style="flex: 1; min-width: 300px; max-width: 500px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: ${mode === 'hacker' ? '#00ff41' : '#ff3333'};">你 <span id="player-progress-text">0%</span></span>
                                <span style="color: ${mode === 'hacker' ? '#ff3333' : '#00ff41'};">AI <span id="ai-progress-text">0%</span></span>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1; background: rgba(0,0,0,0.5); height: 12px; border-radius: 6px; overflow: hidden;">
                                    <div id="player-progress-bar" style="background: linear-gradient(90deg, ${mode === 'hacker' ? '#00ff41' : '#ff3333'}, ${mode === 'hacker' ? '#00cc33' : '#cc0000'}); height: 100%; width: 0%; transition: width 0.3s;"></div>
                                </div>
                                <span style="color: #ff9900; font-weight: bold;">VS</span>
                                <div style="flex: 1; background: rgba(0,0,0,0.5); height: 12px; border-radius: 6px; overflow: hidden;">
                                    <div id="ai-progress-bar" style="background: linear-gradient(90deg, ${mode === 'hacker' ? '#ff3333' : '#00ff41'}, ${mode === 'hacker' ? '#cc0000' : '#00cc33'}); height: 100%; width: 0%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 20px; text-align: center;">
                            <div style="background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 6px;">
                                <div style="color: #888; font-size: 0.75rem;">你的得分</div>
                                <div id="player-score-display" style="color: #00ff41; font-weight: bold; font-size: 1.2rem;">0</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 6px;">
                                <div style="color: #888; font-size: 0.75rem;">AI得分</div>
                                <div id="ai-score-display" style="color: #ff3333; font-weight: bold; font-size: 1.2rem;">0</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- 遊戲頭部 -->
                    <div class="game-header">
                        <div class="game-title-container">
                            <div class="game-mode-icon">
                                <i class="fas ${config.icon}"></i>
                            </div>
                            <div class="game-title">${config.title}</div>
                        </div>

                        <div class="connection-status">
                            <div class="status-indicator ${GameState.connected ? '' : 'disconnected'}" id="connection-status"></div>
                            <span id="connection-text">${GameState.connected ? '已連接' : '未連接'}</span>
                        </div>

                        <div class="target-info">
                            <div class="target-label">目標IP</div>
                            <div class="target-ip" id="target-ip-display">${GameState.battle.targetIP}</div>
                        </div>

                        <div class="game-stats">
                            ${statCards}
                            <div class="stat-card">
                                <div class="stat-label">遊戲時間</div>
                                <div class="stat-value" id="stat-time">00:00</div>
                            </div>
                        </div>
                    </div>

                    <!-- 主遊戲區域 -->
                    <div class="game-main">
                        <!-- 左側主面板 -->
                        <div class="left-panel">
                            <!-- 終端機 -->
                            <div class="terminal-container">
                                <div class="terminal-header">
                                    <div class="terminal-title">
                                        <i class="fas ${config.icon}"></i>
                                        <span>${config.terminalTitle}</span>
                                    </div>
                                    <div class="terminal-status">
                                        <span id="terminal-status">就緒</span>
                                    </div>
                                </div>
                                <div class="terminal-body" id="terminal-body">
                                    <div class="terminal-output" id="terminal-output">
                                        <div class="terminal-line system">
                                            === ${config.title} 已啟動 ===
                                        </div>
                                        <div class="terminal-line system">
                                            你的IP: ${GameConfig.settings.playerIP}
                                        </div>
                                        <div class="terminal-line system">
                                            目標IP: ${GameState.battle.targetIP}
                                        </div>
                                        <div class="terminal-line success">
                                            ${mode === 'hacker' ? '攻擊工具包已載入' : '防禦系統已激活'}
                                        </div>
                                        <div class="terminal-line system">
                                            輸入 "help" 查看可用指令
                                        </div>
                                    </div>
                                    <div class="terminal-input-container">
                                        <span class="terminal-prompt">${config.terminalPrompt}</span>
                                        <input type="text" id="terminal-input" autocomplete="off" autofocus 
                                            placeholder="輸入指令...">
                                    </div>
                                    <div class="input-suggestions" id="input-suggestions">
                                        <!-- 建議按鈕將動態生成 -->
                                    </div>
                                </div>
                            </div>

                            <!-- 工具面板 -->
                            <div class="tools-panel">
                                <div class="tools-title">
                                    <i class="fas fa-tools"></i>
                                    <span>${mode === 'hacker' ? '攻擊工具庫' : '防禦工具庫'}</span>
                                </div>
                                
                                <div class="tools-categories" id="tools-categories">
                                    ${categoryButtons}
                                </div>
                                
                                <div class="tools-grid" id="tools-grid">
                                    ${toolsHTML}
                                </div>
                            </div>
                        </div>

                        <!-- 右側面板 -->
                        <div class="right-panel">
                            <!-- 對戰信息 -->
                            <div class="battle-info">
                                <div class="battle-title">
                                    <i class="fas fa-crosshairs"></i>
                                    <span>${GameState.isBattleMode ? '實時對戰' : '模擬對戰信息'}</span>
                                    ${GameState.isBattleMode ? '<span style="background:#ff9900;color:#000;padding:2px 8px;border-radius:4px;font-size:0.7rem;margin-left:10px;">LIVE</span>' : ''}
                                </div>

                                ${GameState.isBattleMode && mode === 'hacker' ? `
                                <!-- 黑客專用對戰面板 -->
                                <div style="background: linear-gradient(135deg, rgba(0,255,65,0.1) 0%, rgba(0,100,30,0.1) 100%); border: 1px solid #00ff41; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                    <div style="color: #00ff41; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-mask"></i> 身份隱藏狀態
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; text-align: center;">
                                            <div style="color: #888; font-size: 0.8rem;">代理層數</div>
                                            <div style="color: #00ff41; font-size: 1.2rem;" id="proxy-layers">0</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; text-align: center;">
                                            <div style="color: #888; font-size: 0.8rem;">偽裝身份</div>
                                            <div style="color: #00ff41; font-size: 1.2rem;" id="fake-identity">未啟用</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; text-align: center;">
                                            <div style="color: #888; font-size: 0.8rem;">流量混淆</div>
                                            <div style="color: #00ff41; font-size: 1.2rem;" id="traffic-obfs">OFF</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; text-align: center;">
                                            <div style="color: #888; font-size: 0.8rem;">痕跡清除</div>
                                            <div style="color: #00ff41; font-size: 1.2rem;" id="trace-cleared">0%</div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}

                                ${GameState.isBattleMode && mode === 'defender' ? `
                                <!-- 防禦者專用對戰面板 -->
                                <div style="background: linear-gradient(135deg, rgba(255,51,51,0.1) 0%, rgba(100,20,20,0.1) 100%); border: 1px solid #ff3333; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                    <div style="color: #ff3333; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-shield-alt"></i> 防禦監控面板
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; text-align: center;">
                                            <div style="color: #888; font-size: 0.8rem;">入侵偵測</div>
                                            <div style="color: #ff3333; font-size: 1.2rem;" id="intrusion-detect">活躍</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; text-align: center;">
                                            <div style="color: #888; font-size: 0.8rem;">蜜罐狀態</div>
                                            <div style="color: #ff3333; font-size: 1.2rem;" id="honeypot-status">就緒</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; text-align: center;">
                                            <div style="color: #888; font-size: 0.8rem;">威脅等級</div>
                                            <div style="color: #ffaa00; font-size: 1.2rem;" id="threat-level">低</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; text-align: center;">
                                            <div style="color: #888; font-size: 0.8rem;">系統完整性</div>
                                            <div style="color: #00ff41; font-size: 1.2rem;" id="system-integrity">100%</div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}

                                <div class="opponent-info">
                                    <div class="opponent-label">${GameState.isBattleMode ? 'AI對手' : '目標'}信息</div>
                                    <div class="opponent-details">
                                        <div class="detail-item">
                                            <div class="detail-label">名稱</div>
                                            <div class="detail-value">${opponent.name}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">IP地址</div>
                                            <div class="detail-value">${GameState.battle.targetIP}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">等級</div>
                                            <div class="detail-value">${opponent.level}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">${GameState.isBattleMode ? 'AI難度' : '連接質量'}</div>
                                            <div class="detail-value" id="connection-quality">${GameState.isBattleMode ? GameState.battle.aiDifficulty : GameState.battle.connectionQuality + '%'}</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="attack-log" id="attack-log">
                                    <div class="log-entry">
                                        <span class="log-time">[00:00]</span>
                                        <span class="log-message">${GameState.isBattleMode ? '對戰開始！' : '對戰日誌初始化完成'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 視覺化區域 -->
                            <div class="visualization-container">
                                <div class="viz-title">
                                    <i class="fas fa-project-diagram"></i>
                                    <span>${mode === 'hacker' ? '攻擊路徑視覺化' : '防禦網絡視覺化'}</span>
                                </div>
                                <div class="network-map" id="network-map">
                                    ${networkMapHTML}
                                </div>
                            </div>

                            <!-- 雙方設備監控畫面 -->
                            <div class="device-monitors" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                                <!-- 你的設備 -->
                                <div class="device-screen" style="background: linear-gradient(135deg, rgba(0,20,40,0.95) 0%, rgba(0,30,50,0.95) 100%); border: 2px solid ${mode === 'hacker' ? '#00ff41' : '#ff3333'}; border-radius: 8px; padding: 10px; min-height: 150px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <div style="display: flex; gap: 3px;">
                                                <span style="width: 8px; height: 8px; background: #ff5f56; border-radius: 50%;"></span>
                                                <span style="width: 8px; height: 8px; background: #ffbd2e; border-radius: 50%;"></span>
                                                <span style="width: 8px; height: 8px; background: #27ca3f; border-radius: 50%;"></span>
                                            </div>
                                            <span style="color: #888; font-size: 0.7rem;">你的設備</span>
                                        </div>
                                        <i class="fas fa-${mode === 'hacker' ? 'skull' : 'shield-alt'}" style="color: ${mode === 'hacker' ? '#00ff41' : '#ff3333'}; font-size: 0.8rem;"></i>
                                    </div>
                                    <div id="player-device-screen" style="font-family: 'Monaco', monospace; font-size: 0.65rem; color: ${mode === 'hacker' ? '#00ff41' : '#ff3333'}; line-height: 1.4;">
                                        <div>> 系統初始化中...</div>
                                        <div>> IP: ${GameConfig.settings.playerIP}</div>
                                        <div>> 狀態: 就緒</div>
                                        <div id="player-device-activity"></div>
                                    </div>
                                </div>

                                <!-- 對方設備 -->
                                <div class="device-screen" style="background: linear-gradient(135deg, rgba(40,20,0,0.95) 0%, rgba(50,25,0,0.95) 100%); border: 2px solid ${mode === 'hacker' ? '#ff3333' : '#00ff41'}; border-radius: 8px; padding: 10px; min-height: 150px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <div style="display: flex; gap: 3px;">
                                                <span style="width: 8px; height: 8px; background: #ff5f56; border-radius: 50%;"></span>
                                                <span style="width: 8px; height: 8px; background: #ffbd2e; border-radius: 50%;"></span>
                                                <span style="width: 8px; height: 8px; background: #27ca3f; border-radius: 50%;"></span>
                                            </div>
                                            <span style="color: #888; font-size: 0.7rem;">對方設備</span>
                                        </div>
                                        <i class="fas fa-${mode === 'hacker' ? 'shield-alt' : 'skull'}" style="color: ${mode === 'hacker' ? '#ff3333' : '#00ff41'}; font-size: 0.8rem;"></i>
                                    </div>
                                    <div id="opponent-device-screen" style="font-family: 'Monaco', monospace; font-size: 0.65rem; color: ${mode === 'hacker' ? '#ff3333' : '#00ff41'}; line-height: 1.4;">
                                        <div>> 遠端監控中...</div>
                                        <div>> IP: ${GameState.battle.targetIP}</div>
                                        <div>> 狀態: ${mode === 'hacker' ? '防禦中' : '攻擊中'}</div>
                                        <div id="opponent-device-activity"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- 瀏覽器/網絡攻擊模擬 -->
                            <div class="browser-network-sim" style="background: linear-gradient(135deg, rgba(20,20,30,0.95) 0%, rgba(30,30,45,0.95) 100%); border: 2px solid #4a90d9; border-radius: 8px; padding: 12px; margin-top: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-globe" style="color: #4a90d9;"></i>
                                        <span style="color: #4a90d9; font-weight: bold; font-size: 0.85rem;">網絡活動監控</span>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="showBrowserSimulator()" style="background: rgba(74,144,217,0.3); border: 1px solid #4a90d9; padding: 4px 10px; border-radius: 4px; color: #4a90d9; cursor: pointer; font-size: 0.75rem;">
                                            <i class="fas fa-window-maximize"></i> 瀏覽器
                                        </button>
                                        <button onclick="showNetworkPackets()" style="background: rgba(155,89,182,0.3); border: 1px solid #9b59b6; padding: 4px 10px; border-radius: 4px; color: #9b59b6; cursor: pointer; font-size: 0.75rem;">
                                            <i class="fas fa-network-wired"></i> 封包
                                        </button>
                                    </div>
                                </div>

                                <!-- 網絡流量圖 -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                                    <div style="background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px;">
                                        <div style="color: #888; font-size: 0.7rem; margin-bottom: 4px;">⬆️ 上傳流量</div>
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <div style="flex: 1; background: rgba(0,255,65,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                                <div id="upload-traffic-bar" style="background: #00ff41; height: 100%; width: 30%; transition: width 0.3s;"></div>
                                            </div>
                                            <span id="upload-traffic-value" style="color: #00ff41; font-size: 0.7rem;">12 KB/s</span>
                                        </div>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px;">
                                        <div style="color: #888; font-size: 0.7rem; margin-bottom: 4px;">⬇️ 下載流量</div>
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <div style="flex: 1; background: rgba(74,144,217,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                                <div id="download-traffic-bar" style="background: #4a90d9; height: 100%; width: 45%; transition: width 0.3s;"></div>
                                            </div>
                                            <span id="download-traffic-value" style="color: #4a90d9; font-size: 0.7rem;">28 KB/s</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 活躍連接列表 -->
                                <div id="active-connections" style="background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; max-height: 80px; overflow-y: auto;">
                                    <div style="color: #888; font-size: 0.7rem; margin-bottom: 5px;">🔗 活躍連接</div>
                                    <div style="font-family: 'Monaco', monospace; font-size: 0.65rem; color: #aaa;">
                                        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 2px 0;">
                                            <span style="color: #00ff41;">TCP</span>
                                            <span>${GameConfig.settings.playerIP}:443</span>
                                            <span>→</span>
                                            <span style="color: #ff9900;">${GameState.battle.targetIP}:80</span>
                                            <span style="color: #4a90d9;">ESTABLISHED</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 2px 0;">
                                            <span style="color: #9b59b6;">UDP</span>
                                            <span>${GameConfig.settings.playerIP}:53</span>
                                            <span>→</span>
                                            <span style="color: #ff9900;">8.8.8.8:53</span>
                                            <span style="color: #00ff41;">ACTIVE</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 狀態面板 -->
                            <div class="status-panel">
                                <div class="status-title">
                                    <i class="fas fa-chart-line"></i>
                                    <span>系統狀態</span>
                                </div>
                                ${statusBars}
                            </div>
                        </div>
                    </div>

                    <!-- 錢包和VPN狀態欄 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-wallet" style="color: #00ff41;"></i>
                                <span style="color: #00ff41; font-weight: bold; font-size: 1.2rem;">$<span id="wallet-display">${GameState.wallet.balance.toLocaleString()}</span></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fab fa-bitcoin" style="color: #f7931a;"></i>
                                <span style="color: #f7931a;">${GameState.wallet.cryptoBalance.BTC} BTC</span>
                            </div>
                            <div id="vpn-status-indicator" style="padding: 5px 12px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                                ${GameState.vpn.active ?
                                    `<i class="fas fa-shield-alt" style="color: ${GameState.vpn.isFake ? '#ffaa00' : '#00ff41'};"></i> VPN: ${GameState.vpn.currentRegion}` :
                                    '<i class="fas fa-exclamation-triangle" style="color: #ff3333;"></i> 無VPN'
                                }
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="color: #888; font-size: 0.9rem;">
                                防火牆: <span style="color: ${GameState.firewall.level > 70 ? '#00ff41' : GameState.firewall.level > 40 ? '#ffaa00' : '#ff3333'};">${GameState.firewall.level}%</span>
                            </div>
                            <button onclick="showShop()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); border: none; padding: 8px 16px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-store"></i> 商店
                            </button>
                        </div>
                    </div>

                    <!-- 控制按鈕 -->
                    <div class="game-controls">
                        <div class="control-group">
                            <button class="btn btn-primary" id="btn-connect">
                                <i class="fas fa-plug"></i>
                                <span>${GameState.connected ? '斷開連接' : '連接目標'}</span>
                            </button>
                            <button class="btn" id="btn-main-action">
                                <i class="fas ${mode === 'hacker' ? 'fa-crosshairs' : 'fa-shield-alt'}"></i>
                                <span>${mode === 'hacker' ? '快速攻擊' : '強化防禦'}</span>
                            </button>
                            <button class="btn" id="btn-scan">
                                <i class="fas ${mode === 'hacker' ? 'fa-search' : 'fa-eye'}"></i>
                                <span>${mode === 'hacker' ? '掃���目標' : '監控流量'}</span>
                            </button>
                            ${mode === 'hacker' ? `
                                <button class="btn" id="btn-crack-password" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                                    <i class="fas fa-key"></i>
                                    <span>破解密碼</span>
                                </button>
                                <button class="btn" id="btn-decrypt-file" style="background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);">
                                    <i class="fas fa-file-archive"></i>
                                    <span>解密文件</span>
                                </button>
                                <button class="btn" id="btn-attack-mode" style="background: linear-gradient(135deg, #9b59b6 0%, #6c3483 100%);">
                                    <i class="fas fa-skull-crossbones"></i>
                                    <span>攻擊模式</span>
                                </button>
                                <button class="btn" id="btn-hacker-wallet" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);">
                                    <i class="fas fa-coins"></i>
                                    <span>課金系統</span>
                                </button>
                                <button class="btn" id="btn-view-target" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                                    <i class="fas fa-eye"></i>
                                    <span>目標情報</span>
                                </button>
                                <button class="btn" id="btn-hacker-antivirus" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);">
                                    <i class="fas fa-shield-virus"></i>
                                    <span>殺毒軟件</span>
                                </button>
                                <button class="btn" id="btn-device-status" style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);">
                                    <i class="fas fa-desktop"></i>
                                    <span>裝置狀態</span>
                                </button>
                                <button class="btn" id="btn-track-ip" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">
                                    <i class="fas fa-crosshairs"></i>
                                    <span>追蹤IP</span>
                                </button>
                                <button class="btn" id="btn-phishing" style="background: linear-gradient(135deg, #c0392b 0%, #922b21 100%);">
                                    <i class="fas fa-fish"></i>
                                    <span>釣魚連結</span>
                                </button>
                                <button class="btn" id="btn-negotiate-hacker" style="background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%);">
                                    <i class="fas fa-comments"></i>
                                    <span>談判對話</span>
                                </button>
                                <button class="btn" id="btn-surrender-hacker" style="background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);">
                                    <i class="fas fa-handshake"></i>
                                    <span>和解選項</span>
                                </button>
                                <button class="btn" id="btn-vpn-toggle-hacker" style="background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>VPN開關</span>
                                </button>
                            ` : `
                                <button class="btn btn-danger" id="btn-block-all">
                                    <i class="fas fa-ban"></i>
                                    <span>封鎖所有</span>
                                </button>
                                <button class="btn" id="btn-observe" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                                    <i class="fas fa-search"></i>
                                    <span>觀察黑客</span>
                                </button>
                                <button class="btn" id="btn-defender-payment" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                                    <i class="fas fa-user-secret"></i>
                                    <span>反擊課金</span>
                                </button>
                                <button class="btn" id="btn-defender-antivirus" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);">
                                    <i class="fas fa-virus-slash"></i>
                                    <span>殺毒軟件</span>
                                </button>
                                <button class="btn" id="btn-defender-device" style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);">
                                    <i class="fas fa-server"></i>
                                    <span>系統狀態</span>
                                </button>
                                <button class="btn" id="btn-defender-backup" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);">
                                    <i class="fas fa-database"></i>
                                    <span>備份工具</span>
                                </button>
                                <button class="btn" id="btn-negotiate-defender" style="background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%);">
                                    <i class="fas fa-comments"></i>
                                    <span>與黑客談判</span>
                                </button>
                                <button class="btn" id="btn-surrender-defender" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                                    <i class="fas fa-flag"></i>
                                    <span>投降/和解</span>
                                </button>
                                <button class="btn" id="btn-vpn-toggle-defender" style="background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>VPN開關</span>
                                </button>
                                <button class="btn" id="btn-third-party-support" style="background: linear-gradient(135deg, #4a90d9 0%, #357abd 100%);">
                                    <i class="fas fa-handshake"></i>
                                    <span>尋求第三方支援</span>
                                </button>
                            `}
                        </div>
                        <div class="control-group">
                            <button class="btn btn-secondary" id="btn-clear-terminal">
                                <i class="fas fa-eraser"></i>
                                <span>清空終端</span>
                            </button>
                            <button class="btn btn-secondary" id="btn-help">
                                <i class="fas fa-question-circle"></i>
                                <span>遊戲幫助</span>
                            </button>
                            <button class="btn btn-secondary" id="btn-settings">
                                <i class="fas fa-cog"></i>
                                <span>設置</span>
                            </button>
                            <button class="btn btn-secondary" id="btn-back">
                                <i class="fas fa-arrow-left"></i>
                                <span>返回主選單</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 初始化DOM引用
            initDOMReferences();
            
            // 添加連接線
            setTimeout(() => {
                setupNetworkConnections(mode);
                startNetworkAnimation(mode);
            }, 100);
        }

        // ===== 初始化DOM引用 =====
        function initDOMReferences() {
            terminalInput = document.getElementById('terminal-input');
            terminalOutput = document.getElementById('terminal-output');
            terminalBody = document.getElementById('terminal-body');
            toolsGrid = document.getElementById('tools-grid');
            networkMap = document.getElementById('network-map');
            attackLog = document.getElementById('attack-log');
        }

        // ===== 設置網絡連接線 =====
        function setupNetworkConnections(mode) {
            if (!networkMap) return;
            
            const color = GameConfig[mode].primaryColor;
            
            if (mode === 'hacker') {
                // 黑客模式：從攻擊者到目標的攻擊路徑
                addConnectionLine(50, 55, 150, 145, color);
                addConnectionLine(150, 145, 250, 55, color);
                addConnectionLine(250, 55, 350, 145, color);
                addConnectionLine(50, 55, 250, 210, '#ff3333'); // 到防禦者的攻擊線
            } else {
                // 防禦模式：中心化的防禦網絡
                addConnectionLine(150, 145, 50, 55, color); // 到防禦者
                addConnectionLine(150, 145, 250, 55, color); // ���Web伺服器
                addConnectionLine(150, 145, 350, 145, color); // 到數據庫
                addConnectionLine(50, 55, 50, 210, '#ff3333'); // 黑客攻擊線
            }
        }

        function addConnectionLine(x1, y1, x2, y2, color) {
            if (!networkMap) return;
            
            const line = document.createElement('div');
            line.className = 'connection-line';
            
            const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            
            line.style.cssText = `
                width: ${length}px;
                top: ${y1}px;
                left: ${x1}px;
                background: ${color};
                transform: rotate(${angle}deg);
                transform-origin: 0 0;
                opacity: 0.5;
            `;
            
            networkMap.appendChild(line);
        }

        // ===== 初始化遊戲邏輯 =====
        function initGameLogic(mode) {
            const config = GameConfig[mode];
            
            // 設置終端輸入處理
            setupTerminalInput(mode, config);
            
            // 設置工具點擊事件
            setupToolEvents(mode, config);
            
            // 設置分類按鈕事件
            setupCategoryEvents();
            
            // 設置控制按鈕事件
            setupControlButtons(mode, config);
            
            // 開始遊戲計時器
            startGameTimer();
            
            // 開始對戰模擬
            if (GameState.isBattleMode) {
                startBattleSimulation(mode);
            }
            
            console.log(`${mode} 模式遊戲邏輯初始化完成`);
        }

        // ===== 設置終端輸入處理 =====
        function setupTerminalInput(mode, config) {
            if (!terminalInput) return;
            
            terminalInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const command = terminalInput.value.trim().toLowerCase();
                    if (command) {
                        processCommand(mode, command, config);
                        terminalInput.value = '';
                        
                        // 清空建議
                        const suggestions = document.getElementById('input-suggestions');
                        if (suggestions) suggestions.innerHTML = '';
                    }
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    autoCompleteCommand(mode, config);
                }
            });
            
            // 實時建議
            terminalInput.addEventListener('input', () => {
                updateCommandSuggestions(mode, config);
            });
        }

        // ===== 處理命令 =====
        function processCommand(mode, command, config) {
            addTerminalLine(`> ${command}`, 'command');
            
            const cmdConfig = config.commands[command];
            
            if (cmdConfig) {
                if (cmdConfig.handler === 'executeTool') {
                    const tool = config.toolCategories[getToolCategory(mode, cmdConfig.tool)]?.tools.find(t => t.id === cmdConfig.tool);
                    if (tool) {
                        executeTool(mode, tool);
                    } else {
                        addTerminalLine(`工具未找到: ${cmdConfig.tool}`, 'error');
                    }
                } else if (cmdConfig.handler === 'toggleStealth') {
                    toggleStealthMode();
                } else if (cmdConfig.handler === 'showStatus') {
                    showStatus(mode);
                } else if (cmdConfig.handler === 'showHelp') {
                    showHelp(mode, config);
                } else if (cmdConfig.handler === 'clearTerminal') {
                    clearTerminal();
                } else if (cmdConfig.handler === 'connectToTarget') {
                    connectToTarget();
                } else if (cmdConfig.handler === 'disconnectFromTarget') {
                    disconnectFromTarget();
                } else if (cmdConfig.handler === 'showSelection') {
                    showSelection(mode);
                } else if (cmdConfig.handler === 'showHistory') {
                    showHistory();
                } else if (cmdConfig.handler === 'setupVPN') {
                    setupVPN();
                } else if (cmdConfig.handler === 'openShop') {
                    showShop();
                } else if (cmdConfig.handler === 'saveGame') {
                    saveGameState();
                    addTerminalLine('遊戲已保存', 'success');
                } else if (cmdConfig.handler === 'loadGame') {
                    loadGameState();
                    addTerminalLine('遊戲已加載（若有存檔）', 'success');
                } else if (cmdConfig.handler === 'notAvailable') {
                    addTerminalLine('該指令尚未實作，請使用 UI 或稍後更新。', 'warning');
                } else if (cmdConfig.handler === 'toggleNotifications') {
                    GameConfig.settings.notifications = !GameConfig.settings.notifications;
                    addTerminalLine(`通知已${GameConfig.settings.notifications ? '啟用' : '禁用'}`, 'system');
                } else if (cmdConfig.handler === 'toggleSound') {
                    GameConfig.settings.soundEffects = !GameConfig.settings.soundEffects;
                    SoundSystem.enabled = !!GameConfig.settings.soundEffects;
                    addTerminalLine(`音效已${GameConfig.settings.soundEffects ? '啟用' : '禁用'}`, 'system');
                } else if (cmdConfig.handler === 'quitGame') {
                    addTerminalLine('退出遊戲... (請關閉此標籤頁)', 'system');
                }
            } else {
                addTerminalLine(`錯誤: 未知指令 "${command}"`, 'error');
                addTerminalLine('輸入 "help" 查看可用指令', 'system');
            }
        }

        // ===== ���取工具分類 =====
        function getToolCategory(mode, toolId) {
            const config = GameConfig[mode];
            for (const [categoryId, category] of Object.entries(config.toolCategories)) {
                if (category.tools.some(t => t.id === toolId)) {
                    return categoryId;
                }
            }
            return Object.keys(config.toolCategories)[0];
        }

        // ===== 執行工具 =====
        function executeTool(mode, tool) {
            // 檢查冷卻
            if (GameState.toolCooldowns[tool.id] && Date.now() < GameState.toolCooldowns[tool.id]) {
                const remaining = Math.ceil((GameState.toolCooldowns[tool.id] - Date.now()) / 1000);
                addTerminalLine(`工具冷卻中，請等待 ${remaining} 秒`, 'warning');
                return;
            }

            addTerminalLine(`執行: ${tool.command}`, 'system');
            SoundSystem.play('attack');

            // 記錄玩家行動（對戰模式）
            if (GameState.isBattleMode) {
                GameState.battle.lastPlayerAction = { tool: tool.name, time: Date.now() };
                GameState.battle.sharedMessages.push({
                    from: mode,
                    action: tool.name,
                    time: Date.now()
                });
            }

            // 模擬執行時間
            setTimeout(() => {
                // 應用效果
                if (tool.effect) {
                    Object.entries(tool.effect).forEach(([stat, value]) => {
                        if (GameState.stats[stat] !== undefined) {
                            GameState.stats[stat] = Math.max(0, Math.min(100, GameState.stats[stat] + value));
                        }
                    });
                }

                // 更新UI
                updateStatsDisplay(mode);

                // 更新對戰模式專用面板
                if (GameState.isBattleMode) {
                    updateBattlePanels(mode, tool);

                    // 增加玩家對戰進度（根據工具效果）
                    const progressGain = mode === 'hacker' ? 5 : 3;
                    addPlayerBattleProgress(progressGain);

                    // 通知AI對手玩家的行動
                    notifyOpponentOfAction(mode, tool);
                }

                // 添加成功消息
                addTerminalLine(`${tool.name} 執行成功`, 'success');
                SoundSystem.play('success');

                // 發送到對手（模擬對戰）
                if (GameState.connected) {
                    sendAttackToOpponent(mode, tool);
                }

                // 設置冷卻
                GameState.toolCooldowns[tool.id] = Date.now() + tool.cooldown * 1000;
                updateToolCooldowns();

            }, 800);
        }

        // ===== 通知對手玩家行動 =====
        function notifyOpponentOfAction(playerMode, tool) {
            if (!GameState.isBattleMode) return;

            const opponentMode = playerMode === 'hacker' ? 'defender' : 'hacker';

            // AI根據玩家行動做出反應
            setTimeout(() => {
                if (GameState.battle.battleEnded) return;

                const difficulty = GameState.battle.aiDifficulty;
                const reactionChance = difficulty === 'hard' ? 0.8 : difficulty === 'medium' ? 0.5 : 0.3;

                if (Math.random() < reactionChance) {
                    if (opponentMode === 'defender') {
                        addTerminalLine(`[警報] 目標系統偵測到你的 ${tool.name} 並正在反應...`, 'warning');
                    } else {
                        addTerminalLine(`[情報] 偵測到黑客對你的 ${tool.name} 做出反應...`, 'warning');
                    }
                }
            }, 1500);
        }

        // ===== 更新對戰模式專用面板 =====
        function updateBattlePanels(mode, tool) {
            if (mode === 'hacker') {
                // 更新黑客身份隱藏面板
                const identityTools = ['proxy_chain', 'identity_forge', 'traffic_morph', 'timing_rand', 'dns_tunnel', 'steganography', 'antiforensics', 'vm_escape', 'tor', 'vpn', 'log_cleaner', 'spoofing'];

                if (identityTools.includes(tool.id)) {
                    // 更新代理層數
                    const proxyLayers = document.getElementById('proxy-layers');
                    if (proxyLayers && ['proxy_chain', 'tor', 'vpn'].includes(tool.id)) {
                        const current = parseInt(proxyLayers.textContent) || 0;
                        proxyLayers.textContent = Math.min(current + 1, 5);
                    }

                    // 更新偽裝身份
                    const fakeIdentity = document.getElementById('fake-identity');
                    if (fakeIdentity && ['identity_forge', 'spoofing'].includes(tool.id)) {
                        fakeIdentity.textContent = '已啟用';
                        fakeIdentity.style.color = '#00ff41';
                    }

                    // 更新流量混淆
                    const trafficObfs = document.getElementById('traffic-obfs');
                    if (trafficObfs && ['traffic_morph', 'dns_tunnel'].includes(tool.id)) {
                        trafficObfs.textContent = 'ON';
                        trafficObfs.style.color = '#00ff41';
                    }

                    // 更新痕跡清除
                    const traceCleared = document.getElementById('trace-cleared');
                    if (traceCleared && ['log_cleaner', 'antiforensics'].includes(tool.id)) {
                        const current = parseInt(traceCleared.textContent) || 0;
                        traceCleared.textContent = Math.min(current + 25, 100) + '%';
                    }
                }
            } else if (mode === 'defender') {
                // 更新防禦者監控面板
                const intrusionDetect = document.getElementById('intrusion-detect');
                const honeypotStatus = document.getElementById('honeypot-status');
                const threatLevel = document.getElementById('threat-level');
                const systemIntegrity = document.getElementById('system-integrity');

                // 根據使用的工具更新狀態
                if (tool.id === 'honeypot' && honeypotStatus) {
                    honeypotStatus.textContent = '誘捕中';
                    honeypotStatus.style.color = '#ffaa00';
                }

                if (['ids_config', 'threat_hunt', 'behavior_analysis'].includes(tool.id) && intrusionDetect) {
                    intrusionDetect.textContent = '強化';
                    intrusionDetect.style.color = '#00ff41';
                }

                // 更新威脅等級（根據攻擊次數）
                if (threatLevel) {
                    const blockedCount = GameState.stats.blockedAttacks || 0;
                    if (blockedCount > 10) {
                        threatLevel.textContent = '高';
                        threatLevel.style.color = '#ff3333';
                    } else if (blockedCount > 5) {
                        threatLevel.textContent = '中';
                        threatLevel.style.color = '#ffaa00';
                    }
                }

                // 更新系統完整性
                if (systemIntegrity && GameState.stats.systemHealth !== undefined) {
                    systemIntegrity.textContent = GameState.stats.systemHealth + '%';
                    if (GameState.stats.systemHealth < 50) {
                        systemIntegrity.style.color = '#ff3333';
                    } else if (GameState.stats.systemHealth < 80) {
                        systemIntegrity.style.color = '#ffaa00';
                    }
                }
            }
        }

        // ===== 發送攻擊到對手 =====
        function sendAttackToOpponent(mode, tool) {
            const attack = {
                type: 'attack',
                tool: tool.name,
                attacker: GameConfig.settings.playerIP,
                target: GameState.battle.targetIP,
                timestamp: new Date().toISOString(),
                strength: tool.effect?.attack || tool.effect?.defense || 10
            };
            
            // 添加到攻擊日誌
            addAttackLog(`[攻擊] 使用 ${tool.name} 攻擊 ${GameState.battle.targetIP}`);
            
            // 模擬對手的反應
            setTimeout(() => {
                simulateOpponentResponse(mode, attack);
            }, 1500);
        }

        // ===== 模擬對手反應 =====
        function simulateOpponentResponse(mode, attack) {
            const opponentMode = mode === 'hacker' ? 'defender' : 'hacker';
            
            // 防禦者檢測到攻擊
            if (mode === 'hacker') {
                const detectionChance = GameState.battle.opponentStats.detectionRate || 50;
                if (Math.random() * 100 < detectionChance) {
                    // 攻擊被檢測到
                    addTerminalLine(`警告: 攻擊被目標系統檢測到！`, 'alert');
                    addAttackLog(`[防禦] 攻擊被 ${GameState.battle.targetIP} 檢測到`);
                    
                    // 防禦者反擊
                    simulateDefenderCounterAttack(attack);
                }
            } else {
                // 黑客繼續攻擊
                simulateHackerPersistentAttack(attack);
            }
        }

        // ===== 模擬防禦者反擊 =====
        function simulateDefenderCounterAttack(attack) {
            // 防禦者有���會封鎖攻擊者
            const blockChance = 30 + (GameState.battle.opponentStats.defenseLevel || 0) / 2;
            
            if (Math.random() * 100 < blockChance) {
                setTimeout(() => {
                    addTerminalLine(`嚴重: 你的IP地址已被目標系統封鎖！`, 'error');
                    addAttackLog(`[防禦] IP ${GameConfig.settings.playerIP} 已被封鎖`);
                    
                    // 降低連接質量
                    GameState.battle.connectionQuality = Math.max(10, GameState.battle.connectionQuality - 30);
                    updateConnectionDisplay();
                }, 2000);
            }
        }

        // ===== 模擬黑客持續攻擊 =====
        function simulateHackerPersistentAttack(attack) {
            // 黑客嘗試其他攻擊方式
            setTimeout(() => {
                if (Math.random() > 0.5) {
                    addTerminalLine(`警告: 檢測到新的攻擊嘗試`, 'warning');
                    addAttackLog(`[攻擊] 檢測到來自 ${GameState.battle.targetIP} 的新攻擊`);
                    
                    // 降低系統健康
                    GameState.stats.systemHealth = Math.max(0, GameState.stats.systemHealth - 5);
                    updateStatsDisplay('defender');
                }
            }, 3000);
        }

        // ===== 設置工具事件 =====
        function setupToolEvents(mode, config) {
            if (!toolsGrid) return;
            
            toolsGrid.addEventListener('click', (e) => {
                const toolCard = e.target.closest('.tool-card');
                if (!toolCard || toolCard.classList.contains('disabled')) return;
                
                const toolId = toolCard.dataset.toolId;
                const categoryId = toolCard.dataset.category;
                
                if (toolId && categoryId) {
                    const category = config.toolCategories[categoryId];
                    const tool = category.tools.find(t => t.id === toolId);
                    
                    if (tool) {
                        executeTool(mode, tool);
                    }
                }
            });
        }

        // ===== 設置分類事件 =====
        function setupCategoryEvents() {
            const categoriesDiv = document.getElementById('tools-categories');
            if (!categoriesDiv) return;
            
            categoriesDiv.addEventListener('click', (e) => {
                const categoryBtn = e.target.closest('.category-btn');
                if (!categoryBtn) return;
                
                const categoryId = categoryBtn.dataset.category;
                
                // 更新活動按鈕
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                categoryBtn.classList.add('active');
                
                // 顯示對應的工具
                document.querySelectorAll('.tool-category').forEach(category => {
                    category.style.display = 'none';
                });
                
                const targetCategory = document.getElementById(`category-${categoryId}`);
                if (targetCategory) {
                    targetCategory.style.display = 'grid';
                }
            });
        }

        // ===== 設置控制按鈕事件 =====
        function setupControlButtons(mode, config) {
            // 連接按鈕
            const connectBtn = document.getElementById('btn-connect');
            if (connectBtn) {
                connectBtn.addEventListener('click', () => {
                    if (GameState.connected) {
                        disconnectFromTarget();
                    } else {
                        connectToTarget();
                    }
                });
            }
            
            // 主動作按鈕
            const mainActionBtn = document.getElementById('btn-main-action');
            if (mainActionBtn) {
                mainActionBtn.addEventListener('click', () => {
                    const action = mode === 'hacker' ? 'exploit' : 'firewall';
                    processCommand(mode, action, config);
                });
            }
            
            // 掃描按鈕
            const scanBtn = document.getElementById('btn-scan');
            if (scanBtn) {
                scanBtn.addEventListener('click', () => {
                    const action = mode === 'hacker' ? 'scan' : 'monitor';
                    processCommand(mode, action, config);
                });
            }
            
            // 防禦者的封鎖所有按鈕
            const blockAllBtn = document.getElementById('btn-block-all');
            if (blockAllBtn) {
                blockAllBtn.addEventListener('click', () => {
                    processCommand(mode, 'block', config);
                });
            }
            
            // 清空終端
            const clearBtn = document.getElementById('btn-clear-terminal');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearTerminal);
            }
            
            // 幫助按鈕
            const helpBtn = document.getElementById('btn-help');
            if (helpBtn) {
                helpBtn.addEventListener('click', () => {
                    showHelp(mode, config);
                });
            }
            
            // 設置按鈕
            const settingsBtn = document.getElementById('btn-settings');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', showSettings);
            }
            
            // 返回按鈕
            const backBtn = document.getElementById('btn-back');
            if (backBtn) {
                backBtn.addEventListener('click', backToMain);
            }

            // 黑客攻擊模式按鈕
            const attackModeBtn = document.getElementById('btn-attack-mode');
            if (attackModeBtn) {
                attackModeBtn.addEventListener('click', showAttackModePanel);
            }

            // 黑客課金系統按鈕
            const hackerWalletBtn = document.getElementById('btn-hacker-wallet');
            if (hackerWalletBtn) {
                hackerWalletBtn.addEventListener('click', showHackerPaymentPanel);
            }

            // 防禦者反擊課金按鈕
            const defenderPaymentBtn = document.getElementById('btn-defender-payment');
            if (defenderPaymentBtn) {
                defenderPaymentBtn.addEventListener('click', showDefenderPaymentPanel);
            }

            // 黑客查看目標情報按鈕
            const viewTargetBtn = document.getElementById('btn-view-target');
            if (viewTargetBtn) {
                viewTargetBtn.addEventListener('click', showTargetIntelPanel);
            }

            // 黑客殺毒軟件按鈕
            const hackerAntivirusBtn = document.getElementById('btn-hacker-antivirus');
            if (hackerAntivirusBtn) {
                hackerAntivirusBtn.addEventListener('click', () => showAntivirusPanel('hacker'));
            }

            // 裝置狀態按鈕
            const deviceStatusBtn = document.getElementById('btn-device-status');
            if (deviceStatusBtn) {
                deviceStatusBtn.addEventListener('click', () => showDeviceStatusPanel('hacker'));
            }

            // IP追蹤按鈕
            const trackIPBtn = document.getElementById('btn-track-ip');
            if (trackIPBtn) {
                trackIPBtn.addEventListener('click', showIPTrackingPanel);
            }

            // 釣魚連結按鈕
            const phishingBtn = document.getElementById('btn-phishing');
            if (phishingBtn) {
                phishingBtn.addEventListener('click', showPhishingPanel);
            }

            // 防禦者殺毒軟件按鈕
            const defenderAntivirusBtn = document.getElementById('btn-defender-antivirus');
            if (defenderAntivirusBtn) {
                defenderAntivirusBtn.addEventListener('click', () => showAntivirusPanel('defender'));
            }

            // 防禦者系統狀態按鈕
            const defenderDeviceBtn = document.getElementById('btn-defender-device');
            if (defenderDeviceBtn) {
                defenderDeviceBtn.addEventListener('click', () => showDeviceStatusPanel('defender'));
            }

            // 防禦者備份工具按鈕
            const defenderBackupBtn = document.getElementById('btn-defender-backup');
            if (defenderBackupBtn) {
                defenderBackupBtn.addEventListener('click', showBackupToolsPanel);
            }

            // 防禦者第三方支援按鈕
            const thirdPartySupportBtn = document.getElementById('btn-third-party-support');
            if (thirdPartySupportBtn) {
                thirdPartySupportBtn.addEventListener('click', showThirdPartySupportPanel);
            }

            // 黑客談判對話按鈕
            const negotiateHackerBtn = document.getElementById('btn-negotiate-hacker');
            if (negotiateHackerBtn) {
                negotiateHackerBtn.addEventListener('click', () => {
                    GameState.negotiation.isOpen = false; // 重置談判狀態
                    showNegotiationPanel();
                });
            }

            // 防禦者談判對話按鈕
            const negotiateDefenderBtn = document.getElementById('btn-negotiate-defender');
            if (negotiateDefenderBtn) {
                negotiateDefenderBtn.addEventListener('click', () => {
                    GameState.negotiation.isOpen = false; // 重置談判狀態
                    showNegotiationPanel();
                });
            }

            // 黑客和解選項按鈕
            const surrenderHackerBtn = document.getElementById('btn-surrender-hacker');
            if (surrenderHackerBtn) {
                surrenderHackerBtn.addEventListener('click', showSurrenderPanel);
            }

            // 防禦者投降/和解按鈕
            const surrenderDefenderBtn = document.getElementById('btn-surrender-defender');
            if (surrenderDefenderBtn) {
                surrenderDefenderBtn.addEventListener('click', showSurrenderPanel);
            }

            // 黑客VPN開關按鈕
            const vpnToggleHackerBtn = document.getElementById('btn-vpn-toggle-hacker');
            if (vpnToggleHackerBtn) {
                vpnToggleHackerBtn.addEventListener('click', toggleVPN);
            }

            // 防禦者VPN開關按鈕
            const vpnToggleDefenderBtn = document.getElementById('btn-vpn-toggle-defender');
            if (vpnToggleDefenderBtn) {
                vpnToggleDefenderBtn.addEventListener('click', toggleVPN);
            }

            // 黑客破解密碼按鈕
            const crackPasswordBtn = document.getElementById('btn-crack-password');
            if (crackPasswordBtn) {
                crackPasswordBtn.addEventListener('click', () => {
                    addTerminalLine('[破解] 啟動密碼破解程序...', 'command');
                    SoundSystem.play('attack');
                    let progress = 0;
                    const crackInterval = setInterval(() => {
                        progress += Math.floor(Math.random() * 15) + 5;
                        if (progress >= 100) {
                            progress = 100;
                            clearInterval(crackInterval);
                            addTerminalLine('✓ 密碼破解成功！獲取憑證: admin:P@ssw0rd123', 'success');
                            SoundSystem.play('success');
                        } else {
                            addTerminalLine(`[破解] 進度: ${progress}%`, 'response');
                        }
                    }, 800);
                });
            }

            // 黑客解密文件按鈕
            const decryptFileBtn = document.getElementById('btn-decrypt-file');
            if (decryptFileBtn) {
                decryptFileBtn.addEventListener('click', () => {
                    addTerminalLine('[解密] 開始解密加密文件...', 'command');
                    SoundSystem.play('attack');
                    setTimeout(() => {
                        addTerminalLine('發現加密文件: secrets.dat, financial.xlsx, passwords.db', 'response');
                        setTimeout(() => {
                            addTerminalLine('✓ 文件解密成功！', 'success');
                            SoundSystem.play('success');
                        }, 2000);
                    }, 1500);
                });
            }

            // 防禦者觀察黑客按鈕
            const observeBtn = document.getElementById('btn-observe');
            if (observeBtn) {
                observeBtn.addEventListener('click', () => {
                    addTerminalLine('[監控] 正在分析入侵者活動...', 'command');
                    SoundSystem.play('attack');
                    setTimeout(() => {
                        const hackerInfo = GameConfig.opponent.hacker;
                        addTerminalLine(`檢測到黑客: ${hackerInfo.name}`, 'warning');
                        addTerminalLine(`來源IP: ${hackerInfo.ip} (可能經過VPN)`, 'response');
                        addTerminalLine(`攻擊模式: ${hackerInfo.attackPattern}`, 'response');
                        addTerminalLine(`使用工具: ${hackerInfo.tools.join(', ')}`, 'response');
                        SoundSystem.play('success');
                    }, 2000);
                });
            }
        }

        // ===== 模擬連接 =====
        function simulateConnection(mode) {
            addTerminalLine('正在連接目標系統...', 'system');
            
            setTimeout(() => {
                if (GameState.battle.targetIP && GameState.battle.targetIP !== GameConfig.settings.playerIP) {
                    GameState.connected = true;
                    GameState.opponentConnected = true;
                    GameState.battleActive = true;
                    
                    addTerminalLine(`成功連接至 ${GameState.battle.targetIP}`, 'success');
                    addAttackLog(`[系統] 已連接到 ${GameState.battle.targetIP}`);
                    
                    updateConnectionDisplay();
                    showNotification('連接', `已成功���接至 ${GameState.battle.targetIP}`, mode);
                } else {
                    addTerminalLine('錯誤: 無效的目標IP地址', 'error');
                    addTerminalLine('請在設置中輸入有效的目標IP', 'system');
                }
            }, 2000);
        }

        // ===== 連接目標 =====
        function connectToTarget() {
            if (GameState.connected) return;
            
            const targetIP = document.getElementById('target-ip')?.value || GameState.battle.targetIP;
            
            if (!targetIP || targetIP === GameConfig.settings.playerIP) {
                addTerminalLine('錯誤: 無效的目標IP地址', 'error');
                return;
            }
            
            GameState.battle.targetIP = targetIP;
            GameState.connected = true;
            
            addTerminalLine(`正在建立連接到 ${targetIP}...`, 'system');
            
            setTimeout(() => {
                addTerminalLine(`連接成功！與目標系統建立安全通道`, 'success');
                addAttackLog(`[系統] 已連接到 ${targetIP}`);
                
                updateConnectionDisplay();
                showNotification('連接', `已成功連接至 ${targetIP}`, GameState.currentMode);
                
                // 模擬對手的連接
                setTimeout(() => {
                    GameState.opponentConnected = true;
                    GameState.battleActive = true;
                    
                    addTerminalLine('目標系統已接受連接請求', 'system');
                    addAttackLog(`[系統] ${targetIP} 已連接到你的系統`);
                }, 1000);
            }, 1500);
        }

        // ===== 斷開連接 =====
        function disconnectFromTarget() {
            if (!GameState.connected) return;
            
            addTerminalLine('正在斷開連接...', 'system');
            
            setTimeout(() => {
                GameState.connected = false;
                GameState.opponentConnected = false;
                GameState.battleActive = false;
                
                addTerminalLine('已成功斷開連接', 'success');
                addAttackLog(`[系統] 已斷開與 ${GameState.battle.targetIP} 的連接`);
                
                updateConnectionDisplay();
                showNotification('連接', '已斷開連接', GameState.currentMode);
            }, 1000);
        }

        // ===== 更新連接顯示 =====
        function updateConnectionDisplay() {
            const statusIndicator = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            const connectBtn = document.getElementById('btn-connect');
            const qualityDisplay = document.getElementById('connection-quality');
            
            if (statusIndicator) {
                statusIndicator.classList.toggle('disconnected', !GameState.connected);
            }
            
            if (statusText) {
                statusText.textContent = GameState.connected ? '已連接' : '未連接';
            }
            
            if (connectBtn) {
                connectBtn.innerHTML = GameState.connected ? 
                    '<i class="fas fa-plug"></i><span>斷開連接</span>' : 
                    '<i class="fas fa-plug"></i><span>連接目標</span>';
            }
            
            if (qualityDisplay) {
                qualityDisplay.textContent = `${GameState.battle.connectionQuality}%`;
            }
        }

        // ===== 添加終端行 =====
        function addTerminalLine(text, type = 'response') {
            if (!terminalOutput) return;
            
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            line.textContent = text;
            terminalOutput.appendChild(line);
            
            // 限制���數
            const lines = terminalOutput.querySelectorAll('.terminal-line');
            if (lines.length > 100) {
                lines[0].remove();
            }
            
            // 滾動到底部
            if (terminalBody) {
                setTimeout(() => {
                    terminalBody.scrollTop = terminalBody.scrollHeight;
                }, 10);
            }
        }

        // ===== 添加攻擊日誌 =====
        function addAttackLog(message) {
            if (!attackLog) return;
            
            const time = new Date();
            const timeStr = `[${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}]`;
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">${timeStr}</span>
                <span class="log-message">${message}</span>
            `;
            
            attackLog.appendChild(logEntry);
            
            // 限制日誌數量
            const entries = attackLog.querySelectorAll('.log-entry');
            if (entries.length > 20) {
                entries[0].remove();
            }
            
            // 滾動到底部
            attackLog.scrollTop = attackLog.scrollHeight;
        }

        // ===== 清空終端 =====
        function clearTerminal() {
            if (!terminalOutput) return;
            
            terminalOutput.innerHTML = `
                <div class="terminal-line system">
                    終端已清空
                </div>
            `;
        }

        // ===== 顯示狀態 =====
        function showStatus(mode) {
            const stats = GameState.stats;
            
            addTerminalLine('=== 系統狀態 ===', 'system');
            
            if (mode === 'hacker') {
                addTerminalLine(`攻擊強度: ${stats.attackPower}%`, 'response');
                addTerminalLine(`隱蔽等級: ${stats.stealthLevel}%`, 'response');
                addTerminalLine(`檢測風險: ${stats.detectionRisk}%`, 'response');
                addTerminalLine(`訪問權限: ${stats.accessLevel}%`, 'response');
                addTerminalLine(`活動連接: ${stats.connections}`, 'response');
                addTerminalLine(`可用資源: ${stats.resources}`, 'response');
            } else {
                addTerminalLine(`防禦等級: ${stats.defenseLevel}%`, 'response');
                addTerminalLine(`檢測率: ${stats.detectionRate}%`, 'response');
                addTerminalLine(`系統健康: ${stats.systemHealth}%`, 'response');
                addTerminalLine(`已封鎖攻擊: ${stats.blockedAttacks}`, 'response');
                addTerminalLine(`活動警報: ${stats.activeAlerts}`, 'response');
                addTerminalLine(`可用資源: ${stats.resources}`, 'response');
            }
            
            addTerminalLine(`連接狀態: ${GameState.connected ? '已連接' : '未連接'}`, 'response');
            if (GameState.connected) {
                addTerminalLine(`目標IP: ${GameState.battle.targetIP}`, 'response');
                addTerminalLine(`連接質量: ${GameState.battle.connectionQuality}%`, 'response');
            }
        }

        // ===== 顯示幫助 =====
        function showHelp(mode, config) {
            addTerminalLine(`=== ${mode === 'hacker' ? '黑客模式' : '防禦模式'} 幫助 ===`, 'system');
            addTerminalLine('可用指令:', 'system');
            
            Object.entries(config.commands).forEach(([cmd, info]) => {
                addTerminalLine(`${cmd.padEnd(15)} - ${info.desc}`, 'response');
            });
            
            addTerminalLine('', 'system');
            addTerminalLine('提示:', 'system');
            addTerminalLine('- 點擊工具卡片快速使用工具', 'response');
            addTerminalLine('- 使用Tab鍵自動補全���令', 'response');
            addTerminalLine('- 保持連接質量以獲得最佳效果', 'response');
        }

        // ===== 自動補全命令 =====
        function autoCompleteCommand(mode, config) {
            if (!terminalInput) return;
            
            const input = terminalInput.value.trim().toLowerCase();
            const commands = Object.keys(config.commands);
            const matches = commands.filter(cmd => cmd.startsWith(input));
            
            if (matches.length === 1) {
                terminalInput.value = matches[0];
            } else if (matches.length > 1) {
                addTerminalLine(`可能的指令: ${matches.join(', ')}`, 'system');
            }
            
            // 移動光標到末尾
            terminalInput.setSelectionRange(terminalInput.value.length, terminalInput.value.length);
        }

        // ===== 更新命令建議 =====
        function updateCommandSuggestions(mode, config) {
            if (!terminalInput) return;
            
            const input = terminalInput.value.trim().toLowerCase();
            if (!input) {
                const suggestions = document.getElementById('input-suggestions');
                if (suggestions) suggestions.innerHTML = '';
                return;
            }
            
            const commands = Object.keys(config.commands);
            const matches = commands.filter(cmd => cmd.includes(input)).slice(0, 5);
            
            if (matches.length > 0) {
                const suggestions = document.getElementById('input-suggestions');
                if (suggestions) {
                    suggestions.innerHTML = matches.map(cmd => `
                        <button class="suggestion-btn" onclick="setTerminalInput('${cmd}')">${cmd}</button>
                    `).join('');
                }
            }
        }

        // ===== 設置終端輸入 =====
        window.setTerminalInput = function(cmd) {
            if (terminalInput) {
                terminalInput.value = cmd;
                terminalInput.focus();
                
                const suggestions = document.getElementById('input-suggestions');
                if (suggestions) suggestions.innerHTML = '';
            }
        };

        // ===== 更新統計顯示 =====
        function updateStatsDisplay(mode) {
            const stats = GameState.stats;
            
            if (mode === 'hacker') {
                updateElementText('stat-attack', `${stats.attackPower}%`);
                updateElementText('stat-stealth', `${stats.stealthLevel}%`);
                updateElementText('stat-access', `${stats.accessLevel}%`);
                updateElementText('stat-attack-value', `${stats.attackPower}%`);
                updateElementText('stat-stealth-value', `${stats.stealthLevel}%`);
                updateElementText('stat-detection-value', `${stats.detectionRisk}%`);
                
                updateBarWidth('attack-bar', stats.attackPower);
                updateBarWidth('stealth-bar', stats.stealthLevel);
                updateBarWidth('detection-bar', stats.detectionRisk);
            } else {
                updateElementText('stat-defense', `${stats.defenseLevel}%`);
                updateElementText('stat-blocked', stats.blockedAttacks);
                updateElementText('stat-alerts', stats.activeAlerts);
                updateElementText('stat-defense-value', `${stats.defenseLevel}%`);
                updateElementText('stat-detection-value', `${stats.detectionRate}%`);
                updateElementText('stat-health-value', `${stats.systemHealth}%`);
                
                updateBarWidth('defense-bar', stats.defenseLevel);
                updateBarWidth('detection-bar', stats.detectionRate);
                updateBarWidth('health-bar', stats.systemHealth);
            }
        }

        function updateElementText(id, text) {
            const element = document.getElementById(id);
            if (element) element.textContent = text;
        }

        function updateBarWidth(id, percentage) {
            const bar = document.getElementById(id);
            if (bar) bar.style.width = `${percentage}%`;
        }

        // ===== 更新工具冷卻 =====
        function updateToolCooldowns() {
            const now = Date.now();
            const toolCards = document.querySelectorAll('.tool-card');
            
            toolCards.forEach(card => {
                const toolId = card.dataset.toolId;
                if (toolId && GameState.toolCooldowns[toolId]) {
                    const remaining = GameState.toolCooldowns[toolId] - now;
                    
                    if (remaining > 0) {
                        const seconds = Math.ceil(remaining / 1000);
                        const cooldownElement = card.querySelector('.tool-cooldown');
                        if (cooldownElement) {
                            cooldownElement.textContent = `冷卻: ${seconds}s`;
                            card.classList.add('disabled');
                        }
                    } else {
                        const cooldownElement = card.querySelector('.tool-cooldown');
                        if (cooldownElement) {
                            cooldownElement.textContent = '';
                            card.classList.remove('disabled');
                        }
                    }
                }
            });
        }

        // ===== 切換隱蔽模式 =====
        function toggleStealthMode() {
            if (GameState.currentMode !== 'hacker') return;
            
            const stealthBoost = 20;
            const speedPenalty = -10;
            
            GameState.stats.stealthLevel = Math.min(100, GameState.stats.stealthLevel + stealthBoost);
            GameState.stats.attackPower = Math.max(0, GameState.stats.attackPower + speedPenalty);
            
            updateStatsDisplay('hacker');
            addTerminalLine('隱蔽模式已啟動，攻擊速度降低但更難被檢測', 'success');
        }

        // ===== 開始遊戲計時器 =====
        function startGameTimer() {
            let seconds = 0;
            
            GameState.gameTimer = setInterval(() => {
                // 監控支援效果
                if (GameState.battle.supportActive) {
                    applySupportEffects();
                    monitorSupportEffects();
                }
                seconds++;
                GameState.stats.time = seconds;
                
                const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                
                updateElementText('stat-time', `${minutes}:${secs}`);
                
                // 每30秒自動保存
                if (seconds % 30 === 0 && GameConfig.settings.autoSave) {
                    saveGameState();
                }
                
                // 每10秒更新冷卻
                if (seconds % 10 === 0) {
                    updateToolCooldowns();
                }
            }, 1000);
        }

        // ===== 開始對戰模擬 =====
        
        // ===== 支援效果監控 =====
        function monitorSupportEffects() {
            if (!GameState.battle.supportActive) return;
            
            const currentTime = Date.now();
            const supportEndTime = GameState.battle.supportEndTime || 0;
            const remainingTime = Math.max(0, supportEndTime - currentTime);
            
            // 更新支援狀態顯示
            if (remainingTime > 0) {
                const minutes = Math.floor(remainingTime / 60000);
                const seconds = Math.floor((remainingTime % 60000) / 1000);
                
                // 定期更新終端
                if (remainingTime % 10000 < 1000) {
                    const supportType = GameState.battle.supportType === 'professional' ? '專業人士' : '執法部門';
                    addTerminalLine(`[支援] ${supportType}仍在提供協助... 剩餘時間: ${minutes}分${seconds}秒`, 'system');
                }
            }
        }
        
        // ===== 應用支援效果到遊戲邏輯 =====
        function applySupportEffects() {
            if (GameState.battle.supportType === 'professional') {
                // 專業人士協助效果：增加防禦和反擊能力
                GameState.stats.defenseLevel = Math.min(100, GameState.stats.defenseLevel + 0.5);
                GameState.stats.counterAttackPower = Math.min(100, GameState.stats.counterAttackPower + 0.3);
            } else if (GameState.battle.supportType === 'police') {
                // 執法部門協助效果：增加檢測能力，降低黑客隱藏等級
                GameState.stats.detectionRate = Math.min(100, GameState.stats.detectionRate + 0.3);
                if (GameState.battle.opponentStats) {
                    GameState.battle.opponentStats.stealthLevel = Math.max(0, GameState.battle.opponentStats.stealthLevel - 0.2);
                }
            }
        }
        
        // ===== 支援效果結束處理 =====
        function endSupportEffect() {
            if (GameState.battle.supportActive) {
                const supportType = GameState.battle.supportType === 'professional' ? '專業人士' : '執法部門';
                addTerminalLine(`[支援] ${supportType}已完成協助任務，正在撤離...`, 'system');
                GameState.battle.supportActive = false;
                GameState.battle.supportType = null;
                GameState.battle.supportEndTime = null;
            }
        }

        function startBattleSimulation(mode) {
            // 模擬隨機網絡事件
            setInterval(() => {
                if (!GameState.connected || !GameState.battleActive) return;
                
                // 隨機網絡波動
                if (Math.random() > 0.7) {
                    const change = Math.random() > 0.5 ? 5 : -5;
                    GameState.battle.connectionQuality = Math.max(10, Math.min(100, GameState.battle.connectionQuality + change));
                    updateConnectionDisplay();
                    
                    if (change < 0) {
                        addTerminalLine(`網絡連接質量下降: ${GameState.battle.connectionQuality}%`, 'warning');
                    }
                }
                
                // 模擬對手的隨機行動
                simulateRandomOpponentAction(mode);
                
            }, 5000);
        }

        // ===== 模擬隨機對手行動 =====
        function simulateRandomOpponentAction(mode) {
            if (!GameState.opponentConnected) return;
            
            const opponentMode = mode === 'hacker' ? 'defender' : 'hacker';
            
            if (opponentMode === 'defender') {
                // 防禦者隨機掃描
                if (Math.random() > 0.8) {
                    addTerminalLine('警告: 檢測到目標系統正在進行安全掃描', 'warning');
                    addAttackLog(`[防禦] ${GameState.battle.targetIP} 正在進行安全掃描`);
                }
                
                // 防禦者更新防火牆
                if (Math.random() > 0.9) {
                    addTerminalLine('注意: 目標系統更新了防火牆規則', 'system');
                    GameState.battle.opponentStats.defenseLevel = Math.min(100, (GameState.battle.opponentStats.defenseLevel || 0) + 5);
                }
            } else {
                // 黑客隨機攻擊嘗試
                if (Math.random() > 0.85) {
                    const attacks = ['端口掃描', '暴力破解嘗試', 'SQL注入探測', '惡意軟件傳播'];
                    const randomAttack = attacks[Math.floor(Math.random() * attacks.length)];
                    
                    addTerminalLine(`警報: 檢測到來自 ${GameState.battle.targetIP} 的${randomAttack}`, 'alert');
                    addAttackLog(`[攻擊] 檢測到 ${randomAttack} 來自 ${GameState.battle.targetIP}`);
                    
                    // 降低系統健康
                    if (mode === 'defender') {
                        GameState.stats.systemHealth = Math.max(0, GameState.stats.systemHealth - 2);
                        GameState.stats.activeAlerts += 1;
                        updateStatsDisplay('defender');
                    }
                }
            }
        }

        // ===== 開始網絡動畫 =====
        function startNetworkAnimation(mode) {
            if (!networkMap) return;
            
            setInterval(() => {
                const lines = networkMap.querySelectorAll('.connection-line');
                lines.forEach(line => {
                    const currentOpacity = parseFloat(line.style.opacity || '0.5');
                    line.style.opacity = Math.random() > 0.5 ? '1' : '0.3';
                });
                
                // 隨機閃爍節點
                if (Math.random() > 0.7) {
                    const nodes = networkMap.querySelectorAll('.node');
                    const randomNode = nodes[Math.floor(Math.random() * nodes.length)];
                    
                    if (randomNode.classList.contains('protected')) {
                        randomNode.style.boxShadow = '0 0 20px #00ff41';
                    } else if (randomNode.classList.contains('attacked')) {
                        randomNode.style.boxShadow = '0 0 20px #ff3333';
                    } else {
                        const color = GameConfig[mode].primaryColor;
                        randomNode.style.boxShadow = `0 0 20px ${color}`;
                    }
                    
                    setTimeout(() => {
                        randomNode.style.boxShadow = '';
                    }, 300);
                }
                
                // 模擬攻擊效果
                if (GameState.battleActive && Math.random() > 0.8) {
                    const attackerNode = networkMap.querySelector('.node:nth-child(1)');
                    const targetNode = networkMap.querySelector('.node:nth-child(3)');
                    
                    if (attackerNode && targetNode) {
                        attackerNode.classList.add('attacked');
                        setTimeout(() => {
                            attackerNode.classList.remove('attacked');
                        }, 500);
                    }
                }
            }, 1000);
        }

        // ===== 瀏覽器模擬器 =====
        function showBrowserSimulator() {
            const mode = GameState.currentMode;
            const targetIP = GameState.battle.targetIP;

            const browserHTML = `
                <div class="modal-overlay" id="browser-simulator-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 1000px; max-height: 90vh; overflow: hidden; background: #1a1a2e; border: none; border-radius: 12px; padding: 0;">
                        <!-- 瀏覽器標題欄 -->
                        <div style="background: linear-gradient(90deg, #2d2d44 0%, #3d3d5c 100%); padding: 10px 15px; display: flex; align-items: center; gap: 15px; border-radius: 12px 12px 0 0;">
                            <div style="display: flex; gap: 8px;">
                                <span onclick="closeBrowserSimulator()" style="width: 12px; height: 12px; background: #ff5f56; border-radius: 50%; cursor: pointer;"></span>
                                <span style="width: 12px; height: 12px; background: #ffbd2e; border-radius: 50%;"></span>
                                <span style="width: 12px; height: 12px; background: #27ca3f; border-radius: 50%;"></span>
                            </div>
                            <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
                                <button onclick="browserBack()" style="background: rgba(255,255,255,0.1); border: none; padding: 5px 10px; border-radius: 4px; color: #888; cursor: pointer;">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <button onclick="browserRefresh()" style="background: rgba(255,255,255,0.1); border: none; padding: 5px 10px; border-radius: 4px; color: #888; cursor: pointer;">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <div style="flex: 1; background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-lock" style="color: ${mode === 'hacker' ? '#ff3333' : '#00ff41'}; font-size: 0.8rem;"></i>
                                    <input type="text" id="browser-url" value="https://${targetIP}/admin" style="flex: 1; background: transparent; border: none; color: #fff; font-size: 0.9rem; outline: none;">
                                    <button onclick="browserNavigate()" style="background: none; border: none; color: #4a90d9; cursor: pointer;">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 瀏覽器內容 -->
                        <div id="browser-content" style="background: #0d0d1a; height: 500px; overflow-y: auto; padding: 0;">
                            ${mode === 'hacker' ? generateHackerBrowserContent() : generateDefenderBrowserContent()}
                        </div>

                        <!-- 瀏覽器狀態欄 -->
                        <div style="background: #2d2d44; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #888;">
                            <div id="browser-status">就緒</div>
                            <div style="display: flex; gap: 15px;">
                                <span><i class="fas fa-shield-alt" style="color: ${mode === 'hacker' ? '#ff3333' : '#00ff41'};"></i> ${mode === 'hacker' ? '攻擊模式' : '防禦模式'}</span>
                                <span><i class="fas fa-network-wired"></i> ${targetIP}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', browserHTML);
        }

        function generateHackerBrowserContent() {
            const targetIP = GameState.battle.targetIP;
            return `
                <div style="padding: 20px;">
                    <!-- 黑客攻擊控制台 -->
                    <div style="background: rgba(255,51,51,0.1); border: 1px solid #ff3333; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #ff3333; margin-bottom: 15px;"><i class="fas fa-skull-crossbones"></i> 目標系統控制台</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">目標IP</div>
                                <div style="color: #ff3333; font-weight: bold;">${targetIP}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">連接狀態</div>
                                <div style="color: #00ff41;">已連接</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">滲透進度</div>
                                <div style="color: #ff9900;">${GameState.hackerAttack.zombieProgress}%</div>
                            </div>
                        </div>

                        <!-- 攻擊按鈕 -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <button onclick="browserInjectPayload()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; padding: 12px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-syringe"></i> 注入惡意腳本
                            </button>
                            <button onclick="browserSQLInjection()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); border: none; padding: 12px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-database"></i> SQL注入
                            </button>
                            <button onclick="browserXSSAttack()" style="background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); border: none; padding: 12px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-code"></i> XSS攻擊
                            </button>
                            <button onclick="browserPhishing()" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border: none; padding: 12px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-fish"></i> 釣魚頁面
                            </button>
                        </div>
                    </div>

                    <!-- 攻擊日誌 -->
                    <div style="background: rgba(0,0,0,0.5); border: 1px solid #333; border-radius: 8px; padding: 15px;">
                        <h4 style="color: #00ff41; margin-bottom: 10px;"><i class="fas fa-terminal"></i> 攻擊日誌</h4>
                        <div id="browser-attack-log" style="font-family: 'Monaco', monospace; font-size: 0.8rem; color: #0f0; max-height: 150px; overflow-y: auto;">
                            <div style="color: #888;">[${new Date().toLocaleTimeString()}] 瀏覽器攻擊模塊已載入</div>
                            <div style="color: #00ff41;">[${new Date().toLocaleTimeString()}] 已連接至目標 ${targetIP}</div>
                            <div style="color: #ffaa00;">[${new Date().toLocaleTimeString()}] 等待攻擊指令...</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateDefenderBrowserContent() {
            return `
                <div style="padding: 20px;">
                    <!-- 安全監控面板 -->
                    <div style="background: rgba(0,255,65,0.1); border: 1px solid #00ff41; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #00ff41; margin-bottom: 15px;"><i class="fas fa-shield-alt"></i> 安全監控中心</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">防火牆</div>
                                <div style="color: #00ff41;">${GameState.firewall.level}%</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">威脅數</div>
                                <div style="color: #ff3333;">${GameState.stats.activeAlerts || 0}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">系統健康</div>
                                <div style="color: ${GameState.stats.systemHealth > 70 ? '#00ff41' : '#ff9900'};">${GameState.stats.systemHealth}%</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">攔截次數</div>
                                <div style="color: #4a90d9;">${Math.floor(Math.random() * 50) + 10}</div>
                            </div>
                        </div>

                        <!-- 防禦按鈕 -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <button onclick="browserBlockIP()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; padding: 12px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-ban"></i> 封鎖可疑IP
                            </button>
                            <button onclick="browserScanThreats()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none; padding: 12px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-search"></i> 掃描威脅
                            </button>
                            <button onclick="browserUpdateFirewall()" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border: none; padding: 12px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-sync"></i> 更新防火牆
                            </button>
                            <button onclick="browserBackup()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); border: none; padding: 12px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-database"></i> 備份數據
                            </button>
                        </div>
                    </div>

                    <!-- 安全日誌 -->
                    <div style="background: rgba(0,0,0,0.5); border: 1px solid #333; border-radius: 8px; padding: 15px;">
                        <h4 style="color: #ff3333; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> 安全日誌</h4>
                        <div id="browser-security-log" style="font-family: 'Monaco', monospace; font-size: 0.8rem; max-height: 150px; overflow-y: auto;">
                            <div style="color: #00ff41;">[${new Date().toLocaleTimeString()}] 安全監控系統已啟動</div>
                            <div style="color: #ffaa00;">[${new Date().toLocaleTimeString()}] 偵測到可疑連接嘗試</div>
                            <div style="color: #ff3333;">[${new Date().toLocaleTimeString()}] 警告: 發現潛在威脅</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeBrowserSimulator() {
            const modal = document.getElementById('browser-simulator-modal');
            if (modal) modal.remove();
        }

        function browserNavigate() {
            const url = document.getElementById('browser-url').value;
            const statusEl = document.getElementById('browser-status');
            if (statusEl) statusEl.textContent = '正在載入: ' + url;
            addTerminalLine(`[瀏覽器] 導航至: ${url}`, 'system');

            setTimeout(() => {
                if (statusEl) statusEl.textContent = '已載入';
            }, 1000);
        }

        function browserBack() {
            addTerminalLine('[瀏覽器] 返回上一頁', 'system');
        }

        function browserRefresh() {
            addTerminalLine('[瀏覽器] 刷新頁面', 'system');
            const statusEl = document.getElementById('browser-status');
            if (statusEl) statusEl.textContent = '正在刷新...';
            setTimeout(() => {
                if (statusEl) statusEl.textContent = '已刷新';
            }, 500);
        }

        // 瀏覽器攻擊功能
        function browserInjectPayload() {
            addBrowserLog('attack', '正在注入惡意腳本...');
            addTerminalLine('[瀏覽器攻擊] 注入惡意腳本到目標頁面...', 'command');
            setTimeout(() => {
                const success = Math.random() > 0.3;
                if (success) {
                    addBrowserLog('attack', '✓ 惡意腳本注入成功！');
                    addTerminalLine('✓ 惡意腳本已成功注入目標頁面', 'success');
                    GameState.hackerAttack.zombieProgress = Math.min(100, GameState.hackerAttack.zombieProgress + 10);
                } else {
                    addBrowserLog('attack', '✗ 注入被WAF阻擋');
                    addTerminalLine('✗ 注入失敗，被Web應用防火牆阻擋', 'error');
                }
            }, 1500);
        }

        function browserSQLInjection() {
            addBrowserLog('attack', '正在執行SQL注入...');
            addTerminalLine('[瀏覽器攻擊] 嘗試SQL注入攻擊...', 'command');
            setTimeout(() => {
                addBrowserLog('attack', '✓ 發現SQL漏洞！提取數據中...');
                addTerminalLine('✓ SQL注入成功！正在提取數據庫資料...', 'success');
                GameState.hackerAttack.stolenFunds += Math.floor(Math.random() * 5000) + 1000;
            }, 2000);
        }

        function browserXSSAttack() {
            addBrowserLog('attack', '正在部署XSS攻擊腳本...');
            addTerminalLine('[瀏覽器攻擊] 執行跨站腳本攻擊...', 'command');
            setTimeout(() => {
                addBrowserLog('attack', '✓ XSS腳本已植入！等待觸發...');
                addTerminalLine('✓ XSS攻擊成功，已植入惡意腳本', 'success');
            }, 1500);
        }

        function browserPhishing() {
            addBrowserLog('attack', '正在生成釣魚頁���...');
            addTerminalLine('[瀏覽器攻擊] 創建釣魚頁面...', 'command');
            setTimeout(() => {
                addBrowserLog('attack', '✓ 釣魚頁面已創建並發送給目標');
                addTerminalLine('✓ 釣魚頁面已發送給目標用戶', 'success');
                showPhishingTemplateSelector();
            }, 1500);
        }

        // ===== 釣魚網站模擬系統 =====
        const PhishingTemplates = {
            bank: { name: '銀行登入頁面', icon: 'fas fa-university', url: 'secure-bank-login.com/verify', title: '安全銀行', color: '#0066cc' },
            email: { name: '電子郵件登入', icon: 'fas fa-envelope', url: 'mail-security-check.net/login', title: 'Email Security', color: '#ea4335' },
            social: { name: '社交媒體登入', icon: 'fas fa-users', url: 'social-verify.app/account', title: '社交平台', color: '#1877f2' },
            crypto: { name: '加密貨幣錢包', icon: 'fab fa-bitcoin', url: 'wallet-verify.io/secure', title: 'CryptoWallet', color: '#f7931a' },
            ecommerce: { name: '電商購物網站', icon: 'fas fa-shopping-cart', url: 'shop-rewards.deals/claim', title: '購物獎勵', color: '#ff9900' },
            government: { name: '政府服務網站', icon: 'fas fa-landmark', url: 'gov-tax-refund.org/verify', title: '政府稅務', color: '#003366' }
        };

        function showPhishingTemplateSelector() {
            const stats = GameState.phishing;
            const templateHTML = `
                <div class="modal-overlay" id="phishing-template-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(10,10,35,0.98) 0%, rgba(20,20,55,0.98) 100%); border: 2px solid #e74c3c;">
                        <h2 style="color: #e74c3c; margin-bottom: 20px; text-align: center;"><i class="fas fa-fish"></i> 釣魚網站生成器</h2>
                        <p style="color: #888; text-align: center; margin-bottom: 20px;">選擇要發送給目標的釣魚網站模板</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                            ${Object.entries(PhishingTemplates).map(([key, tpl]) => `
                                <div onclick="selectPhishingTemplate('${key}')" style="background: rgba(0,0,0,0.4); border: 2px solid ${tpl.color}40; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center;" onmouseover="this.style.borderColor='${tpl.color}'; this.style.boxShadow='0 0 20px ${tpl.color}40';" onmouseout="this.style.borderColor='${tpl.color}40'; this.style.boxShadow='none';">
                                    <i class="${tpl.icon}" style="font-size: 2.5rem; color: ${tpl.color}; margin-bottom: 12px; display: block;"></i>
                                    <div style="color: #fff; font-weight: bold; margin-bottom: 5px;">${tpl.name}</div>
                                    <div style="color: #666; font-size: 0.75rem;">${tpl.url}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="background: rgba(0,0,0,0.5); border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                                <div><div style="color: #666; font-size: 0.75rem;">已發送</div><div style="color: #3498db; font-size: 1.5rem; font-weight: bold;">${stats.sentCount}</div></div>
                                <div><div style="color: #666; font-size: 0.75rem;">成功捕獲</div><div style="color: #2ecc71; font-size: 1.5rem; font-weight: bold;">${stats.successCount}</div></div>
                                <div><div style="color: #666; font-size: 0.75rem;">���功率</div><div style="color: #f39c12; font-size: 1.5rem; font-weight: bold;">${stats.sentCount > 0 ? Math.round((stats.successCount / stats.sentCount) * 100) : 0}%</div></div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: center;"><button onclick="closePhishingTemplateModal()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 25px; border-radius: 8px; color: #fff; cursor: pointer;"><i class="fas fa-times"></i> 關閉</button></div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', templateHTML);
        }

        function closePhishingTemplateModal() {
            const modal = document.getElementById('phishing-template-modal');
            if (modal) modal.remove();
        }

        function selectPhishingTemplate(templateKey) {
            const template = PhishingTemplates[templateKey];
            GameState.phishing.activeTemplate = templateKey;
            GameState.phishing.sentCount++;
            closePhishingTemplateModal();
            addTerminalLine('[釣魚] 使用模板: ' + template.name, 'command');
            addTerminalLine('[釣魚] URL: https://' + template.url, 'system');
            if (typeof updateDeviceScreen === 'function') {
                updateDeviceScreen('player', '📧 發送釣魚連結: ' + template.name);
                updateDeviceScreen('opponent', '📨 收到可疑郵件...');
            }
            showPhishingSentConfirmation(template, templateKey);
        }

        function showPhishingSentConfirmation(template, templateKey) {
            const sentHTML = `
                <div class="modal-overlay" id="phishing-sent-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 600px; background: linear-gradient(135deg, rgba(10,30,10,0.98) 0%, rgba(15,40,15,0.98) 100%); border: 2px solid #2ecc71;">
                        <h3 style="color: #2ecc71; text-align: center; margin-bottom: 20px;"><i class="fas fa-paper-plane"></i> 釣魚郵件已發送!</h3>
                        <div style="background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="color: #333; font-size: 0.85rem;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                    <i class="fas fa-envelope" style="color: #e74c3c; margin-right: 10px;"></i>
                                    <div><div style="font-weight: bold; color: #333;">緊急通知：帳戶安全警告</div><div style="color: #666; font-size: 0.75rem;">security@${template.url.split('/')[0]}</div></div>
                                </div>
                                <p style="color: #333; margin-bottom: 10px;">親愛的用戶，我們偵測到您的帳戶有異常活動。請立即點擊驗證：</p>
                                <a href="#" style="display: inline-block; background: ${template.color}; color: #fff; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold;">立即驗證</a>
                            </div>
                        </div>
                        <p style="color: #888; text-align: center; margin-bottom: 15px;">正在等待目標點擊連結...</p>
                        <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                            <button onclick="simulateVictimClick('${templateKey}')" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; padding: 12px 25px; border-radius: 8px; color: #fff; cursor: pointer; font-weight: bold;"><i class="fas fa-mouse-pointer"></i> 模擬受害者點擊</button>
                            <button onclick="waitForVictimClick('${templateKey}')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none; padding: 12px 25px; border-radius: 8px; color: #fff; cursor: pointer; font-weight: bold;"><i class="fas fa-clock"></i> 等待AI反應</button>
                            <button onclick="closePhishingSentModal()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 25px; border-radius: 8px; color: #fff; cursor: pointer;"><i class="fas fa-times"></i> 關閉</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', sentHTML);
        }

        function closePhishingSentModal() {
            const modal = document.getElementById('phishing-sent-modal');
            if (modal) modal.remove();
        }

        function simulateVictimClick(templateKey) {
            closePhishingSentModal();
            showVictimBrowserView(templateKey);
        }

        function waitForVictimClick(templateKey) {
            closePhishingSentModal();
            addTerminalLine('[等待] AI受害者正在檢視郵件...', 'system');
            if (typeof updateDeviceScreen === 'function') updateDeviceScreen('opponent', '🔍 查看收到的郵件...');
            setTimeout(() => {
                const random = Math.random();
                if (random < 0.7) {
                    addTerminalLine('[成功!] 目標已點擊釣魚連結!', 'success');
                    if (typeof updateDeviceScreen === 'function') {
                        updateDeviceScreen('player', '🎯 目標已上鉤!');
                        updateDeviceScreen('opponent', '🖱️ 點擊了可疑連結...');
                    }
                    setTimeout(() => showVictimBrowserView(templateKey), 1000);
                } else {
                    addTerminalLine('[警告] 目標察覺到釣魚攻擊!', 'warning');
                    if (typeof updateDeviceScreen === 'function') {
                        updateDeviceScreen('player', '⚠️ 目標未上鉤');
                        updateDeviceScreen('opponent', '🚫 識別為釣魚郵件');
                    }
                    if (typeof showNotification === 'function') showNotification('釣魚失敗', '目標識破了釣魚攻擊', 'warning');
                }
            }, 3000);
        }

        function showVictimBrowserView(templateKey) {
            const template = PhishingTemplates[templateKey];
            const victimBrowserHTML = `
                <div class="modal-overlay" id="victim-browser-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 1100px; max-height: 95vh; overflow: hidden; background: linear-gradient(135deg, rgba(10,10,30,0.98) 0%, rgba(20,20,50,0.98) 100%); border: 2px solid ${template.color}; padding: 0;">
                        <div style="background: rgba(0,0,0,0.8); padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;"><i class="fas fa-eye" style="color: #e74c3c;"></i><span style="color: #e74c3c; font-weight: bold;">受害者瀏覽器視角 - 即時監控</span></div>
                            <span style="background: #e74c3c; padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; animation: pulse 1s infinite;">● 實時監控中</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; height: calc(95vh - 60px);">
                            <div style="border-right: 1px solid #333; overflow: hidden; display: flex; flex-direction: column;">
                                <div style="background: #2d2d2d; padding: 8px 12px; display: flex; align-items: center; gap: 10px;">
                                    <div style="display: flex; gap: 6px;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #ff5f56;"></div><div style="width: 12px; height: 12px; border-radius: 50%; background: #ffbd2e;"></div><div style="width: 12px; height: 12px; border-radius: 50%; background: #27c93f;"></div></div>
                                    <div style="flex: 1; background: #1a1a1a; padding: 6px 12px; border-radius: 4px; display: flex; align-items: center; gap: 8px;"><i class="fas fa-lock" style="color: #2ecc71; font-size: 0.75rem;"></i><span style="color: #aaa; font-size: 0.8rem;">https://${template.url}</span></div>
                                </div>
                                <div style="flex: 1; overflow-y: auto; background: #fff;">${generatePhishingPageContent(templateKey, template)}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto;">
                                <h4 style="color: #e74c3c; margin: 0; display: flex; align-items: center; gap: 8px;"><i class="fas fa-terminal"></i> 數據攔截終端</h4>
                                <div style="background: rgba(0,0,0,0.6); border: 1px solid #333; border-radius: 6px; padding: 10px; flex: 1;">
                                    <div style="color: #666; font-size: 0.7rem; margin-bottom: 8px;">► 活動監控</div>
                                    <div id="phishing-activity-log" style="font-family: monospace; font-size: 0.7rem; color: #00ff41; max-height: 150px; overflow-y: auto;"><div>[${new Date().toLocaleTimeString()}] 連接已建立</div><div>[${new Date().toLocaleTimeString()}] 受害者已載入頁面</div></div>
                                </div>
                                <div style="background: rgba(0,0,0,0.6); border: 1px solid #e74c3c40; border-radius: 6px; padding: 10px;">
                                    <div style="color: #e74c3c; font-size: 0.7rem; margin-bottom: 8px;">► 捕獲數據</div>
                                    <div id="captured-data-display" style="font-family: monospace; font-size: 0.7rem; color: #f39c12;"><div style="color: #666;">等待受害者輸入...</div></div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <button onclick="simulateVictimTyping('${templateKey}')" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; padding: 10px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold; font-size: 0.85rem;"><i class="fas fa-keyboard"></i> 模擬受害者輸入</button>
                                    <button onclick="injectKeylogger()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); border: none; padding: 10px; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.85rem;"><i class="fas fa-bug"></i> 注入鍵盤記錄器</button>
                                    <button onclick="stealCookies()" style="background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); border: none; padding: 10px; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.85rem;"><i class="fas fa-cookie-bite"></i> 竊取Cookies</button>
                                    <button onclick="closeVictimBrowser()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 10px; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.85rem;"><i class="fas fa-times"></i> 關閉監控</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', victimBrowserHTML);
            if (typeof updateDeviceScreen === 'function') {
                updateDeviceScreen('opponent', '🌐 正在瀏覽網站...');
                updateDeviceScreen('player', '👁️ 監控受害者瀏覽器');
            }
            startPhishingActivitySimulation();
        }

        function generatePhishingPageContent(templateKey, template) {
            const bankPage = '<div style="background: linear-gradient(135deg, ' + template.color + ' 0%, #004080 100%); padding: 20px; text-align: center;"><h1 style="color: #fff; margin: 0; font-size: 1.5rem;">🏦 安全銀行</h1></div><div style="max-width: 400px; margin: 40px auto; padding: 30px; background: #fff; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);"><div style="text-align: center; margin-bottom: 25px;"><i class="fas fa-shield-alt" style="font-size: 3rem; color: ' + template.color + ';"></i><h2 style="color: #333; margin: 15px 0 5px 0;">帳戶安全驗證</h2></div><div style="margin-bottom: 15px;"><label style="color: #333; font-size: 0.85rem; display: block; margin-bottom: 5px;">用戶名</label><input type="text" id="victim-username" placeholder="請輸入用戶名" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"></div><div style="margin-bottom: 15px;"><label style="color: #333; font-size: 0.85rem; display: block; margin-bottom: 5px;">密碼</label><input type="password" id="victim-password" placeholder="請輸入密碼" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"></div><button onclick="captureCredentials()" style="width: 100%; padding: 14px; background: ' + template.color + '; color: #fff; border: none; border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer;">立即驗證</button></div>';
            const emailPage = '<div style="background: ' + template.color + '; padding: 15px 20px;"><span style="color: #fff; font-size: 1.2rem; font-weight: bold;"><i class="fas fa-envelope"></i> Email Security</span></div><div style="max-width: 400px; margin: 40px auto; padding: 30px; background: #fff; border-radius: 10px;"><h2 style="color: #333; text-align: center;">帳戶異常登入</h2><div style="margin-bottom: 15px;"><input type="email" id="victim-username" placeholder="電子郵件" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"></div><div style="margin-bottom: 20px;"><input type="password" id="victim-password" placeholder="密碼" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"></div><button onclick="captureCredentials()" style="width: 100%; padding: 14px; background: ' + template.color + '; color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">確認身份</button></div>';
            const cryptoPage = '<div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 20px; text-align: center;"><i class="fab fa-bitcoin" style="color: ' + template.color + '; font-size: 2.5rem;"></i><h1 style="color: #fff; margin: 10px 0 0 0; font-size: 1.3rem;">CryptoWallet</h1></div><div style="max-width: 450px; margin: 30px auto; padding: 30px; background: #fff; border-radius: 10px;"><h2 style="color: #333; text-align: center;">錢包恢復</h2><div style="margin-bottom: 15px;"><label style="color: #333;">12字助記詞</label><textarea id="victim-seed" placeholder="word1 word2 word3..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; height: 80px; box-sizing: border-box;"></textarea></div><div style="margin-bottom: 20px;"><input type="password" id="victim-password" placeholder="錢包密碼" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"></div><button onclick="captureCryptoCredentials()" style="width: 100%; padding: 14px; background: ' + template.color + '; color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">恢復錢包</button></div>';
            const ecommercePage = '<div style="background: ' + template.color + '; padding: 15px 20px;"><span style="color: #fff; font-weight: bold;"><i class="fas fa-shopping-cart"></i> ShopRewards</span></div><div style="max-width: 500px; margin: 30px auto; padding: 30px; background: #fff; border-radius: 10px;"><div style="text-align: center; margin-bottom: 20px;"><div style="background: #e74c3c; color: #fff; display: inline-block; padding: 10px 20px; border-radius: 8px;">🎉 恭喜獲得 $500 購物券</div></div><div style="margin-bottom: 15px;"><input type="text" id="victim-card" placeholder="信用卡號碼" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;"><input type="text" id="victim-expiry" placeholder="MM/YY" style="padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;"><input type="text" id="victim-cvv" placeholder="CVV" style="padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;"></div><button onclick="captureCardCredentials()" style="width: 100%; padding: 14px; background: ' + template.color + '; color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">領取購物券</button></div>';
            const govPage = '<div style="background: ' + template.color + '; padding: 20px; text-align: center;"><i class="fas fa-landmark" style="color: #fff; font-size: 2rem;"></i><h1 style="color: #fff; margin: 10px 0 0 0;">政府稅務局</h1></div><div style="max-width: 450px; margin: 30px auto; padding: 30px; background: #fff; border-radius: 10px;"><div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="color: #155724; margin: 0; font-weight: bold;">💰 您有 $2,847.00 待領取退款</p></div><div style="margin-bottom: 15px;"><input type="text" id="victim-id" placeholder="身份證號碼" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"></div><div style="margin-bottom: 15px;"><input type="text" id="victim-bank" placeholder="銀行帳號" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"></div><div style="margin-bottom: 20px;"><input type="password" id="victim-password" placeholder="網銀密碼" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"></div><button onclick="captureGovCredentials()" style="width: 100%; padding: 14px; background: ' + template.color + '; color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">提交驗證</button></div>';
            const socialPage = '<div style="background: ' + template.color + '; padding: 20px; text-align: center;"><i class="fab fa-facebook" style="color: #fff; font-size: 2.5rem;"></i></div><div style="max-width: 400px; margin: 40px auto; padding: 30px; background: #fff; border-radius: 10px;"><h2 style="color: #333; text-align: center;">登入確認</h2><div style="margin-bottom: 15px;"><input type="text" id="victim-username" placeholder="電話或電郵" style="width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"></div><div style="margin-bottom: 20px;"><input type="password" id="victim-password" placeholder="密碼" style="width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"></div><button onclick="captureCredentials()" style="width: 100%; padding: 14px; background: ' + template.color + '; color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">登入</button></div>';
            const pages = { bank: bankPage, email: emailPage, social: socialPage, crypto: cryptoPage, ecommerce: ecommercePage, government: govPage };
            return pages[templateKey] || bankPage;
        }

        function startPhishingActivitySimulation() {
            const activities = ['正在追蹤滑鼠移動...', '鍵盤活動偵測中...', '頁面滾動: 150px', '滑鼠懸停: 登入按鈕'];
            GameState.phishingActivityInterval = setInterval(() => {
                const logEl = document.getElementById('phishing-activity-log');
                if (!logEl) { clearInterval(GameState.phishingActivityInterval); return; }
                const activity = activities[Math.floor(Math.random() * activities.length)];
                logEl.innerHTML += '<div>[' + new Date().toLocaleTimeString() + '] ' + activity + '</div>';
                logEl.scrollTop = logEl.scrollHeight;
            }, 2000);
        }

        function closeVictimBrowser() {
            const modal = document.getElementById('victim-browser-modal');
            if (modal) modal.remove();
            if (GameState.phishingActivityInterval) clearInterval(GameState.phishingActivityInterval);
        }

        function simulateVictimTyping(templateKey) {
            const logEl = document.getElementById('phishing-activity-log');
            const dataEl = document.getElementById('captured-data-display');
            if (!logEl || !dataEl) return;
            const fakeData = { bank: { username: 'john.doe2024', password: 'MyBank$ecure123' }, email: { username: 'victim@email.com', password: 'EmailPass99!' }, social: { username: '+1-555-123-4567', password: 'Social#123' }, crypto: { seed: 'abandon ability able about above absent absorb abstract absurd abuse access accident', password: 'CryptoWallet$afe' }, ecommerce: { card: '4532-1234-5678-9012', expiry: '12/26', cvv: '847' }, government: { id: 'A123456789', bank: '012-345678-901', password: 'TaxRefund2024' } };
            const creds = fakeData[templateKey] || fakeData.bank;
            let charIndex = 0, fieldIndex = 0;
            const fields = Object.entries(creds);
            if (typeof updateDeviceScreen === 'function') updateDeviceScreen('opponent', '⌨️ 正在輸入資料...');
            const typeInterval = setInterval(() => {
                if (fieldIndex >= fields.length) {
                    clearInterval(typeInterval);
                    logEl.innerHTML += '<div style="color: #2ecc71;">[' + new Date().toLocaleTimeString() + '] ✓ 所有數據已捕獲!</div>';
                    addTerminalLine('✓ 成功捕獲受害者憑證!', 'success');
                    GameState.phishing.successCount++;
                    if (typeof updateDeviceScreen === 'function') {
                        updateDeviceScreen('player', '🎯 憑證捕獲成功!');
                        updateDeviceScreen('opponent', '✅ 提交表單中...');
                    }
                    return;
                }
                const [field, value] = fields[fieldIndex];
                const displayValue = field === 'password' ? '*'.repeat(value.length) : value;
                if (charIndex === 0) logEl.innerHTML += '<div>[' + new Date().toLocaleTimeString() + '] 正在輸入 ' + field + '...</div>';
                const partialValue = displayValue.substring(0, charIndex + 1);
                let displayHTML = '';
                for (let i = 0; i <= fieldIndex; i++) {
                    const [f, v] = fields[i];
                    const dv = f === 'password' ? '*'.repeat(v.length) : v;
                    if (i < fieldIndex) displayHTML += '<div><span style="color: #888;">' + f + ':</span> <span style="color: #2ecc71;">' + dv + '</span></div>';
                    else if (i === fieldIndex) displayHTML += '<div><span style="color: #888;">' + f + ':</span> <span style="color: #f39c12;">' + partialValue + '</span></div>';
                }
                dataEl.innerHTML = displayHTML;
                charIndex++;
                if (charIndex > value.length) { charIndex = 0; fieldIndex++; }
            }, 100);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function captureCredentials() {
            const username = document.getElementById('victim-username')?.value || 'captured_user';
            const password = document.getElementById('victim-password')?.value || '********';
            addPhishingLog('捕獲用戶名: ' + username);
            addPhishingLog('捕獲密碼: ' + '*'.repeat(password.length));
            GameState.phishing.capturedData.push({ type: 'credentials', username: username, password: password, timestamp: new Date() });
            GameState.phishing.successCount++;
            addTerminalLine('✓ 捕獲憑證 - 用戶: ' + username, 'success');
            if (typeof updateDeviceScreen === 'function') updateDeviceScreen('player', '🔓 捕獲: ' + username);
            if (typeof showNotification === 'function') showNotification('數據捕獲', '成功竊取登入憑證', 'success');
        }

        function captureCryptoCredentials() {
            const seed = document.getElementById('victim-seed')?.value || 'captured_seed_phrase';
            addPhishingLog('捕獲助記詞: ' + seed.substring(0, 20) + '...');
            GameState.phishing.capturedData.push({ type: 'crypto', seed: seed, timestamp: new Date() });
            GameState.phishing.successCount++;
            addTerminalLine('✓ 捕獲加密錢包助記詞!', 'success');
            if (typeof updateDeviceScreen === 'function') updateDeviceScreen('player', '💰 竊取助記詞成功!');
            if (typeof showNotification === 'function') showNotification('重大收穫', '成功竊取加密錢包!', 'success');
        }

        function captureCardCredentials() {
            const card = document.getElementById('victim-card')?.value || '4532-****-****-9012';
            addPhishingLog('捕獲信用卡: ' + card);
            GameState.phishing.capturedData.push({ type: 'card', card: card, timestamp: new Date() });
            GameState.phishing.successCount++;
            addTerminalLine('✓ 捕獲信用卡資料', 'success');
            if (typeof updateDeviceScreen === 'function') updateDeviceScreen('player', '💳 信用卡資料到手!');
            if (typeof showNotification === 'function') showNotification('財務數據', '成功竊取信用卡資訊', 'success');
        }

        function captureGovCredentials() {
            const id = document.getElementById('victim-id')?.value || 'A123456789';
            const bank = document.getElementById('victim-bank')?.value || '012-345678-901';
            addPhishingLog('捕獲身份證: ' + id);
            addPhishingLog('捕獲銀行帳號: ' + bank);
            GameState.phishing.capturedData.push({ type: 'government', id: id, bank: bank, timestamp: new Date() });
            GameState.phishing.successCount++;
            addTerminalLine('✓ 捕獲政府身份資料!', 'success');
            if (typeof updateDeviceScreen === 'function') updateDeviceScreen('player', '🏛️ 身份資料已竊取!');
            if (typeof showNotification === 'function') showNotification('身份盜竊', '成功竊取政府身份資訊', 'success');
        }

        function addPhishingLog(message) {
            const logEl = document.getElementById('phishing-activity-log');
            if (logEl) {
                logEl.innerHTML += '<div style="color: #e74c3c;">[' + new Date().toLocaleTimeString() + '] ' + message + '</div>';
                logEl.scrollTop = logEl.scrollHeight;
            }
        }

        function injectKeylogger() {
            addPhishingLog('正在注入鍵盤記錄器...');
            addTerminalLine('[注入] 植入鍵盤記錄器...', 'command');
            setTimeout(() => {
                addPhishingLog('✓ 鍵盤記錄器已啟動');
                addTerminalLine('✓ 鍵盤記錄器運行中', 'success');
                if (typeof updateDeviceScreen === 'function') {
                    updateDeviceScreen('player', '⌨️ 鍵盤監控已啟動');
                    updateDeviceScreen('opponent', '⚠️ 系統變慢...');
                }
            }, 1500);
        }

        function stealCookies() {
            addPhishingLog('正在竊取會話Cookies...');
            addTerminalLine('[竊取] 提取瀏覽器Cookies...', 'command');
            setTimeout(() => {
                const fakeCookies = ['session_id=abc123xyz789', 'auth_token=eyJhbGciOiJIUzI1NiJ9...', 'user_pref=premium_member'];
                fakeCookies.forEach(cookie => addPhishingLog('Cookie: ' + cookie.substring(0, 30) + '...'));
                addTerminalLine('✓ 竊取了 ' + fakeCookies.length + ' 個Cookies', 'success');
                if (typeof updateDeviceScreen === 'function') updateDeviceScreen('player', '🍪 竊取 ' + fakeCookies.length + ' 個Cookies');
                if (typeof showNotification === 'function') showNotification('Cookie竊取', '成功獲取會話Cookie', 'success');
            }, 2000);
        }

        // 瀏覽器防禦功能
        function browserBlockIP() {
            addBrowserLog('security', '正在封鎖可疑IP...');
            addTerminalLine('[防禦] 封鎖可疑IP地址...', 'command');
            setTimeout(() => {
                addBrowserLog('security', '✓ 已封鎖3個可疑IP地址');
                addTerminalLine('✓ 已成功封鎖可疑IP', 'success');
                GameState.stats.defenseLevel = Math.min(100, (GameState.stats.defenseLevel || 50) + 5);
            }, 1000);
        }

        function browserScanThreats() {
            addBrowserLog('security', '正在掃描系統威脅...');
            addTerminalLine('[防禦] 執行威脅掃描...', 'command');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 20;
                addBrowserLog('security', `掃描進度: ${progress}%`);
                if (progress >= 100) {
                    clearInterval(interval);
                    const threats = Math.floor(Math.random() * 5);
                    addBrowserLog('security', `✓ 掃描完成！發現 ${threats} 個威脅`);
                    addTerminalLine(`✓ 掃描完成，發現 ${threats} 個威脅`, threats > 0 ? 'warning' : 'success');
                }
            }, 500);
        }

        function browserUpdateFirewall() {
            addBrowserLog('security', '正在更新防火牆規則...');
            addTerminalLine('[防禦] 更新防火牆...', 'command');
            setTimeout(() => {
                GameState.firewall.level = Math.min(100, GameState.firewall.level + 10);
                addBrowserLog('security', `✓ 防火牆已更新至 ${GameState.firewall.level}%`);
                addTerminalLine(`✓ 防火牆已升級至 ${GameState.firewall.level}%`, 'success');
            }, 1500);
        }

        function browserBackup() {
            addBrowserLog('security', '正在備份重要數據...');
            addTerminalLine('[防禦] 執行數據備份...', 'command');
            setTimeout(() => {
                addBrowserLog('security', '✓ 數據備份完成！');
                addTerminalLine('✓ 重要數據已安全備份', 'success');
            }, 2000);
        }

        function addBrowserLog(type, message) {
            const logId = type === 'attack' ? 'browser-attack-log' : 'browser-security-log';
            const logEl = document.getElementById(logId);
            if (logEl) {
                const color = message.includes('✓') ? '#00ff41' : message.includes('✗') ? '#ff3333' : '#ffaa00';
                logEl.innerHTML += `<div style="color: ${color};">[${new Date().toLocaleTimeString()}] ${message}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        }

        // ===== 網絡封包查看器 =====
        function showNetworkPackets() {
            const packets = generateMockPackets();

            const packetHTML = `
                <div class="modal-overlay" id="network-packets-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(10,10,30,0.98) 0%, rgba(20,20,50,0.98) 100%); border: 2px solid #9b59b6;">
                        <h2 style="color: #9b59b6; margin-bottom: 20px; text-align: center; text-shadow: 0 0 10px rgba(155,89,182,0.5);">
                            <i class="fas fa-network-wired"></i> 網絡封包分析器
                        </h2>

                        <!-- 即時統計 -->
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #3498db;">
                                <div style="color: #888; font-size: 0.75rem;">TCP封包</div>
                                <div style="color: #3498db; font-weight: bold;" id="tcp-count">${Math.floor(Math.random() * 500) + 200}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #2ecc71;">
                                <div style="color: #888; font-size: 0.75rem;">UDP封包</div>
                                <div style="color: #2ecc71; font-weight: bold;" id="udp-count">${Math.floor(Math.random() * 200) + 50}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #f39c12;">
                                <div style="color: #888; font-size: 0.75rem;">HTTP請求</div>
                                <div style="color: #f39c12; font-weight: bold;" id="http-count">${Math.floor(Math.random() * 100) + 30}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #e74c3c;">
                                <div style="color: #888; font-size: 0.75rem;">可疑封包</div>
                                <div style="color: #e74c3c; font-weight: bold;" id="suspicious-count">${Math.floor(Math.random() * 20) + 5}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #9b59b6;">
                                <div style="color: #888; font-size: 0.75rem;">加密封包</div>
                                <div style="color: #9b59b6; font-weight: bold;" id="encrypted-count">${Math.floor(Math.random() * 150) + 80}</div>
                            </div>
                        </div>

                        <!-- 封包列表 -->
                        <div style="background: rgba(0,0,0,0.5); border: 1px solid #333; border-radius: 8px; overflow: hidden;">
                            <div style="display: grid; grid-template-columns: 80px 120px 120px 60px 150px 1fr; background: rgba(155,89,182,0.2); padding: 10px; font-size: 0.8rem; color: #9b59b6; font-weight: bold;">
                                <div>序號</div>
                                <div>源IP</div>
                                <div>目標IP</div>
                                <div>協議</div>
                                <div>端口</div>
                                <div>狀態</div>
                            </div>
                            <div id="packet-list" style="max-height: 300px; overflow-y: auto; font-family: 'Monaco', monospace; font-size: 0.75rem;">
                                ${packets.map((p, i) => `
                                    <div style="display: grid; grid-template-columns: 80px 120px 120px 60px 150px 1fr; padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); color: ${p.suspicious ? '#ff3333' : '#aaa'}; ${p.suspicious ? 'background: rgba(255,51,51,0.1);' : ''}">
                                        <div>${i + 1}</div>
                                        <div>${p.srcIP}</div>
                                        <div>${p.dstIP}</div>
                                        <div style="color: ${p.protocol === 'TCP' ? '#3498db' : p.protocol === 'UDP' ? '#2ecc71' : '#f39c12'};">${p.protocol}</div>
                                        <div>${p.srcPort} → ${p.dstPort}</div>
                                        <div style="color: ${p.status === 'BLOCKED' ? '#ff3333' : '#00ff41'};">${p.status} ${p.suspicious ? '⚠️' : ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- 控制按鈕 -->
                        <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                            <button onclick="capturePackets()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-play"></i> 開始捕獲
                            </button>
                            <button onclick="analyzePackets()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); border: none; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-search"></i> 深度分析
                            </button>
                            <button onclick="exportPackets()" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border: none; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-download"></i> 導出報告
                            </button>
                            <button onclick="closeNetworkPackets()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', packetHTML);

            // 開始即時更新
            startPacketUpdates();
        }

        function generateMockPackets() {
            const protocols = ['TCP', 'UDP', 'HTTP', 'HTTPS', 'DNS'];
            const statuses = ['ESTABLISHED', 'SYN_SENT', 'ACK', 'BLOCKED', 'TIMEOUT'];
            const packets = [];

            for (let i = 0; i < 20; i++) {
                packets.push({
                    srcIP: `${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`,
                    dstIP: GameState.battle.targetIP || '192.168.1.1',
                    protocol: protocols[Math.floor(Math.random() * protocols.length)],
                    srcPort: Math.floor(Math.random() * 65535),
                    dstPort: [80, 443, 22, 3306, 8080][Math.floor(Math.random() * 5)],
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    suspicious: Math.random() > 0.8
                });
            }

            return packets;
        }

        function closeNetworkPackets() {
            const modal = document.getElementById('network-packets-modal');
            if (modal) modal.remove();
            if (GameState.packetUpdateInterval) {
                clearInterval(GameState.packetUpdateInterval);
            }
        }

        function startPacketUpdates() {
            GameState.packetUpdateInterval = setInterval(() => {
                const tcpEl = document.getElementById('tcp-count');
                const udpEl = document.getElementById('udp-count');
                const httpEl = document.getElementById('http-count');

                if (tcpEl) tcpEl.textContent = parseInt(tcpEl.textContent) + Math.floor(Math.random() * 10);
                if (udpEl) udpEl.textContent = parseInt(udpEl.textContent) + Math.floor(Math.random() * 5);
                if (httpEl) httpEl.textContent = parseInt(httpEl.textContent) + Math.floor(Math.random() * 3);
            }, 1000);
        }

        function capturePackets() {
            addTerminalLine('[封包捕獲] 開始捕獲網絡封包...', 'command');
            showNotification('封包捕獲', '正在即時捕獲網絡封包', GameState.currentMode);
        }

        function analyzePackets() {
            addTerminalLine('[封包分析] 執行深度封包分析...', 'command');
            setTimeout(() => {
                addTerminalLine('✓ 分析完成，發現3個可疑封包', 'warning');
            }, 2000);
        }

        function exportPackets() {
            addTerminalLine('[導出] 正在生成封包報告...', 'system');
            setTimeout(() => {
                addTerminalLine('✓ 封包報告已生成', 'success');
            }, 1000);
        }

        // ===== 設備畫面更新函數 =====
        function updateDeviceScreen(side, message) {
            const screenId = side === 'player' ? 'player-device-activity' : 'opponent-device-activity';
            const screenEl = document.getElementById(screenId);
            if (screenEl) {
                const time = new Date().toLocaleTimeString();
                screenEl.innerHTML += `<div>> [${time}] ${message}</div>`;

                // 保持最新的10條記錄
                const lines = screenEl.querySelectorAll('div');
                if (lines.length > 10) {
                    lines[0].remove();
                }

                // 滾動到底部
                screenEl.scrollTop = screenEl.scrollHeight;
            }
        }

        function updateBothDeviceScreens(event, data) {
            const time = new Date().toLocaleTimeString();

            if (event === 'ransom_paid') {
                updateDeviceScreen('player', `💸 已支付勒索金: $${data.toLocaleString()}`);
                updateDeviceScreen('opponent', `💰 收到勒索金: $${data.toLocaleString()}`);
            } else if (event === 'attack') {
                updateDeviceScreen('player', `⚔️ 發起攻擊: ${data}`);
                updateDeviceScreen('opponent', `🛡️ 收到攻擊: ${data}`);
            } else if (event === 'defense') {
                updateDeviceScreen('player', `🛡️ 執行防禦: ${data}`);
                updateDeviceScreen('opponent', `❌ 攻擊被阻擋: ${data}`);
            }
        }

        // 即時流量更新
        function updateNetworkTraffic() {
            const uploadBar = document.getElementById('upload-traffic-bar');
            const downloadBar = document.getElementById('download-traffic-bar');
            const uploadValue = document.getElementById('upload-traffic-value');
            const downloadValue = document.getElementById('download-traffic-value');

            if (uploadBar && downloadBar) {
                const uploadPercent = Math.floor(Math.random() * 60) + 20;
                const downloadPercent = Math.floor(Math.random() * 70) + 30;

                uploadBar.style.width = `${uploadPercent}%`;
                downloadBar.style.width = `${downloadPercent}%`;

                if (uploadValue) uploadValue.textContent = `${Math.floor(uploadPercent * 2)} KB/s`;
                if (downloadValue) downloadValue.textContent = `${Math.floor(downloadPercent * 3)} KB/s`;
            }
        }

        // 開始流量更新循環
        function startTrafficUpdates() {
            setInterval(updateNetworkTraffic, 2000);
        }

        // ===== 顯示通知 =====
        function showNotification(title, message, type) {
            if (!GameConfig.settings.notifications) return;
            
            const notification = document.getElementById('notification');
            const titleElement = document.getElementById('notification-title-text');
            const messageElement = document.getElementById('notification-message');
            
            if (!notification || !titleElement || !messageElement) return;
            
            // 設置通知內容
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // 設置通知類型
            notification.className = `notification ${type} show`;
            
            // 自動隱藏
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ===== 顯示設置 =====
        async function showSettings() {
            // 使用自定義模態框代替 prompt
            const ip = await showPromptModal('輸入新的目標IP地址:', GameState.battle.targetIP);
            if (ip !== null && ip.trim() !== '') {
                GameState.battle.targetIP = ip.trim();
                updateElementText('target-ip-display', ip);
                addTerminalLine(`目標IP已更新為: ${ip}`, 'system');
            }
        }

        // ===== 保存遊戲狀態 =====
        function saveGameState() {
            const data = {
                mode: GameState.currentMode,
                stats: GameState.stats,
                battle: GameState.battle,
                timestamp: new Date().toISOString()
            };

            try {
                MemoryStorage.setItem(`${GameConfig.STORAGE_KEY}_game`, JSON.stringify(data));
                console.log("遊戲狀態已保存");
            } catch (e) {
                console.error("保存遊戲狀態失敗:", e);
            }
        }

        // ===== 顯示選擇/目標 =====
        function showSelection(mode) {
            const roleName = mode === 'hacker' ? '黑客' : '防禦者';
            const targetIP = GameState.battle?.targetIP || GameConfig.settings.targetIP || '未設定';
            addTerminalLine(`角色: ${roleName}`, 'system');
            addTerminalLine(`目標IP: ${targetIP}`, 'system');
            if (GameState.stats) {
                addTerminalLine(`當前資源: ${GameState.stats.resources || 0}`, 'system');
            }
        }

        // ===== 顯示終端歷史 =====
        function showHistory() {
            if (!terminalOutput) {
                addTerminalLine('無法存取終端輸出', 'error');
                return;
            }
            const lines = Array.from(terminalOutput.querySelectorAll('.terminal-line')).map(l => l.textContent);
            const last = lines.slice(-30);
            addTerminalLine('--- 終端歷史（最近30行） ---', 'system');
            last.forEach(l => addTerminalLine(l, 'response'));
            addTerminalLine('--- 歷史結束 ---', 'system');
        }

        // ===== 設置/切換 VPN =====
        function setupVPN() {
            GameState.vpn.active = !GameState.vpn.active;
            GameState.vpn.provider = GameState.vpn.active ? (GameState.vpn.provider || 'NordVPN') : null;
            GameState.vpn.maskedIP = GameState.vpn.active ? `10.8.0.${Math.floor(Math.random()*200)+2}` : null;
            addTerminalLine(`VPN 已${GameState.vpn.active ? '啟動' : '關閉'}，提供者: ${GameState.vpn.provider || '無'}`, 'system');
            updateConnectionDisplay();
        }

        // ===== 加載遊戲狀態 =====
        function loadGameState() {
            try {
                const saved = MemoryStorage.getItem(`${GameConfig.STORAGE_KEY}_game`);
                if (saved) {
                    const data = JSON.parse(saved);
                    GameState.currentMode = data.mode || GameState.currentMode;
                    GameState.stats = data.stats || GameState.stats;
                    GameState.battle = data.battle || GameState.battle;
                    addTerminalLine('存檔已加載', 'success');
                    updateStatsDisplay(GameState.currentMode);
                } else {
                    addTerminalLine('找不到存檔', 'warning');
                }
            } catch (e) {
                addTerminalLine('加載存檔失敗', 'error');
                console.error(e);
            }
        }

        // ===== 商店系統 =====
        function showShop() {
            const mode = GameState.currentMode;
            const isHacker = mode === 'hacker';
            const isDefender = mode === 'defender';
            const items = isHacker ? ShopItems.hacker : ShopItems.defender;
            const vpnItems = ShopItems.vpn; // 僅黑客可用
            const defenderServices = ShopItems.defenderServices; // 僅防禦者可用

            // 防禦者充值限制信息
            const rechargesUsed = GameState.wallet.defenderRecharges || 0;
            const maxRecharges = GameState.wallet.maxDefenderRecharges || 2;
            const rechargesRemaining = maxRecharges - rechargesUsed;

            const shopHTML = `
                <div class="modal-overlay" id="shop-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 950px; max-height: 90vh; overflow-y: auto;">
                        <h2 style="color: ${isHacker ? '#ff3333' : '#3498db'}; margin-bottom: 20px; text-align: center;">
                            <i class="fas ${isHacker ? 'fa-skull-crossbones' : 'fa-shield-alt'}"></i> ${isHacker ? '暗網黑市' : '安全防護中心'}
                        </h2>

                        <!-- 錢包信息 -->
                        <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; align-items: center;">
                            <div style="text-align: center;">
                                <div style="color: #888; font-size: 0.9rem;">現金餘額</div>
                                <div style="color: #00ff41; font-size: 1.5rem; font-weight: bold;">$${GameState.wallet.balance.toLocaleString()}</div>
                            </div>
                            ${isHacker ? `
                            <div style="text-align: center;">
                                <div style="color: #888; font-size: 0.9rem;">BTC</div>
                                <div style="color: #f7931a; font-size: 1.2rem;">${GameState.wallet.cryptoBalance.BTC}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #888; font-size: 0.9rem;">ETH</div>
                                <div style="color: #627eea; font-size: 1.2rem;">${GameState.wallet.cryptoBalance.ETH}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #888; font-size: 0.9rem;">USDT</div>
                                <div style="color: #26a17b; font-size: 1.2rem;">${GameState.wallet.cryptoBalance.USDT.toLocaleString()}</div>
                            </div>
                            ` : `
                            <div style="text-align: center; background: ${rechargesRemaining > 0 ? 'rgba(52,152,219,0.2)' : 'rgba(231,76,60,0.2)'}; padding: 10px 15px; border-radius: 8px; border: 1px solid ${rechargesRemaining > 0 ? '#3498db' : '#e74c3c'};">
                                <div style="color: #888; font-size: 0.8rem;">充值機會</div>
                                <div style="color: ${rechargesRemaining > 0 ? '#3498db' : '#e74c3c'}; font-size: 1.3rem; font-weight: bold;">${rechargesRemaining}/${maxRecharges}</div>
                            </div>
                            `}
                            <button onclick="showTopUp()" style="background: linear-gradient(135deg, ${isHacker ? '#ff9900' : '#3498db'} 0%, ${isHacker ? '#ff6600' : '#2980b9'} 100%); border: none; padding: 10px 20px; border-radius: 6px; color: #fff; font-weight: bold; cursor: pointer; ${isDefender && rechargesRemaining <= 0 ? 'opacity: 0.5;' : ''}">
                                <i class="fas fa-plus-circle"></i> 充值 ${isDefender && rechargesRemaining <= 0 ? '(已用盡)' : ''}
                            </button>
                        </div>

                        <!-- 模式提示 -->
                        <div style="background: ${isHacker ? 'rgba(255,51,51,0.1)' : 'rgba(52,152,219,0.1)'}; border: 1px solid ${isHacker ? '#ff333340' : '#3498db40'}; border-radius: 8px; padding: 12px; margin-bottom: 20px; text-align: center;">
                            <i class="fas ${isHacker ? 'fa-user-secret' : 'fa-user-shield'}" style="color: ${isHacker ? '#ff3333' : '#3498db'};"></i>
                            <span style="color: #aaa; margin-left: 8px;">${isHacker ? '黑客專屬商店 - 所有工具均用於攻擊與滲透' : '防禦者專屬商店 - 所有工具均用於防護與監控'}</span>
                        </div>

                        <!-- 工具商品 -->
                        <h3 style="color: #fff; margin-bottom: 15px;"><i class="fas ${isHacker ? 'fa-skull' : 'fa-tools'}"></i> ${isHacker ? '黑客攻擊工具' : '防禦保護工具'}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px; margin-bottom: 25px;">
                            ${items.map(item => {
                                const tierColors = { 1: '#3498db', 2: '#2ecc71', 3: '#f39c12', 4: '#e74c3c' };
                                const tierNames = { 1: '基礎', 2: '中級', 3: '高級', 4: '終極' };
                                const tierColor = tierColors[item.tier] || '#3498db';
                                const tierName = tierNames[item.tier] || '基礎';
                                const itemIcon = item.icon || 'fa-cube';
                                return `
                                <div class="shop-item" style="background: rgba(30,30,50,0.8); border: 2px solid ${tierColor}40; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s;" onclick="purchaseItem('${item.id}', '${mode}')" onmouseover="this.style.borderColor='${tierColor}'; this.style.boxShadow='0 0 15px ${tierColor}40';" onmouseout="this.style.borderColor='${tierColor}40'; this.style.boxShadow='none';">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: bold; color: #fff;"><i class="fas ${itemIcon}" style="color: ${tierColor}; margin-right: 6px;"></i>${item.name}</div>
                                        <span style="background: ${tierColor}30; color: ${tierColor}; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; border: 1px solid ${tierColor};">★ ${tierName}</span>
                                    </div>
                                    <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 10px;">${item.desc}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="color: #00ff41; font-weight: bold;">$${item.price.toLocaleString()}</div>
                                        ${GameState.wallet.balance >= item.price ? '<span style="color: #2ecc71; font-size: 0.75rem;">✓ 可購買</span>' : '<span style="color: #e74c3c; font-size: 0.75rem;">✗ 餘額不足</span>'}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>

                        ${isHacker ? `
                        <!-- VPN商品 - 僅黑客模式 -->
                        <h3 style="color: #fff; margin-bottom: 15px;"><i class="fas fa-user-secret"></i> VPN匿名服務 <span style="color: #ff3333; font-size: 0.8rem;">(黑客專屬)</span></h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                            ${vpnItems.map(vpn => {
                                const vpnIcon = vpn.icon || 'fa-shield-alt';
                                return `
                                <div class="shop-item" style="background: rgba(30,30,50,0.8); border: 1px solid ${vpn.isFake === false ? '#00ff41' : vpn.isFake === 'random' ? '#ffaa00' : '#ff3333'}; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s;" onclick="purchaseVPN('${vpn.id}')" onmouseover="this.style.boxShadow='0 0 10px ${vpn.isFake === false ? '#00ff4140' : '#ffaa0040'}';" onmouseout="this.style.boxShadow='none';">
                                    <div style="font-weight: bold; color: #fff; margin-bottom: 8px;"><i class="fas ${vpnIcon}" style="color: ${vpn.isFake === false ? '#00ff41' : '#ffaa00'}; margin-right: 6px;"></i>${vpn.name}</div>
                                    <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 10px;">${vpn.desc}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="color: #00ff41; font-weight: bold;">$${vpn.price.toLocaleString()}</div>
                                        <span style="color: ${vpn.isFake === false ? '#00ff41' : vpn.isFake === 'random' ? '#ffaa00' : '#ff3333'}; font-size: 0.75rem;">${vpn.isFake === false ? '✓ 真實' : vpn.isFake === 'random' ? '⚠ 風險' : '✗ 假'}</span>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        ` : `
                        <!-- 防禦者專屬服務 -->
                        <h3 style="color: #fff; margin-bottom: 15px;"><i class="fas fa-concierge-bell"></i> 專業安全服務 <span style="color: #3498db; font-size: 0.8rem;">(防禦者專屬)</span></h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px;">
                            ${defenderServices.map(service => {
                                const tierColors = { 1: '#3498db', 2: '#2ecc71', 3: '#f39c12', 4: '#e74c3c' };
                                const tierNames = { 1: '基礎', 2: '進階', 3: '專業', 4: '企業' };
                                const tierColor = tierColors[service.tier] || '#3498db';
                                const tierName = tierNames[service.tier] || '基礎';
                                const serviceIcon = service.icon || 'fa-cog';
                                return `
                                <div class="shop-item" style="background: rgba(30,40,60,0.8); border: 2px solid ${tierColor}40; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s;" onclick="purchaseDefenderService('${service.id}')" onmouseover="this.style.borderColor='${tierColor}'; this.style.boxShadow='0 0 15px ${tierColor}40';" onmouseout="this.style.borderColor='${tierColor}40'; this.style.boxShadow='none';">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: bold; color: #fff;"><i class="fas ${serviceIcon}" style="color: ${tierColor}; margin-right: 6px;"></i>${service.name}</div>
                                        <span style="background: ${tierColor}30; color: ${tierColor}; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; border: 1px solid ${tierColor};">★ ${tierName}</span>
                                    </div>
                                    <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 10px;">${service.desc}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="color: #00ff41; font-weight: bold;">$${service.price.toLocaleString()}</div>
                                        ${GameState.wallet.balance >= service.price ? '<span style="color: #2ecc71; font-size: 0.75rem;">✓ 可購買</span>' : '<span style="color: #e74c3c; font-size: 0.75rem;">✗ 餘額不足</span>'}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>

                        <!-- 防禦者充值限制提醒 -->
                        <div style="background: rgba(231,76,60,0.1); border: 1px solid #e74c3c40; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-exclamation-triangle" style="color: #e74c3c; font-size: 1.2rem;"></i>
                                <div>
                                    <div style="color: #fff; font-weight: bold;">防禦者充值限制</div>
                                    <div style="color: #aaa; font-size: 0.85rem;">作為防禦者，您只有 <span style="color: #e74c3c; font-weight: bold;">${maxRecharges} 次</span> 充值機會，每次限額 <span style="color: #f39c12;">$${(GameState.wallet.rechargeLimit || 50000).toLocaleString()}</span>。請謹慎使用！</div>
                                </div>
                            </div>
                        </div>
                        `}

                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="showTransactionHistory()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none; padding: 12px 25px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-history"></i> 交易記錄
                            </button>
                            <button onclick="closeShop()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉商店
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', shopHTML);
        }

        function closeShop() {
            const modal = document.getElementById('shop-modal');
            if (modal) modal.remove();
        }

        function purchaseItem(itemId, mode) {
            const items = mode === 'hacker' ? ShopItems.hacker : ShopItems.defender;
            const item = items.find(i => i.id === itemId);

            if (!item) return;

            if (GameState.wallet.balance < item.price) {
                addTerminalLine('餘額不足！請先充值。', 'error');
                SoundSystem.play('error');
                return;
            }

            GameState.wallet.balance -= item.price;

            // 生成交易收據
            const receiptId = 'TXN-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
            const transaction = {
                receiptId: receiptId,
                type: 'purchase',
                category: mode === 'hacker' ? '黑客工具' : '防禦裝備',
                item: item.name,
                itemId: item.id,
                tier: item.tier || 1,
                amount: -item.price,
                balanceAfter: GameState.wallet.balance,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-TW'),
                time: new Date().toLocaleTimeString('zh-TW'),
                playerIP: GameState.vpn.realIP || '192.168.1.1',
                mode: mode
            };
            GameState.wallet.transactionHistory.push(transaction);

            // 顯示購買收據
            showPurchaseReceipt(transaction, item);

            // 應用效果
            if (item.effect) {
                if (item.effect.attackBoost && GameState.stats.attackPower !== undefined) {
                    GameState.stats.attackPower = Math.min(100, GameState.stats.attackPower + item.effect.attackBoost);
                }
                if (item.effect.stealthBoost && GameState.stats.stealthLevel !== undefined) {
                    GameState.stats.stealthLevel = Math.min(100, GameState.stats.stealthLevel + item.effect.stealthBoost);
                }
                if (item.effect.detection && GameState.stats.detectionRisk !== undefined) {
                    GameState.stats.detectionRisk = Math.max(0, GameState.stats.detectionRisk + item.effect.detection);
                }
                if (item.effect.accessLevel) {
                    GameState.hackerIntel.accessLevel = item.effect.accessLevel;
                }
                if (item.effect.decryptPower) {
                    GameState.hackerIntel.decryptPower = (GameState.hackerIntel.decryptPower || 0) + item.effect.decryptPower;
                }
                if (item.effect.hackerVisible) {
                    GameState.defenderIntel.observationLevel += item.effect.hackerVisible;
                    if (GameState.defenderIntel.observationLevel >= 50) {
                        GameState.defenderIntel.hackerVisible = true;
                    }
                }
            }

            updateStatsDisplay(mode);
            addTerminalLine(`已購買: ${item.name}`, 'success');
            SoundSystem.play('success');
            closeShop();
            showShop(); // 刷新商店顯示
        }

        // ===== 購買收據顯示 =====
        function showPurchaseReceipt(transaction, item) {
            const tierNames = { 1: '基礎', 2: '中級', 3: '高級', 4: '終極' };
            const tierColors = { 1: '#3498db', 2: '#2ecc71', 3: '#f39c12', 4: '#e74c3c' };

            const receiptHTML = `
                <div class="modal-overlay" id="receipt-modal" style="display: flex; z-index: 10001;">
                    <div class="modal-box" style="max-width: 450px; background: linear-gradient(135deg, rgba(10,20,30,0.98) 0%, rgba(20,30,40,0.98) 100%); border: 2px solid #00ff41;">
                        <div style="text-align: center; border-bottom: 2px dashed #333; padding-bottom: 20px; margin-bottom: 20px;">
                            <i class="fas fa-receipt" style="font-size: 2.5rem; color: #00ff41; margin-bottom: 10px;"></i>
                            <h2 style="color: #00ff41; margin: 0;">交易收據</h2>
                            <div style="color: #666; font-size: 0.8rem; margin-top: 5px;">TRANSACTION RECEIPT</div>
                        </div>

                        <div style="background: rgba(0,0,0,0.4); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #888;">收據編號:</span>
                                    <span style="color: #00ff41; font-family: monospace;">${transaction.receiptId}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #888;">日期:</span>
                                    <span style="color: #fff;">${transaction.date}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #888;">時間:</span>
                                    <span style="color: #fff;">${transaction.time}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #888;">IP地址:</span>
                                    <span style="color: #ffaa00; font-family: monospace;">${transaction.playerIP}</span>
                                </div>
                                <div style="border-top: 1px solid #333; padding-top: 12px; display: flex; justify-content: space-between;">
                                    <span style="color: #888;">類別:</span>
                                    <span style="color: #9b59b6;">${transaction.category}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #888;">商品:</span>
                                    <span style="color: #fff; font-weight: bold;">${transaction.item}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #888;">等級:</span>
                                    <span style="color: ${tierColors[transaction.tier]}; font-weight: bold;">★ ${tierNames[transaction.tier]}</span>
                                </div>
                                <div style="border-top: 1px solid #333; padding-top: 12px; display: flex; justify-content: space-between;">
                                    <span style="color: #888;">金額:</span>
                                    <span style="color: #e74c3c; font-weight: bold; font-size: 1.2rem;">-$${Math.abs(transaction.amount).toLocaleString()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #888;">餘額:</span>
                                    <span style="color: #00ff41; font-weight: bold;">$${transaction.balanceAfter.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; color: #666; font-size: 0.75rem; margin-bottom: 15px;">
                            <div>━━━━━━━━━━━━━━━━━━━━━</div>
                            <div style="margin: 10px 0;">感謝您的購買！</div>
                            <div>此收據已記錄於交易歷史</div>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="closeReceiptModal()" style="background: linear-gradient(135deg, #00ff41 0%, #00cc33 100%); border: none; padding: 12px 30px; border-radius: 6px; color: #000; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-check"></i> 確認
                            </button>
                            <button onclick="showTransactionHistory()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-history"></i> 查看歷史
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', receiptHTML);
        }

        function closeReceiptModal() {
            const modal = document.getElementById('receipt-modal');
            if (modal) modal.remove();
        }

        // ===== 防禦者專屬服務購買 =====
        function purchaseDefenderService(serviceId) {
            // 確保只有防禦者可以購買
            if (GameState.currentMode !== 'defender') {
                addTerminalLine('此服務僅限防禦者購買！', 'error');
                SoundSystem.play('error');
                return;
            }

            const service = ShopItems.defenderServices.find(s => s.id === serviceId);
            if (!service) return;

            if (GameState.wallet.balance < service.price) {
                addTerminalLine('餘額不足！請先充值。', 'error');
                SoundSystem.play('error');
                return;
            }

            GameState.wallet.balance -= service.price;

            // 生成交易收據
            const receiptId = 'SVC-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
            const transaction = {
                receiptId: receiptId,
                type: 'service',
                category: '安全服務',
                item: service.name,
                itemId: service.id,
                tier: service.tier || 1,
                amount: -service.price,
                balanceAfter: GameState.wallet.balance,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-TW'),
                time: new Date().toLocaleTimeString('zh-TW'),
                playerIP: GameState.vpn.realIP || '192.168.1.1',
                mode: 'defender'
            };
            GameState.wallet.transactionHistory.push(transaction);

            // 顯示購買收據
            showPurchaseReceipt(transaction, service);

            // 應用效果
            if (service.effect) {
                if (service.effect.auditBoost) {
                    GameState.defenderIntel.observationLevel = Math.min(100, (GameState.defenderIntel.observationLevel || 0) + service.effect.auditBoost);
                }
                if (service.effect.vulnerabilityFind) {
                    GameState.defenderIntel.vulnerabilityAwareness = (GameState.defenderIntel.vulnerabilityAwareness || 0) + service.effect.vulnerabilityFind;
                }
                if (service.effect.threatIntel) {
                    GameState.defenderIntel.threatIntelLevel = (GameState.defenderIntel.threatIntelLevel || 0) + service.effect.threatIntel;
                }
                if (service.effect.emergencySupport) {
                    GameState.defenderIntel.hasEmergencySupport = true;
                }
                if (service.effect.readinessBoost) {
                    GameState.defenderIntel.readiness = Math.min(100, (GameState.defenderIntel.readiness || 0) + service.effect.readinessBoost);
                }
            }

            updateStatsDisplay('defender');
            addTerminalLine(`已購買服務: ${service.name}`, 'success');
            SoundSystem.play('success');
            closeShop();
            showShop(); // 刷新商店顯示
        }

        // ===== 購買VPN時檢查模式 =====
        function purchaseVPN(vpnId) {
            // 確保只有黑客可以購買VPN
            if (GameState.currentMode !== 'hacker') {
                addTerminalLine('VPN服務僅限黑客購買！防禦者不需要隱藏身份。', 'error');
                SoundSystem.play('error');
                return;
            }

            const vpn = ShopItems.vpn.find(v => v.id === vpnId);
            if (!vpn) return;

            if (GameState.wallet.balance < vpn.price) {
                addTerminalLine('餘額不足！請先充值。', 'error');
                SoundSystem.play('error');
                return;
            }

            GameState.wallet.balance -= vpn.price;

            // 判斷VPN是否為假
            let isFakeVPN = vpn.isFake;
            if (vpn.isFake === 'random') {
                isFakeVPN = Math.random() < 0.5; // 50%機率是假的
            }

            // 記錄交易
            const receiptId = 'VPN-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
            const transaction = {
                receiptId: receiptId,
                type: 'vpn',
                category: 'VPN服務',
                item: vpn.name,
                itemId: vpn.id,
                tier: isFakeVPN === false ? 3 : 1,
                amount: -vpn.price,
                balanceAfter: GameState.wallet.balance,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-TW'),
                time: new Date().toLocaleTimeString('zh-TW'),
                playerIP: GameState.vpn.realIP || '192.168.1.1',
                mode: 'hacker',
                isFake: isFakeVPN
            };
            GameState.wallet.transactionHistory.push(transaction);

            // 更新VPN狀態
            if (isFakeVPN === false) {
                GameState.vpn.active = true;
                GameState.vpn.type = vpn.name;
                GameState.vpn.fakeIP = generateRandomIP();
                GameState.stats.detectionRisk = Math.max(0, GameState.stats.detectionRisk - 20);
                addTerminalLine(`VPN已激活: ${vpn.name} - IP: ${GameState.vpn.fakeIP}`, 'success');
            } else {
                GameState.vpn.active = true;
                GameState.vpn.isFake = true;
                GameState.vpn.type = vpn.name + ' (假)';
                GameState.vpn.fakeIP = generateRandomIP();
                GameState.stats.detectionRisk = Math.min(100, GameState.stats.detectionRisk + 10);
                addTerminalLine(`警告: 購買的VPN可能是假的！你的真實IP可能暴露`, 'warning');
            }

            updateStatsDisplay('hacker');
            SoundSystem.play('success');
            closeShop();
            showShop();
        }

        function generateRandomIP() {
            return `${Math.floor(Math.random() * 223) + 1}.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}`;
        }

        // ===== 交易歷史記錄面板 =====
        function showTransactionHistory() {
            closeReceiptModal();

            const history = GameState.wallet.transactionHistory;
            const mode = GameState.currentMode;

            const historyHTML = `
                <div class="modal-overlay" id="transaction-history-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 900px; max-height: 85vh; overflow-y: auto; background: linear-gradient(135deg, rgba(10,15,25,0.98) 0%, rgba(20,25,35,0.98) 100%); border: 2px solid #3498db;">
                        <h2 style="color: #3498db; margin-bottom: 20px; text-align: center;">
                            <i class="fas fa-history"></i> 交易歷史記錄
                        </h2>

                        <!-- 統計摘要 -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                            <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #3498db;">
                                <div style="color: #888; font-size: 0.75rem;">總交易數</div>
                                <div style="color: #3498db; font-size: 1.5rem; font-weight: bold;">${history.length}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e74c3c;">
                                <div style="color: #888; font-size: 0.75rem;">總支出</div>
                                <div style="color: #e74c3c; font-size: 1.5rem; font-weight: bold;">$${Math.abs(history.filter(t => t.amount < 0).reduce((sum, t) => sum + t.amount, 0)).toLocaleString()}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #2ecc71;">
                                <div style="color: #888; font-size: 0.75rem;">總收入</div>
                                <div style="color: #2ecc71; font-size: 1.5rem; font-weight: bold;">$${history.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0).toLocaleString()}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #f39c12;">
                                <div style="color: #888; font-size: 0.75rem;">當前餘額</div>
                                <div style="color: #f39c12; font-size: 1.5rem; font-weight: bold;">$${GameState.wallet.balance.toLocaleString()}</div>
                            </div>
                        </div>

                        <!-- 交易列表 -->
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden;">
                            <div style="display: grid; grid-template-columns: 150px 80px 80px 1fr 120px 100px; padding: 12px 15px; background: rgba(52,152,219,0.2); font-weight: bold; color: #3498db; font-size: 0.85rem;">
                                <div>收據編號</div>
                                <div>日期</div>
                                <div>時間</div>
                                <div>項目</div>
                                <div>金額</div>
                                <div>IP</div>
                            </div>
                            <div style="max-height: 350px; overflow-y: auto;">
                                ${history.length === 0 ? `
                                    <div style="padding: 40px; text-align: center; color: #666;">
                                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                        暫無交易記錄
                                    </div>
                                ` : history.slice().reverse().map(t => `
                                    <div style="display: grid; grid-template-columns: 150px 80px 80px 1fr 120px 100px; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.8rem; align-items: center;">
                                        <div style="color: #888; font-family: monospace;">${t.receiptId || 'N/A'}</div>
                                        <div style="color: #aaa;">${t.date || new Date(t.timestamp).toLocaleDateString('zh-TW')}</div>
                                        <div style="color: #aaa;">${t.time || new Date(t.timestamp).toLocaleTimeString('zh-TW').substring(0,5)}</div>
                                        <div>
                                            <span style="color: #fff;">${t.item || t.type}</span>
                                            ${t.category ? `<span style="color: #666; font-size: 0.7rem;"> (${t.category})</span>` : ''}
                                        </div>
                                        <div style="color: ${t.amount >= 0 ? '#2ecc71' : '#e74c3c'}; font-weight: bold;">${t.amount >= 0 ? '+' : ''}$${t.amount.toLocaleString()}</div>
                                        <div style="color: #ffaa00; font-family: monospace; font-size: 0.7rem;">${t.playerIP || 'N/A'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                            <button onclick="exportTransactionHistory()" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border: none; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-download"></i> 導出記錄
                            </button>
                            <button onclick="closeTransactionHistory()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 25px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', historyHTML);
        }

        function closeTransactionHistory() {
            const modal = document.getElementById('transaction-history-modal');
            if (modal) modal.remove();
        }

        function exportTransactionHistory() {
            const history = GameState.wallet.transactionHistory;
            const csvContent = 'data:text/csv;charset=utf-8,' +
                '收據編號,日期,時間,類別,項目,金額,IP地址\\n' +
                history.map(t => `${t.receiptId || 'N/A'},${t.date || ''},${t.time || ''},${t.category || t.type},${t.item || ''},${t.amount},${t.playerIP || ''}`).join('\\n');

            addTerminalLine('✓ 交易記錄已導出', 'success');
            if (typeof showNotification === 'function') showNotification('導出成功', '交易記錄已準備下載', 'success');
        }

        // ===== 充值系統 =====
        function showTopUp() {
            closeShop();

            const mode = GameState.currentMode;
            const isDefender = mode === 'defender';
            const rechargesUsed = GameState.wallet.defenderRecharges || 0;
            const maxRecharges = GameState.wallet.maxDefenderRecharges || 2;
            const rechargeLimit = GameState.wallet.rechargeLimit || 50000;
            const rechargesRemaining = maxRecharges - rechargesUsed;
            const canRecharge = !isDefender || rechargesRemaining > 0;

            const topUpHTML = `
                <div class="modal-overlay" id="topup-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 650px; background: linear-gradient(135deg, rgba(10,15,25,0.98) 0%, rgba(20,25,35,0.98) 100%); border: 2px solid ${isDefender ? '#3498db' : '#ff9900'};">
                        <h2 style="color: ${isDefender ? '#3498db' : '#ff9900'}; margin-bottom: 20px; text-align: center;">
                            <i class="fas fa-credit-card"></i> ${isDefender ? '防禦者充值中心' : '黑客資金中心'}
                        </h2>

                        ${isDefender ? `
                        <!-- 防禦者充值限制提示 -->
                        <div style="background: ${canRecharge ? 'rgba(52,152,219,0.2)' : 'rgba(231,76,60,0.2)'}; border: 1px solid ${canRecharge ? '#3498db' : '#e74c3c'}; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #fff; font-weight: bold;"><i class="fas fa-info-circle"></i> 充值限制</div>
                                    <div style="color: #aaa; font-size: 0.85rem;">防禦者只有 ${maxRecharges} 次充值機會，每次限額 $${rechargeLimit.toLocaleString()}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: ${canRecharge ? '#2ecc71' : '#e74c3c'}; font-size: 1.8rem; font-weight: bold;">${rechargesRemaining}/${maxRecharges}</div>
                                    <div style="color: #888; font-size: 0.75rem;">剩餘次數</div>
                                </div>
                            </div>
                            ${!canRecharge ? `<div style="color: #e74c3c; text-align: center; margin-top: 10px; font-weight: bold;"><i class="fas fa-ban"></i> 已用盡所有充值機會！</div>` : ''}
                        </div>
                        ` : ''}

                        ${canRecharge ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #fff; margin-bottom: 10px;">選擇付款方式</h3>
                            <div style="display: grid; gap: 10px;">
                                ${GameState.wallet.cards.map(card => `
                                    <div onclick="topUpWithCard('${card.id}')" style="background: rgba(30,30,50,0.8); border: 1px solid ${card.isStolen ? '#ff3333' : '#00ff41'}; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <i class="fab fa-cc-${card.type}"></i>
                                            <span style="color: #fff; margin-left: 10px;">**** **** **** ${card.last4}</span>
                                            ${card.isStolen ? '<span style="color: #ff3333; font-size: 0.8rem; margin-left: 10px;">(被盜卡)</span>' : ''}
                                        </div>
                                        <div style="color: #00ff41;">$${card.balance.toLocaleString()}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #fff; margin-bottom: 10px;">加密貨幣充值</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <button onclick="topUpWithCrypto('BTC', 0.1)" style="background: linear-gradient(135deg, #f7931a 0%, #c76b00 100%); border: none; padding: 15px; border-radius: 8px; color: #fff; cursor: pointer;">
                                    <div style="font-size: 1.2rem;">₿ 0.1 BTC</div>
                                    <div style="font-size: 0.8rem;">≈ $6,500</div>
                                </button>
                                <button onclick="topUpWithCrypto('ETH', 1)" style="background: linear-gradient(135deg, #627eea 0%, #3c3c8a 100%); border: none; padding: 15px; border-radius: 8px; color: #fff; cursor: pointer;">
                                    <div style="font-size: 1.2rem;">Ξ 1 ETH</div>
                                    <div style="font-size: 0.8rem;">≈ $3,500</div>
                                </button>
                                <button onclick="topUpWithCrypto('USDT', 1000)" style="background: linear-gradient(135deg, #26a17b 0%, #1a6b52 100%); border: none; padding: 15px; border-radius: 8px; color: #fff; cursor: pointer;">
                                    <div style="font-size: 1.2rem;">₮ 1000 USDT</div>
                                    <div style="font-size: 0.8rem;">≈ $1,000</div>
                                </button>
                            </div>
                        </div>

                        <!-- 暗網支付工具 (模擬) -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #9b59b6; margin-bottom: 10px;"><i class="fas fa-user-secret"></i> 暗網支付工具 <span style="color: #ff3333; font-size: 0.7rem;">(模擬)</span></h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <button onclick="darkWebTopUp('octopus', ${isDefender ? rechargeLimit : 30000})" style="background: linear-gradient(135deg, #ff6b35 0%, #d64600 100%); border: none; padding: 15px; border-radius: 8px; color: #fff; cursor: pointer;">
                                    <div style="font-size: 1rem;"><i class="fas fa-id-card"></i> 八達通錢包</div>
                                    <div style="font-size: 0.8rem;">Octopus Wallet</div>
                                    <div style="font-size: 0.7rem; margin-top: 5px;">餘額: $${(GameState.wallet.octopusBalance || 50000).toLocaleString()}</div>
                                </button>
                                <button onclick="darkWebTopUp('alipay', ${isDefender ? rechargeLimit : 30000})" style="background: linear-gradient(135deg, #1677ff 0%, #0958d9 100%); border: none; padding: 15px; border-radius: 8px; color: #fff; cursor: pointer;">
                                    <div style="font-size: 1rem;"><i class="fab fa-alipay"></i> 支付寶HK</div>
                                    <div style="font-size: 0.8rem;">AlipayHK</div>
                                    <div style="font-size: 0.7rem; margin-top: 5px;">餘額: $${(GameState.wallet.alipayBalance || 80000).toLocaleString()}</div>
                                </button>
                                ${!isDefender ? `
                                <button onclick="darkWebTopUp('monero', 25000)" style="background: linear-gradient(135deg, #ff6600 0%, #cc5200 100%); border: none; padding: 15px; border-radius: 8px; color: #fff; cursor: pointer;">
                                    <div style="font-size: 1rem;"><i class="fas fa-coins"></i> 門羅幣</div>
                                    <div style="font-size: 0.8rem;">Monero (XMR)</div>
                                    <div style="font-size: 0.7rem; margin-top: 5px;">匿名度: 100%</div>
                                </button>
                                <button onclick="darkWebTopUp('tornado', 50000)" style="background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%); border: 1px solid #9b59b6; padding: 15px; border-radius: 8px; color: #fff; cursor: pointer;">
                                    <div style="font-size: 1rem;"><i class="fas fa-wind"></i> Tornado Cash</div>
                                    <div style="font-size: 0.8rem;">混幣服務</div>
                                    <div style="font-size: 0.7rem; margin-top: 5px;">無法追蹤</div>
                                </button>
                                ` : ''}
                            </div>
                        </div>

                        ${!isDefender ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #fff; margin-bottom: 10px;">NFT / 區塊鏈資產</h3>
                            <div style="background: rgba(155,89,182,0.2); border: 1px solid #9b59b6; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: #9b59b6; font-weight: bold;">CryptoHacker #${Math.floor(Math.random() * 9999)}</div>
                                        <div style="color: #aaa; font-size: 0.9rem;">稀有NFT - 可兌換 $50,000</div>
                                    </div>
                                    <button onclick="redeemNFT()" style="background: #9b59b6; border: none; padding: 10px 20px; border-radius: 6px; color: #fff; cursor: pointer;">兌換</button>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #fff; margin-bottom: 10px;"><i class="fas fa-skull"></i> 黑市資金 (高風險高回報)</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <button onclick="blackMarketFunding(100000)" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; padding: 15px; border-radius: 8px; color: #fff; cursor: pointer;">
                                    <div style="font-size: 1rem;">💀 黑市借款</div>
                                    <div style="font-size: 0.8rem;">$100,000 (高利息)</div>
                                </button>
                                <button onclick="ransomFundTransfer()" style="background: linear-gradient(135deg, #9b59b6 0%, #6c3483 100%); border: none; padding: 15px; border-radius: 8px; color: #fff; cursor: pointer;">
                                    <div style="font-size: 1rem;">💰 勒索金轉入</div>
                                    <div style="font-size: 0.8rem;">從收到的勒索金提取</div>
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        ` : `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-lock" style="font-size: 3rem; color: #e74c3c; margin-bottom: 20px;"></i>
                            <p style="color: #aaa;">您已用盡所有充值機會。</p>
                            <p style="color: #888; font-size: 0.85rem;">請謹慎管理現有資金，或嘗試其他方式獲取資源。</p>
                        </div>
                        `}

                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="showTransactionHistory()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-history"></i> 交易記錄
                            </button>
                            <button onclick="closeTopUp()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-arrow-left"></i> 返回商店
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', topUpHTML);
        }

        function closeTopUp() {
            const modal = document.getElementById('topup-modal');
            if (modal) modal.remove();
            showShop();
        }

        function topUpWithCard(cardId) {
            const card = GameState.wallet.cards.find(c => c.id === cardId);
            if (!card || card.balance <= 0) {
                addTerminalLine('此卡餘額不足', 'error');
                return;
            }

            const mode = GameState.currentMode;
            const isDefender = mode === 'defender';
            const rechargeLimit = GameState.wallet.rechargeLimit || 50000;

            // 防禦者充值限制檢查
            if (isDefender) {
                if (GameState.wallet.defenderRecharges >= GameState.wallet.maxDefenderRecharges) {
                    addTerminalLine('已用盡所有充值機會！', 'error');
                    return;
                }
            }

            const maxAmount = isDefender ? Math.min(card.balance, rechargeLimit) : Math.min(card.balance, 50000);
            const amount = maxAmount;
            card.balance -= amount;
            GameState.wallet.balance += amount;

            if (isDefender) {
                GameState.wallet.defenderRecharges++;
            }

            const receiptId = 'TXN-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
            GameState.wallet.transactionHistory.push({
                receiptId: receiptId,
                type: 'topup',
                category: '充值',
                item: `${card.type.toUpperCase()} ****${card.last4}`,
                method: `${card.type} ****${card.last4}`,
                amount: amount,
                balanceAfter: GameState.wallet.balance,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-TW'),
                time: new Date().toLocaleTimeString('zh-TW'),
                playerIP: GameState.vpn.realIP || '192.168.1.1',
                mode: mode
            });

            addTerminalLine(`充值成功: +$${amount.toLocaleString()}${isDefender ? ` (剩餘${GameState.wallet.maxDefenderRecharges - GameState.wallet.defenderRecharges}次機會)` : ''}`, 'success');
            SoundSystem.play('success');
            closeTopUp();
        }

        function topUpWithCrypto(currency, amount) {
            const rates = { BTC: 65000, ETH: 3500, USDT: 1 };
            const mode = GameState.currentMode;
            const isDefender = mode === 'defender';

            if (isDefender && GameState.wallet.defenderRecharges >= GameState.wallet.maxDefenderRecharges) {
                addTerminalLine('已用盡所有充值機會！', 'error');
                return;
            }

            if (GameState.wallet.cryptoBalance[currency] < amount) {
                addTerminalLine(`${currency} 餘額不足`, 'error');
                return;
            }

            GameState.wallet.cryptoBalance[currency] -= amount;
            let cashAmount = Math.floor(amount * rates[currency]);

            if (isDefender) {
                cashAmount = Math.min(cashAmount, GameState.wallet.rechargeLimit);
                GameState.wallet.defenderRecharges++;
            }

            GameState.wallet.balance += cashAmount;

            const receiptId = 'TXN-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
            GameState.wallet.transactionHistory.push({
                receiptId: receiptId,
                type: 'topup',
                category: '加密貨幣充值',
                item: `${currency} ${amount}`,
                amount: cashAmount,
                balanceAfter: GameState.wallet.balance,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-TW'),
                time: new Date().toLocaleTimeString('zh-TW'),
                playerIP: GameState.vpn.realIP || '192.168.1.1',
                mode: mode
            });

            addTerminalLine(`${currency} 兌換成功: +$${cashAmount.toLocaleString()}`, 'success');
            SoundSystem.play('success');
            closeTopUp();
        }

        function redeemNFT() {
            GameState.wallet.balance += 50000;

            const receiptId = 'TXN-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
            GameState.wallet.transactionHistory.push({
                receiptId: receiptId,
                type: 'topup',
                category: 'NFT兌換',
                item: 'CryptoHacker NFT',
                amount: 50000,
                balanceAfter: GameState.wallet.balance,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-TW'),
                time: new Date().toLocaleTimeString('zh-TW'),
                playerIP: GameState.vpn.realIP || '192.168.1.1',
                mode: GameState.currentMode
            });

            addTerminalLine('NFT兌換成功: +$50,000', 'success');
            SoundSystem.play('success');
            closeTopUp();
        }

        // ===== 黑客專用資金選項 =====
        function blackMarketFunding(amount) {
            GameState.wallet.balance += amount;

            const receiptId = 'BLK-' + Date.now().toString(36).toUpperCase();
            GameState.wallet.transactionHistory.push({
                receiptId: receiptId,
                type: 'loan',
                category: '黑市借款',
                item: '高利貸款',
                amount: amount,
                balanceAfter: GameState.wallet.balance,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-TW'),
                time: new Date().toLocaleTimeString('zh-TW'),
                playerIP: 'HIDDEN',
                mode: 'hacker'
            });

            addTerminalLine(`💀 黑市借款: +$${amount.toLocaleString()} (警告: 高利息)`, 'warning');
            SoundSystem.play('success');
            closeTopUp();
        }

        function ransomFundTransfer() {
            const ransomReceived = GameState.hackerAttack.ransomReceived || 0;
            if (ransomReceived <= 0) {
                addTerminalLine('尚未收到任何勒索金', 'error');
                return;
            }

            GameState.wallet.balance += ransomReceived;

            const receiptId = 'RSM-' + Date.now().toString(36).toUpperCase();
            GameState.wallet.transactionHistory.push({
                receiptId: receiptId,
                type: 'ransom',
                category: '勒索金收入',
                item: '勒索金轉帳',
                amount: ransomReceived,
                balanceAfter: GameState.wallet.balance,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-TW'),
                time: new Date().toLocaleTimeString('zh-TW'),
                playerIP: GameState.vpn.maskedIP || 'MASKED',
                mode: 'hacker'
            });

            GameState.hackerAttack.ransomReceived = 0;
            addTerminalLine(`💰 勒索金已轉入: +$${ransomReceived.toLocaleString()}`, 'success');
            SoundSystem.play('success');
            closeTopUp();
        }

        // ===== 暗網支付工具充值 =====
        function darkWebTopUp(method, amount) {
            const mode = GameState.currentMode;
            const isDefender = mode === 'defender';
            const rechargeLimit = GameState.wallet.rechargeLimit || 50000;

            // 防禦者充值限制檢查
            if (isDefender) {
                if (GameState.wallet.defenderRecharges >= GameState.wallet.maxDefenderRecharges) {
                    addTerminalLine('已用盡所有充值機會！', 'error');
                    SoundSystem.play('error');
                    return;
                }
                amount = Math.min(amount, rechargeLimit);
            }

            const methodNames = {
                octopus: '八達通錢包',
                alipay: '支付寶HK',
                monero: '門羅幣',
                tornado: 'Tornado Cash'
            };

            const balanceKeys = {
                octopus: 'octopusBalance',
                alipay: 'alipayBalance',
                monero: 'moneroBalance',
                tornado: 'tornadoBalance'
            };

            const currentBalance = GameState.wallet[balanceKeys[method]] || 0;

            if (currentBalance < amount) {
                addTerminalLine(`${methodNames[method]} 餘額不足`, 'error');
                SoundSystem.play('error');
                return;
            }

            // 扣除支付工具餘額
            GameState.wallet[balanceKeys[method]] -= amount;
            GameState.wallet.balance += amount;

            // 防禦者增加充值次數
            if (isDefender) {
                GameState.wallet.defenderRecharges++;
            }

            // 記錄交易
            const receiptId = 'DRK-' + Date.now().toString(36).toUpperCase();
            GameState.wallet.transactionHistory.push({
                receiptId: receiptId,
                type: 'darkweb_topup',
                category: '暗網支付',
                item: methodNames[method],
                method: method,
                amount: amount,
                balanceAfter: GameState.wallet.balance,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-TW'),
                time: new Date().toLocaleTimeString('zh-TW'),
                playerIP: GameState.vpn.maskedIP || 'HIDDEN',
                mode: mode,
                anonymous: true
            });

            const remainingMsg = isDefender ? ` (剩餘${GameState.wallet.maxDefenderRecharges - GameState.wallet.defenderRecharges}次機會)` : '';
            addTerminalLine(`🌑 ${methodNames[method]} 充值成功: +$${amount.toLocaleString()}${remainingMsg}`, 'success');
            SoundSystem.play('success');
            closeTopUp();
        }

        // ===== 和解/投降機制 =====
        function showSurrenderPanel() {
            const mode = GameState.currentMode;
            const isHacker = mode === 'hacker';

            const surrenderHTML = `
                <div class="modal-overlay" id="surrender-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 700px; background: linear-gradient(135deg, rgba(20,20,40,0.98) 0%, rgba(30,30,50,0.98) 100%); border: 2px solid #f39c12;">
                        <h2 style="color: #f39c12; margin-bottom: 20px; text-align: center;">
                            <i class="fas fa-flag"></i> ${isHacker ? '和解協議' : '投降選項'}
                        </h2>

                        <div style="background: rgba(243,156,18,0.1); border: 1px solid #f39c12; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <p style="color: #fff; margin-bottom: 15px; text-align: center;">
                                ${isHacker ? '您可以選擇與防禦者達成和解，停止所有攻擊行為。' : '您可以選擇投降，接受黑客的條件或請求和解。'}
                            </p>
                            <div style="display: grid; gap: 10px;">
                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                                    <div style="color: #888; font-size: 0.85rem;">當前狀態</div>
                                    <div style="color: #fff;">殭屍化進度: ${GameState.hackerAttack.zombieProgress}%</div>
                                    <div style="color: #fff;">勒索金額: $${(GameState.hackerAttack.ransomAmount || 0).toLocaleString()}</div>
                                    <div style="color: #fff;">攻擊模式: ${GameState.hackerAttack.mode || '無'}</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                            ${isHacker ? `
                            <button onclick="initiateSettlement()" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border: none; padding: 18px; border-radius: 8px; color: #fff; cursor: pointer; text-align: left;">
                                <div style="font-weight: bold; font-size: 1.1rem;"><i class="fas fa-handshake"></i> 提出和解</div>
                                <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">停止所有攻擊，解除殭屍化，雙方重新開始</div>
                            </button>
                            <button onclick="requestRansomSettlement()" style="background: linear-gradient(135deg, #9b59b6 0%, #6c3483 100%); border: none; padding: 18px; border-radius: 8px; color: #fff; cursor: pointer; text-align: left;">
                                <div style="font-weight: bold; font-size: 1.1rem;"><i class="fas fa-coins"></i> 減價和解</div>
                                <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">提供折扣勒索金，快速達成協議</div>
                            </button>
                            ` : `
                            <button onclick="surrenderFull()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; padding: 18px; border-radius: 8px; color: #fff; cursor: pointer; text-align: left;">
                                <div style="font-weight: bold; font-size: 1.1rem;"><i class="fas fa-flag"></i> 完全投降</div>
                                <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">支付全額勒索金，立即解除所有限制</div>
                            </button>
                            <button onclick="requestSettlement()" style="background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); border: none; padding: 18px; border-radius: 8px; color: #fff; cursor: pointer; text-align: left;">
                                <div style="font-weight: bold; font-size: 1.1rem;"><i class="fas fa-comments"></i> 請求和解</div>
                                <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">與黑客談判，嘗試達成和解協議</div>
                            </button>
                            <button onclick="fightBack()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none; padding: 18px; border-radius: 8px; color: #fff; cursor: pointer; text-align: left;">
                                <div style="font-weight: bold; font-size: 1.1rem;"><i class="fas fa-shield-alt"></i> 繼續抵抗</div>
                                <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">拒絕投降，繼續防禦對抗</div>
                            </button>
                            `}
                        </div>

                        <div style="text-align: center;">
                            <button onclick="closeSurrenderPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', surrenderHTML);
        }

        function closeSurrenderPanel() {
            const modal = document.getElementById('surrender-modal');
            if (modal) modal.remove();
        }

        function initiateSettlement() {
            closeSurrenderPanel();
            showSettlementDialogue('hacker');
        }

        function requestSettlement() {
            closeSurrenderPanel();
            showSettlementDialogue('defender');
        }

        function showSettlementDialogue(initiator) {
            const dialogueHTML = `
                <div class="modal-overlay" id="settlement-dialogue-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 800px; max-height: 85vh; background: linear-gradient(135deg, rgba(10,20,30,0.98) 0%, rgba(20,30,40,0.98) 100%); border: 2px solid #27ae60; padding: 0;">
                        <div style="background: rgba(39,174,96,0.2); padding: 15px 20px; border-bottom: 1px solid #27ae60;">
                            <h3 style="color: #27ae60; margin: 0;"><i class="fas fa-handshake"></i> 和解對話</h3>
                        </div>

                        <div id="settlement-chat" style="height: 350px; overflow-y: auto; padding: 20px;">
                            <div style="text-align: center; color: #888; margin-bottom: 20px;">
                                <div style="background: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 20px; display: inline-block;">
                                    ${initiator === 'hacker' ? '黑客發起和解請求' : '防禦者請求和解談判'}
                                </div>
                            </div>
                            <div id="settlement-messages"></div>
                        </div>

                        <div style="padding: 15px 20px; border-top: 1px solid #333;">
                            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                                <button onclick="sendSettlementMessage('accept')" style="background: #27ae60; border: none; padding: 10px 15px; border-radius: 6px; color: #fff; cursor: pointer; flex: 1;">
                                    <i class="fas fa-check"></i> 接受和解
                                </button>
                                <button onclick="sendSettlementMessage('negotiate')" style="background: #f39c12; border: none; padding: 10px 15px; border-radius: 6px; color: #fff; cursor: pointer; flex: 1;">
                                    <i class="fas fa-balance-scale"></i> 協商條款
                                </button>
                                <button onclick="sendSettlementMessage('reject')" style="background: #e74c3c; border: none; padding: 10px 15px; border-radius: 6px; color: #fff; cursor: pointer; flex: 1;">
                                    <i class="fas fa-times"></i> 拒絕
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="settlement-input" placeholder="輸入和解訊息..." style="flex: 1; background: rgba(0,0,0,0.5); border: 1px solid #444; padding: 12px; border-radius: 6px; color: #fff; font-size: 16px;" onkeypress="if(event.key==='Enter')sendCustomSettlementMessage()">
                                <button onclick="sendCustomSettlementMessage()" style="background: #27ae60; border: none; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer;">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>

                        <div style="padding: 15px 20px; border-top: 1px solid #333; text-align: center;">
                            <button onclick="finalizeSettlement()" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border: none; padding: 12px 25px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-handshake"></i> 確認和解
                            </button>
                            <button onclick="closeSettlementDialogue()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 25px; border-radius: 6px; color: #fff; cursor: pointer; margin-left: 10px;">
                                <i class="fas fa-times"></i> 取���
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogueHTML);

            // 添加初始AI訊息
            setTimeout(() => {
                addSettlementMessage('ai', initiator === 'hacker' ? '我願意停止攻擊，讓我們達成和解協議。' : '我會考慮您的和解請求，請說明您的條件。');
            }, 1000);
        }

        function closeSettlementDialogue() {
            const modal = document.getElementById('settlement-dialogue-modal');
            if (modal) modal.remove();
        }

        function addSettlementMessage(sender, message) {
            const messagesDiv = document.getElementById('settlement-messages');
            if (!messagesDiv) return;

            const isPlayer = sender === 'player';
            const msgHTML = `
                <div style="display: flex; justify-content: ${isPlayer ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
                    <div style="max-width: 70%; background: ${isPlayer ? 'rgba(39,174,96,0.3)' : 'rgba(52,152,219,0.3)'}; border: 1px solid ${isPlayer ? '#27ae60' : '#3498db'}; padding: 12px 15px; border-radius: 12px;">
                        <div style="color: ${isPlayer ? '#27ae60' : '#3498db'}; font-size: 0.75rem; margin-bottom: 5px;">${isPlayer ? '你' : 'AI對手'}</div>
                        <div style="color: #fff;">${message}</div>
                    </div>
                </div>
            `;
            messagesDiv.insertAdjacentHTML('beforeend', msgHTML);

            const chatDiv = document.getElementById('settlement-chat');
            if (chatDiv) chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function sendSettlementMessage(type) {
            const messages = {
                accept: '我接受和解協議，讓我們重新開始。',
                negotiate: '我希望能協商更好的條款。',
                reject: '我無法接受這些條件。'
            };

            addSettlementMessage('player', messages[type]);

            setTimeout(() => {
                const responses = {
                    accept: '很好，和解協議已確認。所有攻擊將停止。',
                    negotiate: '我可以考慮減少勒索金額，您認為多少合適？',
                    reject: '那麼攻擊將會繼續，您確定嗎？'
                };
                addSettlementMessage('ai', responses[type]);
            }, 1500);
        }

        function sendCustomSettlementMessage() {
            const input = document.getElementById('settlement-input');
            if (!input || !input.value.trim()) return;

            addSettlementMessage('player', input.value);
            input.value = '';

            setTimeout(() => {
                const responses = [
                    '我理解您的立場，讓我們找到一個雙方都能接受的方案。',
                    '這是一個合理的提議，我會考慮。',
                    '讓我們專注於解決方案而不是爭執。',
                    '我同意和平解決這個問題。'
                ];
                addSettlementMessage('ai', responses[Math.floor(Math.random() * responses.length)]);
            }, 1500);
        }

        function finalizeSettlement() {
            // 重置所有攻擊狀態
            GameState.hackerAttack.zombieProgress = 0;
            GameState.hackerAttack.isZombified = false;
            GameState.hackerAttack.mode = null;
            GameState.hackerAttack.ransomAmount = 0;
            GameState.hackerAttack.ransomPaid = false;
            GameState.hackerAttack.gradualStep = 0;

            // 記錄和解交易
            const receiptId = 'STL-' + Date.now().toString(36).toUpperCase();
            GameState.wallet.transactionHistory.push({
                receiptId: receiptId,
                type: 'settlement',
                category: '和解協議',
                item: '雙方和解',
                amount: 0,
                balanceAfter: GameState.wallet.balance,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-TW'),
                time: new Date().toLocaleTimeString('zh-TW'),
                playerIP: GameState.vpn.realIP || '192.168.1.1',
                mode: GameState.currentMode
            });

            closeSettlementDialogue();

            addTerminalLine('═══════════════════════════════════════', 'success');
            addTerminalLine('✓ 和解協議已達成！', 'success');
            addTerminalLine('✓ 所有攻擊已停止', 'success');
            addTerminalLine('✓ 系統已恢復正常', 'success');
            addTerminalLine('═══════════════════════════════════════', 'success');

            if (typeof updateDeviceScreen === 'function') {
                updateDeviceScreen('player', '🤝 和解協議已達成');
                updateDeviceScreen('opponent', '🤝 和解協議已確認');
            }

            if (typeof showNotification === 'function') {
                showNotification('和解成功', '雙方已達成和解協議', 'success');
            }
        }

        function surrenderFull() {
            const ransomAmount = GameState.hackerAttack.ransomAmount || 0;

            if (GameState.wallet.balance < ransomAmount) {
                addTerminalLine('餘額不足以支付勒索金', 'error');
                return;
            }

            GameState.wallet.balance -= ransomAmount;

            finalizeSettlement();
            addTerminalLine(`已支付勒索金: $${ransomAmount.toLocaleString()}`, 'warning');
        }

        function requestRansomSettlement() {
            closeSurrenderPanel();

            const currentRansom = GameState.hackerAttack.ransomAmount || 50000;
            const discountedRansom = Math.floor(currentRansom * 0.5);

            GameState.hackerAttack.ransomAmount = discountedRansom;
            addTerminalLine(`已提供50%折扣: $${discountedRansom.toLocaleString()}`, 'success');

            showSettlementDialogue('hacker');
        }

        function fightBack() {
            closeSurrenderPanel();
            addTerminalLine('繼續抵抗！加強防禦措施...', 'command');
            if (typeof showNotification === 'function') {
                showNotification('繼續戰鬥', '防禦者選擇繼續抵抗', 'warning');
            }
        }

        // ===== VPN開關控制 =====
        function toggleVPN() {
            if (GameState.vpn.active) {
                GameState.vpn.active = false;
                GameState.vpn.provider = null;
                addTerminalLine('VPN已關閉', 'warning');
            } else {
                if (GameState.vpn.provider) {
                    GameState.vpn.active = true;
                    addTerminalLine(`VPN已重新啟用: ${GameState.vpn.provider}`, 'success');
                } else {
                    addTerminalLine('請先購買VPN服務', 'error');
                    return;
                }
            }
            if (typeof updateVPNDisplay === 'function') updateVPNDisplay();
            if (typeof updateDeviceScreen === 'function') {
                updateDeviceScreen('player', GameState.vpn.active ? '🛡️ VPN已啟用' : '⚠️ VPN已關閉');
            }
        }

        // ===== VPN系統 =====
        function updateVPNDisplay() {
            const vpnIndicator = document.getElementById('vpn-status-indicator');
            if (vpnIndicator) {
                if (GameState.vpn.active) {
                    vpnIndicator.innerHTML = `<i class="fas fa-shield-alt" style="color: ${GameState.vpn.isFake ? '#ffaa00' : '#00ff41'};"></i> VPN: ${GameState.vpn.currentRegion}`;
                } else {
                    vpnIndicator.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ff3333;"></i> 無VPN';
                }
            }
        }

        function changeVPNRegion(region) {
            if (!GameState.vpn.active) {
                addTerminalLine('請先啟用VPN', 'warning');
                return;
            }
            GameState.vpn.currentRegion = region;
            GameState.vpn.maskedIP = generateRandomIP();
            addTerminalLine(`VPN地區已切換: ${region}`, 'success');
            updateVPNDisplay();
        }

        // ===== 黑客攻擊模式系統 =====
        function showAttackModePanel() {
            if (!GameState.connected) {
                addTerminalLine('請先連接到目標系統', 'warning');
                SoundSystem.play('error');
                return;
            }

            const attack = GameState.hackerAttack;
            const panelHTML = `
                <div class="modal-overlay" id="attack-mode-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(20,10,30,0.98) 0%, rgba(40,20,50,0.98) 100%); border: 2px solid #9b59b6;">
                        <h2 style="color: #9b59b6; margin-bottom: 25px; text-align: center; text-shadow: 0 0 10px rgba(155,89,182,0.5);">
                            <i class="fas fa-skull-crossbones"></i> 攻擊模式選擇
                        </h2>

                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.5); border-radius: 8px; border: 1px solid #9b59b6;">
                            <div style="color: #aaa; margin-bottom: 10px;">當前目標: <span style="color: #00ff41; font-weight: bold;">${GameState.battle.targetIP}</span></div>
                            <div style="color: #aaa;">殭屍化進度: <span style="color: ${attack.zombieProgress >= 100 ? '#ff3333' : '#ffaa00'}; font-weight: bold;">${attack.zombieProgress}%</span></div>
                            ${attack.mode ? `<div style="color: #aaa; margin-top: 5px;">當前模式: <span style="color: #9b59b6; font-weight: bold;">${attack.mode === 'direct' ? '直接執行攻擊' : attack.mode === 'gradual' ? '循序漸進攻擊' : '勒索金模式'}</span></div>` : ''}
                        </div>

                        <!-- 三種攻擊模式 -->
                        <div style="display: grid; gap: 20px; margin-bottom: 25px;">
                            <!-- 直接執行攻擊 -->
                            <div onclick="openDirectAttackPanel()" style="background: linear-gradient(135deg, rgba(255,51,51,0.2) 0%, rgba(150,30,30,0.3) 100%); border: 2px solid #ff3333; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; ${attack.mode === 'direct' ? 'box-shadow: 0 0 20px rgba(255,51,51,0.5);' : ''}" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #ff3333, #cc0000); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-bolt" style="font-size: 1.8rem; color: #fff;"></i>
                                    </div>
                                    <div>
                                        <h3 style="color: #ff3333; margin: 0; font-size: 1.4rem;">直接執行攻擊</h3>
                                        <div style="color: #ff6666; font-size: 0.9rem;">點擊進入 → 輸入攻擊指令</div>
                                    </div>
                                    <div style="margin-left: auto; background: rgba(255,51,51,0.3); padding: 8px 15px; border-radius: 20px;">
                                        <i class="fas fa-terminal" style="color: #ff3333;"></i> 進入控制台
                                    </div>
                                </div>
                                <p style="color: #ccc; margin: 0; line-height: 1.6;">
                                    🔥 <strong>效果</strong>: 直接將對方防禦者的系統完全殭屍化，令對方無法作出任何反擊或進行任何設定。<br>
                                    ⚡ <strong>速度</strong>: 即時執行<br>
                                    💰 <strong>消耗</strong>: $50,000
                                </p>
                            </div>

                            <!-- 循序漸進攻擊 -->
                            <div onclick="openGradualAttackPanel()" style="background: linear-gradient(135deg, rgba(255,153,0,0.2) 0%, rgba(150,90,0,0.3) 100%); border: 2px solid #ff9900; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; ${attack.mode === 'gradual' ? 'box-shadow: 0 0 20px rgba(255,153,0,0.5);' : ''}" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #ff9900, #cc7700); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-spider" style="font-size: 1.8rem; color: #fff;"></i>
                                    </div>
                                    <div>
                                        <h3 style="color: #ff9900; margin: 0; font-size: 1.4rem;">循序漸進攻擊</h3>
                                        <div style="color: #ffaa33; font-size: 0.9rem;">點擊進入 → 配置滲透參數</div>
                                    </div>
                                    <div style="margin-left: auto; background: rgba(255,153,0,0.3); padding: 8px 15px; border-radius: 20px;">
                                        <i class="fas fa-cog" style="color: #ff9900;"></i> 進入控制台
                                    </div>
                                </div>
                                <p style="color: #ccc; margin: 0; line-height: 1.6;">
                                    🕷️ <strong>效果</strong>: 慢慢地一步一步逐漸封殺對方系統，讓對方難以察覺直到為時已晚。<br>
                                    ⏱️ <strong>速度</strong>: 每5秒進行一步（共10步）<br>
                                    💰 <strong>消耗</strong>: $25,000
                                </p>
                                ${attack.mode === 'gradual' ? `<div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                    <div style="color: #ff9900; margin-bottom: 5px;">滲透進度: ${attack.gradualStep}/10 步</div>
                                    <div style="background: rgba(0,0,0,0.5); height: 10px; border-radius: 5px; overflow: hidden;">
                                        <div style="background: linear-gradient(90deg, #ff9900, #ffcc00); height: 100%; width: ${attack.gradualStep * 10}%; transition: width 0.3s;"></div>
                                    </div>
                                </div>` : ''}
                            </div>

                            <!-- 勒索金模式 -->
                            <div onclick="openRansomAttackPanel()" style="background: linear-gradient(135deg, rgba(155,89,182,0.2) 0%, rgba(100,50,120,0.3) 100%); border: 2px solid #9b59b6; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; ${attack.mode === 'ransom' ? 'box-shadow: 0 0 20px rgba(155,89,182,0.5);' : ''}" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #9b59b6, #6c3483); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-lock" style="font-size: 1.8rem; color: #fff;"></i>
                                    </div>
                                    <div>
                                        <h3 style="color: #9b59b6; margin: 0; font-size: 1.4rem;">勒索金要求</h3>
                                        <div style="color: #b07cc6; font-size: 0.9rem;">點擊進入 → 發送勒索訊息</div>
                                    </div>
                                    <div style="margin-left: auto; background: rgba(155,89,182,0.3); padding: 8px 15px; border-radius: 20px;">
                                        <i class="fas fa-envelope" style="color: #9b59b6;"></i> 進入控制台
                                    </div>
                                </div>
                                <p style="color: #ccc; margin: 0; line-height: 1.6;">
                                    🔐 <strong>效果</strong>: 發送勒索訊息給防禦者，要求支付勒索金才能解鎖系統。<br>
                                    💎 <strong>勒索金額</strong>: 自訂金額 $1,500,000 - $10,000,000<br>
                                    💰 <strong>消耗</strong>: $10,000
                                </p>
                                ${attack.ransomAmount > 0 ? `<div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                    <div style="color: #9b59b6;">勒索金額: <span style="color: #00ff41; font-weight: bold;">$${attack.ransomAmount.toLocaleString()}</span></div>
                                    <div style="color: ${attack.ransomPaid ? '#00ff41' : '#ff3333'};">${attack.ransomPaid ? '✓ 已收到勒索金' : '⏳ 等待支付中...'}</div>
                                </div>` : ''}
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <button onclick="closeAttackModePanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }

        function closeAttackModePanel() {
            const modal = document.getElementById('attack-mode-modal');
            if (modal) modal.remove();
        }

        // ===== 直接執行攻擊控制台 =====
        function openDirectAttackPanel() {
            closeAttackModePanel();

            const panelHTML = `
                <div class="modal-overlay" id="direct-attack-panel" style="display: flex;">
                    <div class="modal-box" style="max-width: 950px; max-height: 95vh; overflow-y: auto; background: linear-gradient(135deg, rgba(30,10,10,0.98) 0%, rgba(50,15,15,0.98) 100%); border: 2px solid #ff3333;">
                        <h2 style="color: #ff3333; margin-bottom: 20px; text-align: center; text-shadow: 0 0 15px rgba(255,51,51,0.5);">
                            <i class="fas fa-bolt"></i> 直接執行攻擊控制台
                        </h2>

                        <!-- 目標信息 -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; border: 1px solid #ff3333; text-align: center;">
                                <div style="color: #888; font-size: 0.85rem;">目標IP</div>
                                <div style="color: #ff3333; font-size: 1.2rem; font-weight: bold;">${GameState.battle.targetIP}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; border: 1px solid #ff9900; text-align: center;">
                                <div style="color: #888; font-size: 0.85rem;">餘額</div>
                                <div style="color: #ff9900; font-size: 1.2rem; font-weight: bold;">$${GameState.wallet.balance.toLocaleString()}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; border: 1px solid #00ff41; text-align: center;">
                                <div style="color: #888; font-size: 0.85rem;">攻擊消耗</div>
                                <div style="color: #00ff41; font-size: 1.2rem; font-weight: bold;">$50,000</div>
                            </div>
                        </div>

                        <!-- 攻擊代碼輸入區 -->
                        <div style="background: rgba(0,0,0,0.7); border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid #ff3333;">
                            <div style="color: #ff6666; margin-bottom: 15px; font-weight: bold;">
                                <i class="fas fa-code"></i> 輸入攻擊指令 (或選擇預設攻擊)
                            </div>

                            <!-- 預設攻擊選項 -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                                <button onclick="insertDirectAttackCode('zombie')" style="background: rgba(255,51,51,0.2); border: 1px solid #ff3333; padding: 12px; border-radius: 6px; color: #ff3333; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,51,51,0.4)'" onmouseout="this.style.background='rgba(255,51,51,0.2)'">
                                    <div style="font-weight: bold;"><i class="fas fa-skull"></i> 殭屍化攻擊</div>
                                    <div style="font-size: 0.8rem; color: #aaa;">完全接管目標系統</div>
                                </button>
                                <button onclick="insertDirectAttackCode('wipe')" style="background: rgba(255,51,51,0.2); border: 1px solid #ff3333; padding: 12px; border-radius: 6px; color: #ff3333; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,51,51,0.4)'" onmouseout="this.style.background='rgba(255,51,51,0.2)'">
                                    <div style="font-weight: bold;"><i class="fas fa-eraser"></i> 數據擦除</div>
                                    <div style="font-size: 0.8rem; color: #aaa;">刪除目標所有數據</div>
                                </button>
                                <button onclick="insertDirectAttackCode('lockdown')" style="background: rgba(255,51,51,0.2); border: 1px solid #ff3333; padding: 12px; border-radius: 6px; color: #ff3333; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,51,51,0.4)'" onmouseout="this.style.background='rgba(255,51,51,0.2)'">
                                    <div style="font-weight: bold;"><i class="fas fa-lock"></i> 系統鎖定</div>
                                    <div style="font-size: 0.8rem; color: #aaa;">鎖定所有管理權限</div>
                                </button>
                                <button onclick="insertDirectAttackCode('ddos')" style="background: rgba(255,51,51,0.2); border: 1px solid #ff3333; padding: 12px; border-radius: 6px; color: #ff3333; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,51,51,0.4)'" onmouseout="this.style.background='rgba(255,51,51,0.2)'">
                                    <div style="font-weight: bold;"><i class="fas fa-network-wired"></i> DDoS洪水</div>
                                    <div style="font-size: 0.8rem; color: #aaa;">癱瘓目標網絡服務</div>
                                </button>
                            </div>

                            <!-- 代碼輸入框 -->
                            <textarea id="direct-attack-code" style="width: 100%; height: 180px; background: #0a0a0a; border: 1px solid #333; border-radius: 6px; color: #00ff41; font-family: 'Courier New', monospace; font-size: 14px; padding: 15px; resize: none;" placeholder="# 輸入你的攻擊指令...
# 例如:
./zombie_payload --target ${GameState.battle.targetIP} --force
sudo rm -rf /target/system/*
nmap -sS -sV -O ${GameState.battle.targetIP}"></textarea>

                            <!-- 執行狀態 -->
                            <div id="direct-attack-status" style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.5); border-radius: 6px; display: none;">
                                <div style="color: #ff3333; font-weight: bold; margin-bottom: 10px;"><i class="fas fa-spinner fa-spin"></i> 執行中...</div>
                                <div id="direct-attack-progress" style="background: rgba(0,0,0,0.5); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="direct-attack-progress-bar" style="background: linear-gradient(90deg, #ff3333, #ff6666); height: 100%; width: 0%; transition: width 0.3s;"></div>
                                </div>
                                <div id="direct-attack-log" style="margin-top: 10px; color: #aaa; font-size: 0.9rem;"></div>
                            </div>
                        </div>

                        <!-- 執行按鈕 -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button onclick="executeDirectAttackFromPanel()" style="background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%); border: none; padding: 18px 30px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 0 30px rgba(255,51,51,0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                                <i class="fas fa-play"></i> 執行攻擊 ($50,000)
                            </button>
                            <button onclick="closeDirectAttackPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 18px 30px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem;">
                                <i class="fas fa-arrow-left"></i> 返回
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', panelHTML);
            SoundSystem.play('keypress');
        }

        function insertDirectAttackCode(type) {
            const codeArea = document.getElementById('direct-attack-code');
            const codes = {
                zombie: `#!/bin/bash
# === ZOMBIE PAYLOAD v3.1 ===
echo "[*] Initiating zombie attack on ${GameState.battle.targetIP}..."
./exploits/zero_day_exploit.sh --target ${GameState.battle.targetIP}
python3 payload_injector.py --mode=persistent --stealth=true
./zombie_controller --install --backdoor --keylogger
netcat -lvp 4444 &
echo "[+] Zombie payload deployed successfully!"
echo "[+] Target system is now under our control."`,
                wipe: `#!/bin/bash
# === DATA WIPE ATTACK ===
echo "[!] WARNING: Initiating data wipe on ${GameState.battle.targetIP}"
ssh root@${GameState.battle.targetIP} "rm -rf /var/data/* --no-preserve-root"
./wiper.py --target ${GameState.battle.targetIP} --method=DoD_5220.22-M
shred -vfz -n 5 /target/critical_files/*
echo "[+] All data has been permanently destroyed!"`,
                lockdown: `#!/bin/bash
# === SYSTEM LOCKDOWN ===
echo "[*] Locking down target system..."
./privilege_escalation.py --target ${GameState.battle.targetIP}
passwd -l root; passwd -l admin
iptables -P INPUT DROP; iptables -P OUTPUT DROP
systemctl disable --now sshd firewalld
echo "[+] System completely locked. No access possible!"`,
                ddos: `#!/bin/bash
# === DDoS FLOOD ATTACK ===
echo "[*] Launching DDoS attack on ${GameState.battle.targetIP}..."
./botnet_commander --activate --nodes=100000
hping3 -S --flood -V -p 80 ${GameState.battle.targetIP} &
./slowloris.py -t ${GameState.battle.targetIP} -s 10000 &
./amplification_attack.py --dns --ntp --memcached
echo "[+] Target network is overwhelmed!"`
            };
            codeArea.value = codes[type] || '';
            SoundSystem.play('keypress');
        }

        function closeDirectAttackPanel() {
            const panel = document.getElementById('direct-attack-panel');
            if (panel) panel.remove();
            showAttackModePanel();
        }

        function executeDirectAttackFromPanel() {
            const codeArea = document.getElementById('direct-attack-code');
            const code = codeArea.value.trim();

            if (!code) {
                addTerminalLine('請先輸入攻擊指令！', 'error');
                SoundSystem.play('error');
                return;
            }

            if (GameState.wallet.balance < 50000) {
                addTerminalLine('餘額不足！需要 $50,000 才能執行此攻擊', 'error');
                SoundSystem.play('error');
                return;
            }

            // 扣除費用
            GameState.wallet.balance -= 50000;
            updateWalletDisplay();
            GameState.hackerAttack.mode = 'direct';

            // 顯示執行狀態
            const statusDiv = document.getElementById('direct-attack-status');
            const progressBar = document.getElementById('direct-attack-progress-bar');
            const logDiv = document.getElementById('direct-attack-log');
            statusDiv.style.display = 'block';

            SoundSystem.play('attack');
            addTerminalLine('=== 執行直接攻擊指令 ===', 'command');

            // 模擬執行過程
            const lines = code.split('\n').filter(l => l.trim() && !l.trim().startsWith('#'));
            let lineIndex = 0;
            let progress = 0;

            const executeInterval = setInterval(() => {
                if (lineIndex < lines.length) {
                    const line = lines[lineIndex];
                    logDiv.innerHTML += `<div style="color: #00ff41;">> ${line}</div>`;
                    addTerminalLine(`> ${line}`, 'response');
                    lineIndex++;
                    progress = Math.min(90, (lineIndex / lines.length) * 90);
                    progressBar.style.width = progress + '%';
                } else {
                    progress += 5;
                    progressBar.style.width = Math.min(100, progress) + '%';

                    if (progress >= 100) {
                        clearInterval(executeInterval);
                        logDiv.innerHTML += `<div style="color: #ff3333; font-weight: bold;">[+] 攻擊執行完成！正在殭屍化目標系統...</div>`;

                        // 關閉面板並執行真正的攻擊
                        setTimeout(() => {
                            const panel = document.getElementById('direct-attack-panel');
                            if (panel) panel.remove();
                            executeDirectAttack();
                        }, 1500);
                    }
                }
            }, 200);
        }

        // ===== 循序漸進攻擊控制台 =====
        function openGradualAttackPanel() {
            closeAttackModePanel();

            const attack = GameState.hackerAttack;
            const panelHTML = `
                <div class="modal-overlay" id="gradual-attack-panel" style="display: flex;">
                    <div class="modal-box" style="max-width: 950px; max-height: 95vh; overflow-y: auto; background: linear-gradient(135deg, rgba(30,20,10,0.98) 0%, rgba(50,30,15,0.98) 100%); border: 2px solid #ff9900;">
                        <h2 style="color: #ff9900; margin-bottom: 20px; text-align: center; text-shadow: 0 0 15px rgba(255,153,0,0.5);">
                            <i class="fas fa-spider"></i> 循序漸進攻擊控制台
                        </h2>

                        <!-- 目標信息 -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 8px; border: 1px solid #ff9900; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">目標IP</div>
                                <div style="color: #ff9900; font-size: 1rem; font-weight: bold;">${GameState.battle.targetIP}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 8px; border: 1px solid #00ff41; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">餘額</div>
                                <div style="color: #00ff41; font-size: 1rem; font-weight: bold;">$${GameState.wallet.balance.toLocaleString()}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 8px; border: 1px solid #9b59b6; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">當前進度</div>
                                <div style="color: #9b59b6; font-size: 1rem; font-weight: bold;">${attack.gradualStep}/10 步</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 8px; border: 1px solid #ff3333; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">消耗</div>
                                <div style="color: #ff3333; font-size: 1rem; font-weight: bold;">$25,000</div>
                            </div>
                        </div>

                        <!-- 滲透配置 -->
                        <div style="background: rgba(0,0,0,0.7); border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid #ff9900;">
                            <div style="color: #ffaa33; margin-bottom: 15px; font-weight: bold;">
                                <i class="fas fa-cog"></i> 配置滲透參數
                            </div>

                            <!-- 滲透策略選擇 -->
                            <div style="margin-bottom: 20px;">
                                <label style="color: #aaa; display: block; margin-bottom: 8px;">滲透策略:</label>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                    <button onclick="selectGradualStrategy('stealth')" id="strat-stealth" class="gradual-strat-btn" style="background: rgba(0,255,65,0.2); border: 2px solid #00ff41; padding: 15px; border-radius: 8px; color: #00ff41; cursor: pointer; transition: all 0.3s;">
                                        <div style="font-size: 1.5rem; margin-bottom: 5px;"><i class="fas fa-ghost"></i></div>
                                        <div style="font-weight: bold;">隱蔽模式</div>
                                        <div style="font-size: 0.75rem; color: #aaa;">低風險，慢速度</div>
                                    </button>
                                    <button onclick="selectGradualStrategy('balanced')" id="strat-balanced" class="gradual-strat-btn" style="background: rgba(255,153,0,0.2); border: 2px solid #ff9900; padding: 15px; border-radius: 8px; color: #ff9900; cursor: pointer; transition: all 0.3s;">
                                        <div style="font-size: 1.5rem; margin-bottom: 5px;"><i class="fas fa-balance-scale"></i></div>
                                        <div style="font-weight: bold;">均衡模式</div>
                                        <div style="font-size: 0.75rem; color: #aaa;">中等風險，中等速度</div>
                                    </button>
                                    <button onclick="selectGradualStrategy('aggressive')" id="strat-aggressive" class="gradual-strat-btn" style="background: rgba(255,51,51,0.2); border: 2px solid #ff3333; padding: 15px; border-radius: 8px; color: #ff3333; cursor: pointer; transition: all 0.3s;">
                                        <div style="font-size: 1.5rem; margin-bottom: 5px;"><i class="fas fa-fire"></i></div>
                                        <div style="font-weight: bold;">激進模式</div>
                                        <div style="font-size: 0.75rem; color: #aaa;">高風險，快速度</div>
                                    </button>
                                </div>
                            </div>

                            <!-- 滲透指令輸入 -->
                            <div style="margin-bottom: 15px;">
                                <label style="color: #aaa; display: block; margin-bottom: 8px;">自定義滲透指令 (可選):</label>
                                <textarea id="gradual-attack-code" style="width: 100%; height: 120px; background: #0a0a0a; border: 1px solid #333; border-radius: 6px; color: #ff9900; font-family: 'Courier New', monospace; font-size: 13px; padding: 12px; resize: none;" placeholder="# 可選：輸入額外的滲透指令
# 這些指令將在每個滲透步驟中執行
nmap -sS -sV ${GameState.battle.targetIP}
./exploit_scanner.py --target ${GameState.battle.targetIP}"></textarea>
                            </div>

                            <!-- 滲透進度預覽 -->
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; border: 1px solid #333;">
                                <div style="color: #ff9900; font-weight: bold; margin-bottom: 10px;">滲透步驟預覽:</div>
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                                    ${[1,2,3,4,5,6,7,8,9,10].map(i => `
                                        <div style="background: ${i <= attack.gradualStep ? 'rgba(255,153,0,0.4)' : 'rgba(50,50,50,0.5)'}; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid ${i <= attack.gradualStep ? '#ff9900' : '#333'};">
                                            <div style="color: ${i <= attack.gradualStep ? '#ff9900' : '#666'}; font-size: 0.8rem;">步驟 ${i}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- 執行區域 -->
                        <div id="gradual-attack-status" style="background: rgba(0,0,0,0.7); border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid #ff9900; display: none;">
                            <div style="color: #ff9900; font-weight: bold; margin-bottom: 10px;"><i class="fas fa-spider"></i> 滲透進行中...</div>
                            <div id="gradual-attack-progress" style="background: rgba(0,0,0,0.5); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 15px;">
                                <div id="gradual-attack-progress-bar" style="background: linear-gradient(90deg, #ff9900, #ffcc00); height: 100%; width: 0%; transition: width 0.5s;"></div>
                            </div>
                            <div id="gradual-attack-log" style="max-height: 200px; overflow-y: auto; font-size: 0.9rem;"></div>
                        </div>

                        <!-- 執行按鈕 -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button onclick="executeGradualAttackFromPanel()" style="background: linear-gradient(135deg, #ff9900 0%, #cc7700 100%); border: none; padding: 18px 30px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 0 30px rgba(255,153,0,0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                                <i class="fas fa-play"></i> 開始滲透 ($25,000)
                            </button>
                            <button onclick="closeGradualAttackPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 18px 30px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem;">
                                <i class="fas fa-arrow-left"></i> 返回
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', panelHTML);

            // 初始化策略狀態
            if (!GameState.hackerAttack.gradualStrategy) {
                GameState.hackerAttack.gradualStrategy = 'balanced';
            }
            selectGradualStrategy(GameState.hackerAttack.gradualStrategy);
            SoundSystem.play('keypress');
        }

        function selectGradualStrategy(strategy) {
            GameState.hackerAttack.gradualStrategy = strategy;

            // 更新按鈕樣式
            document.querySelectorAll('.gradual-strat-btn').forEach(btn => {
                btn.style.boxShadow = 'none';
                btn.style.transform = 'scale(1)';
            });

            const selectedBtn = document.getElementById('strat-' + strategy);
            if (selectedBtn) {
                const colors = { stealth: '#00ff41', balanced: '#ff9900', aggressive: '#ff3333' };
                selectedBtn.style.boxShadow = `0 0 20px ${colors[strategy]}`;
                selectedBtn.style.transform = 'scale(1.02)';
            }

            SoundSystem.play('keypress');
        }

        function closeGradualAttackPanel() {
            const panel = document.getElementById('gradual-attack-panel');
            if (panel) panel.remove();
            showAttackModePanel();
        }

        function executeGradualAttackFromPanel() {
            if (GameState.wallet.balance < 25000) {
                addTerminalLine('餘額不足！需要 $25,000 才能執行此攻擊', 'error');
                SoundSystem.play('error');
                return;
            }

            // 扣除費用
            GameState.wallet.balance -= 25000;
            updateWalletDisplay();
            GameState.hackerAttack.mode = 'gradual';

            // 顯示執行狀態
            const statusDiv = document.getElementById('gradual-attack-status');
            const progressBar = document.getElementById('gradual-attack-progress-bar');
            const logDiv = document.getElementById('gradual-attack-log');
            statusDiv.style.display = 'block';

            SoundSystem.play('attack');
            addTerminalLine('=== 開始循序漸進滲透攻擊 ===', 'command');
            addTerminalLine(`策略模式: ${GameState.hackerAttack.gradualStrategy}`, 'system');

            const strategy = GameState.hackerAttack.gradualStrategy || 'balanced';
            const speeds = { stealth: 5000, balanced: 3000, aggressive: 1500 };
            const interval = speeds[strategy];

            const steps = [
                { msg: '掃描目標漏洞...', cmd: 'nmap -sS -sV -O ' + GameState.battle.targetIP },
                { msg: '發現開放端口，嘗試連接...', cmd: 'nc -zv ' + GameState.battle.targetIP + ' 22 80 443' },
                { msg: '繞過初級防火牆...', cmd: './firewall_bypass.py --method=fragment' },
                { msg: '植入後門程序...', cmd: './backdoor_installer.sh --persistent --hidden' },
                { msg: '獲取低級權限...', cmd: 'exploit/multi/handler --payload reverse_shell' },
                { msg: '提升權限等級...', cmd: 'sudo -l && ./privesc.py --auto' },
                { msg: '關閉部分防禦系統...', cmd: 'systemctl stop firewalld antivirus' },
                { msg: '擴展殭屍網絡節點...', cmd: './botnet_expand.py --add-nodes 5000' },
                { msg: '接管核心服務...', cmd: 'mysql -u root -e "GRANT ALL ON *.* TO hacker"' },
                { msg: '完全控制系統！', cmd: './full_takeover.sh --stealth --rootkit' }
            ];

            let step = GameState.hackerAttack.gradualStep;

            const executeInterval = setInterval(() => {
                if (step >= 10) {
                    clearInterval(executeInterval);
                    logDiv.innerHTML += `<div style="color: #00ff41; font-weight: bold; margin-top: 10px;">[+] 滲透完成！目標系統已完全被控制</div>`;

                    setTimeout(() => {
                        const panel = document.getElementById('gradual-attack-panel');
                        if (panel) panel.remove();

                        // 完成滲透
                        GameState.hackerAttack.isZombified = true;
                        GameState.hackerAttack.zombieProgress = 100;
                        addTerminalLine('═══════════════════════════════════════', 'success');
                        addTerminalLine('🕷️ 循序漸進攻擊完成！系統已完全被控制', 'success');
                        addTerminalLine('═══════════════════════════���═══════════', 'success');
                        SoundSystem.play('success');
                        triggerDefenderZombie();
                        showNotification('滲透成功', '目標系統已被逐步控制！', 'hacker');

                        if (GameState.isBattleMode) {
                            setTimeout(() => endBattle('win'), 1000);
                        }
                    }, 2000);
                    return;
                }

                step++;
                GameState.hackerAttack.gradualStep = step;
                GameState.hackerAttack.zombieProgress = step * 10;

                const currentStep = steps[step - 1];
                progressBar.style.width = (step * 10) + '%';

                logDiv.innerHTML += `<div style="color: #ff9900; margin-bottom: 5px;">[步驟 ${step}/10] ${currentStep.msg}</div>`;
                logDiv.innerHTML += `<div style="color: #00ff41; margin-bottom: 10px; font-size: 0.85rem;"><i class="fas fa-terminal"></i> ${currentStep.cmd}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;

                addTerminalLine(`[步驟 ${step}/10] ${currentStep.msg}`, 'warning');
                addTerminalLine(`  > ${currentStep.cmd}`, 'response');

                // 發送警報給防禦者
                sendDefenderAlert('gradual', step);

                // 在對戰模式中增加進度
                if (GameState.isBattleMode) {
                    addPlayerBattleProgress(8);
                }

                // 每步隨機偷取一些資金
                if (step % 2 === 0) {
                    const stolenAmount = Math.floor(Math.random() * 5000) + 2000;
                    GameState.hackerAttack.stolenFunds += stolenAmount;
                    GameState.wallet.balance += stolenAmount;
                    updateWalletDisplay();
                    logDiv.innerHTML += `<div style="color: #00ff41;">💰 成功轉移對方資金: +$${stolenAmount.toLocaleString()}</div>`;
                    addTerminalLine(`💰 成功轉移對方資金: +$${stolenAmount.toLocaleString()}`, 'success');
                }
            }, interval);
        }

        // ===== 勒索金攻擊控制台 =====
        function openRansomAttackPanel() {
            closeAttackModePanel();

            const attack = GameState.hackerAttack;
            const panelHTML = `
                <div class="modal-overlay" id="ransom-attack-panel" style="display: flex;">
                    <div class="modal-box" style="max-width: 950px; max-height: 95vh; overflow-y: auto; background: linear-gradient(135deg, rgba(30,15,40,0.98) 0%, rgba(50,25,60,0.98) 100%); border: 2px solid #9b59b6;">
                        <h2 style="color: #9b59b6; margin-bottom: 20px; text-align: center; text-shadow: 0 0 15px rgba(155,89,182,0.5);">
                            <i class="fas fa-lock"></i> 勒索金攻擊控制台
                        </h2>

                        <!-- 目標信息 -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; border: 1px solid #9b59b6; text-align: center;">
                                <div style="color: #888; font-size: 0.85rem;">目標IP</div>
                                <div style="color: #9b59b6; font-size: 1.2rem; font-weight: bold;">${GameState.battle.targetIP}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; border: 1px solid #00ff41; text-align: center;">
                                <div style="color: #888; font-size: 0.85rem;">你的餘額</div>
                                <div style="color: #00ff41; font-size: 1.2rem; font-weight: bold;">$${GameState.wallet.balance.toLocaleString()}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; border: 1px solid #ff3333; text-align: center;">
                                <div style="color: #888; font-size: 0.85rem;">消耗</div>
                                <div style="color: #ff3333; font-size: 1.2rem; font-weight: bold;">$10,000</div>
                            </div>
                        </div>

                        <!-- 勒索配置 -->
                        <div style="background: rgba(0,0,0,0.7); border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid #9b59b6;">
                            <div style="color: #b07cc6; margin-bottom: 15px; font-weight: bold;">
                                <i class="fas fa-edit"></i> 編寫勒索訊息
                            </div>

                            <!-- 勒索金額選擇 -->
                            <div style="margin-bottom: 20px;">
                                <label style="color: #aaa; display: block; margin-bottom: 10px;">選擇勒索金額:</label>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                    <button onclick="selectRansomAmount(1500000)" id="ransom-amt-1" class="ransom-amt-btn" style="background: rgba(155,89,182,0.2); border: 2px solid #9b59b6; padding: 18px; border-radius: 8px; color: #9b59b6; cursor: pointer; transition: all 0.3s;">
                                        <div style="font-size: 1.5rem; font-weight: bold;">$1,500,000</div>
                                        <div style="font-size: 0.85rem; color: #aaa;">基礎勒索</div>
                                    </button>
                                    <button onclick="selectRansomAmount(3500000)" id="ransom-amt-2" class="ransom-amt-btn" style="background: rgba(255,153,0,0.2); border: 2px solid #ff9900; padding: 18px; border-radius: 8px; color: #ff9900; cursor: pointer; transition: all 0.3s;">
                                        <div style="font-size: 1.5rem; font-weight: bold;">$3,500,000</div>
                                        <div style="font-size: 0.85rem; color: #aaa;">進階勒索</div>
                                    </button>
                                    <button onclick="selectRansomAmount(10000000)" id="ransom-amt-3" class="ransom-amt-btn" style="background: rgba(255,51,51,0.2); border: 2px solid #ff3333; padding: 18px; border-radius: 8px; color: #ff3333; cursor: pointer; transition: all 0.3s;">
                                        <div style="font-size: 1.5rem; font-weight: bold;">$10,000,000</div>
                                        <div style="font-size: 0.85rem; color: #aaa;">極致勒索</div>
                                    </button>
                                </div>
                                <div style="margin-top: 10px;">
                                    <label style="color: #aaa; font-size: 0.9rem;">或自訂金額: </label>
                                    <input type="number" id="custom-ransom-amount" style="background: rgba(0,0,0,0.5); border: 1px solid #9b59b6; padding: 8px 12px; border-radius: 4px; color: #9b59b6; width: 180px; font-size: 16px;" placeholder="輸入金額..." min="100000" max="50000000" onchange="selectRansomAmount(parseInt(this.value))">
                                </div>
                            </div>

                            <!-- 勒索期限選擇 -->
                            <div style="margin-bottom: 20px;">
                                <label style="color: #aaa; display: block; margin-bottom: 10px;">設定支付期限:</label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                    <button onclick="selectRansomDeadline(60)" id="deadline-1" class="deadline-btn" style="background: rgba(0,255,65,0.2); border: 1px solid #00ff41; padding: 10px; border-radius: 6px; color: #00ff41; cursor: pointer;">1分鐘</button>
                                    <button onclick="selectRansomDeadline(180)" id="deadline-2" class="deadline-btn" style="background: rgba(255,153,0,0.2); border: 1px solid #ff9900; padding: 10px; border-radius: 6px; color: #ff9900; cursor: pointer;">3分鐘</button>
                                    <button onclick="selectRansomDeadline(300)" id="deadline-3" class="deadline-btn" style="background: rgba(155,89,182,0.2); border: 1px solid #9b59b6; padding: 10px; border-radius: 6px; color: #9b59b6; cursor: pointer;">5分鐘</button>
                                    <button onclick="selectRansomDeadline(600)" id="deadline-4" class="deadline-btn" style="background: rgba(255,51,51,0.2); border: 1px solid #ff3333; padding: 10px; border-radius: 6px; color: #ff3333; cursor: pointer;">10分鐘</button>
                                </div>
                            </div>

                            <!-- 勒索訊息內容 -->
                            <div style="margin-bottom: 15px;">
                                <label style="color: #aaa; display: block; margin-bottom: 8px;">勒索訊息內容:</label>
                                <textarea id="ransom-message-text" style="width: 100%; height: 150px; background: #0a0a0a; border: 1px solid #9b59b6; border-radius: 6px; color: #9b59b6; font-family: 'Courier New', monospace; font-size: 14px; padding: 15px; resize: none;">⚠️ 警告：你的系統已被加密 ⚠️

你的所有文件、數據庫和���份已被我們的加密軟件鎖定。
如果你想恢復訪問權限，必須在限時內支付贖金。

💰 贖金金額: [金額將自動填入]
⏰ 支付期限: [時間將自動填入]

⚠️ 警告：
- 不要嘗試自行解密，���將導致數據永久丟失
- 不要聯繫執法機構，這只會浪費時間
- 支付後，解密密鑰將自動發送

🔐 支付方式: 點擊下方「支付贖金」按鈕

-- HACKER GROUP --</textarea>
                            </div>

                            <!-- 勒索代碼 -->
                            <div style="margin-bottom: 15px;">
                                <label style="color: #aaa; display: block; margin-bottom: 8px;">加密攻擊代碼:</label>
                                <textarea id="ransom-attack-code" style="width: 100%; height: 100px; background: #0a0a0a; border: 1px solid #333; border-radius: 6px; color: #ff3333; font-family: 'Courier New', monospace; font-size: 12px; padding: 12px; resize: none;">#!/bin/bash
# RANSOMWARE DEPLOYMENT
./crypto_locker.py --target ${GameState.battle.targetIP} --algorithm AES-256
find /target -type f -exec ./encrypt.sh {} \\;
./ransom_note_generator.py --template custom</textarea>
                            </div>
                        </div>

                        <!-- 預覽區域 -->
                        <div style="background: rgba(0,0,0,0.7); border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid #ff3333;">
                            <div style="color: #ff3333; margin-bottom: 15px; font-weight: bold;">
                                <i class="fas fa-eye"></i> 防禦者將看到的勒索畫面預覽:
                            </div>
                            <div id="ransom-preview" style="background: linear-gradient(135deg, rgba(50,10,10,0.9) 0%, rgba(80,20,20,0.9) 100%); border: 2px solid #ff3333; border-radius: 10px; padding: 20px; text-align: center;">
                                <i class="fas fa-lock" style="font-size: 4rem; color: #ff3333; margin-bottom: 15px;"></i>
                                <h3 style="color: #ff3333; margin-bottom: 10px;">⚠️ 系統已被加密 ⚠️</h3>
                                <div id="preview-amount" style="color: #00ff41; font-size: 2rem; font-weight: bold; margin: 15px 0;">$1,500,000</div>
                                <div id="preview-deadline" style="color: #ffaa00;">剩餘時間: 5:00</div>
                            </div>
                        </div>

                        <!-- 執行區域 -->
                        <div id="ransom-attack-status" style="background: rgba(0,0,0,0.7); border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid #9b59b6; display: none;">
                            <div style="color: #9b59b6; font-weight: bold; margin-bottom: 10px;"><i class="fas fa-lock"></i> 加密中...</div>
                            <div id="ransom-attack-progress" style="background: rgba(0,0,0,0.5); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 15px;">
                                <div id="ransom-attack-progress-bar" style="background: linear-gradient(90deg, #9b59b6, #b07cc6); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="ransom-attack-log" style="max-height: 150px; overflow-y: auto; font-size: 0.9rem;"></div>
                        </div>

                        <!-- 執行按鈕 -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button onclick="executeRansomAttackFromPanel()" style="background: linear-gradient(135deg, #9b59b6 0%, #6c3483 100%); border: none; padding: 18px 30px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 0 30px rgba(155,89,182,0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                                <i class="fas fa-paper-plane"></i> 發送勒索訊息 ($10,000)
                            </button>
                            <button onclick="closeRansomAttackPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 18px 30px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem;">
                                <i class="fas fa-arrow-left"></i> 返回
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', panelHTML);

            // 初始化預設值
            if (!GameState.hackerAttack.selectedRansomAmount) {
                GameState.hackerAttack.selectedRansomAmount = 1500000;
            }
            if (!GameState.hackerAttack.selectedDeadline) {
                GameState.hackerAttack.selectedDeadline = 300;
            }
            selectRansomAmount(GameState.hackerAttack.selectedRansomAmount);
            selectRansomDeadline(GameState.hackerAttack.selectedDeadline);
            SoundSystem.play('keypress');
        }

        function selectRansomAmount(amount) {
            if (!amount || amount < 100000) amount = 1500000;
            GameState.hackerAttack.selectedRansomAmount = amount;

            // 更新按鈕樣式
            document.querySelectorAll('.ransom-amt-btn').forEach(btn => {
                btn.style.boxShadow = 'none';
                btn.style.transform = 'scale(1)';
            });

            // 根據金額選中對應按鈕
            const btnMap = { 1500000: 'ransom-amt-1', 3500000: 'ransom-amt-2', 10000000: 'ransom-amt-3' };
            const selectedBtn = document.getElementById(btnMap[amount]);
            if (selectedBtn) {
                selectedBtn.style.boxShadow = '0 0 20px currentColor';
                selectedBtn.style.transform = 'scale(1.02)';
            }

            // 更新預覽
            const previewAmount = document.getElementById('preview-amount');
            if (previewAmount) {
                previewAmount.textContent = '$' + amount.toLocaleString();
            }

            SoundSystem.play('keypress');
        }

        function selectRansomDeadline(seconds) {
            GameState.hackerAttack.selectedDeadline = seconds;

            // 更新按鈕樣式
            document.querySelectorAll('.deadline-btn').forEach(btn => {
                btn.style.boxShadow = 'none';
                btn.style.transform = 'scale(1)';
            });

            const btnMap = { 60: 'deadline-1', 180: 'deadline-2', 300: 'deadline-3', 600: 'deadline-4' };
            const selectedBtn = document.getElementById(btnMap[seconds]);
            if (selectedBtn) {
                selectedBtn.style.boxShadow = '0 0 15px currentColor';
                selectedBtn.style.transform = 'scale(1.05)';
            }

            // 更新預覽
            const previewDeadline = document.getElementById('preview-deadline');
            if (previewDeadline) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                previewDeadline.textContent = `剩餘時間: ${mins}:${secs.toString().padStart(2, '0')}`;
            }

            SoundSystem.play('keypress');
        }

        function closeRansomAttackPanel() {
            const panel = document.getElementById('ransom-attack-panel');
            if (panel) panel.remove();
            showAttackModePanel();
        }

        function executeRansomAttackFromPanel() {
            if (GameState.wallet.balance < 10000) {
                addTerminalLine('餘額不足！需要 $10,000 才能執行此攻擊', 'error');
                SoundSystem.play('error');
                return;
            }

            const ransomAmount = GameState.hackerAttack.selectedRansomAmount || 1500000;
            const deadline = GameState.hackerAttack.selectedDeadline || 300;
            const customMessage = document.getElementById('ransom-message-text').value;

            // 扣除費用
            GameState.wallet.balance -= 10000;
            updateWalletDisplay();
            GameState.hackerAttack.mode = 'ransom';
            GameState.hackerAttack.ransomAmount = ransomAmount;
            GameState.hackerAttack.ransomTimeLeft = deadline;

            // 顯示執行狀態
            const statusDiv = document.getElementById('ransom-attack-status');
            const progressBar = document.getElementById('ransom-attack-progress-bar');
            const logDiv = document.getElementById('ransom-attack-log');
            statusDiv.style.display = 'block';

            SoundSystem.play('attack');
            addTerminalLine('=== 啟動勒索軟件攻擊 ===', 'command');
            addTerminalLine(`勒索金額: $${ransomAmount.toLocaleString()}`, 'warning');
            addTerminalLine(`支付期限: ${Math.floor(deadline / 60)}分鐘`, 'warning');

            const encryptStages = [
                { msg: '掃描目標文件系統...', progress: 20 },
                { msg: '注入加密病毒...', progress: 40 },
                { msg: '加密用戶數據...', progress: 60 },
                { msg: '加密數據庫...', progress: 80 },
                { msg: '鎖定系統引導區...', progress: 100 }
            ];

            let stageIndex = 0;

            const encryptInterval = setInterval(() => {
                if (stageIndex >= encryptStages.length) {
                    clearInterval(encryptInterval);

                    logDiv.innerHTML += `<div style="color: #00ff41; font-weight: bold; margin-top: 10px;">[+] 加密完成！正在發送勒索訊息...</div>`;

                    setTimeout(() => {
                        const panel = document.getElementById('ransom-attack-panel');
                        if (panel) panel.remove();

                        // 觸發真正的勒索效果
                        startRansomCountdown(ransomAmount, deadline, customMessage);
                    }, 1500);
                    return;
                }

                const stage = encryptStages[stageIndex];
                progressBar.style.width = stage.progress + '%';
                logDiv.innerHTML += `<div style="color: #9b59b6;">[加密進度 ${stage.progress}%] ${stage.msg}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;
                addTerminalLine(`[加密進度 ${stage.progress}%] ${stage.msg}`, 'response');

                // 發送警報給防禦者
                sendDefenderAlert('encrypt', stage.progress);

                stageIndex++;
            }, 400);
        }

        // 開始勒索倒計時
        function startRansomCountdown(amount, deadline, message) {
            GameState.hackerAttack.ransomAmount = amount;
            GameState.hackerAttack.ransomTimeLeft = deadline;
            GameState.hackerAttack.ransomPaid = false;

            addTerminalLine('═══════════════════════════════════════', 'warning');
            addTerminalLine(`✓ 目標系統已完全加密！`, 'success');
            addTerminalLine(`💎 勒索金額: $${amount.toLocaleString()}`, 'warning');
            addTerminalLine(`⏰ 限時: ${Math.floor(deadline / 60)}分${deadline % 60}秒`, 'warning');
            addTerminalLine('═══════════════════════════════════════', 'warning');

            // 發送勒索訊息給防禦者（模擬顯示）
            sendDefenderAlert('ransom', amount);
            showRansomToDefender(amount, deadline, message);

            showNotification('勒索軟件', `已向目標發送勒索要求: $${amount.toLocaleString()}`, 'hacker');

            // 啟動倒計時
            if (GameState.hackerAttack.ransomTimer) {
                clearInterval(GameState.hackerAttack.ransomTimer);
            }

            GameState.hackerAttack.ransomTimer = setInterval(() => {
                GameState.hackerAttack.ransomTimeLeft--;

                if (GameState.hackerAttack.ransomTimeLeft <= 0) {
                    clearInterval(GameState.hackerAttack.ransomTimer);
                    if (!GameState.hackerAttack.ransomPaid) {
                        addTerminalLine('⏰ 勒索時限已到！', 'error');
                        simulateDefenderRansomDecision(amount, true); // 強制超時處理
                    }
                } else if (GameState.hackerAttack.ransomTimeLeft % 60 === 0) {
                    addTerminalLine(`⏰ 勒索剩餘時間: ${Math.floor(GameState.hackerAttack.ransomTimeLeft / 60)} 分鐘`, 'warning');
                } else if (GameState.hackerAttack.ransomTimeLeft === 30) {
                    addTerminalLine(`⚠️ 警告: 只剩 30 秒！`, 'alert');
                    SoundSystem.play('alert');
                }
            }, 1000);
        }

        // 向防禦者顯示勒索畫面（模擬）
        function showRansomToDefender(amount, deadline, message) {
            // 模擬防禦者收到勒索訊息後的反應（3-8秒後做決定）
            const decisionTime = Math.floor(Math.random() * 5000) + 3000;

            addTerminalLine('📨 勒索訊息已發送給目標...', 'system');
            addTerminalLine('⏳ 等待目標回應...', 'system');

            setTimeout(() => {
                simulateDefenderRansomDecision(amount, false);
            }, decisionTime);
        }

        // 模擬防禦者對勒索的決定
        function simulateDefenderRansomDecision(amount, timeout) {
            if (GameState.hackerAttack.ransomPaid) return; // 已經處理過

            // 模擬防禦者決定（70%機率支付，30%機率拒絕）
            // 金額越高，支付機率越低
            let payChance = 0.7;
            if (amount >= 10000000) payChance = 0.3;
            else if (amount >= 3500000) payChance = 0.5;

            const willPay = !timeout && Math.random() < payChance;

            if (willPay) {
                // 防禦者支付贖金
                GameState.hackerAttack.ransomPaid = true;
                GameState.hackerAttack.stolenFunds += amount;
                GameState.wallet.balance += amount;
                updateWalletDisplay();

                if (GameState.hackerAttack.ransomTimer) {
                    clearInterval(GameState.hackerAttack.ransomTimer);
                }

                addTerminalLine('═══════════════════════════════════════', 'success');
                addTerminalLine('💰 防禦者已支付贖金！', 'success');
                addTerminalLine(`💎 收到: $${amount.toLocaleString()}`, 'success');
                addTerminalLine('═══════════════════════════════════════', 'success');
                SoundSystem.play('success');

                showNotification('贖金到賬', `防禦者已支付 $${amount.toLocaleString()}！`, 'hacker');
                addAttackLog(`[勒索成功] 收到贖金: $${amount.toLocaleString()}`);

                // 在對戰模式中獲得額外進度
                if (GameState.isBattleMode) {
                    addPlayerBattleProgress(30);
                }
            } else {
                // 防禦者拒絕支付
                addTerminalLine('═══════════════════════════════════════', 'alert');
                addTerminalLine('❌ 防禦者拒絕支付贖金！', 'alert');
                addTerminalLine('💀 正在執行懲罰措施...', 'warning');
                addTerminalLine('════════════════════════���══════════════', 'alert');

                if (GameState.hackerAttack.ransomTimer) {
                    clearInterval(GameState.hackerAttack.ransomTimer);
                }

                showNotification('拒絕支付', '防禦者拒絕支付贖金！正在執行殭屍化...', 'hacker');

                // 開始殭屍化攻擊作為懲罰
                setTimeout(() => {
                    addTerminalLine('🔥 啟動懲罰性殭屍化攻擊！', 'command');
                    executeDirectAttackPunishment();
                }, 1500);
            }
        }

        // 懲罰性殭屍化攻擊（不收費，因為對方沒付贖金）
        function executeDirectAttackPunishment() {
            SoundSystem.play('attack');

            let progress = 0;
            const attackInterval = setInterval(() => {
                progress += 15;
                GameState.hackerAttack.zombieProgress = Math.min(100, progress);

                addTerminalLine(`[懲罰殭屍化 ${Math.min(100, progress)}%] 摧毀目標系統...`, progress < 100 ? 'warning' : 'success');

                if (progress >= 100) {
                    clearInterval(attackInterval);
                    GameState.hackerAttack.isZombified = true;

                    addTerminalLine('═══════════════════════════════════════', 'success');
                    addTerminalLine('💀 目標系統已完全摧毀！', 'success');
                    addTerminalLine('═══════════════════════════════════════', 'success');
                    SoundSystem.play('success');

                    triggerDefenderZombie();

                    if (GameState.isBattleMode) {
                        setTimeout(() => endBattle('win'), 1000);
                    }
                }
            }, 200);
        }

        function selectAttackMode(mode) {
            // 此函數現在僅用於向後兼容
            if (mode === 'direct') {
                openDirectAttackPanel();
            } else if (mode === 'gradual') {
                openGradualAttackPanel();
            } else if (mode === 'ransom') {
                openRansomAttackPanel();
            }
        }

        // 直接執行攻擊 - 立即殭屍化
        function executeDirectAttack() {
            addTerminalLine('=== 啟動直接殭屍化攻擊 ===', 'command');
            addTerminalLine('💀 警告：此攻擊將立即封殺對方所有系統！', 'alert');
            SoundSystem.play('attack');

            // 計算攻擊速度（根據升級加成）
            const zombieBonus = GameState.hackerUpgrades?.zombieBonus || 0;
            const baseSpeed = 300;
            const attackSpeed = Math.max(100, baseSpeed - (zombieBonus * 2));

            let progress = 0;
            const attackInterval = setInterval(() => {
                progress += 10;
                GameState.hackerAttack.zombieProgress = progress;

                // 在對戰模式中增加玩家進度
                if (GameState.isBattleMode) {
                    addPlayerBattleProgress(10);
                }

                const statusMessages = [
                    '滲透系統核心...',
                    '植入控制程序...',
                    '接管網絡服務...',
                    '禁用防火牆...',
                    '鎖定管理權限...',
                    '擴展控制範圍...',
                    '封鎖防禦通道...',
                    '接管數據庫...',
                    '關閉安全系統...',
                    '完全控制！'
                ];

                const statusIdx = Math.min(Math.floor(progress / 10) - 1, 9);
                addTerminalLine(`[殭屍化 ${progress}%] ${statusMessages[statusIdx]}`, progress < 100 ? 'warning' : 'success');
                addAttackLog(`[攻擊] 殭屍化進度: ${progress}%`);

                // 發送警報給防禦者（模擬）
                sendDefenderAlert('zombie', progress);

                if (progress >= 100) {
                    clearInterval(attackInterval);
                    GameState.hackerAttack.isZombified = true;
                    GameState.hackerAttack.mode = 'direct';

                    addTerminalLine('═══════════════════════════════════════', 'success');
                    addTerminalLine('💀 目標系統已完全殭屍化！', 'success');
                    addTerminalLine('⛔ 對方防禦者已無法進行任何操作', 'success');
                    addTerminalLine('═══════════════════════════════════════', 'success');
                    SoundSystem.play('success');

                    // 觸發防禦者的殭屍化效果
                    triggerDefenderZombie();

                    // 在對戰模式中直接獲勝
                    if (GameState.isBattleMode) {
                        setTimeout(() => {
                            endBattle('win');
                        }, 1000);
                    }

                    showNotification('攻擊成功', '目標系統已被完全殭屍化控制！', 'hacker');
                }
            }, attackSpeed);
        }

        // 發送防禦者警報（模擬對方收到通知）
        function sendDefenderAlert(type, data) {
            const alertMessage = {
                from: 'hacker',
                type: type,
                data: data,
                time: Date.now()
            };

            GameState.battle.sharedMessages.push(alertMessage);

            // 模擬防禦者收到警報的回應
            if (type === 'zombie' && data % 30 === 0) {
                setTimeout(() => {
                    addTerminalLine(`[偵測] 目標系統嘗試反擊... (已被阻擋)`, 'response');
                }, 500);
            }
        }

        // 循序漸進攻擊
        function executeGradualAttack() {
            addTerminalLine('=== 啟動循序漸進滲透攻擊 ===', 'command');
            addTerminalLine('🕷️ 慢慢滲透，逐步封殺目標系統...', 'system');
            SoundSystem.play('attack');

            GameState.hackerAttack.mode = 'gradual';

            const steps = [
                { msg: '正在掃描目標漏洞...', effect: '發現3個潛在漏洞' },
                { msg: '發現開放端口，嘗試連接...', effect: '成功連接端口 22, 80, 443' },
                { msg: '繞過初級防火牆...', effect: '防火牆規則已修改' },
                { msg: '植入後門程序...', effect: 'Backdoor.exe 已植入' },
                { msg: '獲取低級權限...', effect: 'User級別權限已取得' },
                { msg: '提升權限等級...', effect: 'Admin權限已取得' },
                { msg: '關閉部分防禦系統...', effect: '殺毒軟件已禁用' },
                { msg: '擴展殭屍網絡節點...', effect: '+5000 殭屍節點' },
                { msg: '接管核心服務...', effect: '資料庫服務已接管' },
                { msg: '完全控制系統！', effect: 'Root權限已取得' }
            ];

            // 計算速度（根據升級加成）
            const zombieBonus = GameState.hackerUpgrades?.zombieBonus || 0;
            const baseInterval = 4000;
            const interval = Math.max(2000, baseInterval - (zombieBonus * 50));

            let step = GameState.hackerAttack.gradualStep;

            const gradualInterval = setInterval(() => {
                if (step >= 10) {
                    clearInterval(gradualInterval);
                    GameState.hackerAttack.isZombified = true;
                    GameState.hackerAttack.zombieProgress = 100;

                    addTerminalLine('═══════���═══════════════════════════════', 'success');
                    addTerminalLine('🕷️ 循序漸進攻擊完成！系統已完全被控制', 'success');
                    addTerminalLine('═══════════════════════════════════════', 'success');
                    SoundSystem.play('success');

                    triggerDefenderZombie();

                    // 在對戰模式中獲勝
                    if (GameState.isBattleMode) {
                        setTimeout(() => {
                            endBattle('win');
                        }, 1000);
                    }

                    showNotification('滲透成功', '目標系統已被逐步控制！', 'hacker');
                    return;
                }

                step++;
                GameState.hackerAttack.gradualStep = step;
                GameState.hackerAttack.zombieProgress = step * 10;

                addTerminalLine(`[步驟 ${step}/10] ${steps[step - 1].msg}`, 'warning');
                addTerminalLine(`  ➜ ${steps[step - 1].effect}`, 'response');
                addAttackLog(`[滲透] 第${step}步完成`);

                // 發送警報給防禦者
                sendDefenderAlert('gradual', step);

                // 在對戰模式中增加進度
                if (GameState.isBattleMode) {
                    addPlayerBattleProgress(8);
                }

                // 每步隨機偷取一些資金
                const baseStolen = Math.floor(Math.random() * 5000) + 1000;
                const stolenAmount = Math.floor(baseStolen * (1 + step * 0.1));
                GameState.hackerAttack.stolenFunds += stolenAmount;

                if (step % 2 === 0) {
                    addTerminalLine(`💰 成功轉移對方資金: +$${stolenAmount.toLocaleString()}`, 'success');
                    GameState.wallet.balance += stolenAmount;
                    updateWalletDisplay();
                }
            }, interval);

            addTerminalLine(`滲透程序已啟動，每${interval/1000}秒執行一步...`, 'system');
        }

        // 勒索金攻擊
        function executeRansomAttack() {
            // 基礎勒索金額: $1,500,000 / $3,500,000 / $10,000,000
            const baseRansomAmounts = [1500000, 3500000, 10000000];
            let randomAmount = baseRansomAmounts[Math.floor(Math.random() * baseRansomAmounts.length)];

            // 應用勒索倍增器升級
            const ransomMultiplier = GameState.hackerUpgrades?.ransomMultiplier || 1;
            randomAmount = Math.floor(randomAmount * ransomMultiplier);

            GameState.hackerAttack.ransomAmount = randomAmount;
            GameState.hackerAttack.ransomTimeLeft = 300; // 5分鐘
            GameState.hackerAttack.mode = 'ransom';

            addTerminalLine('=== 啟動勒索軟件攻擊 ===', 'command');
            addTerminalLine(`🔐 正在加密目標系統所有文件...`, 'warning');

            // 顯示勒索金額範圍
            const amountLabels = {
                1500000: '基礎勒索 (150萬)',
                3500000: '進階勒索 (350萬)',
                10000000: '極致勒索 (1000萬)'
            };
            const baseAmount = baseRansomAmounts.find(a => Math.floor(a * ransomMultiplier) === randomAmount) || baseRansomAmounts[0];
            addTerminalLine(`📊 勒索類型: ${amountLabels[baseAmount] || '自定義金額'}`, 'system');

            // 加密動畫
            let encryptProgress = 0;
            const encryptInterval = setInterval(() => {
                encryptProgress += 20;

                const encryptStages = [
                    '掃描文件系統...',
                    '注入加密病毒...',
                    '加密用戶數據...',
                    '加密數據庫...',
                    '鎖定系統引導...'
                ];
                const stageIdx = Math.floor(encryptProgress / 20) - 1;

                addTerminalLine(`[加密進度] ${encryptProgress}% - ${encryptStages[stageIdx]}`, 'response');

                // 發送加密警報給防禦者
                sendDefenderAlert('encrypt', encryptProgress);

                // 在對戰模式中增加進度
                if (GameState.isBattleMode) {
                    addPlayerBattleProgress(5);
                }

                if (encryptProgress >= 100) {
                    clearInterval(encryptInterval);

                    addTerminalLine('═══════════════════════════════════════', 'warning');
                    addTerminalLine(`✓ 目標系統已完全加密！`, 'success');
                    addTerminalLine(`💎 勒索金額已設定: $${randomAmount.toLocaleString()}`, 'warning');
                    addTerminalLine(`⏰ 限時: 5 分鐘`, 'warning');
                    addTerminalLine('═══════════════════════════════════════', 'warning');

                    if (ransomMultiplier > 1) {
                        addTerminalLine(`🔐 勒索倍增器生效: x${ransomMultiplier}`, 'success');
                    }
                    SoundSystem.play('attack');

                    // 發送勒索訊息給防禦者
                    sendRansomMessage(randomAmount);
                    sendDefenderAlert('ransom', randomAmount);

                    showNotification('勒索軟件', `已向目標發送勒索要求: $${randomAmount.toLocaleString()}`, 'hacker');
                }
            }, 400);

            // 啟動倒計時
            if (GameState.hackerAttack.ransomTimer) {
                clearInterval(GameState.hackerAttack.ransomTimer);
            }

            GameState.hackerAttack.ransomTimer = setInterval(() => {
                GameState.hackerAttack.ransomTimeLeft--;

                // 更新倒計時顯示
                const countdownEl = document.getElementById('ransom-countdown');
                if (countdownEl) {
                    const mins = Math.floor(GameState.hackerAttack.ransomTimeLeft / 60);
                    const secs = GameState.hackerAttack.ransomTimeLeft % 60;
                    countdownEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                }

                if (GameState.hackerAttack.ransomTimeLeft <= 0) {
                    clearInterval(GameState.hackerAttack.ransomTimer);
                    if (!GameState.hackerAttack.ransomPaid) {
                        addTerminalLine('⏰ 勒索時限已到！開始銷毀目標數據...', 'error');
                        addTerminalLine('💀 目標拒絕支付，啟動系統殭屍化...', 'warning');
                        sendDefenderAlert('ransom_timeout', 0);
                        executeDirectAttack(); // 時間到自動殭屍化
                    }
                } else if (GameState.hackerAttack.ransomTimeLeft % 60 === 0) {
                    addTerminalLine(`⏰ 勒索剩餘時間: ${Math.floor(GameState.hackerAttack.ransomTimeLeft / 60)} 分鐘`, 'warning');
                } else if (GameState.hackerAttack.ransomTimeLeft === 30) {
                    addTerminalLine(`⚠️ 警告: 只剩 30 秒！`, 'alert');
                    SoundSystem.play('alert');
                }
            }, 1000);
        }

        // 發送勒索訊息給防禦者 (模擬)
        function sendRansomMessage(amount) {
            // 這會在防禦者介面顯示勒索提示
            if (GameState.currentMode === 'defender') {
                showRansomAlert(amount);
            } else {
                addAttackLog(`[勒索] 已發送勒索要求: $${amount.toLocaleString()}`);
            }
        }

        // 防禦者收到勒索提示
        function showRansomAlert(amount) {
            const alertHTML = `
                <div class="modal-overlay" id="ransom-alert-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 600px; background: linear-gradient(135deg, rgba(50,10,10,0.98) 0%, rgba(80,20,20,0.98) 100%); border: 3px solid #ff3333; animation: ransomPulse 1s infinite;">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-lock" style="font-size: 5rem; color: #ff3333; margin-bottom: 20px;"></i>
                            <h2 style="color: #ff3333; margin-bottom: 20px; font-size: 2rem;">⚠️ 系統已被加密 ⚠️</h2>

                            <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <p style="color: #fff; font-size: 1.1rem; line-height: 1.8;">
                                    你的所有文件已被加密。<br>
                                    如需解密，請在限時內支付以下勒索金：
                                </p>
                                <div style="color: #00ff41; font-size: 3rem; font-weight: bold; margin: 20px 0; text-shadow: 0 0 20px rgba(0,255,65,0.5);">
                                    $${amount.toLocaleString()}
                                </div>
                                <p style="color: #ff6666;">
                                    剩餘時間: <span id="ransom-countdown" style="color: #ffaa00; font-weight: bold;">5:00</span>
                                </p>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <button onclick="payRansom(${amount})" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border: none; padding: 15px 25px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem; font-weight: bold;">
                                    <i class="fas fa-money-bill-wave"></i> 支付勒索金
                                </button>
                                <button onclick="closeRansomAlert()" style="background: linear-gradient(135deg, #c0392b 0%, #922b21 100%); border: none; padding: 15px 25px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem; font-weight: bold;">
                                    <i class="fas fa-times"></i> 拒絕支付
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes ransomPulse {
                        0%, 100% { box-shadow: 0 0 30px rgba(255,51,51,0.5); }
                        50% { box-shadow: 0 0 60px rgba(255,51,51,0.8); }
                    }
                </style>
            `;

            document.body.insertAdjacentHTML('beforeend', alertHTML);
            SoundSystem.play('alert');
        }

        function payRansom(amount) {
            if (GameState.wallet.balance < amount) {
                addTerminalLine('餘額不足，無法支付勒索金！', 'error');
                SoundSystem.play('error');
                // 顯示餘額不足選項
                showInsufficientFundsModal(amount);
                return;
            }

            GameState.wallet.balance -= amount;
            GameState.hackerAttack.ransomPaid = true;
            GameState.hackerAttack.ransomReceived = amount;

            // 黑客收到勒索金 - 直接加入黑客錢包餘額
            GameState.hackerAttack.stolenFunds += amount;

            // 如果是對戰模式，更新雙方畫面
            if (GameState.isBattleMode) {
                updateBothDeviceScreens('ransom_paid', amount);
            }

            addTerminalLine(`已支付勒索金: $${amount.toLocaleString()}`, 'warning');
            addTerminalLine('系統已解鎖，但數據可能已被竊取', 'system');

            // 清除勒索計時器
            if (GameState.hackerAttack.ransomTimer) {
                clearInterval(GameState.hackerAttack.ransomTimer);
                GameState.hackerAttack.ransomTimer = null;
            }

            closeRansomAlert();
            SoundSystem.play('success');

            // 更新錢包顯示
            updateWalletDisplay();

            // 通知黑客端收到勒索金
            notifyHackerRansomReceived(amount);
        }

        // 顯示餘額不足選項
        function showInsufficientFundsModal(amount) {
            const shortage = amount - GameState.wallet.balance;
            const modalHTML = `
                <div class="modal-overlay" id="insufficient-funds-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 500px; background: linear-gradient(135deg, rgba(50,30,10,0.98) 0%, rgba(80,40,15,0.98) 100%); border: 2px solid #ff9900;">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #ff9900; margin-bottom: 20px;"></i>
                            <h2 style="color: #ff9900; margin-bottom: 15px;">餘額不足</h2>
                            <p style="color: #fff; margin-bottom: 10px;">你的餘額: <span style="color: #ff3333;">$${GameState.wallet.balance.toLocaleString()}</span></p>
                            <p style="color: #fff; margin-bottom: 10px;">需要金額: <span style="color: #00ff41;">$${amount.toLocaleString()}</span></p>
                            <p style="color: #ff9900; margin-bottom: 20px;">差額: <span style="color: #ff3333;">$${shortage.toLocaleString()}</span></p>

                            <div style="display: grid; gap: 10px;">
                                <button onclick="closeInsufficientFundsModal(); showTopUp();" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border: none; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                    <i class="fas fa-credit-card"></i> 立即充值
                                </button>
                                <button onclick="requestExtension(${amount})" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                    <i class="fas fa-clock"></i> 請求延長時間
                                </button>
                                <button onclick="closeInsufficientFundsModal();" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer;">
                                    <i class="fas fa-times"></i> 返回
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeInsufficientFundsModal() {
            const modal = document.getElementById('insufficient-funds-modal');
            if (modal) modal.remove();
        }

        // 請求延長時間 (會觸發黑客升級攻擊)
        function requestExtension(amount) {
            closeInsufficientFundsModal();
            addTerminalLine('📨 已向黑客發送延長時間請求...', 'system');

            // 模擬黑客反應 (70%拒絕, 30%接受但增加金額)
            setTimeout(() => {
                const accepted = Math.random() < 0.3;
                if (accepted) {
                    const newAmount = Math.floor(amount * 1.5);
                    GameState.hackerAttack.ransomAmount = newAmount;
                    GameState.hackerAttack.ransomTimeLeft = 180; // 額外3分鐘
                    addTerminalLine(`⚠️ 黑客接受延長！但勒索金已增加至: $${newAmount.toLocaleString()}`, 'warning');
                    addTerminalLine('⏰ 你有額外3分鐘時間', 'system');
                    showRansomAlert(newAmount);
                } else {
                    addTerminalLine('❌ 黑客拒絕了你的請求！', 'error');
                    addTerminalLine('⚠️ 黑客正在準備升級攻擊...', 'alert');
                    triggerEscalatedAttack();
                }
            }, 2000);
        }

        // 觸發升級攻擊 (當防禦者拒絕或無法支付時)
        function triggerEscalatedAttack() {
            SoundSystem.play('alert');

            const ultimatumHTML = `
                <div class="modal-overlay" id="escalation-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 700px; background: linear-gradient(135deg, rgba(80,10,10,0.98) 0%, rgba(120,15,15,0.98) 100%); border: 3px solid #ff0000; animation: escalationPulse 0.5s infinite;">
                        <div style="text-align: center; padding: 25px;">
                            <i class="fas fa-skull-crossbones" style="font-size: 5rem; color: #ff0000; margin-bottom: 20px; animation: shake 0.5s infinite;"></i>
                            <h2 style="color: #ff0000; margin-bottom: 20px; font-size: 2.5rem; text-shadow: 0 0 20px rgba(255,0,0,0.8);">⚠️ 最後通牒 ⚠️</h2>

                            <div style="background: rgba(0,0,0,0.6); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ff3333;">
                                <p style="color: #ff6666; font-size: 1.2rem; line-height: 1.8; margin-bottom: 15px;">
                                    你拒絕支付勒索金的行為已觸發升級攻擊程序！
                                </p>
                                <p style="color: #fff; font-size: 1.1rem; line-height: 1.6;">
                                    🔥 階段1: 數據加密已完成<br>
                                    💀 階段2: 系統殭屍化程序啟動中<br>
                                    ☠️ 階段3: 永久數據銷毀倒計時
                                </p>
                                <div style="margin-top: 15px; padding: 10px; background: rgba(255,0,0,0.2); border-radius: 6px;">
                                    <span style="color: #ff3333; font-size: 1.5rem; font-weight: bold;">
                                        剩餘時間: <span id="escalation-countdown" style="color: #ffaa00;">60</span> 秒
                                    </span>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <button onclick="emergencyPayment()" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border: none; padding: 15px 25px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem; font-weight: bold;">
                                    <i class="fas fa-money-bill-wave"></i> 緊急支付 (全部餘額)
                                </button>
                                <button onclick="acceptZombification()" style="background: linear-gradient(135deg, #7f8c8d 0%, #5f6a6a 100%); border: none; padding: 15px 25px; border-radius: 8px; color: #fff; cursor: pointer; font-size: 1.1rem;">
                                    <i class="fas fa-flag-checkered"></i> 放棄抵抗
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes escalationPulse {
                        0%, 100% { box-shadow: 0 0 30px rgba(255,0,0,0.6); }
                        50% { box-shadow: 0 0 60px rgba(255,0,0,1); }
                    }
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        25% { transform: translateX(-5px); }
                        75% { transform: translateX(5px); }
                    }
                </style>
            `;
            document.body.insertAdjacentHTML('beforeend', ultimatumHTML);
            closeRansomAlert();

            // 開始升級攻擊倒計時
            let countdown = 60;
            const escalationInterval = setInterval(() => {
                countdown--;
                const countdownEl = document.getElementById('escalation-countdown');
                if (countdownEl) {
                    countdownEl.textContent = countdown;
                    if (countdown <= 10) {
                        countdownEl.style.color = '#ff0000';
                    }
                }

                if (countdown <= 0) {
                    clearInterval(escalationInterval);
                    closeEscalationModal();
                    executeFullZombification();
                }
            }, 1000);

            GameState.hackerAttack.escalationTimer = escalationInterval;
        }

        // 緊急支付 (用全部餘額)
        function emergencyPayment() {
            const available = GameState.wallet.balance;
            if (available <= 0) {
                addTerminalLine('沒有可用資金！', 'error');
                return;
            }

            GameState.wallet.balance = 0;
            GameState.hackerAttack.ransomPaid = true;
            GameState.hackerAttack.ransomReceived = available;
            GameState.hackerAttack.stolenFunds += available;

            // 清除升級攻擊計時器
            if (GameState.hackerAttack.escalationTimer) {
                clearInterval(GameState.hackerAttack.escalationTimer);
            }

            closeEscalationModal();
            updateWalletDisplay();

            addTerminalLine(`💸 緊急支付完成: $${available.toLocaleString()}`, 'warning');
            addTerminalLine('系統已部分解鎖，但損害已造成', 'system');

            notifyHackerRansomReceived(available);
            SoundSystem.play('success');
        }

        // 放棄抵抗
        function acceptZombification() {
            if (GameState.hackerAttack.escalationTimer) {
                clearInterval(GameState.hackerAttack.escalationTimer);
            }
            closeEscalationModal();
            addTerminalLine('🏳️ 你選擇放棄抵抗...', 'system');
            executeFullZombification();
        }

        // 完全殭屍化
        function executeFullZombification() {
            addTerminalLine('═══════════════════════════════════════', 'error');
            addTerminalLine('💀 系統正在被完全殭屍化...', 'alert');

            let progress = 0;
            const zombieInterval = setInterval(() => {
                progress += 10;
                GameState.hackerAttack.zombieProgress = progress;
                addTerminalLine(`[殭屍化] ${progress}% - ${progress < 30 ? '注入控制程序...' : progress < 60 ? '接管系統服務...' : progress < 90 ? '禁用所有防禦...' : '完成控制！'}`, 'warning');

                updateDeviceScreen('defender', `殭屍化進度: ${progress}%`);

                if (progress >= 100) {
                    clearInterval(zombieInterval);
                    GameState.hackerAttack.isZombified = true;
                    triggerDefenderZombie();

                    addTerminalLine('═══════════════════════════════════════', 'error');
                    addTerminalLine('☠️ 系統已完全被黑客控制！', 'alert');
                    addTerminalLine('═══════════════════════════════════════', 'error');

                    if (GameState.isBattleMode) {
                        setTimeout(() => endBattle('lose'), 1000);
                    }
                }
            }, 300);
        }

        function closeEscalationModal() {
            const modal = document.getElementById('escalation-modal');
            if (modal) modal.remove();
        }

        // 通知黑客收到勒索金
        function notifyHackerRansomReceived(amount) {
            // 在黑客模式下顯示收款通知
            if (GameState.currentMode === 'hacker') {
                showNotification('勒索成功', `收到勒索金: $${amount.toLocaleString()}`, 'hacker');
                addTerminalLine(`💰 [收款] 防禦者已支付勒索金: $${amount.toLocaleString()}`, 'success');
                addTerminalLine(`💎 資金已轉入你的帳戶！`, 'success');
            }

            // 更新黑客課金面板數據
            GameState.hackerAttack.ransomReceived = amount;
        }

        function closeRansomAlert() {
            const modal = document.getElementById('ransom-alert-modal');
            if (modal) modal.remove();
        }

        // ===== 談判對話系統 =====
        // 對話歷史記錄
        GameState.negotiation = {
            messages: [],
            isOpen: false,
            ransomOffer: 0,
            counterOffer: 0,
            negotiationRounds: 0,
            maxRounds: 5,
            aiPersonality: 'balanced' // aggressive, defensive, balanced
        };

        // 顯示談判對話面板
        function showNegotiationPanel() {
            const mode = GameState.currentMode;
            const isHacker = mode === 'hacker';
            const opponent = isHacker ? '防禦者' : '黑客';
            const color = isHacker ? '#00ff41' : '#ff3333';

            // 初始化談判
            if (!GameState.negotiation.isOpen) {
                GameState.negotiation.isOpen = true;
                GameState.negotiation.messages = [];
                GameState.negotiation.negotiationRounds = 0;
                GameState.negotiation.ransomOffer = GameState.hackerAttack.ransomAmount || 50000;

                // AI 開場白
                if (isHacker) {
                    addNegotiationMessage('system', '📡 正在建立加密通訊頻道...');
                    setTimeout(() => {
                        addNegotiationMessage('opponent', '你好，我是被你���擊的系統管理員。我想和你談談關於勒索金的事情。');
                    }, 1000);
                } else {
                    addNegotiationMessage('system', '📡 收到來自黑客的加密通訊請求...');
                    setTimeout(() => {
                        addNegotiationMessage('opponent', '我知道你在找我。你的系統已經在我的控制之下。讓我們談談條件吧。');
                    }, 1000);
                }
            }

            const panelHTML = `
                <div class="modal-overlay" id="negotiation-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 800px; max-height: 90vh; overflow: hidden; background: linear-gradient(135deg, rgba(20,20,30,0.98) 0%, rgba(30,30,50,0.98) 100%); border: 2px solid ${color}; display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <h2 style="color: ${color}; margin: 0; text-align: center; text-shadow: 0 0 10px ${color}40;">
                                <i class="fas fa-comments"></i> 加密通訊頻道 - 談判中
                            </h2>
                            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px; font-size: 0.85rem;">
                                <span style="color: #888;">對方: <span style="color: ${isHacker ? '#ff3333' : '#00ff41'};">${opponent} (AI)</span></span>
                                <span style="color: #888;">談判回合: <span style="color: #ffaa00;">${GameState.negotiation.negotiationRounds}/${GameState.negotiation.maxRounds}</span></span>
                                <span style="color: #888;">當前報價: <span style="color: #00ff41;">$${GameState.negotiation.ransomOffer.toLocaleString()}</span></span>
                            </div>
                        </div>

                        <!-- 對話區域 -->
                        <div id="negotiation-messages" style="flex: 1; overflow-y: auto; padding: 20px; min-height: 300px; max-height: 400px;">
                            ${GameState.negotiation.messages.map(msg => generateMessageHTML(msg)).join('')}
                        </div>

                        <!-- 快速回應選項 -->
                        <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3);">
                            <div style="margin-bottom: 10px; color: #888; font-size: 0.85rem;">快速回應:</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 15px;">
                                ${isHacker ? `
                                    <button onclick="sendNegotiationResponse('demand')" style="background: rgba(255,51,51,0.2); border: 1px solid #ff3333; padding: 10px; border-radius: 6px; color: #ff3333; cursor: pointer; font-size: 0.85rem;">
                                        <i class="fas fa-hand-holding-usd"></i> 要求支付 $${GameState.negotiation.ransomOffer.toLocaleString()}
                                    </button>
                                    <button onclick="sendNegotiationResponse('increase')" style="background: rgba(255,153,0,0.2); border: 1px solid #ff9900; padding: 10px; border-radius: 6px; color: #ff9900; cursor: pointer; font-size: 0.85rem;">
                                        <i class="fas fa-arrow-up"></i> 提高勒索金額
                                    </button>
                                    <button onclick="sendNegotiationResponse('threaten')" style="background: rgba(231,76,60,0.2); border: 1px solid #e74c3c; padding: 10px; border-radius: 6px; color: #e74c3c; cursor: pointer; font-size: 0.85rem;">
                                        <i class="fas fa-skull"></i> 威脅對方
                                    </button>
                                    <button onclick="sendNegotiationResponse('negotiate')" style="background: rgba(52,152,219,0.2); border: 1px solid #3498db; padding: 10px; border-radius: 6px; color: #3498db; cursor: pointer; font-size: 0.85rem;">
                                        <i class="fas fa-handshake"></i> 考慮還價
                                    </button>
                                ` : `
                                    <button onclick="sendNegotiationResponse('ask_price')" style="background: rgba(52,152,219,0.2); border: 1px solid #3498db; padding: 10px; border-radius: 6px; color: #3498db; cursor: pointer; font-size: 0.85rem;">
                                        <i class="fas fa-question-circle"></i> 詢問勒索金額
                                    </button>
                                    <button onclick="sendNegotiationResponse('counter_offer')" style="background: rgba(39,174,96,0.2); border: 1px solid #27ae60; padding: 10px; border-radius: 6px; color: #27ae60; cursor: pointer; font-size: 0.85rem;">
                                        <i class="fas fa-comments-dollar"></i> 提出還價
                                    </button>
                                    <button onclick="sendNegotiationResponse('ask_guarantee')" style="background: rgba(155,89,182,0.2); border: 1px solid #9b59b6; padding: 10px; border-radius: 6px; color: #9b59b6; cursor: pointer; font-size: 0.85rem;">
                                        <i class="fas fa-shield-alt"></i> 要求保證
                                    </button>
                                    <button onclick="sendNegotiationResponse('refuse')" style="background: rgba(231,76,60,0.2); border: 1px solid #e74c3c; padding: 10px; border-radius: 6px; color: #e74c3c; cursor: pointer; font-size: 0.85rem;">
                                        <i class="fas fa-times"></i> 拒絕支付
                                    </button>
                                `}
                            </div>

                            <!-- 自定義訊息輸入 -->
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="negotiation-input" placeholder="輸入你的訊息..." style="flex: 1; background: rgba(0,0,0,0.5); border: 1px solid #444; padding: 12px 15px; border-radius: 6px; color: #fff; font-size: 16px; outline: none;" onkeypress="if(event.key==='Enter')sendCustomNegotiationMessage()">
                                <button onclick="sendCustomNegotiationMessage()" style="background: linear-gradient(135deg, ${color} 0%, ${isHacker ? '#00aa2a' : '#aa0000'} 100%); border: none; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                    <i class="fas fa-paper-plane"></i> 發送
                                </button>
                            </div>
                        </div>

                        <!-- 操作按鈕 -->
                        <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between;">
                            <div style="display: flex; gap: 10px;">
                                ${!isHacker ? `
                                    <button onclick="acceptNegotiatedDeal()" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border: none; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                        <i class="fas fa-check"></i> 接受條件並支付
                                    </button>
                                ` : `
                                    <button onclick="finalizeRansomDemand()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                        <i class="fas fa-gavel"></i> 確認勒索要求
                                    </button>
                                `}
                            </div>
                            <button onclick="closeNegotiationPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 20px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉對話
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', panelHTML);
            scrollNegotiationToBottom();
        }

        function generateMessageHTML(msg) {
            const alignClass = msg.sender === 'player' ? 'flex-end' : msg.sender === 'system' ? 'center' : 'flex-start';
            const bgColor = msg.sender === 'player' ? 'rgba(0,255,65,0.2)' : msg.sender === 'system' ? 'rgba(100,100,100,0.3)' : 'rgba(255,51,51,0.2)';
            const borderColor = msg.sender === 'player' ? '#00ff41' : msg.sender === 'system' ? '#666' : '#ff3333';
            const icon = msg.sender === 'player' ? 'fa-user' : msg.sender === 'system' ? 'fa-cog' : 'fa-user-secret';
            const label = msg.sender === 'player' ? '你' : msg.sender === 'system' ? '系統' : '對方';

            if (msg.sender === 'system') {
                return `
                    <div style="display: flex; justify-content: center; margin: 10px 0;">
                        <div style="background: ${bgColor}; padding: 8px 15px; border-radius: 15px; color: #888; font-size: 0.8rem;">
                            ${msg.content}
                        </div>
                    </div>
                `;
            }

            return `
                <div style="display: flex; justify-content: ${alignClass}; margin: 10px 0;">
                    <div style="max-width: 70%; background: ${bgColor}; border: 1px solid ${borderColor}; padding: 12px 15px; border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 0.75rem; color: #888;">
                            <i class="fas ${icon}"></i>
                            <span>${label}</span>
                            <span style="margin-left: auto;">${msg.time}</span>
                        </div>
                        <div style="color: #fff; line-height: 1.5;">${msg.content}</div>
                    </div>
                </div>
            `;
        }

        function addNegotiationMessage(sender, content) {
            const time = new Date().toLocaleTimeString();
            GameState.negotiation.messages.push({ sender, content, time });

            const messagesDiv = document.getElementById('negotiation-messages');
            if (messagesDiv) {
                messagesDiv.innerHTML += generateMessageHTML({ sender, content, time });
                scrollNegotiationToBottom();
            }
        }

        function scrollNegotiationToBottom() {
            const messagesDiv = document.getElementById('negotiation-messages');
            if (messagesDiv) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        function sendCustomNegotiationMessage() {
            const input = document.getElementById('negotiation-input');
            if (!input || !input.value.trim()) return;

            const message = input.value.trim();
            input.value = '';

            addNegotiationMessage('player', message);
            GameState.negotiation.negotiationRounds++;

            // AI 回應
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                addNegotiationMessage('opponent', aiResponse);
                updateNegotiationPanel();
            }, 1500 + Math.random() * 1000);
        }

        function sendNegotiationResponse(type) {
            const isHacker = GameState.currentMode === 'hacker';
            let message = '';
            let aiResponseType = '';

            if (isHacker) {
                switch(type) {
                    case 'demand':
                        message = `我的要求很簡單：支付 $${GameState.negotiation.ransomOffer.toLocaleString()}，我會解鎖你的系統並刪除所有竊取的資料。這是最後的機會。`;
                        aiResponseType = 'consider_payment';
                        break;
                    case 'increase':
                        GameState.negotiation.ransomOffer = Math.floor(GameState.negotiation.ransomOffer * 1.5);
                        message = `你的拖延讓我失去耐心了。現在價格是 $${GameState.negotiation.ransomOffer.toLocaleString()}。每過一個小時，價格會再漲 50%。`;
                        aiResponseType = 'panic';
                        break;
                    case 'threaten':
                        message = `不要試探我的耐心！我已經掌握了你公司的所有機密資料。如果不付款，這些資料將會被公開出售或發布到暗網。`;
                        aiResponseType = 'scared';
                        break;
                    case 'negotiate':
                        message = `好吧，我可以考慮你的提議。你能出多少錢？記住，我也需要付出時間和風險。`;
                        aiResponseType = 'make_offer';
                        break;
                }
            } else {
                switch(type) {
                    case 'ask_price':
                        message = '你到底要多少錢？請給我一個具體的數字和支付方式。';
                        aiResponseType = 'state_price';
                        break;
                    case 'counter_offer':
                        const counterAmount = Math.floor(GameState.negotiation.ransomOffer * 0.5);
                        GameState.negotiation.counterOffer = counterAmount;
                        message = `$${GameState.negotiation.ransomOffer.toLocaleString()} 太高了。我最多只能支付 $${counterAmount.toLocaleString()}。這已經是我能拿出的全部了。`;
                        aiResponseType = 'consider_counter';
                        break;
                    case 'ask_guarantee':
                        message = '如果我付了錢，你怎麼保證會解鎖我的系統？你怎麼證明你不會再次攻擊我？';
                        aiResponseType = 'give_guarantee';
                        break;
                    case 'refuse':
                        message = '我拒絕支付任何勒索金。我們有備份，而且警方已經介入調查。你最好現在放棄。';
                        aiResponseType = 'threaten_back';
                        break;
                }
            }

            addNegotiationMessage('player', message);
            GameState.negotiation.negotiationRounds++;

            // AI 回應
            setTimeout(() => {
                const aiResponse = generateAIResponseByType(aiResponseType);
                addNegotiationMessage('opponent', aiResponse);
                updateNegotiationPanel();
            }, 1500 + Math.random() * 1000);
        }

        function generateAIResponse(playerMessage) {
            const isHacker = GameState.currentMode === 'hacker';
            const responses = isHacker ? [
                '我需要時間考慮你的提議...',
                '這個價格太高了，我無法接受。',
                '你能保證解鎖我的系統嗎？',
                '我可以分期付款嗎？',
                '給我一些時間籌錢。',
                '我需要先看到你的誠意。'
            ] : [
                '不要浪費我的時間。付款或者承受後果。',
                '我的耐心是有限的。',
                '這是一次性交易，付款後我會消失。',
                '你沒有選擇的餘地。',
                '時間在流逝，���一秒你的數據都在風險中。',
                '我可以考慮降低一點，但不會太多。'
            ];

            return responses[Math.floor(Math.random() * responses.length)];
        }

        function generateAIResponseByType(type) {
            const isHacker = GameState.currentMode === 'hacker';
            const ransomAmount = GameState.negotiation.ransomOffer;

            const responses = {
                // 防禦者AI回應 (當玩家是黑客時)
                'consider_payment': [
                    `$${ransomAmount.toLocaleString()} 是一筆很大的數目...我需要和管理層商量。`,
                    '我需要確認公司有足夠的預算來處理這件事。',
                    '這個金額...讓我考慮一下其他選項。'
                ],
                'panic': [
                    '等等！這個漲幅太快了！我需要更多時間！',
                    '拜託，給我一點時間。我正在盡力籌錢。',
                    '不要這樣！我們可以談的！'
                ],
                'scared': [
                    '好...好的，我明白了。請不要公開那些資料。',
                    '我會盡快處理付款的。請給我48小時。',
                    '我需要聯繫財務部門。這不是我一個人能決定的。'
                ],
                'make_offer': [
                    `我們最多能拿出 $${Math.floor(ransomAmount * 0.6).toLocaleString()}。這是我們的極限。`,
                    `公司預算有限，$${Math.floor(ransomAmount * 0.7).toLocaleString()} 怎麼樣？`,
                    '我們願意支付一半的金額，剩下的在系統解鎖後支付。'
                ],

                // 黑客AI回應 (當玩家是防禦者時)
                'state_price': [
                    `很簡單，$${ransomAmount.toLocaleString()}，用比特幣支付。我會給你一個錢包地址。`,
                    `勒索金是 $${ransomAmount.toLocaleString()}。這是考慮到你們公司規模後的合理價格。`,
                    `$${ransomAmount.toLocaleString()}，一次性付清。付款後24小時內解鎖你的所有系統。`
                ],
                'consider_counter': [
                    `$${GameState.negotiation.counterOffer.toLocaleString()}？這連我的成本都不夠。但是...我可以接受 $${Math.floor(ransomAmount * 0.75).toLocaleString()}。`,
                    '你在開玩笑嗎？這個價格太低了。至少要原價的80%。',
                    `好吧，看在你態度誠懇的份上，$${Math.floor(ransomAmount * 0.8).toLocaleString()}，這是我的底線。`
                ],
                'give_guarantee': [
                    '我在這行做了很多年，信譽就是我的命。付款後我會發送解密密鑰，你可以先解鎖一個測試文件驗證。',
                    '這是一次性交易。我得到錢，你得到系統。之後我會刪除所有訪問權限，我們互不相欠。',
                    '我可以先解鎖你10%的文件作為誠意。剩下的在收到全額付款後解鎖。'
                ],
                'threaten_back': [
                    '備份？你確定嗎？我已經滲透你的系統3個月了，包括你的備份服務器。',
                    '警方？哈！當他們找到任何線索的時候，你的公司早就破產了。',
                    '你很勇敢，但這是個愚蠢的決定。讓我給你展示一下我能做什麼...'
                ]
            };

            const responseList = responses[type] || ['...讓我想想。'];
            return responseList[Math.floor(Math.random() * responseList.length)];
        }

        function updateNegotiationPanel() {
            // 更新談判回合顯示
            const modal = document.getElementById('negotiation-modal');
            if (modal) {
                modal.remove();
                showNegotiationPanel();
            }
        }

        function closeNegotiationPanel() {
            const modal = document.getElementById('negotiation-modal');
            if (modal) modal.remove();
            addTerminalLine('[談判] 通訊頻道已關閉', 'system');
        }

        // 防禦者接受條件並支付
        function acceptNegotiatedDeal() {
            const amount = GameState.negotiation.ransomOffer;

            if (GameState.wallet.balance < amount) {
                addNegotiationMessage('system', `⚠️ 餘額不足！需要 $${amount.toLocaleString()}，你只有 $${GameState.wallet.balance.toLocaleString()}`);
                return;
            }

            addNegotiationMessage('player', `好的，我接受。我現在就支付 $${amount.toLocaleString()}。`);

            setTimeout(() => {
                addNegotiationMessage('opponent', '很好，你做了正確的決定。正在驗證付款...');

                setTimeout(() => {
                    // 執行支付
                    GameState.wallet.balance -= amount;
                    GameState.hackerAttack.ransomPaid = true;
                    GameState.hackerAttack.ransomReceived = amount;
                    GameState.hackerAttack.stolenFunds += amount;

                    addNegotiationMessage('system', `💰 已支付 $${amount.toLocaleString()}`);
                    addNegotiationMessage('opponent', '付款已確認。正在發送解密密鑰...你的系統將在幾分鐘內恢復。合作愉快。');

                    updateWalletDisplay();

                    // 清除任何勒索計時器
                    if (GameState.hackerAttack.ransomTimer) {
                        clearInterval(GameState.hackerAttack.ransomTimer);
                    }

                    addTerminalLine(`[談判] 交易完成，已支付 $${amount.toLocaleString()}`, 'warning');
                    showNotification('談判成功', `已支付勒索金 $${amount.toLocaleString()}`, 'defender');

                    setTimeout(() => {
                        closeNegotiationPanel();
                    }, 3000);
                }, 2000);
            }, 1500);
        }

        // 黑客確認勒索要求
        function finalizeRansomDemand() {
            const amount = GameState.negotiation.ransomOffer;
            GameState.hackerAttack.ransomAmount = amount;

            addNegotiationMessage('player', `最後通牒：$${amount.toLocaleString()}，限時5分鐘。不接受任何討價還價。`);

            setTimeout(() => {
                const willPay = Math.random() > 0.4; // 60% 機會支付

                if (willPay) {
                    addNegotiationMessage('opponent', '...好吧，我接受。我會立即安排付款。');

                    setTimeout(() => {
                        addNegotiationMessage('system', `💰 對方已支付 $${amount.toLocaleString()}`);

                        // 黑客收到錢
                        GameState.wallet.balance += amount;
                        GameState.hackerAttack.ransomPaid = true;
                        GameState.hackerAttack.ransomReceived = amount;
                        GameState.hackerAttack.stolenFunds += amount;

                        updateWalletDisplay();
                        addTerminalLine(`[收款] 勒索成功！收到 $${amount.toLocaleString()}`, 'success');
                        showNotification('勒索成功', `收到勒索金 $${amount.toLocaleString()}`, 'hacker');

                        setTimeout(() => {
                            closeNegotiationPanel();
                        }, 2000);
                    }, 2000);
                } else {
                    addNegotiationMessage('opponent', '我沒辦法在這麼短時間內籌到這麼多錢。請再給我一些時間！');
                    addNegotiationMessage('system', '⚠️ 對方請求延長時間');
                }
            }, 2000);
        }

        // 觸發防禦者殭屍化效果
        function triggerDefenderZombie() {
            // 禁用所有防禦者控制
            addTerminalLine('⚠️ 警告：系統已被接管，所有控制已被鎖定！', 'alert');

            // 模擬系統被完全控制的效果
            GameState.stats.systemHealth = 0;
            GameState.stats.defenseLevel = 0;
            updateStatsDisplay('defender');
        }

        // ===== 黑客課金系統 =====
        function showHackerPaymentPanel() {
            const attack = GameState.hackerAttack;
            const hackerUpgrades = GameState.hackerUpgrades || { attackBonus: 0, stealthBonus: 0, zombieBonus: 0 };
            const totalRansomReceived = attack.ransomPaid ? attack.ransomAmount : 0;
            const totalIncome = attack.stolenFunds + totalRansomReceived;

            const panelHTML = `
                <div class="modal-overlay" id="hacker-payment-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(10,30,20,0.98) 0%, rgba(20,50,30,0.98) 100%); border: 2px solid #00ff41;">
                        <h2 style="color: #00ff41; margin-bottom: 25px; text-align: center; text-shadow: 0 0 10px rgba(0,255,65,0.5);">
                            <i class="fas fa-coins"></i> 黑客課金系統
                        </h2>

                        <div style="background: linear-gradient(135deg, rgba(0,255,65,0.1) 0%, rgba(0,150,40,0.15) 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #00ff41; text-align: center;">
                            <p style="color: #00ff41; margin: 0;">💀 接收防禦者資金 | 升級黑客能力 | 管理偷取資產</p>
                        </div>

                        <!-- 資���概覽 -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 25px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #00ff41;">
                                <div style="color: #888; font-size: 0.85rem;">💰 現金餘額</div>
                                <div style="color: #00ff41; font-size: 1.4rem; font-weight: bold;">$${GameState.wallet.balance.toLocaleString()}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ff9900;">
                                <div style="color: #888; font-size: 0.85rem;">🔓 已偷取資金</div>
                                <div style="color: #ff9900; font-size: 1.4rem; font-weight: bold;">$${attack.stolenFunds.toLocaleString()}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #9b59b6;">
                                <div style="color: #888; font-size: 0.85rem;">🔐 勒索收入</div>
                                <div style="color: #9b59b6; font-size: 1.4rem; font-weight: bold;">$${totalRansomReceived.toLocaleString()}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e74c3c;">
                                <div style="color: #888; font-size: 0.85rem;">📊 總收入</div>
                                <div style="color: #e74c3c; font-size: 1.4rem; font-weight: bold;">$${totalIncome.toLocaleString()}</div>
                            </div>
                        </div>

                        <!-- 接收防禦者資金 -->
                        <h3 style="color: #ff3333; margin-bottom: 15px;"><i class="fas fa-hand-holding-usd"></i> 接收防禦者資金 (被動收入)</h3>
                        <div style="background: rgba(255,51,51,0.1); border: 1px solid #ff3333; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="color: #ff6666; font-weight: bold; margin-bottom: 10px;">勒索金收入</div>
                                    <p style="color: #aaa; font-size: 0.9rem; margin: 0;">當防禦者支付勒索金時，資金會自動轉入你的帳戶。使用「攻擊模式」中的勒索金選項來發起勒索。</p>
                                    <div style="margin-top: 10px; color: #00ff41;">當前勒索狀態: ${attack.ransomAmount > 0 ? (attack.ransomPaid ? '✓ 已收到 $' + attack.ransomAmount.toLocaleString() : '⏳ 等待支付 $' + attack.ransomAmount.toLocaleString()) : '未發起勒索'}</div>
                                </div>
                                <div>
                                    <div style="color: #ff9900; font-weight: bold; margin-bottom: 10px;">資產竊取收入</div>
                                    <p style="color: #aaa; font-size: 0.9rem; margin: 0;">透過循序漸進攻擊或直接攻擊，可以持續偷取防禦者的資金。升級你的能力以增加偷取效率。</p>
                                    <div style="margin-top: 10px; color: #00ff41;">殭屍化進度: ${attack.zombieProgress}%</div>
                                </div>
                            </div>
                        </div>

                        <!-- 升級選項 -->
                        <h3 style="color: #00ff41; margin-bottom: 15px;"><i class="fas fa-arrow-up"></i> 能力升級 (課金提升)</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px;">
                            <div onclick="purchaseHackerUpgrade('attack', 30000)" style="background: rgba(255,51,51,0.15); border: 1px solid #ff3333; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; ${GameState.wallet.balance < 30000 ? 'opacity: 0.5;' : ''}" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div>
                                    <div style="color: #ff3333; font-weight: bold;">⚔️ 攻擊強度升級</div>
                                    <div style="color: #aaa; font-size: 0.85rem;">提升攻擊能力 +20%</div>
                                    <div style="color: #666; font-size: 0.75rem;">當前加成: +${hackerUpgrades.attackBonus || 0}%</div>
                                </div>
                                <div style="color: #00ff41; font-weight: bold;">$30,000</div>
                            </div>
                            <div onclick="purchaseHackerUpgrade('stealth', 35000)" style="background: rgba(0,255,65,0.15); border: 1px solid #00ff41; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; ${GameState.wallet.balance < 35000 ? 'opacity: 0.5;' : ''}" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div>
                                    <div style="color: #00ff41; font-weight: bold;">👻 隱蔽能力升級</div>
                                    <div style="color: #aaa; font-size: 0.85rem;">降低被檢測風險 -15%</div>
                                    <div style="color: #666; font-size: 0.75rem;">當前加成: -${hackerUpgrades.stealthBonus || 0}%</div>
                                </div>
                                <div style="color: #00ff41; font-weight: bold;">$35,000</div>
                            </div>
                            <div onclick="purchaseHackerUpgrade('decrypt', 40000)" style="background: rgba(255,153,0,0.15); border: 1px solid #ff9900; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; ${GameState.wallet.balance < 40000 ? 'opacity: 0.5;' : ''}" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div>
                                    <div style="color: #ff9900; font-weight: bold;">🔓 解密能力升級</div>
                                    <div style="color: #aaa; font-size: 0.85rem;">提升密碼破解速度</div>
                                </div>
                                <div style="color: #00ff41; font-weight: bold;">$40,000</div>
                            </div>
                            <div onclick="purchaseHackerUpgrade('botnet', 100000)" style="background: rgba(155,89,182,0.15); border: 1px solid #9b59b6; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; ${GameState.wallet.balance < 100000 ? 'opacity: 0.5;' : ''}" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div>
                                    <div style="color: #9b59b6; font-weight: bold;">🤖 殭屍網絡擴展</div>
                                    <div style="color: #aaa; font-size: 0.85rem;">增加10萬殭屍節點</div>
                                    <div style="color: #666; font-size: 0.75rem;">當前節點: ${(hackerUpgrades.botnetNodes || 0).toLocaleString()}</div>
                                </div>
                                <div style="color: #00ff41; font-weight: bold;">$100,000</div>
                            </div>
                            <div onclick="purchaseHackerUpgrade('zombie', 75000)" style="background: rgba(231,76,60,0.15); border: 1px solid #e74c3c; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; ${GameState.wallet.balance < 75000 ? 'opacity: 0.5;' : ''}" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div>
                                    <div style="color: #e74c3c; font-weight: bold;">💀 殭屍化加速器</div>
                                    <div style="color: #aaa; font-size: 0.85rem;">殭屍化速度 +25%</div>
                                    <div style="color: #666; font-size: 0.75rem;">當前加成: +${hackerUpgrades.zombieBonus || 0}%</div>
                                </div>
                                <div style="color: #00ff41; font-weight: bold;">$75,000</div>
                            </div>
                            <div onclick="purchaseHackerUpgrade('ransom', 150000)" style="background: linear-gradient(135deg, rgba(155,89,182,0.2) 0%, rgba(100,50,120,0.25) 100%); border: 2px solid #9b59b6; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; box-shadow: 0 0 10px rgba(155,89,182,0.2); ${GameState.wallet.balance < 150000 ? 'opacity: 0.5;' : ''}" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div>
                                    <div style="color: #9b59b6; font-weight: bold;">🔐 勒索倍增器 <span style="background: #9b59b6; color: #fff; padding: 1px 6px; border-radius: 4px; font-size: 0.65rem;">PRO</span></div>
                                    <div style="color: #aaa; font-size: 0.85rem;">勒索金額範圍 x2</div>
                                </div>
                                <div style="color: #00ff41; font-weight: bold;">$150,000</div>
                            </div>
                        </div>

                        <!-- 資金轉移 -->
                        <h3 style="color: #00ff41; margin-bottom: 15px;"><i class="fas fa-exchange-alt"></i> 資金轉移 (將偷取資金轉入錢包)</h3>
                        <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #27ae60;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div>
                                    <p style="color: #aaa; margin: 0 0 10px 0;">將偷取的資金轉入你的錢包（需要混幣服務費 5%）</p>
                                    <div style="color: #888; font-size: 0.9rem;">可轉移金額: <span style="color: #ff9900;">$${attack.stolenFunds.toLocaleString()}</span> → 實收: <span style="color: #00ff41;">$${Math.floor(attack.stolenFunds * 0.95).toLocaleString()}</span></div>
                                </div>
                                <button onclick="transferStolenFunds()" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border: none; padding: 15px 30px; border-radius: 8px; color: #fff; cursor: pointer; font-weight: bold; font-size: 1rem; transition: all 0.3s; ${attack.stolenFunds <= 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-wallet"></i> 轉移資金
                                </button>
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <button onclick="closeHackerPaymentPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }

        function closeHackerPaymentPanel() {
            const modal = document.getElementById('hacker-payment-modal');
            if (modal) modal.remove();
        }

        function purchaseHackerUpgrade(type, cost) {
            if (GameState.wallet.balance < cost) {
                addTerminalLine('餘額不足！', 'error');
                SoundSystem.play('error');
                return;
            }

            GameState.wallet.balance -= cost;

            // 初始化升級狀態
            if (!GameState.hackerUpgrades) {
                GameState.hackerUpgrades = {
                    attackBonus: 0,
                    stealthBonus: 0,
                    zombieBonus: 0,
                    botnetNodes: 0,
                    ransomMultiplier: 1
                };
            }

            switch(type) {
                case 'attack':
                    GameState.stats.attackPower = Math.min(100, (GameState.stats.attackPower || 50) + 20);
                    GameState.hackerUpgrades.attackBonus += 20;
                    addTerminalLine('⚔️ 攻擊強度已提升 +20%', 'success');
                    addTerminalLine(`💪 總攻擊加成: +${GameState.hackerUpgrades.attackBonus}%`, 'system');
                    break;
                case 'stealth':
                    GameState.stats.detectionRisk = Math.max(0, (GameState.stats.detectionRisk || 30) - 15);
                    GameState.hackerUpgrades.stealthBonus += 15;
                    addTerminalLine('👻 隱蔽能力已提升，檢測風險 -15%', 'success');
                    addTerminalLine(`🔇 總隱蔽加成: -${GameState.hackerUpgrades.stealthBonus}%`, 'system');
                    break;
                case 'decrypt':
                    GameState.hackerIntel.decryptPower = (GameState.hackerIntel.decryptPower || 0) + 30;
                    addTerminalLine('🔓 解密能力已強化 +30%', 'success');
                    break;
                case 'botnet':
                    GameState.hackerUpgrades.botnetNodes += 100000;
                    addTerminalLine('🤖 殭屍網絡已擴展 +100,000 節點', 'success');
                    addTerminalLine(`📡 當前殭屍節點總數: ${GameState.hackerUpgrades.botnetNodes.toLocaleString()}`, 'system');
                    break;
                case 'zombie':
                    GameState.hackerUpgrades.zombieBonus += 25;
                    addTerminalLine('💀 殭屍化加速器已激活 +25%', 'success');
                    addTerminalLine(`⚡ 總殭屍化速度加成: +${GameState.hackerUpgrades.zombieBonus}%`, 'system');
                    break;
                case 'ransom':
                    GameState.hackerUpgrades.ransomMultiplier = (GameState.hackerUpgrades.ransomMultiplier || 1) * 2;
                    addTerminalLine('🔐 勒索倍增器已激活！', 'success');
                    addTerminalLine(`💰 勒索金額倍數: x${GameState.hackerUpgrades.ransomMultiplier}`, 'system');
                    break;
            }

            SoundSystem.play('success');
            updateStatsDisplay('hacker');
            updateWalletDisplay();
            closeHackerPaymentPanel();
            showHackerPaymentPanel(); // 刷新面板
        }

        function transferStolenFunds() {
            const stolen = GameState.hackerAttack.stolenFunds;
            if (stolen <= 0) {
                addTerminalLine('沒有可轉移的資金', 'warning');
                return;
            }

            const transferAmount = Math.floor(stolen * 0.95); // 5% 混幣費
            GameState.wallet.balance += transferAmount;
            GameState.hackerAttack.stolenFunds = 0;

            addTerminalLine(`💰 資金轉移成功: +$${transferAmount.toLocaleString()} (扣除5%混幣費)`, 'success');
            SoundSystem.play('success');

            // 更新錢包顯示
            const walletDisplay = document.getElementById('wallet-display');
            if (walletDisplay) {
                walletDisplay.textContent = GameState.wallet.balance.toLocaleString();
            }

            closeHackerPaymentPanel();
            showHackerPaymentPanel(); // 刷新面板
        }

        // ===== 防禦者反擊課金系統 =====
        function showDefenderPaymentPanel() {
            const payment = GameState.defenderPayment;
            const panelHTML = `
                <div class="modal-overlay" id="defender-payment-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 850px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(30,10,10,0.98) 0%, rgba(50,20,20,0.98) 100%); border: 2px solid #ff3333;">
                        <h2 style="color: #ff3333; margin-bottom: 25px; text-align: center; text-shadow: 0 0 10px rgba(255,51,51,0.5);">
                            <i class="fas fa-user-secret"></i> 反擊課金系統
                        </h2>

                        <div style="background: linear-gradient(135deg, rgba(255,51,51,0.15) 0%, rgba(200,30,30,0.2) 100%); padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 2px solid #ff3333;">
                            <p style="color: #ff6666; margin-bottom: 15px; text-align: center; font-size: 1.1rem;">
                                🎯 使用虛擬金錢入侵黑客的戶口，反擊攻擊者！<br>
                                <span style="font-size: 0.9rem; color: #ffaaaa;">充值預算後可執行入侵，成功後偷取黑客資金到你的錢包</span>
                            </p>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                                <div style="text-align: center; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
                                    <div style="color: #888; font-size: 0.85rem;">💰 你的餘額</div>
                                    <div style="color: #00ff41; font-size: 1.4rem; font-weight: bold;">$${GameState.wallet.balance.toLocaleString()}</div>
                                </div>
                                <div style="text-align: center; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
                                    <div style="color: #888; font-size: 0.85rem;">🎯 入侵預算</div>
                                    <div style="color: #ff9900; font-size: 1.4rem; font-weight: bold;">$${payment.hackBudget.toLocaleString()}</div>
                                </div>
                                <div style="text-align: center; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
                                    <div style="color: #888; font-size: 0.85rem;">💎 已偷取金額</div>
                                    <div style="color: #9b59b6; font-size: 1.4rem; font-weight: bold;">$${payment.stolenFromHacker.toLocaleString()}</div>
                                </div>
                                <div style="text-align: center; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
                                    <div style="color: #888; font-size: 0.85rem;">📊 成功率加成</div>
                                    <div style="color: #3498db; font-size: 1.4rem; font-weight: bold;">+${payment.successBonus || 0}%</div>
                                </div>
                            </div>
                        </div>

                        <!-- 充值入侵預算 -->
                        <h3 style="color: #ff3333; margin-bottom: 15px;"><i class="fas fa-plus-circle"></i> 充值入侵預算 (用於入侵黑客戶���)</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 25px;">
                            <button onclick="addHackBudget(50000)" style="background: linear-gradient(135deg, rgba(255,153,0,0.3) 0%, rgba(200,100,0,0.3) 100%); border: 1px solid #ff9900; padding: 15px 10px; border-radius: 8px; color: #ff9900; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-size: 1.1rem;">$50,000</div>
                                <div style="font-size: 0.75rem; color: #aaa;">基礎預算</div>
                            </button>
                            <button onclick="addHackBudget(150000)" style="background: linear-gradient(135deg, rgba(155,89,182,0.3) 0%, rgba(100,50,120,0.3) 100%); border: 1px solid #9b59b6; padding: 15px 10px; border-radius: 8px; color: #9b59b6; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-size: 1.1rem;">$150,000</div>
                                <div style="font-size: 0.75rem; color: #aaa;">進階預算</div>
                            </button>
                            <button onclick="addHackBudget(500000)" style="background: linear-gradient(135deg, rgba(255,51,51,0.3) 0%, rgba(150,30,30,0.3) 100%); border: 1px solid #ff3333; padding: 15px 10px; border-radius: 8px; color: #ff3333; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-size: 1.1rem;">$500,000</div>
                                <div style="font-size: 0.75rem; color: #aaa;">豪華預算</div>
                            </button>
                            <button onclick="addHackBudget(1500000)" style="background: linear-gradient(135deg, rgba(231,76,60,0.4) 0%, rgba(192,57,43,0.5) 100%); border: 2px solid #e74c3c; padding: 15px 10px; border-radius: 8px; color: #e74c3c; cursor: pointer; font-weight: bold; transition: all 0.3s; box-shadow: 0 0 15px rgba(231,76,60,0.3);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-size: 1.1rem;">$1,500,000</div>
                                <div style="font-size: 0.75rem; color: #ffaaaa;">⭐ 終極預算</div>
                            </button>
                        </div>

                        <!-- 入侵選項 -->
                        <h3 style="color: #ff3333; margin-bottom: 15px;"><i class="fas fa-crosshairs"></i> 入侵黑客戶口 (偷取黑客資金)</h3>
                        <div style="display: grid; gap: 12px; margin-bottom: 25px;">
                            <div onclick="executeCounterHack('basic')" style="background: rgba(0,255,65,0.1); border: 1px solid #00ff41; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; ${payment.hackBudget < 25000 ? 'opacity: 0.5; cursor: not-allowed;' : ''}" onmouseover="this.style.boxShadow='0 0 15px rgba(0,255,65,0.3)'" onmouseout="this.style.boxShadow='none'">
                                <div>
                                    <div style="color: #00ff41; font-weight: bold; font-size: 1.1rem;">💻 基礎入侵</div>
                                    <div style="color: #aaa; font-size: 0.9rem;">嘗試入侵黑客帳戶 (成功率: ${40 + (payment.successBonus || 0)}%)</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #ff9900; font-weight: bold;">消耗 $25,000</div>
                                    <div style="color: #00ff41; font-size: 0.85rem;">收益 $10,000-50,000</div>
                                </div>
                            </div>
                            <div onclick="executeCounterHack('advanced')" style="background: rgba(155,89,182,0.1); border: 1px solid #9b59b6; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; ${payment.hackBudget < 100000 ? 'opacity: 0.5; cursor: not-allowed;' : ''}" onmouseover="this.style.boxShadow='0 0 15px rgba(155,89,182,0.3)'" onmouseout="this.style.boxShadow='none'">
                                <div>
                                    <div style="color: #9b59b6; font-weight: bold; font-size: 1.1rem;">🔓 進階入侵</div>
                                    <div style="color: #aaa; font-size: 0.9rem;">深度滲透黑客系統 (成功率: ${60 + (payment.successBonus || 0)}%)</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #ff9900; font-weight: bold;">消耗 $100,000</div>
                                    <div style="color: #00ff41; font-size: 0.85rem;">收益 $50,000-200,000</div>
                                </div>
                            </div>
                            <div onclick="executeCounterHack('elite')" style="background: rgba(255,51,51,0.1); border: 1px solid #ff3333; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; ${payment.hackBudget < 300000 ? 'opacity: 0.5; cursor: not-allowed;' : ''}" onmouseover="this.style.boxShadow='0 0 15px rgba(255,51,51,0.3)'" onmouseout="this.style.boxShadow='none'">
                                <div>
                                    <div style="color: #ff3333; font-weight: bold; font-size: 1.1rem;">⚡ 精英入侵</div>
                                    <div style="color: #aaa; font-size: 0.9rem;">全面控制黑客資產 (成功率: ${80 + (payment.successBonus || 0)}%)</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #ff9900; font-weight: bold;">消耗 $300,000</div>
                                    <div style="color: #00ff41; font-size: 0.85rem;">收益 $200,000-500,000</div>
                                </div>
                            </div>
                            <div onclick="executeCounterHack('ultimate')" style="background: linear-gradient(135deg, rgba(231,76,60,0.2) 0%, rgba(192,57,43,0.25) 100%); border: 2px solid #e74c3c; border-radius: 8px; padding: 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; ${payment.hackBudget < 1000000 ? 'opacity: 0.5; cursor: not-allowed;' : ''}" onmouseover="this.style.boxShadow='0 0 20px rgba(231,76,60,0.5)'" onmouseout="this.style.boxShadow='none'">
                                <div>
                                    <div style="color: #e74c3c; font-weight: bold; font-size: 1.2rem;">🔥 終極入侵 <span style="background: #e74c3c; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">NEW</span></div>
                                    <div style="color: #ffaaaa; font-size: 0.9rem;">完全癱瘓黑客系統並掠奪所有資產 (成功率: 95%)</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #ff9900; font-weight: bold; font-size: 1.1rem;">消耗 $1,000,000</div>
                                    <div style="color: #00ff41; font-size: 0.9rem;">收益 $500,000-2,000,000</div>
                                </div>
                            </div>
                        </div>

                        <!-- 升級入侵能力 -->
                        <h3 style="color: #ff3333; margin-bottom: 15px;"><i class="fas fa-arrow-up"></i> 升級入侵能力</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px;">
                            <button onclick="upgradeDefenderHackSkill('success')" style="background: rgba(52,152,219,0.2); border: 1px solid #3498db; padding: 15px; border-radius: 8px; color: #3498db; cursor: pointer; text-align: left; transition: all 0.3s; ${GameState.wallet.balance < 75000 ? 'opacity: 0.5;' : ''}" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-weight: bold;">📈 成功率提升</div>
                                <div style="font-size: 0.85rem; color: #aaa;">所有入侵成功率 +10%</div>
                                <div style="font-size: 0.9rem; color: #00ff41; margin-top: 5px;">$75,000</div>
                            </button>
                            <button onclick="upgradeDefenderHackSkill('reward')" style="background: rgba(39,174,96,0.2); border: 1px solid #27ae60; padding: 15px; border-radius: 8px; color: #27ae60; cursor: pointer; text-align: left; transition: all 0.3s; ${GameState.wallet.balance < 100000 ? 'opacity: 0.5;' : ''}" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-weight: bold;">💎 收益倍增器</div>
                                <div style="font-size: 0.85rem; color: #aaa;">入侵收益 x1.5</div>
                                <div style="font-size: 0.9rem; color: #00ff41; margin-top: 5px;">$100,000</div>
                            </button>
                        </div>

                        <!-- 入侵記錄 -->
                        <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                                <div>
                                    <div style="color: #888;">入侵次數</div>
                                    <div style="color: #3498db; font-size: 1.2rem; font-weight: bold;">${payment.hackAttempts}</div>
                                </div>
                                <div>
                                    <div style="color: #888;">成功次數</div>
                                    <div style="color: #27ae60; font-size: 1.2rem; font-weight: bold;">${payment.successCount || 0}</div>
                                </div>
                                <div>
                                    <div style="color: #888;">總計偷取</div>
                                    <div style="color: #00ff41; font-size: 1.2rem; font-weight: bold;">$${payment.stolenFromHacker.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <button onclick="closeDefenderPaymentPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }

        // 升級防禦者入侵能力
        function upgradeDefenderHackSkill(type) {
            const costs = { success: 75000, reward: 100000 };
            const cost = costs[type];

            if (GameState.wallet.balance < cost) {
                addTerminalLine('餘額不足！', 'error');
                SoundSystem.play('error');
                return;
            }

            GameState.wallet.balance -= cost;

            if (type === 'success') {
                GameState.defenderPayment.successBonus = (GameState.defenderPayment.successBonus || 0) + 10;
                addTerminalLine('📈 入侵成功率已提升 +10%', 'success');
            } else if (type === 'reward') {
                GameState.defenderPayment.rewardMultiplier = (GameState.defenderPayment.rewardMultiplier || 1) * 1.5;
                addTerminalLine('💎 入侵收益倍增器已激活 x1.5', 'success');
            }

            SoundSystem.play('success');
            updateWalletDisplay();
            closeDefenderPaymentPanel();
            showDefenderPaymentPanel();
        }

        // 更新錢包顯示
        function updateWalletDisplay() {
            const walletDisplay = document.getElementById('wallet-display');
            if (walletDisplay) {
                walletDisplay.textContent = GameState.wallet.balance.toLocaleString();
            }
        }

        function closeDefenderPaymentPanel() {
            const modal = document.getElementById('defender-payment-modal');
            if (modal) modal.remove();
        }

        function addHackBudget(amount) {
            if (GameState.wallet.balance < amount) {
                addTerminalLine('餘額不足！', 'error');
                SoundSystem.play('error');
                return;
            }

            GameState.wallet.balance -= amount;
            GameState.defenderPayment.hackBudget += amount;

            addTerminalLine(`💰 已充值入侵預算: +$${amount.toLocaleString()}`, 'success');
            SoundSystem.play('success');

            // 更新錢包顯示
            const walletDisplay = document.getElementById('wallet-display');
            if (walletDisplay) {
                walletDisplay.textContent = GameState.wallet.balance.toLocaleString();
            }

            closeDefenderPaymentPanel();
            showDefenderPaymentPanel(); // 刷新面板
        }

        function executeCounterHack(level) {
            const costs = { basic: 25000, advanced: 100000, elite: 300000, ultimate: 1000000 };
            const baseSuccessRates = { basic: 0.4, advanced: 0.6, elite: 0.8, ultimate: 0.95 };
            const rewards = {
                basic: { min: 10000, max: 50000 },
                advanced: { min: 50000, max: 200000 },
                elite: { min: 200000, max: 500000 },
                ultimate: { min: 500000, max: 2000000 }
            };

            const cost = costs[level];
            if (GameState.defenderPayment.hackBudget < cost) {
                addTerminalLine('入侵預算不足！請先充值入侵預算', 'error');
                SoundSystem.play('error');
                return;
            }

            GameState.defenderPayment.hackBudget -= cost;
            GameState.defenderPayment.hackAttempts++;

            const levelNames = { basic: '基礎', advanced: '進階', elite: '精英', ultimate: '終極' };
            addTerminalLine(`🎯 執行${levelNames[level]}入侵...`, 'command');
            addTerminalLine(`💰 消耗入侵預算: $${cost.toLocaleString()}`, 'system');
            SoundSystem.play('attack');

            closeDefenderPaymentPanel();

            // 計算成功率（加上升級加成）
            const successBonus = (GameState.defenderPayment.successBonus || 0) / 100;
            const finalSuccessRate = Math.min(0.99, baseSuccessRates[level] + successBonus);

            // 顯示入侵進度動畫
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 20;
                addTerminalLine(`[入侵進度] ${progress}% - ${progress < 40 ? '掃描目標...' : progress < 60 ? '繞過防火牆...' : progress < 80 ? '植入木馬...' : '提取資金...'}`, 'response');

                if (progress >= 100) {
                    clearInterval(progressInterval);

                    const success = Math.random() < finalSuccessRate;

                    if (success) {
                        const reward = rewards[level];
                        let stolen = Math.floor(Math.random() * (reward.max - reward.min)) + reward.min;

                        // 應用收益倍增器
                        const rewardMultiplier = GameState.defenderPayment.rewardMultiplier || 1;
                        stolen = Math.floor(stolen * rewardMultiplier);

                        GameState.defenderPayment.stolenFromHacker += stolen;
                        GameState.defenderPayment.successCount = (GameState.defenderPayment.successCount || 0) + 1;
                        GameState.wallet.balance += stolen;

                        addTerminalLine(`✓ 入侵成功！已從黑客戶口偷取: $${stolen.toLocaleString()}`, 'success');
                        if (rewardMultiplier > 1) {
                            addTerminalLine(`💎 收益倍增器生效: x${rewardMultiplier}`, 'success');
                        }
                        SoundSystem.play('success');
                        showNotification('反擊成功', `成功入侵黑客帳戶，偷取 $${stolen.toLocaleString()}！`, 'defender');

                        // 終極入侵的額外效果
                        if (level === 'ultimate') {
                            addTerminalLine('🔥 終極入侵附加效果：黑客攻擊力下降 20%', 'success');
                            // 模擬削弱黑客
                            GameState.stats.defenseLevel = Math.min(100, (GameState.stats.defenseLevel || 50) + 15);
                        }
                    } else {
                        addTerminalLine('✗ 入侵失敗！黑客防禦系統阻擋了你的攻擊', 'error');
                        SoundSystem.play('error');
                        showNotification('反擊失敗', '入侵被黑客防禦系統阻擋', 'defender');
                    }

                    updateWalletDisplay();
                    updateStatsDisplay('defender');
                }
            }, 400);
        }

        // ===== 目標情報面板 (黑客查看防禦者資料) =====
        function showTargetIntelPanel() {
            const defender = GameConfig.opponent.defender;
            // 生成模擬的行為數據
            const behaviorData = {
                lastOnline: '剛才',
                avgOnlineHours: Math.floor(Math.random() * 8) + 4,
                browserType: ['Chrome', 'Firefox', 'Edge', 'Safari'][Math.floor(Math.random() * 4)],
                timezone: 'UTC+8 (香港)',
                screenRes: '1920x1080',
                lastPasswordChange: Math.floor(Math.random() * 90) + 30 + ' 天前',
                securityScore: Math.floor(Math.random() * 40) + 40
            };

            const panelHTML = `
                <div class="modal-overlay" id="target-intel-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 1100px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(10,20,30,0.98) 0%, rgba(20,40,60,0.98) 100%); border: 2px solid #3498db;">
                        <h2 style="color: #3498db; margin-bottom: 25px; text-align: center; text-shadow: 0 0 10px rgba(52,152,219,0.5);">
                            <i class="fas fa-user-circle"></i> 🎯 目標完整情報 - AI模擬對手
                        </h2>

                        <div style="background: rgba(255,153,0,0.1); border: 1px solid #ff9900; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                            <i class="fas fa-robot" style="color: #ff9900; font-size: 1.5rem;"></i>
                            <span style="color: #ff9900; font-weight: bold; margin-left: 10px;">AI模擬人物 - 自動操作中</span>
                            <div style="color: #888; font-size: 0.85rem; margin-top: 5px;">⚡ 黑客專屬高級情報系統 - 可查看完整目標資料</div>
                        </div>

                        <!-- 個人資料 + 聯繫信息 -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; border: 1px solid #3498db;">
                                <h3 style="color: #3498db; margin-bottom: 15px;"><i class="fas fa-id-card"></i> 公開資料</h3>
                                <div style="display: grid; gap: 10px;">
                                    <div><span style="color: #888;">姓名:</span> <span style="color: #fff;">${defender.profile.realName}</span></div>
                                    <div><span style="color: #888;">公司:</span> <span style="color: #fff;">${defender.profile.company}</span></div>
                                    <div><span style="color: #888;">職位:</span> <span style="color: #fff;">${defender.profile.position}</span></div>
                                    <div><span style="color: #888;">地區:</span> <span style="color: #fff;">${defender.profile.country}</span></div>
                                    <div><span style="color: #888;">認證:</span> <span style="color: #00ff41;">${defender.profile.certifications.join(', ')}</span></div>
                                    <div><span style="color: #888;">經驗:</span> <span style="color: #fff;">${defender.profile.yearsExperience} 年</span></div>
                                </div>
                            </div>

                            <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; border: 1px solid #ff3333;">
                                <h3 style="color: #ff3333; margin-bottom: 15px;"><i class="fas fa-envelope"></i> 聯繫信息</h3>
                                <div style="display: grid; gap: 10px;">
                                    <div><span style="color: #888;">Email:</span> <span style="color: #fff;">${defender.profile.email}</span></div>
                                    <div><span style="color: #888;">電話:</span> <span style="color: #fff;">${defender.profile.phone}</span></div>
                                    <div><span style="color: #888;">LinkedIn:</span> <span style="color: #0077b5;">${defender.profile.socialMedia.linkedin}</span></div>
                                    <div><span style="color: #888;">Twitter:</span> <span style="color: #1da1f2;">${defender.profile.socialMedia.twitter}</span></div>
                                    <div><span style="color: #888;">地址:</span> <span style="color: #fff;">${defender.profile.officeAddress}</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- 行為分析 (黑客專屬) -->
                        <div style="background: linear-gradient(135deg, rgba(0,255,65,0.1) 0%, rgba(0,100,40,0.15) 100%); padding: 20px; border-radius: 10px; border: 2px solid #00ff41; margin-bottom: 25px;">
                            <h3 style="color: #00ff41; margin-bottom: 15px;">
                                <i class="fas fa-chart-line"></i> 🔍 行為分析
                                <span style="background: #00ff41; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 10px;">黑客專屬</span>
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                                    <div style="color: #888; font-size: 0.8rem;">最後在線</div>
                                    <div style="color: #00ff41; font-size: 1rem;">${behaviorData.lastOnline}</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                                    <div style="color: #888; font-size: 0.8rem;">平均上線時數</div>
                                    <div style="color: #00ff41; font-size: 1rem;">${behaviorData.avgOnlineHours} 小時/天</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                                    <div style="color: #888; font-size: 0.8rem;">瀏覽器</div>
                                    <div style="color: #00ff41; font-size: 1rem;">${behaviorData.browserType}</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                                    <div style="color: #888; font-size: 0.8rem;">時區</div>
                                    <div style="color: #00ff41; font-size: 1rem;">${behaviorData.timezone}</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                                    <div style="color: #888; font-size: 0.8rem;">屏幕解析度</div>
                                    <div style="color: #00ff41; font-size: 1rem;">${behaviorData.screenRes}</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                                    <div style="color: #888; font-size: 0.8rem;">密碼上次更改</div>
                                    <div style="color: #ffaa00; font-size: 1rem;">${behaviorData.lastPasswordChange}</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #888;">安全評分:</span>
                                    <span style="color: ${behaviorData.securityScore < 50 ? '#ff3333' : behaviorData.securityScore < 70 ? '#ffaa00' : '#00ff41'}; font-weight: bold;">
                                        ${behaviorData.securityScore}/100 ${behaviorData.securityScore < 50 ? '(弱)' : behaviorData.securityScore < 70 ? '(中)' : '(強)'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- 裝置與網絡信息 -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; border: 1px solid #00ff41;">
                                <h3 style="color: #00ff41; margin-bottom: 15px;"><i class="fas fa-server"></i> 裝置信息</h3>
                                <div style="display: grid; gap: 10px;">
                                    <div><span style="color: #888;">操作系統:</span> <span style="color: #fff;">${defender.device.os}</span></div>
                                    <div><span style="color: #888;">硬件:</span> <span style="color: #fff;">${defender.device.hardware}</span></div>
                                    <div><span style="color: #888;">VPN:</span> <span style="color: ${defender.device.vpnActive ? '#00ff41' : '#ff3333'};">${defender.device.vpnActive ? '啟用 ⚠️ 追蹤時間增加' : '未啟用 ✓ 可直接追蹤'}</span></div>
                                    <div><span style="color: #888;">防火牆:</span> <span style="color: ${defender.device.firewallLevel > 70 ? '#00ff41' : '#ffaa00'};">${defender.device.firewallLevel}%</span></div>
                                    <div><span style="color: #888;">殺毒軟件:</span> <span style="color: ${defender.device.antivirusLevel > 70 ? '#00ff41' : '#ffaa00'};">${defender.device.antivirusLevel}%</span></div>
                                </div>
                            </div>

                            <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; border: 1px solid #9b59b6;">
                                <h3 style="color: #9b59b6; margin-bottom: 15px;"><i class="fas fa-network-wired"></i> 網絡信息</h3>
                                <div style="display: grid; gap: 10px;">
                                    <div><span style="color: #888;">公網IP:</span> <span style="color: #ff3333;">${defender.network.publicIP}</span></div>
                                    <div><span style="color: #888;">內網範圍:</span> <span style="color: #fff;">${defender.network.internalRange}</span></div>
                                    <div><span style="color: #888;">DNS:</span> <span style="color: #fff;">${defender.network.dnsServer}</span></div>
                                    <div><span style="color: #888;">頻寬:</span> <span style="color: #fff;">${defender.network.bandwidth}</span></div>
                                    <div><span style="color: #888;">連接設備:</span> <span style="color: #fff;">${defender.network.connectedDevices} 台</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- 漏洞信息 + 快速利用 -->
                        <div style="background: rgba(255,51,51,0.1); padding: 20px; border-radius: 10px; border: 1px solid #ff3333; margin-bottom: 25px;">
                            <h3 style="color: #ff3333; margin-bottom: 15px;"><i class="fas fa-bug"></i> 已發現漏洞 & 快速利用</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                                ${defender.device.vulnerabilities.map(v => `
                                    <span onclick="exploitVulnerability('${v}')" style="background: rgba(255,51,51,0.3); padding: 8px 15px; border-radius: 20px; color: #ff6666; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,51,51,0.5)'" onmouseout="this.style.background='rgba(255,51,51,0.3)'">
                                        <i class="fas fa-exclamation-triangle"></i> ${v} <i class="fas fa-bolt" style="margin-left: 5px;"></i>
                                    </span>
                                `).join('')}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div style="color: #888; font-size: 0.9rem;">開放端口: <span style="color: #ffaa00;">${defender.device.openPorts.join(', ')}</span></div>
                                <div style="text-align: right;">
                                    <button onclick="showNetworkExploitPanel()" style="background: linear-gradient(135deg, #ff3333, #cc0000); border: none; padding: 8px 15px; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.9rem;">
                                        <i class="fas fa-skull-crossbones"></i> 網絡漏洞利用
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 快捷操作 -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
                            <button onclick="closeTargetIntelPanel(); showIPTrackingPanel();" style="background: rgba(230,126,34,0.2); border: 1px solid #e67e22; padding: 12px; border-radius: 6px; color: #e67e22; cursor: pointer;">
                                <i class="fas fa-crosshairs"></i><div style="font-size: 0.8rem; margin-top: 5px;">IP追蹤</div>
                            </button>
                            <button onclick="closeTargetIntelPanel(); showPhishingPanel();" style="background: rgba(192,57,43,0.2); border: 1px solid #c0392b; padding: 12px; border-radius: 6px; color: #c0392b; cursor: pointer;">
                                <i class="fas fa-fish"></i><div style="font-size: 0.8rem; margin-top: 5px;">釣魚連結</div>
                            </button>
                            <button onclick="closeTargetIntelPanel(); executeTool('port_scanner', 'hacker');" style="background: rgba(52,152,219,0.2); border: 1px solid #3498db; padding: 12px; border-radius: 6px; color: #3498db; cursor: pointer;">
                                <i class="fas fa-door-open"></i><div style="font-size: 0.8rem; margin-top: 5px;">端口掃描</div>
                            </button>
                            <button onclick="closeTargetIntelPanel(); showDeviceStatusPanel('hacker');" style="background: rgba(155,89,182,0.2); border: 1px solid #9b59b6; padding: 12px; border-radius: 6px; color: #9b59b6; cursor: pointer;">
                                <i class="fas fa-desktop"></i><div style="font-size: 0.8rem; margin-top: 5px;">裝置狀態</div>
                            </button>
                        </div>

                        <div style="text-align: center;">
                            <button onclick="closeTargetIntelPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }

        function closeTargetIntelPanel() {
            const modal = document.getElementById('target-intel-modal');
            if (modal) modal.remove();
        }

        // ===== 網絡漏洞利用面板 (黑客專屬) =====
        function showNetworkExploitPanel() {
            closeTargetIntelPanel();
            const defender = GameConfig.opponent.defender;

            const panelHTML = `
                <div class="modal-overlay" id="network-exploit-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 800px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(30,10,10,0.98) 0%, rgba(60,20,20,0.98) 100%); border: 2px solid #e74c3c;">
                        <h2 style="color: #e74c3c; margin-bottom: 25px; text-align: center; text-shadow: 0 0 10px rgba(231,76,60,0.5);">
                            <i class="fas fa-skull-crossbones"></i> 🔓 網絡漏洞利用系統
                        </h2>

                        <div style="background: linear-gradient(135deg, rgba(231,76,60,0.2) 0%, rgba(192,57,43,0.2) 100%); border: 1px solid #e74c3c; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-crosshairs" style="color: #e74c3c; font-size: 1.5rem;"></i>
                                <div>
                                    <div style="color: #e74c3c; font-weight: bold;">目標: ${defender.network.publicIP}</div>
                                    <div style="color: #888; font-size: 0.85rem;">防火牆等級: ${defender.device.firewallLevel}% | 漏洞數量: ${defender.device.vulnerabilities.length}</div>
                                </div>
                            </div>
                        </div>

                        <!-- 防火牆入侵 -->
                        <h3 style="color: #e74c3c; margin-bottom: 15px;"><i class="fas fa-fire"></i> 防火牆入侵</h3>
                        <div style="display: grid; gap: 12px; margin-bottom: 25px;">
                            <div onclick="exploitFirewall('bypass')" style="background: rgba(230,126,34,0.2); border: 1px solid #e67e22; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #e67e22; font-weight: bold;"><i class="fas fa-route"></i> 繞過防火牆</div>
                                    <div style="color: #aaa; font-size: 0.9rem;">利用配置漏洞繞過防火牆規則</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #888; font-size: 0.85rem;">成功率: ${100 - defender.device.firewallLevel}%</div>
                                </div>
                            </div>
                            <div onclick="exploitFirewall('disable')" style="background: rgba(231,76,60,0.2); border: 1px solid #e74c3c; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #e74c3c; font-weight: bold;"><i class="fas fa-power-off"></i> 禁用防火牆</div>
                                    <div style="color: #aaa; font-size: 0.9rem;">發送特製封包強制關閉防火牆</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #888; font-size: 0.85rem;">需要: Root權限</div>
                                </div>
                            </div>
                            <div onclick="exploitFirewall('flood')" style="background: rgba(155,89,182,0.2); border: 1px solid #9b59b6; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #9b59b6; font-weight: bold;"><i class="fas fa-water"></i> 防火牆洪水攻擊</div>
                                    <div style="color: #aaa; font-size: 0.9rem;">發送大量請求使防火牆過載</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #ffaa00;">$5,000</div>
                                </div>
                            </div>
                        </div>

                        <!-- 端口利用 -->
                        <h3 style="color: #3498db; margin-bottom: 15px;"><i class="fas fa-door-open"></i> 端口漏洞利用</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px;">
                            ${defender.device.openPorts.map(port => `
                                <div onclick="exploitPort(${port})" style="background: rgba(52,152,219,0.2); border: 1px solid #3498db; border-radius: 8px; padding: 12px; cursor: pointer; text-align: center;">
                                    <div style="color: #3498db; font-weight: bold; font-size: 1.2rem;">端口 ${port}</div>
                                    <div style="color: #aaa; font-size: 0.8rem;">${getPortService(port)}</div>
                                    <div style="color: #00ff41; font-size: 0.75rem; margin-top: 5px;">點擊利用</div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- 高級入侵工具 -->
                        <h3 style="color: #00ff41; margin-bottom: 15px;"><i class="fas fa-tools"></i> 高級入侵工具</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px;">
                            <button onclick="executeAdvancedExploit('sql')" style="background: linear-gradient(135deg, rgba(46,204,113,0.3), rgba(39,174,96,0.3)); border: 1px solid #2ecc71; padding: 15px; border-radius: 8px; color: #2ecc71; cursor: pointer;">
                                <i class="fas fa-database" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">SQL注入</div>
                                <div style="font-size: 0.75rem; color: #888;">攻擊數據庫</div>
                            </button>
                            <button onclick="executeAdvancedExploit('xss')" style="background: linear-gradient(135deg, rgba(241,196,15,0.3), rgba(243,156,18,0.3)); border: 1px solid #f1c40f; padding: 15px; border-radius: 8px; color: #f1c40f; cursor: pointer;">
                                <i class="fas fa-code" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">XSS攻擊</div>
                                <div style="font-size: 0.75rem; color: #888;">跨站腳本</div>
                            </button>
                            <button onclick="executeAdvancedExploit('buffer')" style="background: linear-gradient(135deg, rgba(231,76,60,0.3), rgba(192,57,43,0.3)); border: 1px solid #e74c3c; padding: 15px; border-radius: 8px; color: #e74c3c; cursor: pointer;">
                                <i class="fas fa-memory" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">緩衝區溢出</div>
                                <div style="font-size: 0.75rem; color: #888;">記憶體攻擊</div>
                            </button>
                            <button onclick="executeAdvancedExploit('mitm')" style="background: linear-gradient(135deg, rgba(155,89,182,0.3), rgba(142,68,173,0.3)); border: 1px solid #9b59b6; padding: 15px; border-radius: 8px; color: #9b59b6; cursor: pointer;">
                                <i class="fas fa-user-secret" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">中間人攻擊</div>
                                <div style="font-size: 0.75rem; color: #888;">截獲通訊</div>
                            </button>
                        </div>

                        <div style="text-align: center;">
                            <button onclick="closeNetworkExploitPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }

        function closeNetworkExploitPanel() {
            const modal = document.getElementById('network-exploit-modal');
            if (modal) modal.remove();
        }

        function getPortService(port) {
            const services = {
                21: 'FTP 文件傳輸', 22: 'SSH 遠程連接', 23: 'Telnet 遠程登錄', 25: 'SMTP 郵件服務',
                53: 'DNS 域名服務', 80: 'HTTP 網頁服務', 110: 'POP3 郵件服務', 143: 'IMAP 郵件服務',
                443: 'HTTPS 安全網頁', 445: 'SMB 文件共享', 3306: 'MySQL 數據庫', 3389: 'RDP 遠程桌面',
                5432: 'PostgreSQL 數據庫', 8080: 'HTTP代理服務'
            };
            return services[port] || '未知服務';
        }

        function exploitVulnerability(vuln) {
            closeTargetIntelPanel();
            addTerminalLine('[漏洞利用] 正在利用漏洞: ' + vuln + '...', 'command');
            SoundSystem.play('attack');
            setTimeout(() => {
                const success = Math.random() > 0.3;
                if (success) {
                    addTerminalLine('✓ 成功利用漏洞 ' + vuln + '！', 'success');
                    addTerminalLine('已獲取部分系統權限...', 'warning');
                    GameState.stats.attackPower = Math.min(100, (GameState.stats.attackPower || 50) + 10);
                    SoundSystem.play('success');
                } else {
                    addTerminalLine('✗ 漏洞利用失敗，目標已修補此漏洞', 'error');
                    SoundSystem.play('error');
                }
            }, 2500);
        }

        function exploitFirewall(type) {
            closeNetworkExploitPanel();
            const types = { bypass: '繞過防火牆', disable: '禁用防火牆', flood: '洪水攻擊' };
            if (type === 'flood' && GameState.wallet.balance < 5000) {
                addTerminalLine('餘額不足！需要 $5,000', 'error');
                SoundSystem.play('error');
                return;
            }
            if (type === 'flood') GameState.wallet.balance -= 5000;
            addTerminalLine('[防火牆入侵] 正在執行' + types[type] + '...', 'command');
            SoundSystem.play('attack');
            setTimeout(() => {
                const defender = GameConfig.opponent.defender;
                const successRate = type === 'bypass' ? (100 - defender.device.firewallLevel) / 100 : type === 'flood' ? 0.8 : 0.4;
                const success = Math.random() < successRate;
                if (success) {
                    addTerminalLine('✓ ' + types[type] + '成功！', 'success');
                    if (type === 'disable' || type === 'flood') {
                        addTerminalLine('目標防火牆已被削弱！', 'warning');
                        GameConfig.opponent.defender.device.firewallLevel = Math.max(0, defender.device.firewallLevel - 30);
                    }
                    SoundSystem.play('success');
                } else {
                    addTerminalLine('✗ ' + types[type] + '失敗，防火牆仍在運作', 'error');
                    SoundSystem.play('error');
                }
            }, 3000);
        }

        function exploitPort(port) {
            closeNetworkExploitPanel();
            addTerminalLine('[端口利用] 正在攻擊端口 ' + port + ' (' + getPortService(port) + ')...', 'command');
            SoundSystem.play('attack');
            setTimeout(() => {
                const success = Math.random() > 0.35;
                if (success) {
                    addTerminalLine('✓ 成功入侵端口 ' + port + '！', 'success');
                    addTerminalLine('已建立 ' + getPortService(port) + ' 後門連接', 'warning');
                    SoundSystem.play('success');
                } else {
                    addTerminalLine('✗ 端口 ' + port + ' 受到保護，入侵失敗', 'error');
                    SoundSystem.play('error');
                }
            }, 2000);
        }

        function executeAdvancedExploit(type) {
            closeNetworkExploitPanel();
            const types = { sql: 'SQL注入攻擊', xss: 'XSS跨站腳本攻擊', buffer: '緩衝區溢出攻擊', mitm: '中間人攻擊' };
            addTerminalLine('[高級攻擊] 正在執行' + types[type] + '...', 'command');
            SoundSystem.play('attack');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 20;
                addTerminalLine('[攻擊進度] ' + progress + '%...', 'response');
                if (progress >= 100) {
                    clearInterval(interval);
                    const success = Math.random() > 0.25;
                    if (success) {
                        addTerminalLine('✓ ' + types[type] + '成功！', 'success');
                        addTerminalLine('已獲取目標系統敏感數據！', 'warning');
                        GameState.stats.attackPower = Math.min(100, (GameState.stats.attackPower || 50) + 15);
                        SoundSystem.play('success');
                    } else {
                        addTerminalLine('✗ ' + types[type] + '被防禦系統攔截', 'error');
                        SoundSystem.play('error');
                    }
                }
            }, 600);
        }

        // ===== 殺毒軟件面板 =====
        function showAntivirusPanel(mode) {
            const isHacker = mode === 'hacker';
            const av = GameState.antivirus;
            const color = isHacker ? '#00ff41' : '#ff3333';
            const bgColor = isHacker ? 'rgba(10,30,20,0.98)' : 'rgba(30,10,10,0.98)';

            const panelHTML = `
                <div class="modal-overlay" id="antivirus-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, ${bgColor} 0%, ${isHacker ? 'rgba(20,50,30,0.98)' : 'rgba(50,20,20,0.98)'} 100%); border: 2px solid ${color};">
                        <h2 style="color: ${color}; margin-bottom: 25px; text-align: center; text-shadow: 0 0 10px ${color}40;">
                            <i class="fas ${isHacker ? 'fa-shield-virus' : 'fa-virus-slash'}"></i> ${isHacker ? '🔒 精英殺毒系統 Pro Max' : '🛡️ 基礎殺毒軟件'}
                        </h2>

                        ${isHacker ? `
                        <div style="background: linear-gradient(135deg, rgba(0,255,65,0.15) 0%, rgba(0,100,40,0.2) 100%); border: 2px solid #00ff41; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                <i class="fas fa-crown" style="color: #ffd700; font-size: 2rem; animation: crownPulse 2s infinite;"></i>
                                <div>
                                    <div style="color: #00ff41; font-weight: bold; font-size: 1.2rem;">🏆 專業版 - 完整軍事級防護</div>
                                    <div style="color: #88ffaa; font-size: 0.9rem;">反追蹤 | 反監視 | 反勾線 | 零日漏洞修復</div>
                                </div>
                            </div>
                        </div>
                        <style>
                            @keyframes crownPulse {
                                0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px #ffd700); }
                                50% { transform: scale(1.1); filter: drop-shadow(0 0 15px #ffd700); }
                            }
                        </style>
                        ` : `
                        <div style="background: rgba(255,153,0,0.1); border: 1px solid #ff9900; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="color: #ff9900; font-size: 1.5rem;"></i>
                            <span style="color: #ff9900; font-weight: bold; margin-left: 10px;">基礎版 - 有限防護功能</span>
                            <div style="color: #888; font-size: 0.85rem; margin-top: 8px;">⚠️ 無法檢測高級威脅 | 更新延遲24小時</div>
                        </div>
                        `}

                        <!-- 狀態概覽 -->
                        <div style="display: grid; grid-template-columns: repeat(${isHacker ? '5' : '4'}, 1fr); gap: 12px; margin-bottom: 25px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid ${av.realTimeProtection ? '#00ff41' : '#ff3333'};">
                                <i class="fas fa-shield-alt" style="font-size: 1.8rem; color: ${av.realTimeProtection ? '#00ff41' : '#ff3333'};"></i>
                                <div style="color: #888; font-size: 0.75rem; margin-top: 8px;">實時保護</div>
                                <div style="color: ${av.realTimeProtection ? '#00ff41' : '#ff3333'}; font-weight: bold; font-size: 0.9rem;">${av.realTimeProtection ? '啟用' : '停用'}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid ${av.firewallActive ? '#00ff41' : '#ff3333'};">
                                <i class="fas fa-fire" style="font-size: 1.8rem; color: ${av.firewallActive ? '#00ff41' : '#ff3333'};"></i>
                                <div style="color: #888; font-size: 0.75rem; margin-top: 8px;">防火牆</div>
                                <div style="color: ${av.firewallActive ? '#00ff41' : '#ff3333'}; font-weight: bold; font-size: 0.9rem;">${av.firewallActive ? '啟用' : '停用'}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #9b59b6;">
                                <i class="fas fa-bug" style="font-size: 1.8rem; color: ${av.threatsFound.length > 0 ? '#ff3333' : '#00ff41'};"></i>
                                <div style="color: #888; font-size: 0.75rem; margin-top: 8px;">威脅數量</div>
                                <div style="color: ${av.threatsFound.length > 0 ? '#ff3333' : '#00ff41'}; font-weight: bold; font-size: 0.9rem;">${av.threatsFound.length}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #3498db;">
                                <i class="fas fa-percentage" style="font-size: 1.8rem; color: ${color};"></i>
                                <div style="color: #888; font-size: 0.75rem; margin-top: 8px;">防護等級</div>
                                <div style="color: ${color}; font-weight: bold; font-size: 0.9rem;">${isHacker ? '98%' : '65%'}</div>
                            </div>
                            ${isHacker ? `
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ffd700;">
                                <i class="fas fa-eye-slash" style="font-size: 1.8rem; color: #ffd700;"></i>
                                <div style="color: #888; font-size: 0.75rem; margin-top: 8px;">反追蹤</div>
                                <div style="color: #ffd700; font-weight: bold; font-size: 0.9rem;">✓ 啟用</div>
                            </div>
                            ` : ''}
                        </div>

                        <!-- 掃描功能 -->
                        <h3 style="color: ${color}; margin-bottom: 15px;"><i class="fas fa-search"></i> 掃描功能</h3>
                        <div style="display: grid; grid-template-columns: repeat(${isHacker ? '4' : '2'}, 1fr); gap: 12px; margin-bottom: 25px;">
                            <button onclick="runAntivirusScan('quick', '${mode}')" style="background: linear-gradient(135deg, rgba(52,152,219,0.3) 0%, rgba(41,128,185,0.3) 100%); border: 1px solid #3498db; padding: 18px; border-radius: 8px; color: #3498db; cursor: pointer;">
                                <i class="fas fa-bolt" style="font-size: 1.8rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold; font-size: 0.9rem;">快速掃描</div>
                                <div style="font-size: 0.75rem; color: #888;">~30秒</div>
                            </button>
                            <button onclick="runAntivirusScan('full', '${mode}')" style="background: linear-gradient(135deg, rgba(46,204,113,0.3) 0%, rgba(39,174,96,0.3) 100%); border: 1px solid #2ecc71; padding: 18px; border-radius: 8px; color: #2ecc71; cursor: pointer;">
                                <i class="fas fa-search-plus" style="font-size: 1.8rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold; font-size: 0.9rem;">完整掃描</div>
                                <div style="font-size: 0.75rem; color: #888;">~2分鐘</div>
                            </button>
                            ${isHacker ? `
                            <button onclick="runAntivirusScan('deep', '${mode}')" style="background: linear-gradient(135deg, rgba(155,89,182,0.3) 0%, rgba(142,68,173,0.3) 100%); border: 1px solid #9b59b6; padding: 18px; border-radius: 8px; color: #9b59b6; cursor: pointer;">
                                <i class="fas fa-microscope" style="font-size: 1.8rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold; font-size: 0.9rem;">深度掃描</div>
                                <div style="font-size: 0.75rem; color: #888;">隱藏威脅</div>
                            </button>
                            <button onclick="runAntivirusScan('rootkit', '${mode}')" style="background: linear-gradient(135deg, rgba(231,76,60,0.3) 0%, rgba(192,57,43,0.3) 100%); border: 1px solid #e74c3c; padding: 18px; border-radius: 8px; color: #e74c3c; cursor: pointer;">
                                <i class="fas fa-biohazard" style="font-size: 1.8rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold; font-size: 0.9rem;">Rootkit掃描</div>
                                <div style="font-size: 0.75rem; color: #888;">核心層檢測</div>
                            </button>
                            ` : ''}
                        </div>

                        ${isHacker ? `
                        <!-- 黑客專用功能 - 反追蹤 -->
                        <h3 style="color: #00ff41; margin-bottom: 15px;"><i class="fas fa-user-secret"></i> 🔐 反追蹤 & 反監視功能</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                            <button onclick="checkForTrackers()" style="background: rgba(255,51,51,0.2); border: 1px solid #ff3333; padding: 15px; border-radius: 8px; color: #ff3333; cursor: pointer;">
                                <i class="fas fa-eye-slash" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">檢測追蹤器</div>
                                <div style="font-size: 0.75rem; color: #888;">掃描監視軟件</div>
                            </button>
                            <button onclick="checkForBackdoors()" style="background: rgba(255,153,0,0.2); border: 1px solid #ff9900; padding: 15px; border-radius: 8px; color: #ff9900; cursor: pointer;">
                                <i class="fas fa-door-closed" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">檢測後門</div>
                                <div style="font-size: 0.75rem; color: #888;">反入侵檢查</div>
                            </button>
                            <button onclick="checkForWiretapping()" style="background: rgba(155,89,182,0.2); border: 1px solid #9b59b6; padding: 15px; border-radius: 8px; color: #9b59b6; cursor: pointer;">
                                <i class="fas fa-phone-slash" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">反勾線檢測</div>
                                <div style="font-size: 0.75rem; color: #888;">通訊監聽掃描</div>
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px;">
                            <button onclick="blockRemoteAccess()" style="background: rgba(231,76,60,0.2); border: 1px solid #e74c3c; padding: 15px; border-radius: 8px; color: #e74c3c; cursor: pointer;">
                                <i class="fas fa-ban" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">阻止遠程訪問</div>
                                <div style="font-size: 0.75rem; color: #888;">封鎖外部連接</div>
                            </button>
                            <button onclick="encryptCommunications()" style="background: rgba(0,255,65,0.2); border: 1px solid #00ff41; padding: 15px; border-radius: 8px; color: #00ff41; cursor: pointer;">
                                <i class="fas fa-lock" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">加密通訊</div>
                                <div style="font-size: 0.75rem; color: #888;">端對端加密</div>
                            </button>
                            <button onclick="activateGhostMode()" style="background: rgba(52,152,219,0.2); border: 1px solid #3498db; padding: 15px; border-radius: 8px; color: #3498db; cursor: pointer;">
                                <i class="fas fa-ghost" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">幽靈模式</div>
                                <div style="font-size: 0.75rem; color: #888;">隱形上網</div>
                            </button>
                        </div>

                        <!-- 高級安全工具 -->
                        <h3 style="color: #ffd700; margin-bottom: 15px;"><i class="fas fa-tools"></i> ⚙️ 高級安全工具</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px;">
                            <button onclick="cleanAllTraces()" style="background: linear-gradient(135deg, rgba(231,76,60,0.3) 0%, rgba(192,57,43,0.3) 100%); border: 1px solid #e74c3c; padding: 15px; border-radius: 8px; color: #e74c3c; cursor: pointer;">
                                <i class="fas fa-broom" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">清除所有痕跡</div>
                                <div style="font-size: 0.75rem; color: #888;">日誌 | 緩存 | Cookie | 歷史</div>
                            </button>
                            <button onclick="secureWipeMemory()" style="background: linear-gradient(135deg, rgba(155,89,182,0.3) 0%, rgba(142,68,173,0.3) 100%); border: 1px solid #9b59b6; padding: 15px; border-radius: 8px; color: #9b59b6; cursor: pointer;">
                                <i class="fas fa-memory" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">安全擦除記憶體</div>
                                <div style="font-size: 0.75rem; color: #888;">防止記憶體取證</div>
                            </button>
                            <button onclick="spoofHardwareID()" style="background: linear-gradient(135deg, rgba(46,204,113,0.3) 0%, rgba(39,174,96,0.3) 100%); border: 1px solid #2ecc71; padding: 15px; border-radius: 8px; color: #2ecc71; cursor: pointer;">
                                <i class="fas fa-fingerprint" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">硬件ID偽造</div>
                                <div style="font-size: 0.75rem; color: #888;">MAC地址 | 序列號</div>
                            </button>
                            <button onclick="virtualMachineEscape()" style="background: linear-gradient(135deg, rgba(52,152,219,0.3) 0%, rgba(41,128,185,0.3) 100%); border: 1px solid #3498db; padding: 15px; border-radius: 8px; color: #3498db; cursor: pointer;">
                                <i class="fas fa-cube" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">VM環境檢測</div>
                                <div style="font-size: 0.75rem; color: #888;">虛擬機安全檢查</div>
                            </button>
                        </div>
                        ` : `
                        <!-- 防禦者基礎功能 -->
                        <h3 style="color: #ff9900; margin-bottom: 15px;"><i class="fas fa-shield-alt"></i> 基礎防護工具</h3>
                        <div style="background: rgba(255,51,51,0.1); border: 1px dashed #ff3333; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <p style="color: #ff6666; margin: 0; text-align: center;">
                                <i class="fas fa-lock"></i> 進階功能需升級至專業版
                            </p>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px;">
                            <button onclick="basicVirusScan()" style="background: rgba(46,204,113,0.2); border: 1px solid #2ecc71; padding: 15px; border-radius: 8px; color: #2ecc71; cursor: pointer;">
                                <i class="fas fa-virus-slash" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">病毒查殺</div>
                            </button>
                            <button onclick="updateVirusDatabase()" style="background: rgba(52,152,219,0.2); border: 1px solid #3498db; padding: 15px; border-radius: 8px; color: #3498db; cursor: pointer;">
                                <i class="fas fa-database" style="font-size: 1.5rem;"></i>
                                <div style="margin-top: 8px; font-weight: bold;">更新病毒庫</div>
                            </button>
                        </div>
                        `}

                        <div style="text-align: center;">
                            <button onclick="closeAntivirusPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }

        // 新增黑客專用反追蹤功能
        function checkForWiretapping() {
            addTerminalLine('[反勾線] 正在掃描通訊監聽設備...', 'system');
            SoundSystem.play('attack');
            setTimeout(() => {
                addTerminalLine('✓ 掃描網絡數據包...', 'response');
                setTimeout(() => {
                    addTerminalLine('✓ 檢測異常流量...', 'response');
                    setTimeout(() => {
                        addTerminalLine('✓ 分析加密通道...', 'response');
                        setTimeout(() => {
                            addTerminalLine('✓ 未發現第三方勾線或監視', 'success');
                            addTerminalLine('✓ 通訊線路安全', 'success');
                            SoundSystem.play('success');
                        }, 800);
                    }, 800);
                }, 800);
            }, 1000);
        }

        function activateGhostMode() {
            addTerminalLine('[幽靈模式] 正在啟動隱形上網...', 'system');
            SoundSystem.play('attack');
            setTimeout(() => {
                GameState.stats.stealthLevel = Math.min(100, (GameState.stats.stealthLevel || 50) + 30);
                GameState.stats.detectionRisk = Math.max(0, (GameState.stats.detectionRisk || 30) - 20);
                updateStatsDisplay('hacker');
                addTerminalLine('✓ 幽靈模式已啟動', 'success');
                addTerminalLine('✓ 所有網絡活動已匿名化', 'success');
                addTerminalLine('✓ 瀏覽器指紋已隨機化', 'success');
                SoundSystem.play('success');
            }, 2000);
        }

        function cleanAllTraces() {
            addTerminalLine('[清除痕跡] 開始安全擦除...', 'system');
            SoundSystem.play('attack');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 20;
                if (progress <= 100) {
                    addTerminalLine(`[清除] 進度: ${progress}%`, 'response');
                }
                if (progress >= 100) {
                    clearInterval(interval);
                    addTerminalLine('✓ 瀏覽歷史已清除', 'success');
                    addTerminalLine('✓ Cookie已清除', 'success');
                    addTerminalLine('✓ 緩存已清除', 'success');
                    addTerminalLine('✓ 系統日誌已清除', 'success');
                    addTerminalLine('✓ DNS緩存已刷新', 'success');
                    SoundSystem.play('success');
                }
            }, 500);
        }

        function secureWipeMemory() {
            addTerminalLine('[記憶體擦除] 正在安全清除RAM...', 'system');
            SoundSystem.play('attack');
            setTimeout(() => {
                addTerminalLine('✓ 敏感數據已從記憶體中移除', 'success');
                addTerminalLine('✓ 已防止冷啟動攻擊', 'success');
                SoundSystem.play('success');
            }, 2000);
        }

        function spoofHardwareID() {
            const newMAC = Array(6).fill(0).map(() => Math.floor(Math.random() * 256).toString(16).padStart(2, '0')).join(':').toUpperCase();
            addTerminalLine('[硬件偽造] 正在生成新硬件ID...', 'system');
            SoundSystem.play('attack');
            setTimeout(() => {
                addTerminalLine(`✓ 新MAC地址: ${newMAC}`, 'success');
                addTerminalLine('✓ 硬件序列號已偽造', 'success');
                addTerminalLine('✓ BIOS指紋已隨機化', 'success');
                SoundSystem.play('success');
            }, 1500);
        }

        function virtualMachineEscape() {
            addTerminalLine('[VM檢測] 正在分析運行環境...', 'system');
            SoundSystem.play('attack');
            setTimeout(() => {
                addTerminalLine('✓ 未檢測到虛擬機環境', 'success');
                addTerminalLine('✓ 未檢測到沙盒環境', 'success');
                addTerminalLine('✓ 未檢測到調試器', 'success');
                addTerminalLine('✓ 運行環境安全', 'success');
                SoundSystem.play('success');
            }, 2000);
        }

        // 防禦者基礎殺毒功能
        function basicVirusScan() {
            addTerminalLine('[基礎掃描] 正在掃描常見威脅...', 'system');
            SoundSystem.play('attack');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 15;
                if (progress <= 100) {
                    addTerminalLine(`[掃描] 進度: ${progress}%`, 'response');
                }
                if (progress >= 100) {
                    clearInterval(interval);
                    const threats = Math.floor(Math.random() * 3);
                    if (threats > 0) {
                        GameState.antivirus.threatsFound = Array(threats).fill(null).map((_, i) => `Threat_${Date.now()}_${i}`);
                        addTerminalLine(`⚠️ 發現 ${threats} 個威脅`, 'warning');
                        addTerminalLine('建議：升級至專業版以獲得更好的防護', 'system');
                    } else {
                        addTerminalLine('✓ 未發現已知威脅', 'success');
                    }
                    SoundSystem.play('success');
                }
            }, 600);
        }

        function updateVirusDatabase() {
            addTerminalLine('[更新] 正在連接更新服務器...', 'system');
            SoundSystem.play('attack');
            setTimeout(() => {
                addTerminalLine('⚠️ 基礎版更新延遲24小時', 'warning');
                addTerminalLine('✓ 病毒庫已更新至昨日版本', 'success');
                addTerminalLine('提示：專業版可獲得即時更新', 'system');
                SoundSystem.play('success');
            }, 2000);
        }

        function closeAntivirusPanel() {
            const modal = document.getElementById('antivirus-modal');
            if (modal) modal.remove();
        }

        function runAntivirusScan(type, mode) {
            closeAntivirusPanel();
            const scanNames = { quick: '快速', full: '完整', deep: '深度' };
            addTerminalLine(`[殺毒] 開始${scanNames[type]}掃描...`, 'system');
            SoundSystem.play('attack');

            const duration = type === 'quick' ? 3 : type === 'full' ? 6 : 10;
            let progress = 0;

            const scanInterval = setInterval(() => {
                progress += 10;
                addTerminalLine(`[掃描] 進度: ${progress}%`, 'response');

                if (progress >= 100) {
                    clearInterval(scanInterval);
                    GameState.antivirus.lastScan = new Date().toISOString();

                    const threats = mode === 'hacker' ? Math.floor(Math.random() * 2) : Math.floor(Math.random() * 5);
                    if (threats > 0) {
                        GameState.antivirus.threatsFound = Array(threats).fill(null).map((_, i) => `Threat_${Date.now()}_${i}`);
                        addTerminalLine(`⚠️ 發現 ${threats} 個威脅！`, 'warning');
                    } else {
                        addTerminalLine('✓ 系統安全，未發現威脅', 'success');
                    }
                    SoundSystem.play('success');
                }
            }, duration * 100);
        }

        function checkForTrackers() {
            addTerminalLine('[反追蹤] 正在檢測追蹤器...', 'system');
            setTimeout(() => {
                addTerminalLine('✓ 未發現追蹤器或監視軟件', 'success');
                addTerminalLine('✓ 裝置未被第三方勾線', 'success');
                SoundSystem.play('success');
            }, 2000);
        }

        function checkForBackdoors() {
            addTerminalLine('[安全] 正在檢測後門程序...', 'system');
            setTimeout(() => {
                addTerminalLine('✓ 未發現後門程序', 'success');
                addTerminalLine('✓ 系統入口安全', 'success');
                SoundSystem.play('success');
            }, 2000);
        }

        function blockRemoteAccess() {
            addTerminalLine('[防護] 正在阻止遠程訪問...', 'system');
            setTimeout(() => {
                addTerminalLine('✓ 已阻止所有未授權遠程連接', 'success');
                SoundSystem.play('success');
            }, 1500);
        }

        function encryptCommunications() {
            addTerminalLine('[加密] 正在加密通訊頻道...', 'system');
            setTimeout(() => {
                addTerminalLine('✓ 已啟用端對端加密', 'success');
                addTerminalLine('✓ 通訊安全等級: 軍事級', 'success');
                SoundSystem.play('success');
            }, 1500);
        }

        // ===== 裝置狀態面板 =====
        function showDeviceStatusPanel(mode) {
            const device = GameState.deviceStatus;
            const isHacker = mode === 'hacker';
            const color = isHacker ? '#00ff41' : '#ff3333';
            const opponentDevice = isHacker ? GameConfig.opponent.defender.device : GameConfig.opponent.hacker.device;

            const panelHTML = `
                <div class="modal-overlay" id="device-status-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(20,20,30,0.98) 0%, rgba(40,40,60,0.98) 100%); border: 2px solid ${color};">
                        <h2 style="color: ${color}; margin-bottom: 25px; text-align: center;">
                            <i class="fas fa-desktop"></i> 裝置狀態監控
                        </h2>

                        <!-- 我的裝置 -->
                        <h3 style="color: ${color}; margin-bottom: 15px;"><i class="fas fa-laptop"></i> 我的裝置</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: ${device.cpu > 80 ? '#ff3333' : device.cpu > 60 ? '#ffaa00' : '#00ff41'}; font-size: 2rem; font-weight: bold;">${device.cpu}%</div>
                                <div style="color: #888; font-size: 0.9rem;"><i class="fas fa-microchip"></i> CPU</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: ${device.memory > 80 ? '#ff3333' : device.memory > 60 ? '#ffaa00' : '#00ff41'}; font-size: 2rem; font-weight: bold;">${device.memory}%</div>
                                <div style="color: #888; font-size: 0.9rem;"><i class="fas fa-memory"></i> 記憶體</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: ${device.disk > 90 ? '#ff3333' : device.disk > 70 ? '#ffaa00' : '#00ff41'}; font-size: 2rem; font-weight: bold;">${device.disk}%</div>
                                <div style="color: #888; font-size: 0.9rem;"><i class="fas fa-hdd"></i> 硬碟</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #00ff41; font-size: 2rem; font-weight: bold;">${device.network}%</div>
                                <div style="color: #888; font-size: 0.9rem;"><i class="fas fa-wifi"></i> 網絡</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: ${device.temperature > 70 ? '#ff3333' : device.temperature > 55 ? '#ffaa00' : '#00ff41'}; font-size: 1.5rem;">${device.temperature}°C</div>
                                <div style="color: #888; font-size: 0.8rem;"><i class="fas fa-thermometer-half"></i> 溫度</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #3498db; font-size: 1.5rem;">${device.processes}</div>
                                <div style="color: #888; font-size: 0.8rem;"><i class="fas fa-cogs"></i> 進程</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #9b59b6; font-size: 1.5rem;">${device.connections}</div>
                                <div style="color: #888; font-size: 0.8rem;"><i class="fas fa-plug"></i> 連接</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: ${device.threats > 0 ? '#ff3333' : '#00ff41'}; font-size: 1.5rem;">${device.threats}</div>
                                <div style="color: #888; font-size: 0.8rem;"><i class="fas fa-bug"></i> 威脅</div>
                            </div>
                        </div>

                        <!-- 對方裝置 (模擬) -->
                        <h3 style="color: ${isHacker ? '#ff3333' : '#00ff41'}; margin-bottom: 15px;"><i class="fas fa-server"></i> ${isHacker ? '目標裝置' : '攻擊者裝置'} (AI模擬)</h3>
                        <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; border: 1px solid ${isHacker ? '#ff3333' : '#00ff41'}; margin-bottom: 25px;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div>
                                    <span style="color: #888;">操作系統:</span>
                                    <span style="color: #fff; margin-left: 10px;">${opponentDevice.os}</span>
                                </div>
                                <div>
                                    <span style="color: #888;">硬件:</span>
                                    <span style="color: #fff; margin-left: 10px;">${opponentDevice.hardware}</span>
                                </div>
                                <div>
                                    <span style="color: #888;">防火牆:</span>
                                    <span style="color: ${opponentDevice.firewallLevel > 70 ? '#00ff41' : '#ffaa00'}; margin-left: 10px;">${opponentDevice.firewallLevel}%</span>
                                </div>
                                <div>
                                    <span style="color: #888;">殺毒:</span>
                                    <span style="color: ${opponentDevice.antivirusLevel > 70 ? '#00ff41' : '#ffaa00'}; margin-left: 10px;">${opponentDevice.antivirusLevel}%</span>
                                </div>
                                <div>
                                    <span style="color: #888;">VPN:</span>
                                    <span style="color: ${opponentDevice.vpnActive ? '#00ff41' : '#ff3333'}; margin-left: 10px;">${opponentDevice.vpnActive ? '啟用' : '未啟用'}</span>
                                </div>
                                ${opponentDevice.torActive ? `
                                <div>
                                    <span style="color: #888;">Tor:</span>
                                    <span style="color: #00ff41; margin-left: 10px;">啟用</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <button onclick="closeDeviceStatusPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }

        function closeDeviceStatusPanel() {
            const modal = document.getElementById('device-status-modal');
            if (modal) modal.remove();
        }

        // ===== IP追蹤面板 =====
        function showIPTrackingPanel() {
            const tracking = GameState.ipTracking;
            const defender = GameConfig.opponent.defender;

            const panelHTML = `
                <div class="modal-overlay" id="ip-tracking-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 700px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(20,10,5,0.98) 0%, rgba(50,25,10,0.98) 100%); border: 2px solid #e67e22;">
                        <h2 style="color: #e67e22; margin-bottom: 25px; text-align: center; text-shadow: 0 0 10px rgba(230,126,34,0.5);">
                            <i class="fas fa-crosshairs"></i> IP追蹤系統
                        </h2>

                        <!-- 目標信息 -->
                        <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e67e22;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="color: #888;">目標公網IP</div>
                                    <div style="color: #e67e22; font-size: 1.3rem; font-weight: bold;">${defender.network.publicIP}</div>
                                </div>
                                <div>
                                    <div style="color: #888;">VPN狀態</div>
                                    <div style="color: ${defender.device.vpnActive ? '#ffaa00' : '#00ff41'}; font-size: 1.1rem;">${defender.device.vpnActive ? '已啟用 (需繞過)' : '未啟用 (可直接追蹤)'}</div>
                                </div>
                            </div>
                        </div>

                        <!-- 追蹤進度 -->
                        ${tracking.isTracking ? `
                        <div style="background: rgba(230,126,34,0.2); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e67e22;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #e67e22;">追蹤進度</span>
                                <span style="color: #fff;">${tracking.progress}%</span>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #e67e22, #f39c12); height: 100%; width: ${tracking.progress}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="color: #888; margin-top: 10px; text-align: center;">預計剩餘時間: ${tracking.estimatedTime} 秒</div>
                        </div>
                        ` : ''}

                        <!-- 追蹤選項 -->
                        <h3 style="color: #e67e22; margin-bottom: 15px;"><i class="fas fa-route"></i> 追蹤方法</h3>
                        <div style="display: grid; gap: 15px; margin-bottom: 25px;">
                            <div onclick="startIPTracking('basic')" style="background: rgba(46,204,113,0.2); border: 1px solid #2ecc71; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #2ecc71; font-weight: bold;">🔍 基礎追蹤</div>
                                    <div style="color: #aaa; font-size: 0.9rem;">透過DNS和WHOIS查詢</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #888;">時間: ~30秒</div>
                                    <div style="color: #00ff41;">免費</div>
                                </div>
                            </div>
                            <div onclick="startIPTracking('advanced')" style="background: rgba(230,126,34,0.2); border: 1px solid #e67e22; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #e67e22; font-weight: bold;">⚡ 進階追蹤</div>
                                    <div style="color: #aaa; font-size: 0.9rem;">繞過VPN層，追蹤真實IP</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #888;">時間: ~${defender.device.vpnActive ? '2分鐘' : '45秒'}</div>
                                    <div style="color: #ffaa00;">$15,000</div>
                                </div>
                            </div>
                            <div onclick="startIPTracking('elite')" style="background: rgba(155,89,182,0.2); border: 1px solid #9b59b6; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #9b59b6; font-weight: bold;">🎯 精準追蹤</div>
                                    <div style="color: #aaa; font-size: 0.9rem;">獲取完整地理位置和ISP信息</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #888;">時間: ~${defender.device.vpnActive ? '3分鐘' : '1分鐘'}</div>
                                    <div style="color: #ff3333;">$50,000</div>
                                </div>
                            </div>
                        </div>

                        <!-- 已追蹤IP記錄 -->
                        ${tracking.trackedIPs.length > 0 ? `
                        <h3 style="color: #e67e22; margin-bottom: 15px;"><i class="fas fa-history"></i> 追蹤記錄</h3>
                        <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; margin-bottom: 20px; max-height: 150px; overflow-y: auto;">
                            ${tracking.trackedIPs.map(ip => `
                                <div style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); color: #fff;">
                                    <i class="fas fa-map-marker-alt" style="color: #e67e22;"></i> ${ip}
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}

                        <div style="text-align: center;">
                            <button onclick="closeIPTrackingPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }

        function closeIPTrackingPanel() {
            const modal = document.getElementById('ip-tracking-modal');
            if (modal) modal.remove();
        }

        function startIPTracking(level) {
            const costs = { basic: 0, advanced: 15000, elite: 50000 };
            const cost = costs[level];

            if (cost > 0 && GameState.wallet.balance < cost) {
                addTerminalLine('餘額不足！', 'error');
                SoundSystem.play('error');
                return;
            }

            if (cost > 0) {
                GameState.wallet.balance -= cost;
            }

            closeIPTrackingPanel();

            const defender = GameConfig.opponent.defender;
            const hasVPN = defender.device.vpnActive;
            const baseTimes = { basic: 30, advanced: hasVPN ? 120 : 45, elite: hasVPN ? 180 : 60 };
            const trackingTime = baseTimes[level];

            GameState.ipTracking.isTracking = true;
            GameState.ipTracking.progress = 0;
            GameState.ipTracking.estimatedTime = trackingTime;

            addTerminalLine(`[追蹤] 開始${level === 'basic' ? '基礎' : level === 'advanced' ? '���階' : '精準'}IP追蹤...`, 'command');
            SoundSystem.play('attack');

            const trackInterval = setInterval(() => {
                GameState.ipTracking.progress += 5;
                GameState.ipTracking.estimatedTime = Math.max(0, GameState.ipTracking.estimatedTime - (trackingTime * 0.05));

                if (GameState.ipTracking.progress % 20 === 0) {
                    addTerminalLine(`[追蹤] 進度: ${GameState.ipTracking.progress}%`, 'response');
                }

                if (GameState.ipTracking.progress >= 100) {
                    clearInterval(trackInterval);
                    GameState.ipTracking.isTracking = false;

                    const trackedIP = level === 'basic' ? defender.network.publicIP :
                                      level === 'advanced' ? `${defender.network.publicIP} (真實IP確認)` :
                                      `${defender.network.publicIP} - ${defender.profile.officeAddress}`;

                    GameState.ipTracking.trackedIPs.push(trackedIP);

                    if (level === 'elite') {
                        GameState.ipTracking.realIPDiscovered = true;
                    }

                    addTerminalLine(`✓ IP追蹤完成！`, 'success');
                    addTerminalLine(`目標位置: ${trackedIP}`, 'success');
                    SoundSystem.play('success');
                    showNotification('追蹤成功', `已成功追蹤目標IP: ${defender.network.publicIP}`, 'hacker');
                }
            }, trackingTime * 50);
        }

        // ===== 釣魚連結面板 =====
        function showPhishingPanel() {
            const phishing = GameState.phishingLinks;
            const panelHTML = `
                <div class="modal-overlay" id="phishing-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 700px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(30,10,10,0.98) 0%, rgba(60,20,20,0.98) 100%); border: 2px solid #c0392b;">
                        <h2 style="color: #c0392b; margin-bottom: 25px; text-align: center; text-shadow: 0 0 10px rgba(192,57,43,0.5);">
                            <i class="fas fa-fish"></i> 虛假連結生成器
                        </h2>

                        <div style="background: rgba(255,153,0,0.1); border: 1px solid #ff9900; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <p style="color: #ff9900; text-align: center; margin: 0;">
                                <i class="fas fa-exclamation-triangle"></i> 生成虛假連結誘騙目標點擊
                            </p>
                        </div>

                        <!-<!-- 模式功能介紹 -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 20px;">
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #c0392b;">
                                <div style="color: #c0392b; font-size: 2rem; font-weight: bold;">${phishing.created.length}</div>
                                <div style="color: #888;">已創建</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #00ff41;">
                                <div style="color: #00ff41; font-size: 2rem; font-weight: bold;">${phishing.clicked}</div>
                                <div style="color: #888;">已點擊</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #9b59b6;">
                                <div style="color: #9b59b6; font-size: 2rem; font-weight: bold;">${phishing.successRate}%</div>
                                <div style="color: #888;">成功率</div>
                            </div>
                        </div>

                        <!-- 創建選項 -->
                        <h3 style="color: #c0392b; margin-bottom: 15px;"><i class="fas fa-link"></i> 創建釣魚連結</h3>
                        <div style="display: grid; gap: 15px; margin-bottom: 25px;">
                            <div onclick="createPhishingLink('login')" style="background: rgba(52,152,219,0.2); border: 1px solid #3498db; border-radius: 8px; padding: 15px; cursor: pointer;">
                                <div style="color: #3498db; font-weight: bold;"><i class="fas fa-sign-in-alt"></i> 虛假登入頁面</div>
                                <div style="color: #aaa; font-size: 0.9rem;">偽裝成銀行/社交媒體登入頁</div>
                            </div>
                            <div onclick="createPhishingLink('download')" style="background: rgba(46,204,113,0.2); border: 1px solid #2ecc71; border-radius: 8px; padding: 15px; cursor: pointer;">
                                <div style="color: #2ecc71; font-weight: bold;"><i class="fas fa-download"></i> 惡意下載連結</div>
                                <div style="color: #aaa; font-size: 0.9rem;">偽裝成軟件更新或免費工具</div>
                            </div>
                            <div onclick="createPhishingLink('email')" style="background: rgba(155,89,182,0.2); border: 1px solid #9b59b6; border-radius: 8px; padding: 15px; cursor: pointer;">
                                <div style="color: #9b59b6; font-weight: bold;"><i class="fas fa-envelope"></i> 釣魚郵件模板</div>
                                <div style="color: #aaa; font-size: 0.9rem;">發送帶有惡意連結的郵件</div>
                            </div>
                            <div onclick="createPhishingLink('drive')" style="background: rgba(192,57,43,0.2); border: 1px solid #c0392b; border-radius: 8px; padding: 15px; cursor: pointer;">
                                <div style="color: #c0392b; font-weight: bold;"><i class="fas fa-virus"></i> 隱蔽式攻擊連結</div>
                                <div style="color: #aaa; font-size: 0.9rem;">無需點擊即可執行的惡意代碼</div>
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <button onclick="closePhishingPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }

        function closePhishingPanel() {
            const modal = document.getElementById('phishing-modal');
            if (modal) modal.remove();
        }

        function createPhishingLink(type) {
            const types = {
                login: '虛假登入頁面',
                download: '惡意下載連結',
                email: '釣魚郵件',
                drive: '隱蔽式攻擊'
            };

            closePhishingPanel();
            addTerminalLine(`[釣魚] 正在生成${types[type]}...`, 'system');
            SoundSystem.play('attack');

            setTimeout(() => {
                const fakeUrl = `https://secure-${Math.random().toString(36).substr(2, 8)}.com/${type}`;
                GameState.phishingLinks.created.push({ type, url: fakeUrl, created: new Date().toISOString() });

                addTerminalLine(`✓ 釣魚連結已創建: ${fakeUrl}`, 'success');
                addTerminalLine('正在向目標發送連結...', 'system');

                // 模擬目標點擊
                setTimeout(() => {
                    const clicked = Math.random() > 0.4; // 60%點擊率
                    if (clicked) {
                        GameState.phishingLinks.clicked++;
                        GameState.phishingLinks.successRate = Math.round((GameState.phishingLinks.clicked / GameState.phishingLinks.created.length) * 100);
                        addTerminalLine('🎯 目標已點擊連結！', 'success');
                        addTerminalLine('正在收集目標資訊...', 'warning');

                        if (type === 'login') {
                            addTerminalLine('✓ 已獲取登入憑證', 'success');
                        } else if (type === 'download') {
                            addTerminalLine('✓ 惡意程序已植入目標系統', 'success');
                        }
                        SoundSystem.play('success');
                    } else {
                        addTerminalLine('⚠️ 目標未點擊連結', 'warning');
                    }
                }, 3000);
            }, 2000);
        }

        // ===== 防禦者第三方支援面板 =====
        function showThirdPartySupportPanel() {
            const panelHTML = `
                <div class="modal-overlay" id="third-party-support-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 750px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(10,30,30,0.98) 0%, rgba(20,60,60,0.98) 100%); border: 2px solid #4a90d9;">
                        <h2 style="color: #4a90d9; margin-bottom: 25px; text-align: center; text-shadow: 0 0 10px rgba(74,144,217,0.5);">
                            <i class="fas fa-handshake"></i> 尋求第三方支援
                        </h2>

                        <p style="color: #ccc; margin-bottom: 20px; text-align: center; line-height: 1.8;">
                            當黑客攻擊難以抵擋時，你可以選擇尋求外部專業力量的協助。
                            不同的選項將帶來不同的結果和時間延遲。
                        </p>

                        <!-- 支援選項 -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                            <!-- 尋求專業人士協助 -->
                            <button onclick="requestSupport('professional')" style="background: linear-gradient(135deg, rgba(74,144,217,0.3) 0%, rgba(52,152,219,0.3) 100%); border: 2px solid #3498db; padding: 20px; border-radius: 8px; color: #3499db; cursor: pointer; text-align: left; transition: all 0.3s; hover: border-color: #2980b9;">
                                <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 8px;"><i class="fas fa-user-tie"></i> 尋求專業人士協助</div>
                                <div style="font-size: 0.9rem; color: #aaa; line-height: 1.6;">
                                    <strong>效果:</strong> 防禦力+30%，反擊力+20%，檢測率+25%<br>
                                    <strong>時間:</strong> 1分鐘內到達<br>
                                    <strong>成本:</strong> $50,000<br>
                                    <strong>成功率:</strong> 95%
                                </div>
                            </button>

                            <!-- 報案給執法部門 -->
                            <button onclick="requestSupport('police')" style="background: linear-gradient(135deg, rgba(231,76,60,0.3) 0%, rgba(192,57,43,0.3) 100%); border: 2px solid #e74c3c; padding: 20px; border-radius: 8px; color: #e74c3c; cursor: pointer; text-align: left; transition: all 0.3s; hover: border-color: #c0392b;">
                                <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 8px;"><i class="fas fa-gavel"></i> 報案給執法部門</div>
                                <div style="font-size: 0.9rem; color: #aaa; line-height: 1.6;">
                                    <strong>效果:</strong> 黑客隱藏等級-50%，檢測能力+40%<br>
                                    <strong>時間:</strong> 3分鐘內介入<br>
                                    <strong>成本:</strong> 免費<br>
                                    <strong>成功率:</strong> 85%
                                </div>
                            </button>
                        </div>

                        <!-- 額外支援選項 -->
                        <div style="background: rgba(0,0,0,0.3); border: 1px solid #555; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="color: #f39c12; margin-top: 0; margin-bottom: 10px;">
                                <i class="fas fa-plus-circle"></i> 額外支援選項
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <button onclick="requestSupport('cyber_security')" style="background: #3498db; border: 2px solid #2980b9; padding: 10px; border-radius: 4px; color: #fff; font-weight: bold; cursor: pointer; font-size: 0.9rem;">
                                    🔐 網絡安全專家
                                </button>
                                <button onclick="requestSupport('forensics')" style="background: #2ecc71; border: 2px solid #27ae60; padding: 10px; border-radius: 4px; color: #fff; font-weight: bold; cursor: pointer; font-size: 0.9rem;">
                                    🔬 數字取證團隊
                                </button>
                                <button onclick="requestSupport('military')" style="background: rgba(231,76,60,0.2); border: 1px solid #e74c3c; padding: 10px; border-radius: 4px; color: #e74c3c; cursor: pointer; font-size: 0.9rem;">
                                    🎖️ 軍事網絡部隊
                                </button>
                                <button onclick="requestSupport('interpol')" style="background: rgba(155,89,182,0.2); border: 1px solid #9b59b6; padding: 10px; border-radius: 4px; color: #9b59b6; cursor: pointer; font-size: 0.9rem;">
                                    🌍 國際刑警組織
                                </button>
                            </div>
                        </div>

                        <!-- 報案資料模擬 -->
                        <div style="background: rgba(0,0,0,0.4); border: 1px solid #666; padding: 20px; border-radius: 10px;">
                            <h3 style="color: #ff9900; margin-bottom: 15px;"><i class="fas fa-file-alt"></i> 模擬報案資料</h3>
                            <div style="color: #aaa; font-size: 0.9rem; line-height: 1.8;">
                                <p><strong>案件編號:</strong> #CYBER-${Math.floor(Math.random() * 90000) + 10000}</p>
                                <p><strong>攻擊者IP:</strong> <span id="report-hacker-ip">${GameState.battle.targetIP}</span></p>
                                <p><strong>系統狀態:</strong> <span id="report-system-status">系統完整性 ${GameState.stats.systemHealth}%</span></p>
                                <p><strong>攻擊類型:</strong> 權限爭奪、數據竊取</p>
                                <p><strong>報案時間:</strong> ${new Date().toLocaleTimeString()}</p>
                            </div>
                            <button id="btn-send-report" onclick="sendReport()" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); border: none; padding: 10px 20px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold; margin-top: 15px;">
                                <i class="fas fa-paper-plane"></i> 模擬傳送報案資料
                            </button>
                            <div id="report-status" style="color: #ff9900; margin-top: 10px; font-size: 0.9rem;"></div>
                        </div>

                        <!-- 按鈕組 -->
                        <div style="text-align: center; margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                            <button onclick="showLawEnforcementPanel()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-police-box"></i> 查看執法部門面板
                            </button>
                            <button onclick="closeThirdPartySupportPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', panelHTML);
            document.getElementById('btn-send-report').disabled = GameState.battle.reportSent;
            document.getElementById('report-status').textContent = GameState.battle.reportSent ? '✓ 報案資料已傳送' : '';
        }

        function closeThirdPartySupportPanel() {
            const modal = document.getElementById('third-party-support-modal');
            if (modal) modal.remove();
        }

        function requestSupport(type) {
            closeThirdPartySupportPanel();
            let message = '';
            let delay = 0;
            let effect = '';
            let supportType = '';

            const supportTypes = {
                'professional': {
                    name: '專業人士',
                    message: '✓ 已聯繫網絡安全專業人士，他們將在1分鐘內到達並提供協助。',
                    delay: 60000,
                    effect: '防禦力+30%，反擊力+20%，系統健康+15%，檢測率+25%',
                    defenseBoost: 30,
                    counterBoost: 20,
                    healthBoost: 15,
                    detectionBoost: 25
                },
                'police': {
                    name: '執法部門',
                    message: '✓ 已向執法部門報案，他們將在3分鐘內介入調查。',
                    delay: 180000,
                    effect: '黑客隱藏等級-50%，檢測能力+40%，系統健康+10%',
                    stealthPenalty: 50,
                    detectionBoost: 40,
                    healthBoost: 10
                },
                'cyber_security': {
                    name: '網絡安全專家',
                    message: '✓ 已聯繫頂級網絡安全專家，他們將在2分鐘內到達。',
                    delay: 120000,
                    effect: '防禦力+40%，檢測率+35%，系統完整性+20%',
                    defenseBoost: 40,
                    detectionBoost: 35,
                    healthBoost: 20
                },
                'forensics': {
                    name: '數字取證團隊',
                    message: '✓ 已聯繫數字取證專家，他們將在4分鐘內到達進行取證。',
                    delay: 240000,
                    effect: '證據收集+50%，黑客隱藏等級-60%，調查進度+30%',
                    stealthPenalty: 60,
                    evidenceBoost: 50
                },
                'military': {
                    name: '軍事網絡部隊',
                    message: '✓ 已啟動軍事網絡部隊，他們將在5分鐘內全面接管防禦。',
                    delay: 300000,
                    effect: '防禦力+60%，反擊力+50%，黑客隱藏等級-80%',
                    defenseBoost: 60,
                    counterBoost: 50,
                    stealthPenalty: 80
                },
                'interpol': {
                    name: '國際刑警組織',
                    message: '✓ 已聯繫國際刑警組織，他們將在10分鐘內啟動全球追蹤。',
                    delay: 600000,
                    effect: '全球追蹤啟動，黑客隱藏等級-100%，逮捕概率+95%',
                    stealthPenalty: 100,
                    arrestProbability: 95
                }
            };
            
            const supportConfig = supportTypes[type];
            if (!supportConfig) return;
            
            message = supportConfig.message;
            delay = supportConfig.delay;
            effect = supportConfig.effect;
            supportType = supportConfig.name;
            
            if (type === 'professional') {
                
                // 立即應用防禦力提升
                GameState.stats.defenseLevel = Math.min(100, GameState.stats.defenseLevel + 30);
                GameState.stats.counterAttackPower = Math.min(100, GameState.stats.counterAttackPower + 20);
                GameState.stats.systemHealth = Math.min(100, GameState.stats.systemHealth + 15);
                GameState.stats.detectionRate = Math.min(100, GameState.stats.detectionRate + 25);
                
                // 記錄支援事件
                GameState.battle.supportActive = true;
                GameState.battle.supportType = 'professional';
                GameState.battle.supportEndTime = Date.now() + delay;
                
                updateStatsDisplay();
            } else if (type === 'police') {
                message = '✓ 已向執法部門報案，他們將在3分鐘內介入調查。';
                delay = 180000; // 3分鐘
                effect = '黑客隱藏等級-50%，檢測能力+40%，系統健康+10%';
                supportType = '執法部門';
                
                // 立即應用效果
                GameState.battle.opponentStats.stealthLevel = Math.max(0, GameState.battle.opponentStats.stealthLevel - 50);
                GameState.stats.detectionRate = Math.min(100, GameState.stats.detectionRate + 40);
                GameState.stats.systemHealth = Math.min(100, GameState.stats.systemHealth + 10);
                
                // 記錄支援事件
                GameState.battle.supportActive = true;
                GameState.battle.supportType = 'police';
                GameState.battle.supportEndTime = Date.now() + delay;
                GameState.battle.reportSent = true;
                
                updateStatsDisplay();
            }

            // 終端輸出
            addTerminalLine(`[支援] 正在尋求 ${supportType} 協助...`, 'system');
            addTerminalLine(`[支援] 支援類型: ${supportType}`, 'info');
            addTerminalLine(`[支援] 預計到達時間: ${delay / 1000 / 60} 分鐘`, 'info');
            addTerminalLine(`[支援] 效果: ${effect}`, 'warning');
            
            // 顯示通知
            showNotification('支援請求已發送', `${supportType}將在 ${delay / 1000 / 60} 分鐘內到達。\n效果: ${effect}`, 'defender');

            // 倒計時提示
            let remainingTime = delay / 1000;
            const countdownInterval = setInterval(() => {
                remainingTime -= 10;
                if (remainingTime <= 0) {
                    clearInterval(countdownInterval);
                } else if (remainingTime % 30 === 0) {
                    addTerminalLine(`[支援] ${supportType}將在 ${Math.ceil(remainingTime / 60)} 分鐘內到達...`, 'system');
                }
            }, 10000);

            // 支援到達
            setTimeout(() => {
                addTerminalLine(`[支援] ${message}`, 'success');
                addTerminalLine(`[支援] ${supportType}已開始提供協助！`, 'success');
                addTerminalLine(`[支援] 防禦能力已提升，黑客難度增加！`, 'success');
                showNotification('支援已到達', `${supportType}已介入！\n系統防禦能力大幅提升！`, 'defender');
                
                // 更新支援狀態
                GameState.battle.supportActive = false;
            }, delay);
        }

        function sendReport() {
            if (GameState.battle.reportSent) {
                document.getElementById('report-status').textContent = '報案資料已傳送，請勿重複操作。';
                return;
            }

            document.getElementById('report-status').textContent = '正在模擬傳送報案資料...';
            document.getElementById('btn-send-report').disabled = true;

            setTimeout(() => {
                GameState.battle.reportSent = true;
                document.getElementById('report-status').textContent = '✓ 報案資料已成功傳送給執法部門。';
                addTerminalLine('[報案] 報案資料已傳送給執法部門，等待介入...', 'success');
                showNotification('報案成功', '模擬報案資料已傳送。執法部門已開始調查。', 'defender');
                
                // 初始化執法部門系統
                LawEnforcementSystem.initializeCase(GameState.battle.targetIP);
                
                // 提示用戶可以查看執法部門面板
                setTimeout(() => {
                    addTerminalLine('[系統] 您現在可以點擊「查看執法部門面板」來與執法部門互動。', 'info');
                }, 1000);
            }, 3000);
        }
        // ===== 執法部門互動系統 =====
        const LawEnforcementSystem = {
            caseId: null,
            caseStatus: 'pending', // pending, investigating, evidence_review, tracking, arrested
            investigationProgress: 0,
            messages: [],
            evidence: [],
            investigators: [],
            riskLevel: 'high', // low, medium, high, critical
            priority: 'urgent', // normal, high, urgent, critical
            estimatedResolutionTime: 0,
            investigationSteps: [
                { step: 1, name: '接收報案', progress: 0, completed: false, duration: '5分鐘' },
                { step: 2, name: '初步評估', progress: 25, completed: false, duration: '15分鐘' },
                { step: 3, name: '蒐集證據', progress: 50, completed: false, duration: '30分鐘' },
                { step: 4, name: '追蹤黑客', progress: 75, completed: false, duration: '45分鐘' },
                { step: 5, name: '逮捕嫌疑人', progress: 100, completed: false, duration: '60分鐘' }
            ],
            assignedAgencies: ['網絡犯罪調查局', '國家安全部門', '執法部門'],
            
            // 初始化案件
            initializeCase: function(targetIP) {
                this.caseId = 'CASE-' + Date.now().toString(36).toUpperCase();
                this.caseStatus = 'investigating';
                this.investigationProgress = 0;
                this.messages = [];
                this.evidence = [];
                
                // 重置調查步驟
                this.investigationSteps.forEach(step => {
                    step.completed = false;
                });
                this.investigationSteps[0].completed = true;
                
                // 執法部門的初始消息
                this.addMessage('law_enforcement', `案件 ${this.caseId} 已建立。我們已接收到您的報案。`, 'system');
                this.addMessage('law_enforcement', `目標IP地址: ${targetIP} 已記錄在案。`, 'info');
                this.addMessage('law_enforcement', '我們需要您提供以下信息以加快調查進度：', 'warning');
                this.addMessage('law_enforcement', '1. 攻擊開始時間和持續時間\n2. 被竊取的數據類型\n3. 系統日誌或流量記錄\n4. 任何其他可疑活動的證據', 'info');
            },
            
            // 添加消息
            addMessage: function(sender, content, type = 'normal') {
                this.messages.push({
                    sender: sender, // 'defender' 或 'law_enforcement'
                    content: content,
                    type: type, // normal, system, info, warning, success
                    timestamp: new Date().toLocaleTimeString()
                });
            },
            
            // 添加證據
            addEvidence: function(type, description, data) {
                const evidence = {
                    id: 'EV-' + Date.now(),
                    type: type, // 'log', 'traffic', 'screenshot', 'data', 'other'
                    description: description,
                    data: data,
                    timestamp: new Date().toLocaleTimeString(),
                    verified: false
                };
                this.evidence.push(evidence);
                return evidence;
            },
            
            // 驗證證據
            verifyEvidence: function(evidenceId) {
                const evidence = this.evidence.find(e => e.id === evidenceId);
                if (evidence) {
                    evidence.verified = true;
                    this.addMessage('law_enforcement', `✓ 證據 ${evidenceId} 已驗證並納入調查。`, 'success');
                    this.updateInvestigationProgress();
                }
            },
            
            // 更新調查進度
            updateInvestigationProgress: function() {
                const verifiedEvidenceCount = this.evidence.filter(e => e.verified).length;
                const totalEvidence = Math.max(this.evidence.length, 1);
                const evidenceProgress = (verifiedEvidenceCount / totalEvidence) * 30; // 30%權重
                
                this.investigationProgress = Math.min(100, evidenceProgress + (this.investigationSteps.filter(s => s.completed).length * 14));
                
                // 根據進度自動推進調查步驟
                if (this.investigationProgress >= 25 && !this.investigationSteps[1].completed) {
                    this.completeStep(1);
                }
                if (this.investigationProgress >= 50 && !this.investigationSteps[2].completed) {
                    this.completeStep(2);
                }
                if (this.investigationProgress >= 75 && !this.investigationSteps[3].completed) {
                    this.completeStep(3);
                }
                if (this.investigationProgress >= 100 && !this.investigationSteps[4].completed) {
                    this.completeStep(4);
                }
            },
            
            // 完成調查步驟
            completeStep: function(stepIndex) {
                const step = this.investigationSteps[stepIndex];
                if (step && !step.completed) {
                    step.completed = true;
                    const messages = [
                        '案件已建立',
                        '初步評估完成：確認為嚴重網絡犯罪',
                        '證據蒐集完成：已獲得充分證據',
                        '黑客追蹤完成：已鎖定黑客位置',
                        '逮捕成功：嫌疑人已被逮捕！'
                    ];
                    this.addMessage('law_enforcement', `✓ ${step.name}: ${messages[stepIndex]}`, 'success');
                }
            },
            
            // 獲取案件摘要
            getCaseSummary: function() {
                return {
                    caseId: this.caseId,
                    status: this.caseStatus,
                    progress: this.investigationProgress,
                    evidenceCount: this.evidence.length,
                    verifiedEvidenceCount: this.evidence.filter(e => e.verified).length,
                    messageCount: this.messages.length
                };
            }
        };
        
        // ===== 顯示執法部門互動面板 =====
        function showLawEnforcementPanel() {
            if (!LawEnforcementSystem.caseId) {
                showAlertModal('錯誤', '請先報案才能查看執法部門互動面板');
                return;
            }
            
            const summary = LawEnforcementSystem.getCaseSummary();
            const progressPercent = Math.round(summary.progress);
            
            let messagesHTML = '';
            LawEnforcementSystem.messages.forEach(msg => {
                const bgColor = msg.type === 'success' ? 'rgba(46,204,113,0.2)' : 
                               msg.type === 'warning' ? 'rgba(243,156,18,0.2)' :
                               msg.type === 'info' ? 'rgba(52,152,219,0.2)' :
                               'rgba(100,100,100,0.2)';
                const textColor = msg.type === 'success' ? '#2ecc71' :
                                 msg.type === 'warning' ? '#f39c12' :
                                 msg.type === 'info' ? '#3498db' :
                                 '#aaa';
                
                messagesHTML += `
                    <div style="background: ${bgColor}; border-left: 3px solid ${textColor}; padding: 12px; margin-bottom: 10px; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <strong style="color: ${textColor};">${msg.sender === 'law_enforcement' ? '🚔 執法部門' : '👤 您'}</strong>
                            <span style="color: #666; font-size: 0.8rem;">${msg.timestamp}</span>
                        </div>
                        <div style="color: #ccc; font-size: 0.9rem; white-space: pre-wrap;">${msg.content}</div>
                    </div>
                `;
            });
            
            let evidenceHTML = '';
            LawEnforcementSystem.evidence.forEach(ev => {
                const verifiedBadge = ev.verified ? '✓ 已驗證' : '⏳ 待驗證';
                const verifiedColor = ev.verified ? '#2ecc71' : '#f39c12';
                evidenceHTML += `
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #555;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #fff;">${ev.type.toUpperCase()}</strong>
                                <div style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">${ev.description}</div>
                                <div style="color: ${verifiedColor}; font-size: 0.8rem; margin-top: 5px;">${verifiedBadge}</div>
                            </div>
                            ${!ev.verified ? `<button onclick="LawEnforcementSystem.verifyEvidence('${ev.id}'); showLawEnforcementPanel();" style="background: #3498db; border: none; padding: 8px 12px; border-radius: 4px; color: #fff; cursor: pointer; font-size: 0.85rem;">驗證</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            let stepsHTML = '';
            LawEnforcementSystem.investigationSteps.forEach(step => {
                const stepColor = step.completed ? '#2ecc71' : '#666';
                const stepBg = step.completed ? 'rgba(46,204,113,0.2)' : 'rgba(100,100,100,0.1)';
                stepsHTML += `
                    <div style="background: ${stepBg}; border: 1px solid ${stepColor}; padding: 12px; margin-bottom: 10px; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: ${stepColor};">步驟 ${step.step}: ${step.name}</strong>
                                <div style="background: rgba(0,0,0,0.3); height: 6px; margin-top: 8px; border-radius: 3px; overflow: hidden; width: 200px;">
                                    <div style="background: ${stepColor}; height: 100%; width: ${step.progress}%;"></div>
                                </div>
                            </div>
                            ${step.completed ? '<span style="color: #2ecc71; font-size: 1.2rem;">✓</span>' : ''}
                        </div>
                    </div>
                `;
            });
            
            const panelHTML = `
                <div class="modal-overlay" id="law-enforcement-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(10,20,40,0.98) 0%, rgba(20,30,50,0.98) 100%); border: 2px solid #3498db;">
                        <h2 style="color: #3498db; margin-bottom: 20px; text-align: center;">
                            <i class="fas fa-police-box"></i> 執法部門案件管理系統
                        </h2>
                        
                        <!-- 案件信息 -->
                        <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #3498db;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <div style="color: #888; font-size: 0.9rem;">案件編號</div>
                                    <div style="color: #3498db; font-weight: bold; font-size: 1rem;">${summary.caseId}</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.9rem;">調查進度</div>
                                    <div style="color: #3498db; font-weight: bold; font-size: 1rem;">${progressPercent}%</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.9rem;">證據數量</div>
                                    <div style="color: #3498db; font-weight: bold; font-size: 1rem;">${summary.verifiedEvidenceCount}/${summary.evidenceCount}</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.9rem;">風險等級</div>
                                    <div style="color: #ff6b6b; font-weight: bold; font-size: 1rem;">🔴 高危</div>
                                </div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); height: 8px; margin-top: 10px; border-radius: 4px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #3498db, #2ecc71); height: 100%; width: ${progressPercent}%;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; font-size: 0.85rem;">
                                <div style="background: rgba(52,152,219,0.2); padding: 8px; border-radius: 4px; border-left: 3px solid #3498db;">
                                    <strong>優先級:</strong> 🔴 緊急
                                </div>
                                <div style="background: rgba(46,204,113,0.2); padding: 8px; border-radius: 4px; border-left: 3px solid #2ecc71;">
                                    <strong>狀態:</strong> 🔍 調查中
                                </div>
                                <div style="background: rgba(155,89,182,0.2); padding: 8px; border-radius: 4px; border-left: 3px solid #9b59b6;">
                                    <strong>部門:</strong> 🚔 多部門聯動
                                </div>
                            </div>
                        </div>
                        
                        <!-- 標籤頁 -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #555; padding-bottom: 10px;">
                            <button onclick="showTab('messages')" id="tab-messages" style="background: #3498db; border: none; padding: 10px 20px; border-radius: 4px 4px 0 0; color: #fff; cursor: pointer; font-weight: bold;">
                                💬 消息 (${summary.messageCount})
                            </button>
                            <button onclick="showTab('evidence')" id="tab-evidence" style="background: rgba(255,255,255,0.1); border: none; padding: 10px 20px; border-radius: 4px 4px 0 0; color: #aaa; cursor: pointer;">
                                📋 證據 (${summary.evidenceCount})
                            </button>
                            <button onclick="showTab('investigation')" id="tab-investigation" style="background: rgba(255,255,255,0.1); border: none; padding: 10px 20px; border-radius: 4px 4px 0 0; color: #aaa; cursor: pointer;">
                                🔍 調查進度
                            </button>
                        </div>
                        
                        <!-- 消息標籤 -->
                        <div id="tab-content-messages" style="display: block;">
                            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                                ${messagesHTML}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="message-input" placeholder="輸入消息..." style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid #555; border-radius: 4px; color: #fff;">
                                <button onclick="sendMessageToLawEnforcement()" style="background: #2ecc71; border: none; padding: 10px 20px; border-radius: 4px; color: #fff; cursor: pointer; font-weight: bold;">發送</button>
                            </div>
                        </div>
                        
                        <!-- 證據標籤 -->
                        <div id="tab-content-evidence" style="display: none;">
                            <div style="margin-bottom: 15px;">
                                ${evidenceHTML}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="uploadEvidence('log')" style="background: #3498db; border: none; padding: 10px 15px; border-radius: 4px; color: #fff; cursor: pointer; flex: 1;">📝 上傳日誌</button>
                                <button onclick="uploadEvidence('traffic')" style="background: #3498db; border: none; padding: 10px 15px; border-radius: 4px; color: #fff; cursor: pointer; flex: 1;">📊 上傳流量記錄</button>
                                <button onclick="uploadEvidence('screenshot')" style="background: #3498db; border: none; padding: 10px 15px; border-radius: 4px; color: #fff; cursor: pointer; flex: 1;">📸 上傳截圖</button>
                                <button onclick="uploadEvidence('other')" style="background: #3498db; border: none; padding: 10px 15px; border-radius: 4px; color: #fff; cursor: pointer; flex: 1;">📎 上傳其他</button>
                            </div>
                        </div>
                        
                        <!-- 調查進度標籤 -->
                        <div id="tab-content-investigation" style="display: none;">
                            ${stepsHTML}
                        </div>
                        
                        <!-- 關閉按鈕 -->
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="closeLawEnforcementPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }
        
        function showTab(tabName) {
            // 隱藏所有標籤內容
            document.getElementById('tab-content-messages').style.display = 'none';
            document.getElementById('tab-content-evidence').style.display = 'none';
            document.getElementById('tab-content-investigation').style.display = 'none';
            
            // 重置所有標籤按鈕
            document.getElementById('tab-messages').style.background = 'rgba(255,255,255,0.1)';
            document.getElementById('tab-messages').style.color = '#aaa';
            document.getElementById('tab-evidence').style.background = 'rgba(255,255,255,0.1)';
            document.getElementById('tab-evidence').style.color = '#aaa';
            document.getElementById('tab-investigation').style.background = 'rgba(255,255,255,0.1)';
            document.getElementById('tab-investigation').style.color = '#aaa';
            
            // 顯示選中的標籤
            document.getElementById('tab-content-' + tabName).style.display = 'block';
            document.getElementById('tab-' + tabName).style.background = '#3498db';
            document.getElementById('tab-' + tabName).style.color = '#fff';
        }
        
        function sendMessageToLawEnforcement() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // 添加防禦者的消息
            LawEnforcementSystem.addMessage('defender', message, 'normal');
            input.value = '';
            
            // 模擬執法部門的回應
            setTimeout(() => {
                const responses = [
                    '感謝您提供的信息，我們正在進一步調查。',
                    '我們已記錄您的報告。請提供更多技術細節。',
                    '根據您提供的信息，我們已鎖定嫌疑人的位置。',
                    '調查進展順利，我們正在準備逮捕令。',
                    '恭喜！嫌疑人已被逮捕。案件即將結案。'
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                LawEnforcementSystem.addMessage('law_enforcement', randomResponse, 'success');
                LawEnforcementSystem.updateInvestigationProgress();
                showLawEnforcementPanel();
            }, 2000);
        }
        
        function uploadEvidence(type) {
            const descriptions = {
                'log': '系統日誌 - 包含攻擊時間戳和操作記錄',
                'traffic': '網絡流量記錄 - 顯示黑客的通信模式',
                'screenshot': '系統截圖 - 記錄被攻擊時的系統狀態',
                'other': '其他證據 - 用戶上傳的補充證據'
            };
            
            const evidence = LawEnforcementSystem.addEvidence(
                type,
                descriptions[type],
                'mock_data_' + Date.now()
            );
            
            addTerminalLine(`[證據] 已上傳 ${type} 類型的證據: ${evidence.id}`, 'success');
            showLawEnforcementPanel();
        }
        
        function closeLawEnforcementPanel() {
            const modal = document.getElementById('law-enforcement-modal');
            if (modal) modal.remove();
        }


        // ===== 防禦者備份工具面板 =====
        function showBackupToolsPanel() {
            const panelHTML = `
                <div class="modal-overlay" id="backup-tools-modal" style="display: flex;">
                    <div class="modal-box" style="max-width: 700px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(10,30,30,0.98) 0%, rgba(20,60,60,0.98) 100%); border: 2px solid #16a085;">
                        <h2 style="color: #16a085; margin-bottom: 25px; text-align: center; text-shadow: 0 0 10px rgba(22,160,133,0.5);">
                            <i class="fas fa-database"></i> 備份與恢復工具
                        </h2>

                        <!-- 備份選項 -->
                        <h3 style="color: #16a085; margin-bottom: 15px;"><i class="fas fa-cloud-upload-alt"></i> 備份數據</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                            <button onclick="performBackup('full')" style="background: linear-gradient(135deg, rgba(22,160,133,0.3) 0%, rgba(26,188,156,0.3) 100%); border: 1px solid #1abc9c; padding: 20px; border-radius: 8px; color: #1abc9c; cursor: pointer;">
                                <i class="fas fa-hdd" style="font-size: 2rem;"></i>
                                <div style="margin-top: 10px; font-weight: bold;">完整備份</div>
                                <div style="font-size: 0.8rem; color: #888;">備份所有系統數據</div>
                            </button>
                            <button onclick="performBackup('incremental')" style="background: linear-gradient(135deg, rgba(52,152,219,0.3) 0%, rgba(41,128,185,0.3) 100%); border: 1px solid #3498db; padding: 20px; border-radius: 8px; color: #3498db; cursor: pointer;">
                                <i class="fas fa-sync" style="font-size: 2rem;"></i>
                                <div style="margin-top: 10px; font-weight: bold;">增量備份</div>
                                <div style="font-size: 0.8rem; color: #888;">僅備份變更數據</div>
                            </button>
                        </div>

                        <!-- 恢復選項 -->
                        <h3 style="color: #e74c3c; margin-bottom: 15px;"><i class="fas fa-undo"></i> 系統恢復</h3>
                        <div style="display: grid; gap: 15px; margin-bottom: 25px;">
                            <button onclick="performRestore('latest')" style="background: rgba(231,76,60,0.2); border: 1px solid #e74c3c; padding: 15px; border-radius: 8px; color: #e74c3c; cursor: pointer; text-align: left;">
                                <div style="font-weight: bold;"><i class="fas fa-clock"></i> 恢復到最近備份點</div>
                                <div style="font-size: 0.9rem; color: #888;">恢復到系統被攻擊前的狀態</div>
                            </button>
                            <button onclick="performRestore('factory')" style="background: rgba(155,89,182,0.2); border: 1px solid #9b59b6; padding: 15px; border-radius: 8px; color: #9b59b6; cursor: pointer; text-align: left;">
                                <div style="font-weight: bold;"><i class="fas fa-industry"></i> 恢復出廠設���</div>
                                <div style="font-size: 0.9rem; color: #888;">完全重置系統（清除所有數據）</div>
                            </button>
                        </div>

                        <!-- 防護工具 -->
                        <h3 style="color: #f39c12; margin-bottom: 15px;"><i class="fas fa-tools"></i> 防護工具</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                            <button onclick="enableFailsafe()" style="background: rgba(243,156,18,0.2); border: 1px solid #f39c12; padding: 15px; border-radius: 8px; color: #f39c12; cursor: pointer;">
                                <i class="fas fa-shield-alt"></i> 啟用故障保護
                            </button>
                            <button onclick="isolateNetwork()" style="background: rgba(231,76,60,0.2); border: 1px solid #e74c3c; padding: 15px; border-radius: 8px; color: #e74c3c; cursor: pointer;">
                                <i class="fas fa-network-wired"></i> 網絡隔離
                            </button>
                            <button onclick="enableHoneypot()" style="background: rgba(46,204,113,0.2); border: 1px solid #2ecc71; padding: 15px; border-radius: 8px; color: #2ecc71; cursor: pointer;">
                                <i class="fas fa-spider"></i> 部署蜜罐
                            </button>
                            <button onclick="emergencyShutdown()" style="background: rgba(192,57,43,0.2); border: 1px solid #c0392b; padding: 15px; border-radius: 8px; color: #c0392b; cursor: pointer;">
                                <i class="fas fa-power-off"></i> 緊急關閉
                            </button>
                        </div>

                        <div style="text-align: center;">
                            <button onclick="closeBackupToolsPanel()" style="background: rgba(255,255,255,0.1); border: 1px solid #666; padding: 12px 30px; border-radius: 6px; color: #fff; cursor: pointer;">
                                <i class="fas fa-times"></i> 關閉
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }

        function closeBackupToolsPanel() {
            const modal = document.getElementById('backup-tools-modal');
            if (modal) modal.remove();
        }

        function performBackup(type) {
            closeBackupToolsPanel();
            addTerminalLine(`[備份] 開始${type === 'full' ? '完整' : '增量'}備份...`, 'system');
            SoundSystem.play('attack');

            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                addTerminalLine(`[備份] 進度: ${progress}%`, 'response');

                if (progress >= 100) {
                    clearInterval(interval);
                    addTerminalLine('✓ 備份完成！數據已安全存儲', 'success');
                    SoundSystem.play('success');
                }
            }, 500);
        }

        function performRestore(type) {
            closeBackupToolsPanel();
            addTerminalLine(`[恢復] 開始${type === 'latest' ? '恢復到最近備份點' : '恢復出廠設置'}...`, 'warning');
            SoundSystem.play('alert');

            setTimeout(() => {
                if (type === 'latest') {
                    // 恢復系統健康
                    GameState.stats.systemHealth = 100;
                    GameState.stats.defenseLevel = 80;
                    GameState.hackerAttack.zombieProgress = 0;
                    GameState.hackerAttack.isZombified = false;
                    updateStatsDisplay('defender');
                }
                addTerminalLine('✓ 系統恢復完成！', 'success');
                SoundSystem.play('success');
            }, 3000);
        }

        function enableFailsafe() {
            closeBackupToolsPanel();
            addTerminalLine('[防護] 啟用故障保護模式...', 'system');
            setTimeout(() => {
                addTerminalLine('✓ 故障保護已啟用', 'success');
                SoundSystem.play('success');
            }, 1000);
        }

        function isolateNetwork() {
            closeBackupToolsPanel();
            addTerminalLine('[網絡] 正在隔離網絡...', 'warning');
            setTimeout(() => {
                addTerminalLine('✓ 網絡已隔離，阻止外部連接', 'success');
                GameState.connected = false;
                updateConnectionDisplay();
                SoundSystem.play('success');
            }, 1500);
        }

        function enableHoneypot() {
            closeBackupToolsPanel();
            addTerminalLine('[蜜罐] 正在部署蜜罐系統...', 'system');
            setTimeout(() => {
                addTerminalLine('✓ 蜜罐已部署，誘捕攻擊者', 'success');
                SoundSystem.play('success');
            }, 1500);
        }

        function emergencyShutdown() {
            closeBackupToolsPanel();
            addTerminalLine('[緊急] 執行緊急關閉...', 'alert');
            SoundSystem.play('alert');
            setTimeout(() => {
                addTerminalLine('系統正在關閉...', 'warning');
                setTimeout(() => {
                    addTerminalLine('✓ 系統已安全關閉', 'success');
                    GameState.connected = false;
                    updateConnectionDisplay();
                }, 2000);
            }, 1000);
        }

        // ===== 黑客監視系統 =====
        function showHackerIntelPanel() {
            const intel = GameState.hackerIntel;
            const defenderVPN = GameState.vpn; // 在對戰中這會是防禦者的VPN狀態

            return `
                <div style="background: linear-gradient(135deg, rgba(0,255,65,0.1) 0%, rgba(0,50,20,0.2) 100%); border: 1px solid #00ff41; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #00ff41; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-eye"></i> 情報監視面板
                        <span style="background: #00ff41; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">黑客專用</span>
                    </h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                        <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.8rem;">防禦者VPN狀態</div>
                            <div style="color: ${defenderVPN.isFake ? '#ff3333' : '#00ff41'}; font-size: 1.1rem; font-weight: bold;">
                                ${defenderVPN.active ? (defenderVPN.isFake ? '❌ 假VPN (可入侵)' : '✓ 真VPN') : '❌ 未啟用'}
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.8rem;">訪問權限等級</div>
                            <div style="color: #00ff41; font-size: 1.1rem; font-weight: bold;">${intel.accessLevel.toUpperCase()}</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.8rem;">已破解密碼</div>
                            <div style="color: #00ff41; font-size: 1.1rem; font-weight: bold;">${intel.passwordsCracked.length}</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.8rem;">已解密文件</div>
                            <div style="color: #00ff41; font-size: 1.1rem; font-weight: bold;">${intel.filesDecrypted.length}</div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; padding: 10px; background: rgba(0,255,65,0.1); border-radius: 6px;">
                        <div style="color: #00ff41; font-size: 0.9rem; margin-bottom: 5px;">🔍 防禦者數據分析</div>
                        <div style="color: #aaa; font-size: 0.85rem;">
                            • 防火牆等級: ${GameState.firewall.level}%<br>
                            • 開放端口: ${GameState.firewall.allowedPorts.join(', ')}<br>
                            • 入侵嘗試次數: ${GameState.firewall.intrusionAttempts}
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== 防禦者觀察系統 =====
        function showDefenderObservationPanel() {
            const intel = GameState.defenderIntel;

            return `
                <div style="background: linear-gradient(135deg, rgba(255,51,51,0.1) 0%, rgba(50,20,20,0.2) 100%); border: 1px solid #ff3333; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #ff3333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-search"></i> 威脅觀察面板
                        <span style="background: #ff3333; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">防禦者專用</span>
                    </h3>

                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; color: #aaa; margin-bottom: 5px;">
                            <span>觀察等���</span>
                            <span>${intel.observationLevel}%</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.4); height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #ff3333, #ff9900); height: 100%; width: ${intel.observationLevel}%; transition: width 0.3s;"></div>
                        </div>
                        <div style="color: #888; font-size: 0.8rem; margin-top: 5px;">
                            ${intel.observationLevel < 30 ? '⚠️ 無法看到黑客活動' : intel.observationLevel < 60 ? '👁️ 可看到部分活動' : '🔍 可看到大部分活動'}
                        </div>
                    </div>

                    ${intel.hackerVisible ? `
                        <div style="background: rgba(0,255,65,0.1); border: 1px solid #00ff41; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                            <div style="color: #00ff41; font-size: 0.9rem;">✓ 已獲得黑客可見性</div>
                        </div>
                    ` : `
                        <div style="background: rgba(255,51,51,0.1); border: 1px solid #ff3333; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                            <div style="color: #ff3333; font-size: 0.9rem;">❌ 黑客活動不可見 - 使用觀察工具提升等級</div>
                        </div>
                    `}

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.8rem;">檢測到的操作</div>
                            <div style="color: #ff3333; font-size: 1.1rem; font-weight: bold;">${intel.detectedActions.length}</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.8rem;">可疑IP</div>
                            <div style="color: #ffaa00; font-size: 1.1rem; font-weight: bold;">${intel.suspiciousIPs.length}</div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button onclick="executeObservation('deep_scan')" style="background: rgba(255,51,51,0.2); border: 1px solid #ff3333; padding: 10px; border-radius: 6px; color: #ff3333; cursor: pointer;">
                            <i class="fas fa-radar"></i> 深度掃描
                        </button>
                        <button onclick="executeObservation('log_analysis')" style="background: rgba(255,153,0,0.2); border: 1px solid #ff9900; padding: 10px; border-radius: 6px; color: #ff9900; cursor: pointer;">
                            <i class="fas fa-file-alt"></i> 日誌分析
                        </button>
                    </div>
                </div>
            `;
        }

        function executeObservation(type) {
            const intel = GameState.defenderIntel;

            addTerminalLine(`執行${type === 'deep_scan' ? '深度掃描' : '日誌分析'}...`, 'system');

            setTimeout(() => {
                let increase = 0;
                if (type === 'deep_scan') {
                    increase = 15 + Math.floor(Math.random() * 10);
                } else {
                    increase = 10 + Math.floor(Math.random() * 8);
                }

                intel.observationLevel = Math.min(100, intel.observationLevel + increase);

                if (intel.observationLevel >= 50 && !intel.hackerVisible) {
                    intel.hackerVisible = true;
                    addTerminalLine('🔍 突破！現在可以看到黑客的部分活動！', 'success');
                }

                // 隨機檢測到一些黑客操作
                if (Math.random() > 0.5) {
                    const actions = ['端口掃描', 'SQL注入嘗試', '密碼破解', '文件訪問', 'VPN連接'];
                    const detected = actions[Math.floor(Math.random() * actions.length)];
                    intel.detectedActions.push({ action: detected, time: new Date().toISOString() });
                    addTerminalLine(`⚠️ 檢測到可疑活動: ${detected}`, 'warning');
                }

                addTerminalLine(`觀察等級提升: +${increase}% (現在: ${intel.observationLevel}%)`, 'success');
                SoundSystem.play('success');
            }, 1500);
        }

        // ===== 密碼破解系統 (黑客) =====
        function crackPassword(target) {
            const intel = GameState.hackerIntel;
            const decryptPower = intel.decryptPower || 10;

            addTerminalLine(`嘗試破解 ${target} 密碼...`, 'system');

            setTimeout(() => {
                const success = Math.random() * 100 < decryptPower;
                if (success) {
                    const password = generateRandomPassword();
                    intel.passwordsCracked.push({ target, password, time: new Date().toISOString() });
                    addTerminalLine(`✓ 密碼破解成功: ${password}`, 'success');
                    SoundSystem.play('success');
                } else {
                    addTerminalLine('✗ 密碼破解失敗 - 嘗試升級解密工具', 'error');
                    SoundSystem.play('error');
                }
            }, 2000);
        }

        function generateRandomPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // ===== 文件解密系統 (黑客) =====
        function decryptFile(filename) {
            const intel = GameState.hackerIntel;
            const decryptPower = intel.decryptPower || 10;

            addTerminalLine(`解密文件: ${filename}...`, 'system');

            setTimeout(() => {
                const success = Math.random() * 100 < decryptPower + 20;
                if (success) {
                    const contents = ['用戶數據庫', '財務報告', 'API密鑰', '系統配置', '客戶資料'];
                    const content = contents[Math.floor(Math.random() * contents.length)];
                    intel.filesDecrypted.push({ filename, content, time: new Date().toISOString() });
                    addTerminalLine(`✓ 解密成功! 內容: ${content}`, 'success');
                    SoundSystem.play('success');
                } else {
                    addTerminalLine('✗ 解密失敗 - 加密強度太高', 'error');
                }
            }, 2500);
        }

        // ===== 返回主選單 =====
        function backToMain() {
            // 清除計時器
            if (GameState.gameTimer) {
                clearInterval(GameState.gameTimer);
                GameState.gameTimer = null;
            }

            // 清除AI對手計時器
            if (GameState.battle.aiAttackTimer) {
                clearInterval(GameState.battle.aiAttackTimer);
                GameState.battle.aiAttackTimer = null;
            }

            // 保存遊戲狀態
            if (GameConfig.settings.autoSave) {
                saveGameState();
            }

            // 重置遊戲狀態
            GameState.currentMode = null;
            GameState.isBattleMode = false;
            GameState.connected = false;
            GameState.opponentConnected = false;
            GameState.battleActive = false;
            GameState.stats = null;
            GameState.toolCooldowns = {};
            GameState.attackLog = [];

            // 切換頁面
            gamePage.classList.remove('active');
            gamePage.classList.add('hidden');
            gamePage.innerHTML = '';

            mainPage.classList.remove('hidden');
            mainPage.classList.add('active');
            
            showNotification('系統', '已返回主選單', 'info');
        }

        // ===== 頁面載入完成 =====
        document.addEventListener('DOMContentLoaded', init);
        console.log("頁面載入完成，準備就緒！");
    

        // ===== 增強功能模組 =====
        // ===== 增強功能模組 =====
        // 此模組包含商店系統、即時預覽、延遲提示、權限爭奪等功能
        
        // 商品應用系統
        const ItemEffects = {
            // 黑客商品效果
            hacker: {
                'vpn-basic': {
                    apply: () => {
                        GameState.vpn.tier = 1;
                        GameState.vpn.hideChance = 30;
                        addTerminalLine('[商品應用] VPN基礎版已啟用 - 隱藏機率 30%', 'success');
                    }
                },
                'vpn-premium': {
                    apply: () => {
                        GameState.vpn.tier = 2;
                        GameState.vpn.hideChance = 60;
                        addTerminalLine('[商品應用] VPN高級版已啟用 - 隱藏機率 60%', 'success');
                    }
                },
                'vpn-elite': {
                    apply: () => {
                        GameState.vpn.tier = 3;
                        GameState.vpn.hideChance = 90;
                        addTerminalLine('[商品應用] VPN精英版已啟用 - 隱藏機率 90%', 'success');
                    }
                },
                'attack-boost-1': {
                    apply: () => {
                        GameState.hackerUpgrades = GameState.hackerUpgrades || {};
                        GameState.hackerUpgrades.attackBonus = (GameState.hackerUpgrades.attackBonus || 0) + 20;
                        GameState.hackerUpgrades.controlSpeed = 1.5;
                        addTerminalLine('[商品應用] 攻擊加速器已啟用 - 攻擊力 +20%, 控制速度 x1.5', 'success');
                    }
                },
                'attack-boost-2': {
                    apply: () => {
                        GameState.hackerUpgrades = GameState.hackerUpgrades || {};
                        GameState.hackerUpgrades.attackBonus = (GameState.hackerUpgrades.attackBonus || 0) + 50;
                        GameState.hackerUpgrades.controlSpeed = 3.0;
                        addTerminalLine('[商品應用] 高級攻擊套裝已啟用 - 攻擊力 +50%, 控制速度 x3.0', 'success');
                    }
                },
                'ultimate-package': {
                    apply: () => {
                        GameState.hackerUpgrades = GameState.hackerUpgrades || {};
                        GameState.hackerUpgrades.attackBonus = (GameState.hackerUpgrades.attackBonus || 0) + 100;
                        GameState.hackerUpgrades.controlSpeed = 10.0;
                        GameState.hackerUpgrades.instantControl = true;
                        addTerminalLine('[商品應用] 終極套裝已啟用 - 攻擊力 +100%, 瞬間控制能力已解鎖！', 'success');
                        showNotification('終極力量', '您現在可以在短時間內完全控制防禦者系統！', 'hacker');
                    }
                },
                'stealth-kit': {
                    apply: () => {
                        GameState.hackerUpgrades = GameState.hackerUpgrades || {};
                        GameState.hackerUpgrades.stealthBonus = (GameState.hackerUpgrades.stealthBonus || 0) + 40;
                        GameState.hackerUpgrades.delayNotification = 120; // 延遲2分鐘
                        addTerminalLine('[商品應用] 隱身工具包已啟用 - 隱身 +40%, 通知延遲 120秒', 'success');
                    }
                }
            },
            // 防禦者商品效果
            defender: {
                'firewall-basic': {
                    apply: () => {
                        GameState.defenderUpgrades = GameState.defenderUpgrades || {};
                        GameState.defenderUpgrades.firewallLevel = 1;
                        GameState.defenderUpgrades.blockChance = 30;
                        addTerminalLine('[商品應用] 基礎防火牆已啟用 - 阻擋機率 30%', 'success');
                    }
                },
                'firewall-advanced': {
                    apply: () => {
                        GameState.defenderUpgrades = GameState.defenderUpgrades || {};
                        GameState.defenderUpgrades.firewallLevel = 2;
                        GameState.defenderUpgrades.blockChance = 60;
                        addTerminalLine('[商品應用] 高級防火牆已啟用 - 阻擋機率 60%', 'success');
                    }
                },
                'counter-attack-kit': {
                    apply: () => {
                        GameState.defenderUpgrades = GameState.defenderUpgrades || {};
                        GameState.defenderUpgrades.counterAttackEnabled = true;
                        GameState.defenderUpgrades.counterAttackPower = 50;
                        addTerminalLine('[商品應用] 反擊套裝已啟用 - 可以反追蹤並攻擊黑客', 'success');
                    }
                },
                'trace-detector': {
                    apply: () => {
                        GameState.defenderUpgrades = GameState.defenderUpgrades || {};
                        GameState.defenderUpgrades.traceDetection = true;
                        GameState.defenderUpgrades.earlyWarning = 30; // 提前30秒警告
                        addTerminalLine('[商品應用] 追蹤偵測器已啟用 - 提前30秒警告', 'success');
                    }
                }
            }
        };
        
        // 商品應用管理器
        const ItemManager = {
            ownedItems: {
                hacker: [],
                defender: []
            },
            
            // 購買商品
            purchaseItem: function(itemId, mode, cost) {
                if (GameState.wallet.balance < cost) {
                    return { success: false, message: '餘額不足' };
                }
                
                GameState.wallet.balance -= cost;
                this.ownedItems[mode].push({
                    id: itemId,
                    purchaseTime: Date.now(),
                    applied: false
                });
                
                updateWalletDisplay();
                return { success: true, message: '購買成功' };
            },
            
            // 應用商品效果
            applyItem: function(itemId, mode) {
                const item = this.ownedItems[mode].find(i => i.id === itemId);
                if (!item) {
                    return { success: false, message: '您尚未擁有此商品' };
                }
                
                if (item.applied) {
                    return { success: false, message: '此商品已經應用過了' };
                }
                
                // 執行商品效果
                if (ItemEffects[mode] && ItemEffects[mode][itemId]) {
                    ItemEffects[mode][itemId].apply();
                    item.applied = true;
                    item.applyTime = Date.now();
                    return { success: true, message: '商品效果已應用' };
                }
                
                return { success: false, message: '無法應用商品效果' };
            },
            
            // 獲取已擁有但未應用的商品
            getUnappliedItems: function(mode) {
                return this.ownedItems[mode].filter(item => !item.applied);
            },
            
            // 顯示商品選擇面板
            showItemSelector: function(mode) {
                const unappliedItems = this.getUnappliedItems(mode);
                
                if (unappliedItems.length === 0) {
                    showNotification('提示', '您沒有可應用的商品', mode);
                    return;
                }
                
                const itemsHTML = unappliedItems.map(item => {
                    const itemName = this.getItemName(item.id);
                    return `
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; margin: 10px 0; border-radius: 8px; cursor: pointer; border: 2px solid rgba(255,255,255,0.1);" 
                             onclick="ItemManager.applyItem('${item.id}', '${mode}'); ItemManager.showItemSelector('${mode}');">
                            <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 5px;">${itemName}</div>
                            <div style="color: #888; font-size: 0.9rem;">點擊應用此商品</div>
                        </div>
                    `;
                }).join('');
                
                const modalHTML = `
                    <div class="modal-overlay" id="item-selector-modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="margin: 0; color: ${mode === 'hacker' ? '#00ff41' : '#ff3333'};">
                                    <i class="fas fa-box-open"></i> 選擇要應用的商品
                                </h2>
                                <button onclick="closeItemSelector()" style="background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">&times;</button>
                            </div>
                            <div style="margin-bottom: 20px; padding: 15px; background: rgba(100,100,255,0.1); border-radius: 8px;">
                                <i class="fas fa-info-circle"></i> 您有 ${unappliedItems.length} 個未應用的商品
                            </div>
                            ${itemsHTML}
                        </div>
                    </div>
                `;
                
                // 移除舊的模態框
                const oldModal = document.getElementById('item-selector-modal');
                if (oldModal) oldModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            },
            
            // 獲取商品名稱
            getItemName: function(itemId) {
                const names = {
                    'vpn-basic': 'VPN 基礎版',
                    'vpn-premium': 'VPN 高級版',
                    'vpn-elite': 'VPN 精英版',
                    'attack-boost-1': '攻擊加速器',
                    'attack-boost-2': '高級攻擊套裝',
                    'ultimate-package': '終極套裝',
                    'stealth-kit': '隱身工具包',
                    'firewall-basic': '基礎防火牆',
                    'firewall-advanced': '高級防火牆',
                    'counter-attack-kit': '反擊套裝',
                    'trace-detector': '追蹤偵測器'
                };
                return names[itemId] || itemId;
            }
        };
        
        // 關閉商品選擇器
        function closeItemSelector() {
            const modal = document.getElementById('item-selector-modal');
            if (modal) modal.remove();
        }
        
        
        // ===== 防禦者反追蹤系統 =====
        const DefenderCounterTracking = {
            isTracking: false,
            hackerInfo: {
                ip: '未知',
                location: '未知',
                device: '未知',
                browser: '未知',
                os: '未知',
                activities: []
            },
            
            // 啟動反追蹤
            startTracking: function() {
                if (this.isTracking) {
                    addTerminalLine('[反追蹤] 反追蹤系統已在運行中', 'warning');
                    return;
                }
                
                this.isTracking = true;
                addTerminalLine('[反追蹤] 啟動反追蹤系統...', 'system');
                
                // 模擬追蹤黑客信息
                setTimeout(() => {
                    this.hackerInfo.ip = this.generateFakeIP();
                    this.hackerInfo.location = this.generateFakeLocation();
                    this.hackerInfo.device = this.detectDevice();
                    this.hackerInfo.browser = this.detectBrowser();
                    this.hackerInfo.os = this.detectOS();
                    
                    this.showTrackedInfo();
                    addTerminalLine('[反追蹤] 成功追蹤到黑客信息!', 'success');
                    SoundSystem.play('success');
                }, 2000);
            },
            
            // 生成假IP
            generateFakeIP: function() {
                return `${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`;
            },
            
            // 生成假位置
            generateFakeLocation: function() {
                const locations = ['香港', '台北', '東京', '首爾', '新加坡', '上海', '北京', '深圳'];
                return locations[Math.floor(Math.random() * locations.length)];
            },
            
            // 檢測設備
            detectDevice: function() {
                const ua = navigator.userAgent;
                if (/mobile/i.test(ua)) return '移動設備';
                if (/tablet/i.test(ua)) return '平板電腦';
                return '桌面電腦';
            },
            
            // 檢測瀏覽器
            detectBrowser: function() {
                const ua = navigator.userAgent;
                if (ua.indexOf('Chrome') > -1) return 'Chrome';
                if (ua.indexOf('Firefox') > -1) return 'Firefox';
                if (ua.indexOf('Safari') > -1) return 'Safari';
                if (ua.indexOf('Edge') > -1) return 'Edge';
                return '未知瀏覽器';
            },
            
            // 檢測操作系統
            detectOS: function() {
                const ua = navigator.userAgent;
                if (ua.indexOf('Win') > -1) return 'Windows';
                if (ua.indexOf('Mac') > -1) return 'macOS';
                if (ua.indexOf('Linux') > -1) return 'Linux';
                if (ua.indexOf('Android') > -1) return 'Android';
                if (ua.indexOf('iOS') > -1) return 'iOS';
                return '未知系統';
            },
            
            // 顯示追蹤到的信息
            showTrackedInfo: function() {
                const infoHTML = `
                    <div class="modal-overlay" id="hacker-info-modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 600px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="margin: 0; color: #ff3333;">
                                    <i class="fas fa-crosshairs"></i> 黑客追蹤信息
                                </h2>
                                <button onclick="DefenderCounterTracking.closeInfo()" style="background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">&times;</button>
                            </div>
                            
                            <div style="background: rgba(0,0,0,0.5); border-radius: 8px; padding: 20px;">
                                <div style="margin-bottom: 15px; padding: 10px; background: rgba(255,51,51,0.1); border-left: 3px solid #ff3333;">
                                    <strong>IP 地址:</strong> ${this.hackerInfo.ip}
                                </div>
                                <div style="margin-bottom: 15px; padding: 10px; background: rgba(255,51,51,0.1); border-left: 3px solid #ff3333;">
                                    <strong>位置:</strong> ${this.hackerInfo.location}
                                </div>
                                <div style="margin-bottom: 15px; padding: 10px; background: rgba(255,51,51,0.1); border-left: 3px solid #ff3333;">
                                    <strong>設備:</strong> ${this.hackerInfo.device}
                                </div>
                                <div style="margin-bottom: 15px; padding: 10px; background: rgba(255,51,51,0.1); border-left: 3px solid #ff3333;">
                                    <strong>瀏覽器:</strong> ${this.hackerInfo.browser}
                                </div>
                                <div style="margin-bottom: 15px; padding: 10px; background: rgba(255,51,51,0.1); border-left: 3px solid #ff3333;">
                                    <strong>操作系統:</strong> ${this.hackerInfo.os}
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button onclick="DefenderCounterTracking.attackHacker()" style="flex: 1; padding: 12px; background: rgba(255,51,51,0.2); border: 2px solid #ff3333; color: #ff3333; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                    <i class="fas fa-bolt"></i> 反擊黑客
                                </button>
                                <button onclick="DefenderCounterTracking.blockHacker()" style="flex: 1; padding: 12px; background: rgba(255,51,51,0.2); border: 2px solid #ff3333; color: #ff3333; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                    <i class="fas fa-ban"></i> 封鎖IP
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', infoHTML);
            },
            
            // 關閉信息窗口
            closeInfo: function() {
                const modal = document.getElementById('hacker-info-modal');
                if (modal) modal.remove();
            },
            
            // 反擊黑客
            attackHacker: function() {
                addTerminalLine('[反擊] 向黑客發起反擊...', 'warning');
                setTimeout(() => {
                    addTerminalLine('[反擊] 反擊成功! 黑客連接已中斷', 'success');
                    SoundSystem.play('success');
                    this.closeInfo();
                }, 1500);
            },
            
            // 封鎖黑客
            blockHacker: function() {
                addTerminalLine('[封鎖] 封鎖黑客IP...', 'warning');
                setTimeout(() => {
                    addTerminalLine(`[封鎖] 已成功封鎖 IP: ${this.hackerInfo.ip}`, 'success');
                    SoundSystem.play('success');
                    this.closeInfo();
                }, 1500);
            }
        };

        // ===== 防禦者延遲警告系統 =====
        const DefenderWarningSystem = {
            warningShown: false,
            warningDelay: 30000, // 30秒延遲
            
            // 觸發警告（由黑客監控觸發）
            triggerWarning: function() {
                if (this.warningShown) return;
                
                setTimeout(() => {
                    this.showWarning();
                    this.warningShown = true;
                }, this.warningDelay);
            },
            
            // 顯示警告
            showWarning: function() {
                const warningHTML = `
                    <div class="modal-overlay" id="defender-warning-modal" style="display: flex; z-index: 99999;">
                        <div class="modal-content" style="max-width: 500px; border: 3px solid #ff3333; animation: warningPulse 1s ease-in-out infinite;">
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #ff3333; animation: shake 0.5s ease-in-out infinite;"></i>
                                <h2 style="margin: 20px 0; color: #ff3333;">⚠️ 安全警報 ⚠️</h2>
                                <div style="background: rgba(255,51,51,0.1); padding: 20px; border-radius: 8px; margin: 20px 0;">
                                    <p style="font-size: 1.2rem; margin-bottom: 10px;">檢測到未授權的監控活動!</p>
                                    <p style="color: #ffaa00;">黑客正在監視您的瀏覽器和操作</p>
                                    <p style="color: #ffaa00;">您的設備信息可能已被竊取</p>
                                </div>
                                <button onclick="DefenderWarningSystem.closeWarning()" style="padding: 12px 30px; background: rgba(255,51,51,0.2); border: 2px solid #ff3333; color: #ff3333; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.1rem;">
                                    <i class="fas fa-shield-alt"></i> 我知道了
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <style>
                    @keyframes warningPulse {
                        0%, 100% { box-shadow: 0 0 20px rgba(255,51,51,0.5); }
                        50% { box-shadow: 0 0 40px rgba(255,51,51,0.8); }
                    }
                    
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        25% { transform: translateX(-10px); }
                        75% { transform: translateX(10px); }
                    }
                    </style>
                `;
                
                document.body.insertAdjacentHTML('beforeend', warningHTML);
                
                // 添加終端消息
                addTerminalLine('⚠️ [警報] 檢測到黑客正在監視您的瀏覽器!', 'error');
                addTerminalLine('[警報] 建議立即啟動反追蹤系統', 'warning');
                SoundSystem.play('alert');
            },
            
            // 關閉警告
            closeWarning: function() {
                const modal = document.getElementById('defender-warning-modal');
                if (modal) modal.remove();
            }
        };

// 即時預覽系統
        const LivePreview = {
            isActive: false,
            updateInterval: null,
            defenderOnline: false,
            notificationSent: false,
            notificationDelay: 30000, // 30秒延遲
            
            // 啟動即時預覽（黑客視角）
            startHackerPreview: function() {
                if (!GameState.connected) {
                    addTerminalLine('[即時預覽] 請先連接到目標系統', 'warning');
                    return;
                }
                
                this.isActive = true;
                this.showPreviewWindow();
                
                // 模擬防禦者上線
                setTimeout(() => {
                    this.defenderOnline = true;
                    this.simulateDefenderActivity();
                    
                    // 延遲通知防禦者
                    const delay = (GameState.hackerUpgrades?.delayNotification || 30) * 1000;
                    setTimeout(() => {
                        this.notifyDefender();
                    }, delay);
                }, 5000);
            },
            
            // 顯示預覽窗口
            showPreviewWindow: function() {
                const previewHTML = `
                    <div class="modal-overlay" id="live-preview-modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="margin: 0; color: #00ff41;">
                                    <i class="fas fa-eye"></i> 防禦者即時預覽
                                </h2>
                                <button onclick="LivePreview.closePreview()" style="background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">&times;</button>
                            </div>
                            
                            <div id="defender-status" style="padding: 15px; background: rgba(255,100,100,0.1); border-radius: 8px; margin-bottom: 20px;">
                                <i class="fas fa-spinner fa-spin"></i> 等待防禦者上線...
                            </div>
                            
                            <div style="background: rgba(0,0,0,0.5); border-radius: 8px; padding: 20px; min-height: 400px;">
                                <div style="background: #1a1a1a; padding: 10px; border-radius: 5px 5px 0 0; display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 12px; height: 12px; background: #ff5f56; border-radius: 50%;"></div>
                                    <div style="width: 12px; height: 12px; background: #ffbd2e; border-radius: 50%;"></div>
                                    <div style="width: 12px; height: 12px; background: #27c93f; border-radius: 50%;"></div>
                                    <span style="margin-left: 10px; color: #888;">防禦者瀏覽器</span>
                                </div>
                                <div id="defender-browser-view" style="background: #fff; color: #000; padding: 20px; min-height: 350px; border-radius: 0 0 5px 5px;">
                                    <div style="text-align: center; padding: 50px; color: #888;">
                                        <i class="fas fa-hourglass-half fa-3x"></i>
                                        <p style="margin-top: 20px;">等待防禦者開始操作...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="defender-activity-log" style="margin-top: 20px; padding: 15px; background: rgba(0,255,65,0.1); border-radius: 8px; max-height: 200px; overflow-y: auto;">
                                <div style="font-weight: bold; margin-bottom: 10px;"><i class="fas fa-list"></i> 活動日誌</div>
                                <div id="activity-log-content"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', previewHTML);
            },
            
            // 模擬防禦者活動
            simulateDefenderActivity: function() {
                const statusDiv = document.getElementById('defender-status');
                if (statusDiv) {
                    statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> 防禦者已上線 - 正在監控中...';
                    statusDiv.style.background = 'rgba(0,255,65,0.1)';
                }
                
                const activities = [
                    { action: '打開系統監控面板', content: '<h3>系統監控</h3><p>CPU: 45%</p><p>記憶體: 62%</p><p>網絡: 正常</p>' },
                    { action: '檢查防火牆設置', content: '<h3>防火牆設置</h3><p>狀態: 已啟用</p><p>規則: 127 條</p><p>阻擋: 23 次</p>' },
                    { action: '查看連接日誌', content: '<h3>連接日誌</h3><p>192.168.1.105 - 已連接</p><p>10.0.0.34 - 已拒絕</p><p>172.16.0.8 - 已連接</p>' },
                    { action: '執行安全掃描', content: '<h3>安全掃描</h3><p>掃描中...</p><p>已掃描: 1,234 個文件</p><p>威脅: 0 個</p>' },
                    { action: '更新病毒庫', content: '<h3>病毒庫更新</h3><p>當前版本: 2024.12.15</p><p>正在下載更新...</p><p>進度: 67%</p>' },
                    { action: '查看網絡流量', content: '<h3>網絡流量監控</h3><p>上傳: 2.3 MB/s</p><p>下載: 5.7 MB/s</p><p>異常: 未檢測到</p>' }
                ];
                
                let activityIndex = 0;
                this.updateInterval = setInterval(() => {
                    const activity = activities[activityIndex % activities.length];
                    this.updateDefenderView(activity.content);
                    this.logActivity(activity.action);
                    activityIndex++;
                }, 4000);
            },
            
            // 更新防禦者視圖
            updateDefenderView: function(content) {
                const viewDiv = document.getElementById('defender-browser-view');
                if (viewDiv) {
                    viewDiv.innerHTML = `
                        <div style="padding: 20px;">
                            ${content}
                            <div style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <small style="color: #666;">最後更新: ${new Date().toLocaleTimeString()}</small>
                            </div>
                        </div>
                    `;
                }
            },
            
            // 記錄活動
            logActivity: function(action) {
                const logContent = document.getElementById('activity-log-content');
                if (logContent) {
                    const time = new Date().toLocaleTimeString();
                    const logEntry = `<div style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <span style="color: #888;">[${time}]</span> ${action}
                    </div>`;
                    logContent.insertAdjacentHTML('afterbegin', logEntry);
                }
                
                // 同時在終端顯示
                addTerminalLine(`[監控] 防禦者: ${action}`, 'system');
            },
            
            // 通知防禦者
            notifyDefender: function() {
                if (this.notificationSent) return;
                this.notificationSent = true;
                
                // 在防禦者介面顯示警告（模擬）
                this.logActivity('⚠️ 收到警告：檢測到未授權的監控活動');
                addTerminalLine('[系統] 防禦者已收到監控警告（延遲通知）', 'warning');
                
                // 顯示通知
                showNotification('防禦者警覺', '防禦者已察覺到您的監控，但有延遲', 'hacker');
            },
            
            // 關閉預覽
            closePreview: function() {
                this.isActive = false;
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
                const modal = document.getElementById('live-preview-modal');
                if (modal) modal.remove();
            }
        };
        
        // 權限爭奪系統
        const ControlBattle = {
            hackerControl: 0,
            defenderControl: 100,
            battleActive: false,
            updateInterval: null,
            
            // 開始權限爭奪
            startBattle: function() {
                if (this.battleActive) return;
                
                this.battleActive = true;
                this.showControlPanel();
                this.startControlUpdates();
            },
            
            // 顯示控制面板
            showControlPanel: function() {
                const panelHTML = `
                    <div id="control-battle-panel" style="position: fixed; top: 20px; right: 20px; width: 300px; background: rgba(20,20,30,0.95); border: 2px solid #00ff41; border-radius: 10px; padding: 20px; z-index: 9999;">
                        <h3 style="margin: 0 0 15px 0; color: #00ff41;">
                            <i class="fas fa-tachometer-alt"></i> 系統控制權
                        </h3>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #00ff41;">黑客</span>
                                <span id="hacker-control-percent" style="color: #00ff41;">0%</span>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); height: 20px; border-radius: 10px; overflow: hidden;">
                                <div id="hacker-control-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #00ff41, #00cc33); transition: width 0.5s;"></div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #ff3333;">防禦者</span>
                                <span id="defender-control-percent" style="color: #ff3333;">100%</span>
                            </div>
                            <div style="background: rgba(0,0,0,0.5); height: 20px; border-radius: 10px; overflow: hidden;">
                                <div id="defender-control-bar" style="width: 100%; height: 100%; background: linear-gradient(90deg, #ff3333, #cc0000); transition: width 0.5s;"></div>
                            </div>
                        </div>
                        
                        <div id="control-status" style="padding: 10px; background: rgba(0,255,65,0.1); border-radius: 5px; text-align: center; font-size: 0.9rem;">
                            爭奪中...
                        </div>
                        
                        <button onclick="ControlBattle.accelerateControl()" style="width: 100%; margin-top: 15px; padding: 10px; background: rgba(0,255,65,0.2); border: 2px solid #00ff41; color: #00ff41; border-radius: 5px; cursor: pointer; font-weight: bold;">
                            <i class="fas fa-bolt"></i> 加速奪取 (消耗 $10,000)
                        </button>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', panelHTML);
            },
            
            // 開始控制權更新
            startControlUpdates: function() {
                const baseSpeed = GameState.hackerUpgrades?.controlSpeed || 1;
                const instantControl = GameState.hackerUpgrades?.instantControl || false;
                
                if (instantControl) {
                    // 終極套裝：瞬間奪取控制權
                    this.hackerControl = 100;
                    this.defenderControl = 0;
                    this.updateControlDisplay();
                    this.checkControlWinner();
                    return;
                }
                
                this.updateInterval = setInterval(() => {
                    // 黑客每次增加控制權
                    const increase = 2 * baseSpeed;
                    this.hackerControl = Math.min(100, this.hackerControl + increase);
                    this.defenderControl = Math.max(0, 100 - this.hackerControl);
                    
                    // 防禦者反擊（如果有反擊套裝）
                    if (GameState.defenderUpgrades?.counterAttackEnabled) {
                        const counterPower = GameState.defenderUpgrades.counterAttackPower || 30;
                        if (Math.random() * 100 < counterPower) {
                            this.hackerControl = Math.max(0, this.hackerControl - 5);
                            this.defenderControl = 100 - this.hackerControl;
                            addTerminalLine('[反擊] 防禦者發動反擊！', 'warning');
                        }
                    }
                    
                    this.updateControlDisplay();
                    this.checkControlWinner();
                }, 1000);
            },
            
            // 更新控制顯示
            updateControlDisplay: function() {
                const hackerBar = document.getElementById('hacker-control-bar');
                const defenderBar = document.getElementById('defender-control-bar');
                const hackerPercent = document.getElementById('hacker-control-percent');
                const defenderPercent = document.getElementById('defender-control-percent');
                const status = document.getElementById('control-status');
                
                if (hackerBar) hackerBar.style.width = this.hackerControl + '%';
                if (defenderBar) defenderBar.style.width = this.defenderControl + '%';
                if (hackerPercent) hackerPercent.textContent = Math.round(this.hackerControl) + '%';
                if (defenderPercent) defenderPercent.textContent = Math.round(this.defenderControl) + '%';
                
                if (status) {
                    if (this.hackerControl > 80) {
                        status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 黑客即將完全控制系統！';
                        status.style.background = 'rgba(255,0,0,0.2)';
                    } else if (this.hackerControl > 50) {
                        status.innerHTML = '<i class="fas fa-balance-scale"></i> 黑客佔據優勢';
                        status.style.background = 'rgba(255,153,0,0.2)';
                    } else {
                        status.innerHTML = '<i class="fas fa-shield-alt"></i> 防禦者仍在抵抗';
                        status.style.background = 'rgba(0,255,65,0.1)';
                    }
                }
            },
            
            // 檢查勝負
            checkControlWinner: function() {
                if (this.hackerControl >= 100) {
                    this.endBattle('hacker');
                } else if (this.defenderControl >= 100) {
                    this.endBattle('defender');
                }
            },
            
            // 加速奪取
            accelerateControl: function() {
                if (GameState.wallet.balance < 10000) {
                    addTerminalLine('[加速] 餘額不足！需要 $10,000', 'error');
                    return;
                }
                
                GameState.wallet.balance -= 10000;
                updateWalletDisplay();
                
                this.hackerControl = Math.min(100, this.hackerControl + 15);
                this.defenderControl = 100 - this.hackerControl;
                this.updateControlDisplay();
                this.checkControlWinner();
                
                addTerminalLine('[加速] 控制權奪取加速！+15%', 'success');
                SoundSystem.play('attack');
            },
            
            // 結束戰鬥
            endBattle: function(winner) {
                this.battleActive = false;
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
                
                if (winner === 'hacker') {
                    addTerminalLine('═══════════════════════════════════════', 'success');
                    addTerminalLine('🎉 勝利！您已完全控制防禦者的系統！', 'success');
                    addTerminalLine('═══════════════════════════════════════', 'success');
                    
                    showNotification('完全控制', '您已奪取防禦者的所有系統權限！', 'hacker');
                    
                    // 獎勵
                    const reward = 50000;
                    GameState.wallet.balance += reward;
                    updateWalletDisplay();
                    addTerminalLine(`[獎勵] 獲得 $${reward.toLocaleString()}`, 'success');
                } else {
                    addTerminalLine('防禦者成功保住了系統控制權', 'warning');
                }
            }
        };
        
        // 將功能綁定到全局
        window.ItemManager = ItemManager;
        window.LivePreview = LivePreview;
        window.ControlBattle = ControlBattle;
        window.ItemEffects = ItemEffects;
        window.closeItemSelector = closeItemSelector;
        

        // ===== 導航和麵包屑函數 =====
        function goToMainPage() {
            const mainPage = document.getElementById('main-page');
            const gamePage = document.getElementById('game-page');
            const battleSelectPage = document.getElementById('battle-select-page');
            const guidePage = document.getElementById('guide-page');
            const flowchartPage = document.getElementById('flowchart-page');
            
            // 隱藏所有頁面
            [gamePage, battleSelectPage, guidePage, flowchartPage].forEach(page => {
                if (page) {
                    page.classList.remove('active');
                    page.classList.add('hidden');
                }
            });
            
            // 顯示主頁面
            mainPage.classList.remove('hidden');
            mainPage.classList.add('active');
            
            // 隱藏麵包屑
            updateBreadcrumb('');
            
            // 更新導航菜單
            updateNavMenu('home');
        }

        function navigateToMode(mode) {
            if (mode === 'hacker') {
                startSoloGame('hacker');
                updateBreadcrumb('主頁 > 黑客模式');
                updateNavMenu('hacker');
            } else if (mode === 'defender') {
                startSoloGame('defender');
                updateBreadcrumb('主頁 > 防禦者模式');
                updateNavMenu('defender');
            } else if (mode === 'battle') {
                showBattleSelect();
                updateBreadcrumb('主頁 > 對戰模式');
                updateNavMenu('battle');
            }
        }

        function updateBreadcrumb(breadcrumbText) {
            const breadcrumb = document.getElementById('breadcrumb');
            if (breadcrumbText) {
                breadcrumb.innerHTML = breadcrumbText.split(' > ').map((item, index, arr) => {
                    if (index === arr.length - 1) {
                        return `<span>${item}</span>`;
                    } else {
                        return `<a onclick="goToMainPage()">${item}</a><span> > </span>`;
                    }
                }).join('');
                breadcrumb.classList.add('active');
            } else {
                breadcrumb.classList.remove('active');
            }
        }

        function updateNavMenu(active) {
            const navItems = document.querySelectorAll('.nav-menu li a');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            const activeMap = {
                'home': 'nav-home',
                'hacker': 'nav-hacker',
                'defender': 'nav-defender',
                'battle': 'nav-battle'
            };
            
            if (activeMap[active]) {
                document.getElementById(activeMap[active]).classList.add('active');
            }
        }

        // 該功能已移除


        // 模式選擇功能已移除

        // 已移除該模式相關遊戲函數與提示

        // 重新開始功能已移除

        // 談判與專用面板功能已移除
</script>


    <!-- 執法系統模態框 -->
    <div class="law-enforcement-modal" id="law-enforcement-modal" style="display: none;">
        <div class="law-enforcement-container">
            <button class="close-law-enforcement" onclick="closeLawEnforcement()">&times;</button>
            
            <div class="law-enforcement-header">
                <div class="law-enforcement-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div>
                    <div class="law-enforcement-title">執法部門聯動系統</div>
                    <div class="law-enforcement-subtitle">網絡罪案調查與追蹤</div>
                </div>
            </div>

            <!-- 報案信息 -->
            <div class="law-enforcement-section">
                <h3><i class="fas fa-file-alt"></i> 案件報告</h3>
                <div class="hacker-profile">
                    <div class="hacker-profile-item">
                        <span class="hacker-profile-label">報案時間：</span>
                        <span class="hacker-profile-value" id="report-time">-</span>
                    </div>
                    <div class="hacker-profile-item">
                        <span class="hacker-profile-label">攻擊者 IP：</span>
                        <span class="hacker-profile-value" id="attacker-ip">-</span>
                    </div>
                    <div class="hacker-profile-item">
                        <span class="hacker-profile-label">攻擊類型：</span>
                        <span class="hacker-profile-value" id="attack-type">-</span>
                    </div>
                    <div class="hacker-profile-item">
                        <span class="hacker-profile-label">案件狀態：</span>
                        <span class="hacker-profile-value" id="case-status">調查中</span>
                    </div>
                </div>
            </div>

            <!-- 執法部門 -->
            <div class="law-enforcement-section">
                <h3><i class="fas fa-building"></i> 參與部門</h3>
                <div class="department-grid" id="department-grid">
                    <!-- 動態生成 -->
                </div>
            </div>

            <!-- 調查進度 -->
            <div class="law-enforcement-section">
                <h3><i class="fas fa-tasks"></i> 調查進度</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="investigation-progress" style="width: 0%;">0%</div>
                </div>
                <div class="investigation-timeline" id="investigation-timeline">
                    <!-- 動態生成時間線 -->
                </div>
            </div>

            <!-- 黑客檔案 -->
            <div class="law-enforcement-section" id="hacker-file-section" style="display: none;">
                <h3><i class="fas fa-user-secret"></i> 嫌疑人檔案</h3>
                <div class="hacker-profile" id="hacker-details">
                    <!-- 動態生成 -->
                </div>
            </div>

            <!-- 執法行動 -->
            <div class="law-enforcement-actions" id="law-enforcement-actions">
                <button class="law-enforcement-btn" onclick="continueInvestigation()">
                    <i class="fas fa-search"></i> 繼續調查
                </button>
                <button class="law-enforcement-btn arrest" onclick="executeArrest()">
                    <i class="fas fa-handcuffs"></i> 執行拘捕
                </button>
            </div>

            <!-- 結果顯示 -->
            <div id="law-enforcement-result-container"></div>
        </div>
    </div>
</body></html>
